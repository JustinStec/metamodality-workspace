<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>An Inquiry into Forms of the Possible — Spring 2026</title>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: #f8f7f4;
            color: #1a1a1a;
            height: 100vh;
            overflow: hidden;
        }

        .workspace {
            display: flex;
            height: 100vh;
        }

        /* Left Panel - Schedule */
        .schedule-panel {
            width: 340px;
            background: #fff;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .schedule-header {
            padding: 1.25rem;
            border-bottom: 1px solid #eee;
            background: #fafaf8;
        }

        .schedule-header h1 {
            font-size: 1.2rem;
            font-weight: normal;
            margin-bottom: 0.25rem;
            line-height: 1.3;
        }

        .schedule-header .meta {
            font-size: 0.8rem;
            color: #666;
            line-height: 1.4;
        }

        .schedule-content {
            flex: 1;
            overflow-y: auto;
            padding: 0.75rem;
        }

        .unit-header {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: #888;
            padding: 1rem 0.5rem 0.4rem;
            border-bottom: 1px solid #eee;
            margin-top: 0.5rem;
        }

        .unit-header:first-child {
            margin-top: 0;
        }

        .week {
            margin: 0.5rem 0;
        }

        .week-header {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            cursor: pointer;
            border-radius: 6px;
            transition: background 0.15s;
        }

        .week-header:hover {
            background: #f5f5f0;
        }

        .week-header.active {
            background: #e8f4fc;
        }

        .week-num {
            font-size: 0.7rem;
            color: #888;
            width: 50px;
            flex-shrink: 0;
        }

        .week-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .week-readings {
            display: none;
            padding: 0.25rem 0 0.5rem 50px;
        }

        .week.expanded .week-readings {
            display: block;
        }

        .reading-item {
            font-size: 0.82rem;
            padding: 0.35rem 0.5rem;
            margin: 0.15rem 0;
            cursor: pointer;
            border-radius: 4px;
            color: #444;
            line-height: 1.35;
            transition: background 0.15s;
        }

        .reading-item:hover {
            background: #f0f0eb;
        }

        .reading-item.active {
            background: #3498db;
            color: #fff;
        }

        .reading-item em {
            font-style: italic;
        }

        .reading-item .pages {
            font-size: 0.75rem;
            color: #888;
            margin-left: 0.25rem;
        }

        .reading-item.active .pages {
            color: rgba(255,255,255,0.7);
        }

        /* Center Panel - Viewer */
        .viewer-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #525659;
            min-width: 0;
        }

        .viewer-toolbar {
            background: #3d4043;
            color: #fff;
            padding: 0.6rem 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.85rem;
        }

        .viewer-toolbar .reading-title {
            flex: 1;
            font-weight: 500;
        }

        .viewer-toolbar button {
            background: rgba(255,255,255,0.1);
            border: none;
            color: #fff;
            padding: 0.4rem 0.75rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .viewer-toolbar button:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Auth styles */
        .auth-section {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .login-btn {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: #10b981 !important;
        }

        .login-btn:hover {
            background: #059669 !important;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-email {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.8);
            max-width: 150px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .logout-btn {
            font-size: 0.7rem !important;
            padding: 0.25rem 0.5rem !important;
            opacity: 0.8;
        }

        /* Auth modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .auth-modal.active {
            display: flex;
        }

        .auth-modal-content {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            width: 100%;
            max-width: 360px;
        }

        .auth-modal h3 {
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .auth-modal p {
            font-size: 0.85rem;
            color: #666;
            margin-bottom: 1rem;
        }

        .auth-modal input {
            width: 100%;
            padding: 0.6rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-bottom: 0.75rem;
        }

        .auth-modal input:focus {
            outline: none;
            border-color: #3498db;
        }

        .auth-modal .btn-row {
            display: flex;
            gap: 0.5rem;
        }

        .auth-modal button {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .auth-modal .primary-btn {
            background: #10b981;
            color: #fff;
        }

        .auth-modal .secondary-btn {
            background: #e5e5e5;
            color: #333;
        }

        .auth-message {
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 0.75rem;
            display: none;
        }

        .auth-message.success {
            display: block;
            background: #d1fae5;
            color: #065f46;
        }

        .auth-message.error {
            display: block;
            background: #fee2e2;
            color: #991b1b;
        }

        .viewer-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .viewer-content iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #fff;
        }

        .viewer-placeholder {
            text-align: center;
            color: #aaa;
            padding: 2rem;
        }

        .viewer-placeholder h2 {
            font-size: 1.1rem;
            font-weight: normal;
            margin-bottom: 0.5rem;
        }

        .viewer-placeholder p {
            font-size: 0.9rem;
        }

        /* Right Panel - Context */
        .context-panel {
            width: 360px;
            background: #fff;
            border-left: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .context-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            background: #fafaf8;
        }

        .context-tab {
            flex: 1;
            padding: 0.7rem 0.4rem;
            text-align: center;
            font-size: 0.75rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #666;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }

        .context-tab:hover {
            color: #333;
        }

        .context-tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
            background: #fff;
        }

        .context-content {
            flex: 1;
            overflow-y: auto;
        }

        .tab-panel {
            display: none;
            padding: 1rem;
            height: 100%;
        }

        .tab-panel.active {
            display: flex;
            flex-direction: column;
        }

        /* Focus tab */
        .focus-question {
            font-size: 0.95rem;
            line-height: 1.6;
            color: #333;
            font-style: italic;
        }

        .focus-meta {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            font-size: 0.8rem;
            color: #888;
        }

        /* Annotations tab */
        .annotations-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }

        .annotations-header h4 {
            font-size: 0.85rem;
            font-weight: 600;
        }

        .annotation-count {
            background: #3498db;
            color: #fff;
            font-size: 0.7rem;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
        }

        .annotation-card {
            background: #fffbeb;
            border: 1px solid #fde68a;
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            font-size: 0.82rem;
        }

        .annotation-card.blue { background: #eff6ff; border-color: #bfdbfe; }
        .annotation-card.green { background: #f0fdf4; border-color: #bbf7d0; }
        .annotation-card.purple { background: #faf5ff; border-color: #e9d5ff; }

        .annotation-quote {
            font-style: italic;
            color: #666;
            border-left: 2px solid #ccc;
            padding-left: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .annotation-comment {
            margin-bottom: 0.4rem;
        }

        .annotation-meta {
            font-size: 0.7rem;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 2rem 1rem;
            font-size: 0.85rem;
        }

        /* New annotation */
        .new-annotation {
            border-top: 1px solid #eee;
            padding: 0.75rem 1rem;
            background: #fafaf8;
        }

        .new-annotation textarea {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
            font-family: inherit;
            font-size: 0.82rem;
            resize: vertical;
            min-height: 50px;
        }

        .new-annotation textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .annotation-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-picker {
            display: flex;
            gap: 0.25rem;
        }

        .color-dot {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-dot.selected { border-color: #333; }
        .color-dot.yellow { background: #fde68a; }
        .color-dot.blue { background: #bfdbfe; }
        .color-dot.green { background: #bbf7d0; }
        .color-dot.purple { background: #e9d5ff; }

        .annotation-actions button {
            margin-left: auto;
            background: #3498db;
            color: #fff;
            border: none;
            padding: 0.35rem 0.7rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .annotation-actions button:hover {
            background: #2980b9;
        }

        .annotation-actions button.secondary {
            background: #ddd;
            color: #666;
            margin-left: 0;
        }

        /* Notes tab */
        .notes-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .notes-list {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 0.75rem;
        }

        .note-item {
            padding: 0.6rem;
            border: 1px solid #eee;
            border-radius: 6px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .note-item:hover {
            background: #f8f8f5;
            border-color: #ddd;
        }

        .note-item.active {
            background: #e8f4fc;
            border-color: #3498db;
        }

        .note-title {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .note-preview {
            font-size: 0.75rem;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-meta {
            font-size: 0.7rem;
            color: #aaa;
            margin-top: 0.35rem;
        }

        .note-links {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-top: 0.35rem;
        }

        .note-link {
            font-size: 0.65rem;
            background: #e8f4fc;
            color: #3498db;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            cursor: pointer;
        }

        .note-link:hover {
            background: #d0e8f8;
        }

        .note-editor {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .note-editor.active {
            display: flex;
        }

        .note-editor-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .note-editor-header input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.4rem 0.5rem;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .note-editor textarea {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.5rem;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.8rem;
            resize: none;
            min-height: 150px;
        }

        .note-editor textarea:focus,
        .note-editor-header input:focus {
            outline: none;
            border-color: #3498db;
        }

        .note-editor-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: space-between;
        }

        .note-editor-actions .left {
            display: flex;
            gap: 0.5rem;
        }

        .note-preview-pane {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: #fafaf8;
            border: 1px solid #eee;
            border-radius: 4px;
            font-size: 0.82rem;
            line-height: 1.5;
            max-height: 150px;
            overflow-y: auto;
        }

        .note-preview-pane .wiki-link {
            color: #3498db;
            cursor: pointer;
            text-decoration: underline;
        }

        .note-preview-pane .wiki-link:hover {
            color: #2980b9;
        }

        .new-note-btn {
            width: 100%;
            background: #f0f0eb;
            border: 1px dashed #ccc;
            border-radius: 6px;
            padding: 0.6rem;
            cursor: pointer;
            font-size: 0.8rem;
            color: #666;
        }

        .new-note-btn:hover {
            background: #e8e8e3;
            border-color: #999;
        }

        /* Feed tab */
        .feed-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .feed-list {
            flex: 1;
            overflow-y: auto;
        }

        .post-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            background: #fff;
        }

        .post-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .post-author-info {
            flex: 1;
        }

        .post-author {
            font-size: 0.82rem;
            font-weight: 600;
        }

        .post-date {
            font-size: 0.7rem;
            color: #999;
        }

        .post-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.35rem;
        }

        .post-content {
            font-size: 0.82rem;
            line-height: 1.5;
            color: #444;
            margin-bottom: 0.5rem;
        }

        .post-content .wiki-link {
            color: #3498db;
            cursor: pointer;
        }

        .post-readings {
            display: flex;
            flex-wrap: wrap;
            gap: 0.25rem;
            margin-bottom: 0.5rem;
        }

        .post-reading-tag {
            font-size: 0.65rem;
            background: #f0f0eb;
            color: #666;
            padding: 0.15rem 0.4rem;
            border-radius: 3px;
            cursor: pointer;
        }

        .post-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding-top: 0.5rem;
            border-top: 1px solid #f0f0eb;
        }

        .reaction-btn {
            background: none;
            border: 1px solid #eee;
            border-radius: 15px;
            padding: 0.2rem 0.5rem;
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .reaction-btn:hover {
            background: #f8f8f5;
        }

        .reaction-btn.active {
            background: #e8f4fc;
            border-color: #3498db;
        }

        .reaction-count {
            font-size: 0.7rem;
            color: #666;
        }

        .comment-btn {
            font-size: 0.75rem;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
        }

        .comment-btn:hover {
            color: #333;
        }

        .post-comments {
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid #f0f0eb;
        }

        .comment-item {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.4rem;
            background: #fafaf8;
            border-radius: 4px;
        }

        .comment-content {
            flex: 1;
        }

        .comment-author {
            font-size: 0.75rem;
            font-weight: 600;
        }

        .comment-text {
            font-size: 0.78rem;
            color: #444;
            line-height: 1.4;
        }

        .comment-input {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .comment-input input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.35rem 0.5rem;
            font-size: 0.78rem;
        }

        .comment-input button {
            background: #3498db;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.35rem 0.6rem;
            cursor: pointer;
            font-size: 0.75rem;
        }

        /* Auth required message */
        .auth-required {
            text-align: center;
            padding: 2rem 1rem;
        }

        .auth-required p {
            color: #888;
            font-size: 0.85rem;
            margin-bottom: 1rem;
        }

        .auth-required button {
            background: #10b981;
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
        }

        /* Selection popup */
        .selection-popup {
            position: fixed;
            background: #2c3e50;
            color: #fff;
            padding: 0.4rem;
            border-radius: 6px;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .selection-popup button {
            background: transparent;
            border: none;
            color: #fff;
            padding: 0.3rem 0.5rem;
            cursor: pointer;
            border-radius: 3px;
            font-size: 0.75rem;
        }

        .selection-popup button:hover {
            background: rgba(255,255,255,0.15);
        }

        /* Sync indicator */
        .sync-indicator {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .sync-indicator.syncing::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #f1c40f;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }

        .sync-indicator.synced::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #2ecc71;
            border-radius: 50%;
        }

        .sync-indicator.offline::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #e74c3c;
            border-radius: 50%;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Button styles */
        .btn {
            background: #3498db;
            color: #fff;
            border: none;
            padding: 0.35rem 0.7rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .btn:hover { background: #2980b9; }
        .btn.secondary { background: #ddd; color: #666; }
        .btn.secondary:hover { background: #ccc; }
        .btn.danger { background: #e74c3c; }
        .btn.danger:hover { background: #c0392b; }
        .btn.success { background: #27ae60; }
        .btn.success:hover { background: #219a52; }

        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            .workspace { flex-direction: column; }
            .schedule-panel {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid #ddd;
            }
            .context-panel {
                width: 100%;
                height: 250px;
                border-left: none;
                border-top: 1px solid #ddd;
            }
        }

        @media (max-width: 768px) {
            .schedule-panel { display: none; }
            .context-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 50vh;
                transform: translateY(calc(100% - 40px));
                transition: transform 0.3s;
                z-index: 100;
            }
            .context-panel.expanded { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="workspace">
        <!-- Schedule Panel -->
        <nav class="schedule-panel">
            <div class="schedule-header">
                <h1>An Inquiry into Forms of the Possible</h1>
                <div class="meta">
                    Center for Possible Minds<br>
                    Spring 2026 · Wednesdays 4–5:30pm
                </div>
            </div>
            <div class="schedule-content" id="schedule"></div>
        </nav>

        <!-- Viewer Panel -->
        <main class="viewer-panel">
            <div class="viewer-toolbar">
                <span class="reading-title" id="reading-title">Select a reading</span>
                <div class="sync-indicator" id="sync-indicator"><span></span></div>
                <button onclick="togglePanel()">Toggle Panel</button>
                <button onclick="exportAnnotations()">Export Notes</button>
                <div class="auth-section" id="auth-section">
                    <button class="login-btn" onclick="showAuthModal()" id="login-btn">Sign in</button>
                    <div class="user-info" id="user-info" style="display:none;">
                        <span class="user-email" id="user-email"></span>
                        <button class="logout-btn" onclick="signOut()">Sign out</button>
                    </div>
                </div>
            </div>
            <div class="viewer-content" id="viewer">
                <div class="viewer-placeholder">
                    <h2>Welcome</h2>
                    <p>Select a week and reading from the schedule to begin.</p>
                </div>
            </div>
        </main>

        <!-- Context Panel -->
        <aside class="context-panel" id="context-panel">
            <div class="context-tabs">
                <button class="context-tab active" data-tab="focus">Focus</button>
                <button class="context-tab" data-tab="annotations">Annotations <span id="ann-count"></span></button>
                <button class="context-tab" data-tab="notes">Notes</button>
                <button class="context-tab" data-tab="feed">Feed</button>
            </div>
            <div class="context-content">
                <!-- Focus Tab -->
                <div class="tab-panel active" id="tab-focus">
                    <p class="focus-question" id="focus-question">Select a week to see its guiding question.</p>
                    <div class="focus-meta" id="focus-meta"></div>
                </div>

                <!-- Annotations Tab -->
                <div class="tab-panel" id="tab-annotations">
                    <div class="annotations-header">
                        <h4>Annotations</h4>
                        <span class="annotation-count" id="annotation-count">0</span>
                    </div>
                    <div id="annotations-list" style="flex:1; overflow-y:auto;">
                        <div class="empty-state">No annotations yet.<br>Select text in the PDF to annotate.</div>
                    </div>
                </div>

                <!-- Notes Tab -->
                <div class="tab-panel" id="tab-notes">
                    <div id="notes-auth-required" class="auth-required">
                        <p>Sign in to create and view notes</p>
                        <button onclick="showAuthModal()">Sign in with email</button>
                    </div>
                    <div id="notes-content" class="notes-container" style="display:none;">
                        <div id="notes-list-view">
                            <div class="notes-list" id="notes-list"></div>
                            <button class="new-note-btn" onclick="createNewNote()">+ New Note</button>
                        </div>
                        <div class="note-editor" id="note-editor">
                            <div class="note-editor-header">
                                <button class="btn secondary" onclick="closeNoteEditor()">Back</button>
                                <input type="text" id="note-title" placeholder="Note title...">
                            </div>
                            <textarea id="note-content" placeholder="Write your note... Use [[Week 1: Parmenides]] to link to readings."></textarea>
                            <div class="note-preview-pane" id="note-preview"></div>
                            <div class="note-editor-actions">
                                <div class="left">
                                    <button class="btn danger" onclick="deleteNote()" id="delete-note-btn" style="display:none;">Delete</button>
                                </div>
                                <div>
                                    <button class="btn success" onclick="publishNote()">Publish to Feed</button>
                                    <button class="btn" onclick="saveNote()">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Feed Tab -->
                <div class="tab-panel" id="tab-feed">
                    <div class="feed-container">
                        <div class="feed-list" id="feed-list">
                            <div class="empty-state">No posts yet.<br>Be the first to share your thoughts!</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="new-annotation" id="new-annotation" style="display:none;">
                <div class="annotation-quote" id="selected-quote"></div>
                <textarea id="annotation-input" placeholder="Add your note..."></textarea>
                <div class="annotation-actions">
                    <div class="color-picker">
                        <div class="color-dot yellow selected" data-color="yellow"></div>
                        <div class="color-dot blue" data-color="blue"></div>
                        <div class="color-dot green" data-color="green"></div>
                        <div class="color-dot purple" data-color="purple"></div>
                    </div>
                    <button class="secondary" onclick="cancelAnnotation()">Cancel</button>
                    <button onclick="saveAnnotation()">Save</button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Auth Modal -->
    <div class="auth-modal" id="auth-modal">
        <div class="auth-modal-content">
            <h3>Sign in</h3>
            <p>Enter your email to receive a magic link.</p>
            <div class="auth-message" id="auth-message"></div>
            <input type="email" id="auth-email" placeholder="your@email.com">
            <div class="btn-row">
                <button class="secondary-btn" onclick="hideAuthModal()">Cancel</button>
                <button class="primary-btn" onclick="sendMagicLink()">Send link</button>
            </div>
        </div>
    </div>

    <div class="selection-popup" id="selection-popup">
        <button onclick="startAnnotation()">Annotate</button>
    </div>

    <script>
        // =============================================
        // SUPABASE CONFIGURATION
        // =============================================
        // Supabase project credentials
        const SUPABASE_URL = 'https://tnasxupoydyoxibccovm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuYXN4dXBveWR5b3hpYmNjb3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDM5NjksImV4cCI6MjA4NDc3OTk2OX0.JTXSnyDDl5Ta3s7fDtnGfWcuicuchwP5A5WhRZ_exIg';

        let supabase = null;
        let currentUser = null;
        let supabaseInitialized = false;

        try {
            if (SUPABASE_URL !== 'https://YOUR_PROJECT.supabase.co') {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                supabaseInitialized = true;
            }
        } catch (e) {
            console.warn('Supabase not configured. Using localStorage fallback.');
        }

        // =============================================
        // COURSE DATA (Updated to match PDF)
        // =============================================
        const schedule = [
            { unit: "Unit I: Ancient and Medieval Foundations", weeks: [
                { num: 1, date: "Feb 4", title: "Parmenides", focus: "How can we think or speak \"what is not\"? This problem drives subsequent responses from Aristotle through Heidegger. Kingsley's reading situates Parmenides within an initiatory tradition.", readings: [
                    { id: "w01_parmenides", title: "Parmenides, \"On Nature\"", pages: "~10 pp.", file: "readings/week01_parmenides.pdf" },
                    { id: "w01_kingsley", title: "Kingsley, <em>In the Dark Places of Wisdom</em>, ch. 1–4", pages: "~30 pp.", file: "readings/week01_kingsley.pdf" }
                ]},
                { num: 2, date: "Feb 11", title: "Aristotle", focus: "Aristotle's potentiality (dynamis) answers Parmenides by locating possibility within beings themselves. The sea-battle problem asks whether future contingents have determinate truth values.", readings: [
                    { id: "w02_meta", title: "Aristotle, <em>Metaphysics</em> Book Theta, ch. 1–3, 6–8", pages: "~30 pp.", file: "readings/week02_aristotle_metaphysics.pdf" },
                    { id: "w02_di", title: "Aristotle, <em>De Interpretatione</em>, ch. 9", pages: "~5 pp.", file: "readings/week02_aristotle_de_interpretatione.pdf" },
                    { id: "w02_witt", title: "Witt, \"The Priority of Actuality\"", pages: "~10 pp.", file: "readings/week02_witt.pdf" }
                ]},
                { num: 3, date: "Feb 18", title: "Avicenna", focus: "Separating essence from existence, Avicenna makes contingency fundamental to everything except the Necessary Existent.", readings: [
                    { id: "w03_avicenna", title: "Avicenna, <em>Metaphysics of The Healing</em>", pages: "~25 pp.", file: "readings/week03_avicenna.pdf" },
                    { id: "w03_adamson", title: "Adamson, \"From the Necessary Existent to God\"", pages: "~15 pp.", file: "readings/week03_adamson.pdf" }
                ]},
                { num: 4, date: "Feb 25", title: "Nagarjuna", focus: "Does \"possibility\" mean anything once inherent existence drops out? Nagarjuna's tetralemma refuses the logical options that Western frameworks take for granted.", readings: [
                    { id: "w04_nagarjuna", title: "Nagarjuna, <em>Mulamadhyamakakarika</em>, ch. 1, 15, 24", pages: "~20 pp.", file: "readings/week04_nagarjuna.pdf" },
                    { id: "w04_garfield", title: "Garfield, \"Dependent Arising and the Emptiness of Emptiness\"", pages: "~20 pp.", file: "readings/week04_garfield.pdf" }
                ]}
            ]},
            { unit: "Unit II: Rationalism, Transcendentalism, and the Imaginal", weeks: [
                { num: 5, date: "Mar 4", title: "Leibniz and Du Châtelet", focus: "Compossibility constrains which possibilities can coexist within a single world. The Monadology raises the question of what individuates possible worlds; the Institutions de physique systematizes Leibniz-Wolffian metaphysics.", readings: [
                    { id: "w05_monad", title: "Leibniz, <em>Monadology</em>", pages: "~15 pp.", file: "readings/week05_leibniz_monadology.pdf" },
                    { id: "w05_duchat", title: "Du Châtelet, <em>Institutions de physique</em>, ch. 1–2", pages: "~15 pp.", file: "readings/week05_du_chatelet.pdf" },
                    { id: "w05_orig", title: "Leibniz, \"On the Ultimate Origination of Things\"", pages: "~5 pp.", file: "readings/week05_leibniz_origination.pdf" }
                ]},
                { num: 6, date: "Mar 11", title: "Kant and Contemporary Kantian Modality", focus: "What must any possible experience conform to? Kant's Postulates distinguish logical from real possibility. Leech's \"modal transcendentalism\" develops this for contemporary debates.", readings: [
                    { id: "w06_kant", title: "Kant, <em>CPR</em>: \"Postulates of Empirical Thought\"", pages: "~20 pp.", file: "readings/week06_kant.pdf" },
                    { id: "w06_leech", title: "Leech, \"The Function of Modal Judgment and the Kantian Gap\"", pages: "~25 pp.", file: "readings/week06_leech.pdf" }
                ]},
                { num: 7, date: "Mar 18", title: "Sufi Metaphysics", focus: "Ibn Arabi's imaginal world (alam al-mithal) occupies a realm between sensible and intelligible, where possibilities take on form. Rabia's sayings mark an earlier moment in the tradition.", readings: [
                    { id: "w07_rabia", title: "Rabia al-Adawiyya, selected sayings", pages: "~5 pp.", file: "readings/week07_rabia.pdf" },
                    { id: "w07_arabi", title: "Ibn Arabi, <em>Fusus al-Hikam</em>, \"Adam\"", pages: "~10 pp.", file: "readings/week07_ibn_arabi.pdf" },
                    { id: "w07_chittick", title: "Chittick, <em>Sufi Path of Knowledge</em>, ch. 1", pages: "~20 pp.", file: "readings/week07_chittick.pdf" }
                ]}
            ]},
            { unit: "Unit III: Phenomenology, Pragmatism, and Nothingness", weeks: [
                { num: 8, date: "Mar 25", title: "Husserl and Derrida", focus: "Can a condition of possibility also be a condition of impossibility? Derrida's introduction examines how ideal objects arise in history yet claim eternal validity.", readings: [
                    { id: "w08_husserl", title: "Husserl, \"The Origin of Geometry\"", pages: "~20 pp.", file: "readings/week08_husserl.pdf" },
                    { id: "w08_derrida", title: "Derrida, <em>Introduction to \"The Origin of Geometry\"</em>, selections", pages: "~25 pp.", file: "readings/week08_derrida.pdf" }
                ]},
                { num: 9, date: "Apr 1", title: "Heidegger and Arendt", focus: "Possibility becomes constitutive of Dasein; death individualizes as the ownmost possibility. Arendt's natality offers a counter-emphasis to being-toward-death.", readings: [
                    { id: "w09_heid", title: "Heidegger, <em>Being and Time</em>, II.1 (§§46–53)", pages: "~30 pp.", file: "readings/week09_heidegger.pdf" },
                    { id: "w09_arendt", title: "Arendt, <em>Human Condition</em>, ch. 5 §§24–26", pages: "~15 pp.", file: "readings/week09_arendt.pdf" }
                ]},
                { num: 10, date: "Apr 8", title: "Peirce", focus: "Firstness is pure qualitative possibility, prior to relation or resistance. Peirce's continuum allows possibility to grade into actuality.", readings: [
                    { id: "w10_incap", title: "Peirce, \"Some Consequences of Four Incapacities\"", pages: "~20 pp.", file: "readings/week10_peirce_incapacities.pdf" },
                    { id: "w10_guess", title: "Peirce, \"A Guess at the Riddle\", ch. 1–3", pages: "~20 pp.", file: "readings/week10_peirce_guess.pdf" }
                ]},
                { num: 11, date: "Apr 15", title: "Nothingness East and West", focus: "Nishida's \"place of absolute nothingness\" holds particulars without being one itself. Lalla's Kashmiri Shaivite poetry pursues nothingness through a different idiom.", readings: [
                    { id: "w11_nishida", title: "Nishida, <em>An Inquiry into the Good</em>, I.1–3", pages: "~25 pp.", file: "readings/week11_nishida.pdf" },
                    { id: "w11_lalla", title: "Lalla, <em>Naked Song</em>, selections", pages: "~10 pp.", file: "readings/week11_lalla.pdf" }
                ]}
            ]},
            { unit: "Unit IV: Process, Contemplation, Emanation", weeks: [
                { num: 12, date: "Apr 22", title: "Whitehead", focus: "Eternal objects ingress into actual occasions as pure potentials. Whitehead's God functions as the primordial envisagement of possibility.", readings: [
                    { id: "w12_smw", title: "Whitehead, <em>Science and the Modern World</em>, ch. 11", pages: "~25 pp.", file: "readings/week12_whitehead_smw.pdf" },
                    { id: "w12_pr", title: "Whitehead, <em>Process and Reality</em>, I.2.1", pages: "~20 pp.", file: "readings/week12_whitehead_pr.pdf" }
                ]},
                { num: 13, date: "Apr 29", title: "Contemplative Science", focus: "Thompson and Varela bridge first-person contemplative methods and third-person neuroscience. Weil's account of attention resonates with contemplative approaches.", readings: [
                    { id: "w13_thomp", title: "Thompson, <em>Waking, Dreaming, Being</em>, ch. 1", pages: "~20 pp.", file: "readings/week13_thompson.pdf" },
                    { id: "w13_weil", title: "Weil, \"Reflections on the Right Use of School Studies\"", pages: "~10 pp.", file: "readings/week13_weil.pdf" },
                    { id: "w13_varela", title: "Varela, \"Neurophenomenology\"", pages: "~15 pp.", file: "readings/week13_varela.pdf" }
                ]},
                { num: 14, date: "May 6", title: "Neoplatonism", focus: "Possibility flows from the One's inexhaustible superabundance. Conway synthesizes Neoplatonic emanation with Kabbalistic and vitalist sources.", readings: [
                    { id: "w14_plot", title: "Plotinus, <em>Enneads</em> V.1", pages: "~25 pp.", file: "readings/week14_plotinus.pdf" },
                    { id: "w14_conway", title: "Conway, <em>Principles</em>, selections", pages: "~15 pp.", file: "readings/week14_conway.pdf" }
                ]}
            ]},
            { unit: "Unit V: Mathematical and Formal Possibility", weeks: [
                { num: 15, date: "May 13", title: "Modal Logic and Set-Theoretic Potentialism", focus: "Ruth Barcan Marcus founded quantified modal logic; her Barcan formula raises questions about possibility and existence. Hamkins's multiverse holds many distinct concepts of set.", readings: [
                    { id: "w15_marcus", title: "Barcan Marcus, \"Modalities and Intensional Languages\"", pages: "~15 pp.", file: "readings/week15_marcus.pdf" },
                    { id: "w15_multi", title: "Hamkins, \"The Set-Theoretic Multiverse\"", pages: "~25 pp.", file: "readings/week15_hamkins_multiverse.pdf" },
                    { id: "w15_pot", title: "Hamkins & Linnebo, \"Modal Logic of Potentialism\"", pages: "~20 pp.", file: "readings/week15_hamkins_linnebo.pdf" }
                ]},
                { num: 16, date: "May 20", title: "Foster", focus: "How do possibility spaces themselves get produced? Foster's work shows tradition constraining what becomes thinkable while furnishing materials for innovation.", readings: [
                    { id: "w16_foster", title: "Koch, Silvestro & Foster, \"The Evolutionary Dynamics of Cultural Change\"", pages: "~40 pp.", file: "readings/week16_koch_foster.pdf" }
                ]}
            ]}
        ];

        // Build reading lookup for wiki-links
        const readingLookup = {};
        schedule.forEach(unit => {
            unit.weeks.forEach(week => {
                const weekKey = `Week ${week.num}: ${week.title}`;
                readingLookup[weekKey] = { week: week.num, readings: week.readings };
                week.readings.forEach(r => {
                    readingLookup[r.title.replace(/<[^>]*>/g, '')] = { week: week.num, reading: r };
                });
            });
        });

        // =============================================
        // STATE
        // =============================================
        let annotations = {};
        let notes = {};
        let posts = [];
        let currentReading = null;
        let currentWeek = null;
        let selectedText = '';
        let selectedColor = 'yellow';
        let currentNoteId = null;

        // =============================================
        // AUTHENTICATION
        // =============================================
        function showAuthModal() {
            document.getElementById('auth-modal').classList.add('active');
            document.getElementById('auth-email').focus();
        }

        function hideAuthModal() {
            document.getElementById('auth-modal').classList.remove('active');
            document.getElementById('auth-message').className = 'auth-message';
            document.getElementById('auth-message').textContent = '';
        }

        async function sendMagicLink() {
            const email = document.getElementById('auth-email').value.trim();
            if (!email) return;

            if (!supabaseInitialized) {
                showAuthMessage('Supabase not configured. Add your credentials to the code.', 'error');
                return;
            }

            const { error } = await supabase.auth.signInWithOtp({
                email: email,
                options: {
                    emailRedirectTo: window.location.href
                }
            });

            if (error) {
                showAuthMessage(error.message, 'error');
            } else {
                showAuthMessage('Check your email for the login link!', 'success');
            }
        }

        function showAuthMessage(msg, type) {
            const el = document.getElementById('auth-message');
            el.textContent = msg;
            el.className = 'auth-message ' + type;
        }

        async function signOut() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            updateAuthUI(null);
        }

        function updateAuthUI(user) {
            const loginBtn = document.getElementById('login-btn');
            const userInfo = document.getElementById('user-info');

            if (user) {
                loginBtn.style.display = 'none';
                userInfo.style.display = 'flex';
                document.getElementById('user-email').textContent = user.email;

                document.getElementById('notes-auth-required').style.display = 'none';
                document.getElementById('notes-content').style.display = 'flex';
            } else {
                loginBtn.style.display = 'flex';
                userInfo.style.display = 'none';

                document.getElementById('notes-auth-required').style.display = 'block';
                document.getElementById('notes-content').style.display = 'none';
            }
        }

        // =============================================
        // SUPABASE REAL-TIME
        // =============================================
        async function setupRealtimeListeners() {
            if (!supabase || !currentUser) return;

            updateSyncStatus('syncing');

            // Load initial annotations
            const { data: annData } = await supabase
                .from('annotations')
                .select('*');

            if (annData) {
                annotations = {};
                annData.forEach(a => {
                    if (!annotations[a.reading_id]) annotations[a.reading_id] = [];
                    annotations[a.reading_id].push(a);
                });
                renderAnnotations();
            }

            // Subscribe to annotations changes
            supabase
                .channel('annotations')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'annotations' }, payload => {
                    if (payload.eventType === 'INSERT') {
                        const a = payload.new;
                        if (!annotations[a.reading_id]) annotations[a.reading_id] = [];
                        annotations[a.reading_id].push(a);
                    } else if (payload.eventType === 'DELETE') {
                        const a = payload.old;
                        if (annotations[a.reading_id]) {
                            annotations[a.reading_id] = annotations[a.reading_id].filter(x => x.id !== a.id);
                        }
                    }
                    renderAnnotations();
                })
                .subscribe();

            // Load user's notes
            const { data: notesData } = await supabase
                .from('notes')
                .select('*')
                .eq('user_id', currentUser.id);

            if (notesData) {
                notes = {};
                notesData.forEach(n => { notes[n.id] = n; });
                renderNotes();
            }

            // Subscribe to notes changes
            supabase
                .channel('notes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'notes', filter: `user_id=eq.${currentUser.id}` }, payload => {
                    if (payload.eventType === 'INSERT' || payload.eventType === 'UPDATE') {
                        notes[payload.new.id] = payload.new;
                    } else if (payload.eventType === 'DELETE') {
                        delete notes[payload.old.id];
                    }
                    renderNotes();
                })
                .subscribe();

            // Load posts
            const { data: postsData } = await supabase
                .from('posts')
                .select('*, comments(count)')
                .order('published_at', { ascending: false })
                .limit(50);

            if (postsData) {
                posts = postsData;
                renderFeed();
            }

            // Subscribe to posts changes
            supabase
                .channel('posts')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'posts' }, async () => {
                    const { data } = await supabase
                        .from('posts')
                        .select('*, comments(count)')
                        .order('published_at', { ascending: false })
                        .limit(50);
                    if (data) {
                        posts = data;
                        renderFeed();
                    }
                })
                .subscribe();

            updateSyncStatus('synced');
        }

        function updateSyncStatus(status) {
            const indicator = document.getElementById('sync-indicator');
            indicator.className = 'sync-indicator ' + status;
            const labels = { syncing: 'Syncing...', synced: 'Synced', offline: 'Offline' };
            indicator.querySelector('span').textContent = labels[status] || '';
        }

        // =============================================
        // SCHEDULE UI
        // =============================================
        function buildSchedule() {
            const container = document.getElementById('schedule');
            let html = '';

            schedule.forEach(unit => {
                html += `<div class="unit-header">${unit.unit}</div>`;
                unit.weeks.forEach(week => {
                    html += `
                        <div class="week" data-week="${week.num}">
                            <div class="week-header" onclick="toggleWeek(${week.num})">
                                <span class="week-num">Week ${week.num}</span>
                                <span class="week-title">${week.title}</span>
                            </div>
                            <div class="week-readings">
                                ${week.readings.map(r => `
                                    <div class="reading-item" data-id="${r.id}" data-file="${r.file}" onclick="loadReading('${r.id}', '${r.file}', ${week.num})">
                                        ${r.title} <span class="pages">${r.pages}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;
        }

        function toggleWeek(num) {
            const weekEl = document.querySelector(`.week[data-week="${num}"]`);
            const wasExpanded = weekEl.classList.contains('expanded');

            document.querySelectorAll('.week').forEach(w => w.classList.remove('expanded'));
            document.querySelectorAll('.week-header').forEach(h => h.classList.remove('active'));

            if (!wasExpanded) {
                weekEl.classList.add('expanded');
                weekEl.querySelector('.week-header').classList.add('active');
                showWeekFocus(num);
            }
        }

        function showWeekFocus(num) {
            let week = null;
            schedule.forEach(unit => {
                unit.weeks.forEach(w => {
                    if (w.num === num) week = w;
                });
            });

            if (week) {
                currentWeek = week;
                document.getElementById('focus-question').innerHTML = week.focus;
                document.getElementById('focus-meta').innerHTML = `Week ${week.num} · ${week.date} · ${week.title}`;
            }
        }

        function loadReading(id, file, weekNum) {
            currentReading = id;

            document.querySelectorAll('.reading-item').forEach(r => r.classList.remove('active'));
            document.querySelector(`.reading-item[data-id="${id}"]`).classList.add('active');

            showWeekFocus(weekNum);

            let title = '';
            schedule.forEach(unit => {
                unit.weeks.forEach(week => {
                    week.readings.forEach(r => {
                        if (r.id === id) title = r.title.replace(/<[^>]*>/g, '');
                    });
                });
            });

            document.getElementById('reading-title').textContent = title;
            document.getElementById('viewer').innerHTML = `<iframe src="${file}"></iframe>`;

            renderAnnotations();
        }

        function loadReadingByTitle(title) {
            const lookup = readingLookup[title];
            if (lookup) {
                if (lookup.reading) {
                    loadReading(lookup.reading.id, lookup.reading.file, lookup.week);
                } else if (lookup.readings && lookup.readings.length > 0) {
                    const first = lookup.readings[0];
                    loadReading(first.id, first.file, lookup.week);
                }
                toggleWeek(lookup.week);
            }
        }

        // =============================================
        // ANNOTATIONS
        // =============================================
        function renderAnnotations() {
            const list = document.getElementById('annotations-list');
            const anns = annotations[currentReading] || [];

            document.getElementById('annotation-count').textContent = anns.length;
            document.getElementById('ann-count').textContent = anns.length > 0 ? `(${anns.length})` : '';

            if (anns.length === 0) {
                list.innerHTML = '<div class="empty-state">No annotations yet.<br>Select text in the PDF to annotate.</div>';
                return;
            }

            const sorted = [...anns].sort((a, b) => new Date(b.created_at || b.timestamp) - new Date(a.created_at || a.timestamp));

            list.innerHTML = sorted.map(a => `
                <div class="annotation-card ${a.color || 'yellow'}">
                    <div class="annotation-quote">"${escapeHtml((a.quote || '').substring(0, 80))}${(a.quote || '').length > 80 ? '...' : ''}"</div>
                    ${a.comment ? `<div class="annotation-comment">${escapeHtml(a.comment)}</div>` : ''}
                    <div class="annotation-meta">
                        <span>${a.author_name || a.author || 'Anonymous'}</span>
                        <span>${formatDate(a.created_at || a.timestamp)}</span>
                    </div>
                </div>
            `).join('');
        }

        function startAnnotation() {
            document.getElementById('selection-popup').style.display = 'none';
            document.getElementById('selected-quote').textContent = '"' + selectedText.substring(0, 100) + (selectedText.length > 100 ? '...' : '') + '"';
            document.getElementById('new-annotation').style.display = 'block';
            document.getElementById('annotation-input').focus();

            switchTab('annotations');
        }

        async function saveAnnotation() {
            const comment = document.getElementById('annotation-input').value.trim();

            const annotation = {
                reading_id: currentReading,
                quote: selectedText,
                comment: comment,
                color: selectedColor,
                author_name: currentUser?.email || localStorage.getItem('metamodality_username') || 'Anonymous',
                user_id: currentUser?.id || null,
                created_at: new Date().toISOString()
            };

            if (supabase && currentUser) {
                await supabase.from('annotations').insert(annotation);
            } else {
                // Fallback to localStorage
                if (!annotations[currentReading]) annotations[currentReading] = [];
                annotation.id = Date.now();
                annotations[currentReading].push(annotation);
                localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));
                renderAnnotations();
            }

            cancelAnnotation();
        }

        function cancelAnnotation() {
            document.getElementById('new-annotation').style.display = 'none';
            document.getElementById('annotation-input').value = '';
            selectedText = '';
        }

        // =============================================
        // NOTES
        // =============================================
        function renderNotes() {
            const list = document.getElementById('notes-list');
            const notesList = Object.values(notes);

            notesList.sort((a, b) => new Date(b.updated_at || b.created_at) - new Date(a.updated_at || a.created_at));

            if (notesList.length === 0) {
                list.innerHTML = '<div class="empty-state">No notes yet.<br>Create your first note!</div>';
                return;
            }

            list.innerHTML = notesList.map(note => `
                <div class="note-item ${note.id === currentNoteId ? 'active' : ''}" onclick="openNote('${note.id}')">
                    <div class="note-title">${escapeHtml(note.title || 'Untitled')}</div>
                    <div class="note-preview">${escapeHtml((note.content || '').substring(0, 60))}</div>
                    ${note.linked_readings && note.linked_readings.length > 0 ? `
                        <div class="note-links">
                            ${note.linked_readings.slice(0, 3).map(link => `
                                <span class="note-link" onclick="event.stopPropagation(); loadReadingByTitle('${escapeHtml(link)}')">${escapeHtml(link)}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="note-meta">${formatDate(note.updated_at || note.created_at)}</div>
                </div>
            `).join('');
        }

        function createNewNote() {
            currentNoteId = null;
            document.getElementById('note-title').value = '';
            document.getElementById('note-content').value = '';
            document.getElementById('note-preview').innerHTML = '';
            document.getElementById('delete-note-btn').style.display = 'none';
            document.getElementById('notes-list-view').style.display = 'none';
            document.getElementById('note-editor').classList.add('active');
        }

        function openNote(id) {
            currentNoteId = id;
            const note = notes[id];
            if (!note) return;

            document.getElementById('note-title').value = note.title || '';
            document.getElementById('note-content').value = note.content || '';
            updateNotePreview();
            document.getElementById('delete-note-btn').style.display = 'block';
            document.getElementById('notes-list-view').style.display = 'none';
            document.getElementById('note-editor').classList.add('active');
        }

        function closeNoteEditor() {
            currentNoteId = null;
            document.getElementById('note-editor').classList.remove('active');
            document.getElementById('notes-list-view').style.display = 'block';
        }

        async function saveNote() {
            if (!currentUser) {
                alert('Please sign in to save notes.');
                return;
            }

            const title = document.getElementById('note-title').value.trim() || 'Untitled';
            const content = document.getElementById('note-content').value;
            const linkedReadings = extractWikiLinks(content);

            const noteData = {
                title,
                content,
                linked_readings: linkedReadings,
                user_id: currentUser.id,
                updated_at: new Date().toISOString()
            };

            if (currentNoteId && notes[currentNoteId]) {
                // Update existing
                await supabase.from('notes').update(noteData).eq('id', currentNoteId);
            } else {
                // Insert new
                noteData.created_at = new Date().toISOString();
                const { data } = await supabase.from('notes').insert(noteData).select();
                if (data && data[0]) {
                    currentNoteId = data[0].id;
                }
            }

            document.getElementById('delete-note-btn').style.display = 'block';
        }

        async function deleteNote() {
            if (!currentNoteId || !currentUser) return;

            if (confirm('Delete this note?')) {
                await supabase.from('notes').delete().eq('id', currentNoteId);
                closeNoteEditor();
            }
        }

        async function publishNote() {
            if (!currentUser) {
                alert('Please sign in to publish.');
                return;
            }

            await saveNote();

            const title = document.getElementById('note-title').value.trim() || 'Untitled';
            const content = document.getElementById('note-content').value;
            const linkedReadings = extractWikiLinks(content);

            const post = {
                title,
                content,
                author_id: currentUser.id,
                author_email: currentUser.email,
                linked_readings: linkedReadings,
                published_at: new Date().toISOString(),
                reactions: {}
            };

            await supabase.from('posts').insert(post);
            alert('Published to feed!');
            switchTab('feed');
        }

        function extractWikiLinks(content) {
            const regex = /\[\[([^\]]+)\]\]/g;
            const links = [];
            let match;
            while ((match = regex.exec(content)) !== null) {
                links.push(match[1]);
            }
            return [...new Set(links)];
        }

        function updateNotePreview() {
            const content = document.getElementById('note-content').value;
            const preview = document.getElementById('note-preview');

            let html = escapeHtml(content);
            html = html.replace(/\[\[([^\]]+)\]\]/g, (match, title) => {
                return `<span class="wiki-link" onclick="loadReadingByTitle('${escapeHtml(title)}')">${escapeHtml(title)}</span>`;
            });

            preview.innerHTML = html;
        }

        document.getElementById('note-content').addEventListener('input', updateNotePreview);

        // =============================================
        // FEED
        // =============================================
        function renderFeed() {
            const list = document.getElementById('feed-list');

            if (posts.length === 0) {
                list.innerHTML = '<div class="empty-state">No posts yet.<br>Be the first to share your thoughts!</div>';
                return;
            }

            list.innerHTML = posts.map(post => `
                <div class="post-card" data-id="${post.id}">
                    <div class="post-header">
                        <div class="post-author-info">
                            <div class="post-author">${escapeHtml(post.author_email || 'Anonymous')}</div>
                            <div class="post-date">${formatDate(post.published_at)}</div>
                        </div>
                    </div>
                    <div class="post-title">${escapeHtml(post.title)}</div>
                    <div class="post-content">${renderPostContent(post.content)}</div>
                    ${post.linked_readings && post.linked_readings.length > 0 ? `
                        <div class="post-readings">
                            ${post.linked_readings.map(link => `
                                <span class="post-reading-tag" onclick="loadReadingByTitle('${escapeHtml(link)}')">${escapeHtml(link)}</span>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="post-actions">
                        ${renderReactions(post)}
                        <button class="comment-btn" onclick="toggleComments('${post.id}')">
                            Comments ${post.comments?.[0]?.count ? `(${post.comments[0].count})` : ''}
                        </button>
                    </div>
                    <div class="post-comments" id="comments-${post.id}" style="display:none;">
                        <div class="comments-list" id="comments-list-${post.id}"></div>
                        ${currentUser ? `
                            <div class="comment-input">
                                <input type="text" placeholder="Add a comment..." id="comment-input-${post.id}" onkeypress="if(event.key==='Enter')addComment('${post.id}')">
                                <button onclick="addComment('${post.id}')">Post</button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function renderPostContent(content) {
            if (!content) return '';
            let html = escapeHtml(content);
            html = html.replace(/\[\[([^\]]+)\]\]/g, (match, title) => {
                return `<span class="wiki-link" onclick="loadReadingByTitle('${escapeHtml(title)}')">${escapeHtml(title)}</span>`;
            });
            if (html.length > 300) html = html.substring(0, 300) + '...';
            return html;
        }

        function renderReactions(post) {
            const types = ['like', 'insightful', 'question'];
            const symbols = { like: '\u2764', insightful: '\u{1F4A1}', question: '?' };

            return types.map(type => {
                const users = post.reactions?.[type] || [];
                const count = users.length;
                const isActive = currentUser && users.includes(currentUser.id);
                return `
                    <button class="reaction-btn ${isActive ? 'active' : ''}" onclick="toggleReaction('${post.id}', '${type}')">
                        <span>${symbols[type]}</span>
                        ${count > 0 ? `<span class="reaction-count">${count}</span>` : ''}
                    </button>
                `;
            }).join('');
        }

        async function toggleReaction(postId, type) {
            if (!currentUser) {
                alert('Please sign in to react.');
                return;
            }

            const post = posts.find(p => p.id === postId);
            if (!post) return;

            const reactions = { ...post.reactions } || {};
            const users = reactions[type] || [];
            const idx = users.indexOf(currentUser.id);

            if (idx === -1) {
                users.push(currentUser.id);
            } else {
                users.splice(idx, 1);
            }
            reactions[type] = users;

            await supabase.from('posts').update({ reactions }).eq('id', postId);
        }

        async function toggleComments(postId) {
            const el = document.getElementById(`comments-${postId}`);
            const isVisible = el.style.display !== 'none';
            el.style.display = isVisible ? 'none' : 'block';

            if (!isVisible) {
                loadComments(postId);
            }
        }

        async function loadComments(postId) {
            if (!supabase) return;

            const { data } = await supabase
                .from('comments')
                .select('*')
                .eq('post_id', postId)
                .order('created_at');

            const list = document.getElementById(`comments-list-${postId}`);
            if (!data || data.length === 0) {
                list.innerHTML = '<div class="empty-state" style="padding:0.5rem;">No comments yet.</div>';
            } else {
                list.innerHTML = data.map(c => `
                    <div class="comment-item">
                        <div class="comment-content">
                            <div class="comment-author">${escapeHtml(c.author_email || 'Anonymous')}</div>
                            <div class="comment-text">${escapeHtml(c.content)}</div>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function addComment(postId) {
            if (!currentUser) return;

            const input = document.getElementById(`comment-input-${postId}`);
            const content = input.value.trim();
            if (!content) return;

            await supabase.from('comments').insert({
                post_id: postId,
                content,
                author_id: currentUser.id,
                author_email: currentUser.email,
                created_at: new Date().toISOString()
            });

            input.value = '';
            loadComments(postId);
        }

        // =============================================
        // UTILITIES
        // =============================================
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '';
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;

            if (diff < 60000) return 'Just now';
            if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
            if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
            if (diff < 604800000) return Math.floor(diff / 86400000) + 'd ago';

            return date.toLocaleDateString();
        }

        function togglePanel() {
            const panel = document.getElementById('context-panel');
            panel.style.display = panel.style.display === 'none' ? 'flex' : 'none';
        }

        function exportAnnotations() {
            const data = JSON.stringify(annotations, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'annotations.json';
            a.click();
        }

        function switchTab(tabName) {
            document.querySelectorAll('.context-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // Tab switching
        document.querySelectorAll('.context-tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        // Color picker
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.addEventListener('click', () => {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                dot.classList.add('selected');
                selectedColor = dot.dataset.color;
            });
        });

        // Text selection in viewer
        document.getElementById('viewer').addEventListener('mouseup', e => {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (text.length > 10 && currentReading) {
                selectedText = text;
                const popup = document.getElementById('selection-popup');
                popup.style.left = e.pageX + 'px';
                popup.style.top = (e.pageY + 10) + 'px';
                popup.style.display = 'block';
            }
        });

        document.addEventListener('mousedown', e => {
            if (!e.target.closest('.selection-popup')) {
                document.getElementById('selection-popup').style.display = 'none';
            }
        });

        // Mobile panel toggle
        document.querySelector('.context-tabs').addEventListener('click', () => {
            if (window.innerWidth <= 768) {
                document.getElementById('context-panel').classList.toggle('expanded');
            }
        });

        // =============================================
        // INITIALIZATION
        // =============================================
        buildSchedule();

        // Check for auth callback (magic link redirect)
        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                if (session?.user) {
                    currentUser = session.user;
                    updateAuthUI(currentUser);
                    hideAuthModal();
                    setupRealtimeListeners();
                } else {
                    currentUser = null;
                    updateAuthUI(null);
                    // Fallback to localStorage
                    annotations = JSON.parse(localStorage.getItem('metamodality_annotations') || '{}');
                    renderAnnotations();
                }
            });

            // Initial session check
            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session?.user) {
                    currentUser = session.user;
                    updateAuthUI(currentUser);
                    setupRealtimeListeners();
                }
            });
        } else {
            annotations = JSON.parse(localStorage.getItem('metamodality_annotations') || '{}');
            updateSyncStatus('offline');
        }
    </script>
</body>
</html>
