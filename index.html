<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metamodality â€” Reading Group</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">

    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #f5f4f0;
            --bg-sidebar: #eae8e4;
            --bg-panel: #ffffff;
            --bg-editor: #fffcf8;
            --border: #e0ddd5;
            --text: #3d3929;
            --text-muted: #8b8579;
            --text-bright: #1a1815;
            --accent: #da7756;
            --accent-hover: #c4684a;
            --highlight: #f0ebe3;
            --success: #5a9a6e;
            --warning: #b8860b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        header {
            height: 50px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            cursor: pointer;
        }

        nav {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }

        .nav-tab {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .nav-tab:hover { background: var(--highlight); color: var(--text); }
        .nav-tab.active { background: var(--accent); color: white; }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .status-dot.connected { background: var(--success); }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn.secondary {
            background: var(--bg-dark);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn.secondary:hover { background: var(--highlight); }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== MAIN CONTENT ========== */
        main {
            flex: 1;
            overflow: hidden;
            display: flex;
        }

        .view {
            display: none;
            height: 100%;
            overflow: auto;
            flex: 1;
        }
        .view.active { display: block; }

        /* ========== SPLIT VIEW ========== */
        .split-container {
            display: none;
            flex: 1;
            height: 100%;
        }
        .split-container.active {
            display: flex;
        }
        .split-container.horizontal {
            flex-direction: row;
        }
        .split-container.vertical {
            flex-direction: column;
        }
        .split-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-dark);
            padding: 12px;
            min-width: 0;
        }
        .split-pane:first-child {
            padding-right: 6px;
        }
        .split-pane:last-child {
            padding-left: 6px;
        }
        .split-container.vertical .split-pane:first-child {
            padding-right: 12px;
            padding-bottom: 6px;
        }
        .split-container.vertical .split-pane:last-child {
            padding-left: 12px;
            padding-top: 6px;
        }
        .split-pane-module {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            min-width: 0;
        }
        .split-pane-header {
            padding: 10px 16px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .split-pane-select {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-panel);
            font-size: 12px;
            cursor: pointer;
        }
        .split-pane-close {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-muted);
            padding: 2px 6px;
        }
        .split-pane-close:hover {
            color: var(--text);
        }
        .split-pane-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            min-height: 0;
        }
        .split-divider {
            width: 12px;
            background: transparent;
            cursor: col-resize;
            flex-shrink: 0;
        }
        .split-divider:hover {
            background: rgba(139,90,43,0.1);
        }
        .split-container.vertical .split-divider {
            width: auto;
            height: 12px;
            cursor: row-resize;
        }

        /* Split PDF Viewer */
        .split-pdf-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .split-readings-sidebar {
            width: 180px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            background: var(--bg-sidebar);
            flex-shrink: 0;
        }
        .split-readings-header {
            padding: 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }
        .split-reading-item {
            padding: 10px 12px;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }
        .split-reading-item:hover {
            background: var(--highlight);
        }
        .split-reading-item.active {
            background: rgba(139,90,43,0.1);
            border-left: 3px solid var(--accent);
        }
        .split-week-header {
            padding: 8px 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--accent);
            background: var(--bg-dark);
        }
        .split-pdf-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        .split-pdf-toolbar {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            background: var(--bg-panel);
        }
        .split-pdf-toolbar .pdf-title {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-bright);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .split-pdf-toolbar .zoom-btn {
            padding: 4px 8px;
            font-size: 12px;
        }
        .split-pdf-viewer {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .split-page-wrapper {
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            background: white;
        }
        .split-page-wrapper canvas {
            display: block;
        }
        .split-page-wrapper .textLayer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            line-height: 1.0;
        }
        .split-annotations-panel {
            width: 280px;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-panel);
            flex-shrink: 0;
        }
        .split-annotations-header {
            padding: 12px;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            color: var(--text-bright);
        }
        .split-annotations-list {
            flex: 1;
            overflow-y: auto;
        }
        .split-btn {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .split-btn:hover {
            background: var(--highlight);
            color: var(--text);
        }
        .split-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* ========== HOME VIEW ========== */
        .home-view {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 40px;
        }

        .home-hero {
            margin-bottom: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(139,90,43,0.08) 0%, rgba(101,67,33,0.04) 100%);
            border-radius: 16px;
            border: 1px solid rgba(139,90,43,0.15);
        }
        .home-hero h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 36px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 8px;
            letter-spacing: -0.01em;
            text-align: center;
        }
        .home-hero .subtitle {
            font-size: 16px;
            color: var(--text-muted);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            margin-bottom: 24px;
            text-align: center;
        }
        .home-hero .epigraph {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 16px;
            line-height: 1.35;
            color: var(--text);
            max-width: 640px;
            margin: 0 0 12px;
            text-align: left;
        }
        .home-hero .epigraph-source {
            font-size: 13px;
            color: var(--text-muted);
            text-align: left;
        }
        .home-intro {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
            max-width: 800px;
            margin: 24px 0 0;
            padding-top: 20px;
            border-top: 1px solid rgba(139,90,43,0.15);
            text-align: left;
        }

        .current-week {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .current-week-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 8px;
        }
        .current-week h2 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .current-week .focus {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            margin-bottom: 20px;
        }
        .current-week-readings {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .reading-card {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .reading-card:hover { background: var(--highlight); transform: translateX(4px); }
        .reading-card .icon { font-size: 18px; margin-right: 12px; }
        .reading-card .info { flex: 1; }
        .reading-card .title { font-size: 14px; color: var(--text-bright); }
        .reading-card .pages { font-size: 12px; color: var(--text-muted); }
        .reading-card .arrow { color: var(--text-muted); }

        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 700px) {
            .home-grid { grid-template-columns: 1fr; }
        }

        .home-section {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .home-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            padding: 16px 20px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
        }
        .home-section h3 .icon { font-size: 16px; }
        .home-section > div {
            max-height: 280px;
            overflow-y: auto;
            padding: 0;
        }

        .activity-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-item .author { color: var(--accent); font-weight: 500; }
        .activity-item .action { color: var(--text-muted); }
        .activity-item .target { color: var(--text); }
        .activity-item .time { font-size: 11px; color: var(--text-muted); display: block; margin-top: 4px; }

        .empty-state {
            text-align: left;
            padding: 20px;
            color: var(--text-muted);
            font-size: 13px;
            font-style: italic;
        }

        /* Home Layout - Three columns: Schedule | Main | Sidebar */
        .home-layout {
            display: grid;
            grid-template-columns: 260px 1fr 320px;
            gap: 24px;
            margin-top: 30px;
        }
        @media (max-width: 1200px) {
            .home-layout { grid-template-columns: 240px 1fr; }
            .home-sidebar { display: none; }
        }
        @media (max-width: 900px) {
            .home-layout { grid-template-columns: 1fr; }
            .course-stream-sidebar { display: none; }
        }

        .course-stream-sidebar {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .course-stream-card {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 100%;
        }
        .course-stream-header {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .course-stream-body {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }
        .course-week-item {
            padding: 10px 18px;
            cursor: pointer;
            transition: background 0.15s;
            border-left: 3px solid transparent;
        }
        .course-week-item:hover {
            background: var(--highlight);
        }
        .course-week-item.current {
            background: rgba(139,90,43,0.08);
            border-left-color: var(--accent);
        }
        .course-week-item .week-num {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .course-week-item .week-title {
            font-size: 13px;
            color: var(--text-bright);
            line-height: 1.3;
        }
        .course-week-item .week-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .course-unit-header {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            padding: 12px 18px 6px;
            font-weight: 600;
            background: var(--bg-dark);
        }

        .home-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
            min-width: 0;
        }

        .home-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .home-sidebar .activity-card {
            flex-shrink: 0;
        }

        .activity-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .activity-card {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .activity-card-header {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .activity-card-header .icon { font-size: 14px; }
        .activity-card-header .toggle-icon {
            margin-left: auto;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .activity-card-header .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        .activity-card-body {
            max-height: 280px;
            overflow-y: auto;
        }
        .activity-card-body.collapsed {
            display: none;
        }

        /* Orientation card */
        .orientation-card .activity-card-body {
            max-height: none;
            padding: 0;
        }
        .orientation-section {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
        }
        .orientation-section:last-child {
            border-bottom: none;
        }
        .orientation-section h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 6px;
        }
        .orientation-section p {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text);
            margin: 0;
        }
        .orientation-section code {
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--accent);
        }
        .orientation-section ul {
            margin: 0;
            padding-left: 18px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text);
        }
        .orientation-section li {
            margin-bottom: 4px;
        }
        .orientation-section kbd {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 1px 5px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-muted);
        }

        .stream-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: background 0.15s;
            cursor: pointer;
        }
        .stream-item:last-child { border-bottom: none; }
        .stream-item:hover { background: var(--highlight); }
        .stream-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .stream-avatar.system { background: var(--text-muted); font-size: 14px; }
        .stream-content { flex: 1; min-width: 0; }
        .stream-text {
            font-size: 13px;
            color: var(--text);
            line-height: 1.4;
        }
        .stream-text .author { color: var(--accent); font-weight: 500; }
        .stream-text .target { color: var(--text-bright); font-weight: 500; }
        .stream-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .upcoming-item {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .upcoming-item:last-child { border-bottom: none; }
        .upcoming-item:hover { background: var(--highlight); }
        .upcoming-date {
            width: 44px;
            height: 44px;
            background: var(--bg-dark);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .upcoming-date .month {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            font-weight: 600;
        }
        .upcoming-date .day {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            line-height: 1;
        }
        .upcoming-info { flex: 1; }
        .upcoming-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 2px;
        }
        .upcoming-detail {
            font-size: 11px;
            color: var(--text-muted);
        }
        .upcoming-item.current .upcoming-date {
            background: var(--accent);
        }
        .upcoming-item.current .upcoming-date .month,
        .upcoming-item.current .upcoming-date .day { color: white; }

        /* ========== SYLLABUS VIEW ========== */
        .syllabus-view {
            max-width: 850px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .syllabus-view h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 28px;
            font-weight: normal;
            margin-bottom: 30px;
            color: var(--text-bright);
        }

        .unit {
            margin-bottom: 40px;
        }
        .unit-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--accent);
        }
        .unit-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .unit-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 20px;
            color: var(--text-bright);
            font-weight: normal;
        }

        .week-card {
            background: var(--bg-panel);
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            overflow: hidden;
            border-left: 3px solid transparent;
            transition: all 0.15s;
        }
        .week-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .week-card.current { border-left-color: var(--accent); background: rgba(218, 119, 86, 0.03); }
        .week-card.completed { border-left-color: var(--success); }
        .week-card-main {
            padding: 20px;
            cursor: pointer;
        }
        .week-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .week-card .week-num {
            font-size: 11px;
            font-weight: 600;
            color: white;
            background: var(--text-muted);
            padding: 3px 8px;
            border-radius: 4px;
            min-width: 55px;
            text-align: center;
        }
        .week-card.current .week-num { background: var(--accent); }
        .week-card.completed .week-num { background: var(--success); }
        .week-card .week-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 18px;
            color: var(--text-bright);
            flex: 1;
        }
        .week-card .week-date {
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-card .week-status {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            background: var(--bg-dark);
            color: var(--text-muted);
        }
        .week-card.current .week-status { background: rgba(218, 119, 86, 0.15); color: var(--accent); }
        .week-card .week-focus {
            font-size: 13px;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        .week-card .week-summary {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-card .expand-icon {
            margin-left: auto;
            transition: transform 0.2s;
            color: var(--text-muted);
        }
        .week-card.expanded .expand-icon { transform: rotate(180deg); }

        .week-readings-list {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid var(--border);
            margin-top: 0;
        }
        .week-card.expanded .week-readings-list { display: block; }
        .week-reading-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
        }
        .week-reading-item:last-child { border-bottom: none; }
        .week-reading-item:hover { padding-left: 8px; }
        .week-reading-item .reading-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-dark);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
        }
        .week-reading-item .reading-info { flex: 1; }
        .week-reading-item .reading-title {
            font-size: 14px;
            color: var(--text-bright);
            margin-bottom: 2px;
        }
        .week-reading-item .reading-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-reading-item .reading-progress {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: transparent;
        }
        .week-reading-item .reading-progress.started { border-color: var(--warning); background: rgba(184, 134, 11, 0.1); }
        .week-reading-item .reading-progress.complete { border-color: var(--success); background: var(--success); color: white; }

        /* ========== READ VIEW ========== */
        .read-view {
            display: none;
            height: 100%;
            width: 100%;
            flex-direction: row;
            overflow: hidden;
        }
        .read-view.active { display: flex; }

        .read-sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s ease;
        }
        .read-sidebar.collapsed {
            width: 50px;
            overflow: hidden;
        }
        .read-sidebar.collapsed .read-sidebar-content,
        .read-sidebar.collapsed .read-sidebar-header span {
            display: none;
        }
        .read-sidebar.collapsed .sidebar-toggle-btn {
            transform: rotate(180deg);
        }
        .sidebar-toggle-btn {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .sidebar-toggle-btn:hover {
            background: var(--highlight);
            color: var(--text);
        }
        .read-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .read-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .sidebar-unit {
            border-bottom: 1px solid var(--border);
        }
        .sidebar-unit-header {
            padding: 10px 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-unit-header:hover { background: var(--highlight); }
        .sidebar-unit-header .collapse-icon {
            transition: transform 0.2s;
        }
        .sidebar-unit.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        .sidebar-unit.collapsed .sidebar-unit-weeks {
            display: none;
        }
        .sidebar-week {
            border-top: 1px solid var(--border);
        }
        .sidebar-week-header {
            padding: 8px 15px 8px 25px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-bright);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sidebar-week-header:hover { background: var(--highlight); }
        .sidebar-week.collapsed .sidebar-week-readings {
            display: none;
        }
        .sidebar-week.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .reading-list-item {
            padding: 8px 15px 8px 40px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s;
            font-size: 12px;
            color: var(--text);
        }
        .reading-list-item:hover { background: var(--highlight); }
        .reading-list-item.active {
            background: var(--highlight);
            border-left-color: var(--accent);
            color: var(--text-bright);
        }

        .pdf-container {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            min-width: 0;
            overflow: hidden;
            padding: 12px;
        }
        .pdf-module {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            min-width: 0;
        }
        .pdf-header {
            padding: 10px 15px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .pdf-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }
        .pdf-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pdf-controls button {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .pdf-controls button:hover { background: var(--highlight); }
        .pdf-controls span { font-size: 12px; color: var(--text-muted); }
        .fullscreen-btn { margin-left: 8px; }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 2px;
        }
        .zoom-controls button {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text);
        }
        .zoom-controls button:hover {
            background: var(--highlight);
        }
        .zoom-controls #zoomLevel {
            min-width: 50px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }

        .ocr-btn { position: relative; }
        .ocr-btn.loading { opacity: 0.7; pointer-events: none; }
        .ocr-btn .spinner {
            display: none;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 4px;
        }
        .ocr-btn.loading .spinner { display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .ocr-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(90, 154, 110, 0.15);
            color: var(--success);
        }
        .ocr-status.warning {
            background: rgba(184, 134, 11, 0.15);
            color: var(--warning);
        }

        /* Fullscreen mode */
        .read-view.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            background: var(--bg-dark);
            padding: 12px;
            gap: 12px;
        }
        .read-view.fullscreen .read-sidebar { display: none; }
        .read-view.fullscreen .pdf-container {
            flex: 1;
            padding: 0;
            min-width: 0;
        }
        .read-view.fullscreen .pdf-module {
            border-radius: 12px;
        }
        .read-view.fullscreen .pdf-viewer {
            align-items: center;
            padding: 20px;
        }
        .read-view.fullscreen .annotations-container {
            padding: 0;
            background: transparent;
        }
        .read-view.fullscreen .annotations-panel {
            width: 380px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .read-view.fullscreen .annotations-panel.collapsed {
            width: 50px;
        }

        .pdf-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 10px;
            background: #e8e4dc;
            width: 100%;
            min-width: 0; /* Allow flex item to shrink below content size */
        }
        .pdf-viewer canvas {
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: block;
        }
        .pdf-page-container {
            position: relative;
            flex-shrink: 0;
        }
        /* Text layer - uses PDF.js textLayer class with pdf_viewer.css */
        .pdf-page-container .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            line-height: 1;
            z-index: 2;
        }
        /* Custom selection color */
        .textLayer ::selection {
            background: rgba(218, 119, 86, 0.4);
        }
        .textLayer ::-moz-selection {
            background: rgba(218, 119, 86, 0.4);
        }
        /* Column selection mode - dim opposite column */
        .textLayer.column-mode-left span[data-column="right"] {
            opacity: 0.3;
            pointer-events: none;
            user-select: none;
        }
        .textLayer.column-mode-right span[data-column="left"] {
            opacity: 0.3;
            pointer-events: none;
            user-select: none;
        }

        .column-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px;
        }
        .column-toggle button {
            padding: 4px 8px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 11px;
            border-radius: 3px;
            color: var(--text-muted);
        }
        .column-toggle button:hover {
            background: var(--highlight);
        }
        .column-toggle button.active {
            background: var(--accent);
            color: white;
        }
        .pdf-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            gap: 15px;
        }
        .pdf-empty-icon { font-size: 48px; opacity: 0.5; }

        .annotations-container {
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            padding: 12px;
            padding-left: 0;
            flex-shrink: 0;
        }
        .annotations-panel {
            width: 380px;
            background: var(--bg-panel);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .annotations-panel.collapsed {
            width: 50px;
        }
        .annotations-panel.collapsed .annotations-list,
        .annotations-panel.collapsed .annotation-form,
        .annotations-panel.collapsed .annotations-header h3,
        .annotations-panel.collapsed #annotationsCount,
        .annotations-panel.collapsed .add-note-btn {
            display: none;
        }
        .annotations-panel.collapsed .sidebar-toggle-btn {
            transform: rotate(180deg);
        }
        .annotations-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .annotations-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-bright);
            flex: 1;
            margin: 0;
        }
        #annotationsCount {
            font-size: 12px;
            color: var(--text-muted);
        }
        .add-note-btn {
            font-size: 11px;
            padding: 4px 8px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .add-note-btn:hover {
            background: var(--accent-hover);
        }
        .annotations-list {
            flex: 1;
            overflow-y: auto;
        }
        .annotation-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .annotation-quote {
            font-size: 13px;
            font-style: italic;
            color: var(--text);
            margin-bottom: 8px;
            padding-left: 12px;
            border-left: 3px solid var(--accent);
            line-height: 1.5;
        }
        .annotation-comment {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }
        .annotation-meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        .annotations-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .annotation-form {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            display: none;
        }
        .annotation-form.active { display: block; }
        .annotation-form .quote-preview {
            font-size: 12px;
            font-style: italic;
            color: var(--text-muted);
            padding: 10px;
            background: var(--bg-panel);
            border-radius: 6px;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }
        .annotation-form .quote-preview:empty {
            display: none;
        }
        .annotation-form .quote-preview.pinned-note {
            display: block;
            font-style: normal;
            color: var(--accent);
            background: rgba(139,90,43,0.1);
        }
        /* Pinned annotation display */
        .annotation-item.pinned .annotation-quote {
            border-left-color: var(--text-muted);
            font-style: normal;
            color: var(--text-muted);
            font-size: 11px;
        }
        .annotation-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            resize: none;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .annotation-form textarea:focus { outline: none; border-color: var(--accent); }

        /* RTF Editor */
        .rtf-toolbar {
            display: flex;
            gap: 2px;
            padding: 4px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
        }
        .rtf-toolbar button {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
        }
        .rtf-toolbar button:hover {
            background: var(--highlight);
        }
        .rtf-toolbar button.active {
            background: var(--accent);
            color: white;
        }
        .rtf-editor {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 0 0 6px 6px;
            font-size: 13px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            background: var(--bg-panel);
            line-height: 1.5;
        }
        .rtf-editor:focus {
            outline: none;
            border-color: var(--accent);
        }
        .rtf-editor:empty:before {
            content: attr(data-placeholder);
            color: var(--text-muted);
        }

        /* Annotation replies */
        .annotation-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        .annotation-actions button {
            font-size: 11px;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        .annotation-actions button:hover {
            color: var(--accent);
        }
        .annotation-replies {
            margin-top: 12px;
            padding-left: 15px;
            border-left: 2px solid var(--border);
        }
        .annotation-reply {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .annotation-reply:last-child {
            border-bottom: none;
        }
        .reply-form {
            margin-top: 10px;
            display: none;
        }
        .reply-form.active {
            display: block;
        }
        .reply-form .rtf-editor {
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* ========== DISCUSS VIEW ========== */
        .discuss-view {
            max-width: 700px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .discuss-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .discuss-header h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
        }

        .post-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }
        .post-author { font-size: 14px; font-weight: 500; color: var(--text-bright); }
        .post-date { font-size: 12px; color: var(--text-muted); }
        .post-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 20px;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .post-content {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text);
        }
        .post-content p { margin-bottom: 12px; }
        .post-links {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .post-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 20px;
        }
        .post-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .post-action:hover { color: var(--accent); }

        /* ========== WRITE VIEW ========== */
        .write-view {
            display: none;
            height: 100%;
            flex-direction: row;
        }
        .write-view.active { display: flex; }

        .notes-sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .notes-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notes-sidebar-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
        }
        .notes-list {
            flex: 1;
            overflow-y: auto;
        }
        .note-list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .note-list-item:hover { background: var(--highlight); }
        .note-list-item.active { background: var(--highlight); border-left: 3px solid var(--accent); }
        .note-list-item .note-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 4px;
        }
        .note-list-item .note-preview {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .note-list-item .note-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-editor);
        }
        .editor-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
        }
        .editor-title-input {
            font-size: 20px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--text-bright);
            flex: 1;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .editor-title-input:focus { outline: none; }
        .editor-title-input::placeholder { color: var(--text-muted); }

        .editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .editor-textarea {
            flex: 1;
            padding: 25px;
            border: none;
            font-size: 15px;
            line-height: 1.8;
            resize: none;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: var(--bg-editor);
            color: var(--text);
        }
        .editor-textarea:focus { outline: none; }
        .editor-textarea::placeholder { color: var(--text-muted); }

        .editor-footer {
            padding: 12px 25px;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-links {
            font-size: 12px;
            color: var(--text-muted);
        }
        .editor-link {
            display: inline-block;
            background: var(--bg-dark);
            padding: 3px 10px;
            border-radius: 12px;
            margin-right: 6px;
            cursor: pointer;
        }
        .editor-link:hover { background: var(--highlight); }

        .editor-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 15px;
        }
        .editor-empty-icon { font-size: 48px; opacity: 0.5; }

        /* ========== SELECTION POPUP ========== */
        .selection-popup {
            display: none;
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
        }
        .selection-popup button {
            padding: 10px 18px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 13px;
            cursor: pointer;
        }
        .selection-popup button:hover { background: var(--accent-hover); }

        /* ========== AUTH MODAL ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-panel);
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            padding: 30px;
        }
        .modal h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-bright);
        }
        .modal p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        .modal input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .modal input:focus { outline: none; border-color: var(--accent); }
        .modal .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal .message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        .modal .message.success { background: #d1fae5; color: #065f46; }
        .modal .message.error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo" onclick="switchView('home')">Metamodality</div>
        <nav>
            <button class="nav-tab active" data-view="home">Home</button>
            <button class="nav-tab" data-view="syllabus">Syllabus</button>
            <button class="nav-tab" data-view="read">Read</button>
            <button class="nav-tab" data-view="discuss">Discuss</button>
            <button class="nav-tab" data-view="write">Write</button>
        </nav>
        <div class="header-right">
            <button class="split-btn" id="splitBtn" onclick="toggleSplitView()" title="Split view (âŒ˜/)">
                <span>â«¿</span> Split
            </button>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- HOME VIEW -->
        <div class="view active" id="view-home">
            <div class="home-view">
                <div class="home-hero">
                    <h1>An Inquiry into Forms of the Possible</h1>
                    <p class="subtitle">Center for Possible Minds â€” Spring 2026</p>
                    <div class="epigraph">
                        What is it that it would not be right to say?<br>
                        That which is to be thought and spoken of must be.<br>
                        For it is there for being,<br>
                        but nothing is not.
                    </div>
                    <p class="epigraph-source">â€” Parmenides, Fr. 6.1â€“2 (Kingsley trans.)</p>
                    <p class="home-intro">
                        From Parmenides through contemporary set theory, thinkers have asked what it means for something to be possible. This reading group traces possibility across traditionsâ€”Greek, Islamic, Buddhist, phenomenological, pragmatistâ€”asking how each configures the space between what is and what might be.
                    </p>
                </div>

                <div class="home-layout">
                    <!-- Course Stream Sidebar -->
                    <div class="course-stream-sidebar">
                        <div class="course-stream-card">
                            <div class="course-stream-header">
                                <span class="icon">ðŸ“š</span> Course Schedule
                            </div>
                            <div class="course-stream-body" id="courseStream">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Center: Current Week + Discussion -->
                    <div class="home-main">
                        <!-- Current Week (Featured) -->
                        <div class="current-week" id="currentWeekCard">
                            <!-- Populated by JS -->
                        </div>

                        <!-- Recent Discussion -->
                        <div class="home-section">
                            <h3><span class="icon">ðŸ’¬</span> Recent Discussion</h3>
                            <div id="recentPosts">
                                <div class="empty-state">No posts yet. Be the first to share your thoughts.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar: Getting Started + Activity -->
                    <div class="home-sidebar">
                        <!-- Getting Started -->
                        <div class="activity-card orientation-card">
                            <div class="activity-card-header" onclick="toggleOrientation()" style="cursor: pointer;">
                                <span class="icon">ðŸ§­</span> Getting Started
                                <span class="toggle-icon" id="orientationToggle">â–¼</span>
                            </div>
                            <div class="activity-card-body" id="orientationBody">
                                <div class="orientation-section">
                                    <h4>Read</h4>
                                    <p>Browse readings by week. Select text to annotate.</p>
                                </div>
                                <div class="orientation-section">
                                    <h4>Notes</h4>
                                    <p>Write private notes. Use <code>[[Week 1]]</code> to link readings.</p>
                                </div>
                                <div class="orientation-section">
                                    <h4>Discuss</h4>
                                    <p>Post essays and respond to others.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="activity-card">
                            <div class="activity-card-header">
                                <span class="icon">âš¡</span> Recent Activity
                            </div>
                            <div class="activity-card-body" id="activityStream">
                                <div class="empty-state">Activity from the group will appear here.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SYLLABUS VIEW -->
        <div class="view" id="view-syllabus">
            <div class="syllabus-view">
                <h1>Schedule of Readings</h1>
                <div id="syllabusContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- READ VIEW -->
        <div class="view read-view" id="view-read">
            <div class="read-sidebar" id="readSidebar">
                <div class="read-sidebar-header">
                    <span>Readings</span>
                    <button class="sidebar-toggle-btn" onclick="toggleReadSidebar()" title="Toggle sidebar (âŒ˜[)">â—€</button>
                </div>
                <div class="read-sidebar-content" id="readingsList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="pdf-container">
                <div class="pdf-module">
                    <div class="pdf-header">
                        <div class="pdf-title" id="pdfTitle">Select a reading</div>
                        <div class="pdf-controls" id="pdfControls" style="display: none;">
                            <span><span id="totalPages">0</span> pages</span>
                            <div class="zoom-controls">
                                <button onclick="zoomOut()" title="Zoom out">âˆ’</button>
                                <span id="zoomLevel">100%</span>
                                <button onclick="zoomIn()" title="Zoom in">+</button>
                                <button onclick="fitWidth()" title="Reset">â†”</button>
                            </div>
                            <div class="column-toggle" id="columnToggle" style="display: none;">
                                <button onclick="setColumnMode('all')" class="active" data-mode="all">All</button>
                                <button onclick="setColumnMode('left')" data-mode="left">Left</button>
                                <button onclick="setColumnMode('right')" data-mode="right">Right</button>
                            </div>
                            <span class="ocr-status" id="ocrStatus" style="display: none;"></span>
                            <button class="ocr-btn" id="ocrBtn" onclick="runOcrOnCurrentPage()" style="display: none;">
                                <span class="spinner"></span>OCR
                            </button>
                            <button class="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>
                        </div>
                    </div>
                    <div class="pdf-viewer" id="pdfViewer">
                        <div class="pdf-empty">
                            <div class="pdf-empty-icon">ðŸ“–</div>
                            <div>Select a reading from the sidebar</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="annotations-container">
                <div class="annotations-panel" id="annotationsPanel">
                    <div class="annotations-header">
                        <button class="sidebar-toggle-btn" onclick="toggleAnnotationsPanel()" title="Toggle annotations (âŒ˜])">â–¶</button>
                        <h3>Annotations</h3>
                        <span id="annotationsCount"></span>
                        <button class="add-note-btn" onclick="startPinnedNote()" title="Add a note without highlighting">+ Note</button>
                    </div>
                <div class="annotations-list" id="annotationsList">
                    <div class="annotations-empty">
                        Select text to annotate, or click "+ Note" to add a pinned note.
                    </div>
                </div>
                <div class="annotation-form" id="annotationForm">
                    <div class="quote-preview" id="quotePreview"></div>
                    <div class="rtf-toolbar">
                        <button onclick="rtfCommand('bold')" title="Bold (âŒ˜B)"><b>B</b></button>
                        <button onclick="rtfCommand('italic')" title="Italic (âŒ˜I)"><i>I</i></button>
                        <button onclick="rtfCommand('underline')" title="Underline (âŒ˜U)"><u>U</u></button>
                        <button onclick="rtfCommand('strikeThrough')" title="Strikethrough"><s>S</s></button>
                        <button onclick="rtfCommand('insertUnorderedList')" title="Bullet list">â€¢</button>
                        <button onclick="rtfCommand('insertOrderedList')" title="Numbered list">1.</button>
                    </div>
                    <div class="rtf-editor" id="annotationComment" contenteditable="true" data-placeholder="Add your thoughts..."></div>
                    <div class="form-actions">
                        <button class="btn secondary" onclick="cancelAnnotation()">Cancel</button>
                        <button class="btn" onclick="saveAnnotation()">Save</button>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- DISCUSS VIEW -->
        <div class="view" id="view-discuss">
            <div class="discuss-view">
                <div class="discuss-header">
                    <h1>Discussion</h1>
                    <button class="btn" onclick="switchView('write')">+ New Post</button>
                </div>
                <div id="postsContainer">
                    <div class="empty-state" style="padding: 60px 20px;">
                        No posts yet. Switch to Write to share your thoughts with the group.
                    </div>
                </div>
            </div>
        </div>

        <!-- WRITE VIEW -->
        <div class="view write-view" id="view-write">
            <div class="notes-sidebar">
                <div class="notes-sidebar-header">
                    <h3>Your Notes</h3>
                    <button class="btn" onclick="newNote()">+ New</button>
                </div>
                <div class="notes-list" id="notesList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="editor-container" id="editorContainer">
                <div class="editor-empty">
                    <div class="editor-empty-icon">âœï¸</div>
                    <div>Select a note or create a new one</div>
                </div>
            </div>
            <div class="editor-active" id="editorActive" style="display: none; flex: 1; flex-direction: column;">
                <div class="editor-header">
                    <input type="text" class="editor-title-input" id="noteTitleInput" placeholder="Title...">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn secondary" onclick="saveNote()">Save</button>
                        <button class="btn" onclick="publishNote()">Publish</button>
                    </div>
                </div>
                <div class="editor-body">
                    <textarea class="editor-textarea" id="noteContentInput" placeholder="Write your thoughts...

Use [[Week 1: Parmenides]] to link to readings."></textarea>
                </div>
                <div class="editor-footer">
                    <div class="editor-links" id="editorLinks">
                        Use [[Week Title]] to link to readings
                    </div>
                </div>
            </div>
        </div>

        <!-- SPLIT VIEW CONTAINER -->
        <div class="split-container horizontal" id="splitContainer">
            <div class="split-pane" id="splitPane1">
                <div class="split-pane-module">
                    <div class="split-pane-header">
                        <select class="split-pane-select" onchange="setSplitPaneContent(1, this.value)">
                            <option value="read">Read</option>
                            <option value="notes">Notes</option>
                            <option value="discuss">Discuss</option>
                            <option value="annotations">Annotations</option>
                        </select>
                        <button class="split-pane-close" onclick="closeSplitPane(1)" title="Close pane">âœ•</button>
                    </div>
                    <div class="split-pane-content" id="splitPane1Content"></div>
                </div>
            </div>
            <div class="split-divider" id="splitDivider"></div>
            <div class="split-pane" id="splitPane2">
                <div class="split-pane-module">
                    <div class="split-pane-header">
                        <select class="split-pane-select" onchange="setSplitPaneContent(2, this.value)">
                            <option value="notes" selected>Notes</option>
                            <option value="read">Read</option>
                            <option value="discuss">Discuss</option>
                            <option value="annotations">Annotations</option>
                        </select>
                        <button class="split-pane-close" onclick="closeSplitPane(2)" title="Close pane">âœ•</button>
                    </div>
                    <div class="split-pane-content" id="splitPane2Content"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Selection Popup -->
    <div class="selection-popup" id="selectionPopup">
        <button onclick="startAnnotation()">Annotate</button>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h3>Sign in</h3>
            <p>Enter your email to receive a magic link.</p>
            <div class="message" id="authMessage" style="display: none;"></div>
            <input type="email" id="authEmail" placeholder="your@email.com">
            <div class="btn-row">
                <button class="btn secondary" onclick="hideAuthModal()">Cancel</button>
                <button class="btn" onclick="sendMagicLink()">Send link</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://tnasxupoydyoxibccovm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuYXN4dXBveWR5b3hpYmNjb3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDM5NjksImV4cCI6MjA4NDc3OTk2OX0.JTXSnyDDl5Ta3s7fDtnGfWcuicuchwP5A5WhRZ_exIg';

        let db = null;
        let currentUser = null;

        try {
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.warn('Supabase init failed:', e);
        }

        // =============================================
        // SCHEDULE DATA
        // =============================================
        const schedule = [
            {
                unit: "Unit I: Ancient and Medieval Foundations",
                weeks: [
                    { num: 1, date: "Feb 4", title: "Being and Non-Being",
                      focus: `How can we think or speak "what is not"? This problem drives subsequent responses from Aristotle through Heidegger. Kingsley's reading situates Parmenides within an initiatory tradition.`,
                      readings: [
                        { id: "w01_parmenides", title: `Parmenides, "On Nature" (complete fragments)`, file: "readings/Week 1_Parmenides/Week 1_Parmenides.pdf" },
                        { id: "w01_kingsley", title: "Kingsley, In the Dark Places of Wisdom (Parts One and Two most essential)", file: "readings/Week 1_Parmenides/Week 1_Kingsley.pdf" }
                    ]},
                    { num: 2, date: "Feb 11", title: "Potentiality and Actuality",
                      focus: "Aristotle's potentiality (dynamis) answers Parmenides by locating possibility within beings themselves. The sea-battle problem asks whether future contingents have determinate truth values.",
                      readings: [
                        { id: "w02_meta", title: "Aristotle, Metaphysics Book Î˜, ch. 1â€“3 and 6â€“8", file: "readings/Week 2_Aristotle/Week 2_Aristotle.pdf" },
                        { id: "w02_di", title: "Aristotle, De Interpretatione, ch. 9", file: "readings/Week 2_Aristotle/Week 2_Conway.pdf" },
                        { id: "w02_witt", title: `Witt, "The Priority of Actuality in Aristotle"`, file: "readings/Week 2_Aristotle/Week 2_Witt.pdf" }
                    ]},
                    { num: 3, date: "Feb 18", title: "Essence and Existence",
                      focus: "Separating essence from existence, Avicenna makes contingency fundamental to everything except the Necessary Existent. This reconfiguration of Aristotle shapes Leibniz's later work on possible worlds.",
                      readings: [
                        { id: "w03_avicenna", title: "Avicenna, The Metaphysics of The Healing, selections", file: "readings/Week 3_Avicenna/Week 3_Avicenna.pdf" },
                        { id: "w03_adamson", title: `Adamson, "From the Necessary Existent to God"`, file: "readings/Week 3_Avicenna/Week 3_Adamson.pdf" }
                    ]},
                    { num: 4, date: "Feb 25", title: "Emptiness and Dependent Arising",
                      focus: `Does "possibility" mean anything once inherent existence drops out? NÄgÄrjuna's tetralemma refuses the logical options that Western frameworks take for granted.`,
                      readings: [
                        { id: "w04_nagarjuna", title: "NÄgÄrjuna, MÅ«lamadhyamakakÄrikÄ, ch. 1, 2, 15, 24, 25", file: "readings/Week 4_Nagarjuna/Week 4_Nagarjuna.pdf" },
                        { id: "w04_garfield", title: `Garfield, "Dependent Arising and the Emptiness of Emptiness"`, file: "readings/Week 4_Nagarjuna/Week 4_Garfield (Essay).pdf" },
                        { id: "w04_commentary", title: "Garfield, Commentary (optional)", file: "readings/Week 4_Nagarjuna/Week 4_Garfield (Commentary).pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit II: Rationalism, Transcendentalism, and the Imaginal",
                weeks: [
                    { num: 5, date: "Mar 4", title: "Compossibility and Possible Worlds",
                      focus: "Compossibility constrains which possibilities can coexist within a single world. The Monadology raises the question of what individuates possible worlds.",
                      readings: [
                        { id: "w05_monad", title: "Leibniz, Monadology", file: "readings/Week 5_Leibniz and Du ChÃ¢telet/Leibniz_Monadology.pdf" },
                        { id: "w05_duchat", title: "Du ChÃ¢telet, Institutions de physique, ch. 1â€“2", file: "readings/Week 5_Leibniz and Du ChÃ¢telet/Week 5_Du Chatelet.pdf" },
                        { id: "w05_orig", title: `Leibniz, "On the Ultimate Origination of Things"`, file: "readings/Week 5_Leibniz and Du ChÃ¢telet/Week 5_Leibniz (Origination).pdf" }
                    ]},
                    { num: 6, date: "Mar 11", title: "Real and Logical Possibility",
                      focus: "What must any possible experience conform to? Kant's Postulates distinguish logical possibility from real possibility.",
                      readings: [
                        { id: "w06_kant", title: `Kant, Critique of Pure Reason: "Postulates of Empirical Thought"`, file: "readings/Week 6_Kant and Leech/Week 6_Kant.pdf" },
                        { id: "w06_leech", title: `Leech, "The Function of Modal Judgment and the Kantian Gap"`, file: "readings/Week 6_Kant and Leech/Week 6_Leech.pdf" }
                    ]},
                    { num: 7, date: "Mar 18", title: "The Imaginal World",
                      focus: "Ibn Ê¿ArabÄ«'s imaginal world (Ê¿Älam al-mithÄl) occupies a realm between sensible and intelligible, where possibilities take on form. The Adam chapter introduces the human being as comprehensive mirror of divine names; the Joseph chapter develops imagination as an ontological realm through dream interpretation. (Spring Breakâ€”informal)",
                      readings: [
                        { id: "w07_arabi", title: `Ibn Ê¿ArabÄ«, Fuá¹£Å«á¹£ al-á¸¤ikam (Bezels of Wisdom), "Adam" and "Joseph" chapters (Austin trans.)`, file: "readings/Week 7_al-Adawiyya and Ibn Arabi/Week 7_Arabi.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit III: Phenomenology, Pragmatism, and Nothingness",
                weeks: [
                    { num: 8, date: "Mar 25", title: "Conditions of Possibility",
                      focus: "Can a condition of possibility also be a condition of impossibility? Derrida's introduction examines how ideal objects arise in history yet claim eternal validity.",
                      readings: [
                        { id: "w08_husserl", title: `Husserl, "The Origin of Geometry"`, file: "readings/Week 8_Husserl and Derrida/Week 8_Husserl and Derrida.pdf" },
                        { id: "w08_derrida", title: `Derrida, Introduction to "The Origin of Geometry," selections`, file: "readings/Week 8_Husserl and Derrida/Week 8_Husserl and Derrida.pdf" }
                    ]},
                    { num: 9, date: "Apr 1", title: "Death and Natality",
                      focus: "Heidegger transforms the Aristotelian vocabulary so that possibility becomes constitutive of Dasein; death individualizes as the ownmost possibility. Arendt's natality offers a counter-emphasis.",
                      readings: [
                        { id: "w09_heid", title: "Heidegger, Being and Time, Division II ch. 1 (Â§Â§46â€“53)", file: "readings/Week 9_Heidegger and Arendt/Week 9_Heidegger.pdf" },
                        { id: "w09_arendt", title: "Arendt, The Human Condition, ch. 5 Â§Â§24â€“26", file: "readings/Week 9_Heidegger and Arendt/Week 9_Arendt.pdf" }
                    ]},
                    { num: 10, date: "Apr 8", title: "Firstness and Continuity",
                      focus: "Firstness is pure qualitative possibility, prior to relation or resistance. Peirce's continuum allows possibility to grade into actuality.",
                      readings: [
                        { id: "w10_peirce", title: `Peirce, "A Guess at the Riddle"`, file: "readings/Week 10_Peirce/Week 10_Peirce.pdf" },
                        { id: "w10_continuity", title: `"The Continuity of Life: On Peirce's Objective Idealism"`, file: "readings/Week 10_Peirce/Week 10_Ibri (On Peirce's Objective Idealism).pdf" }
                    ]},
                    { num: 11, date: "Apr 15", title: "Nothingness East and West",
                      focus: `Nishida's "place of absolute nothingness" (zettai mu no basho) holds particulars without being one itself. Lalla's Kashmiri Shaivite poetry pursues nothingness through a different idiom.`,
                      readings: [
                        { id: "w11_nishida", title: "Nishida KitarÅ, An Inquiry into the Good, Part I ch. 1â€“3", file: "readings/Week 11_Nishida and Lalla/Week 11_Nishida.pdf" },
                        { id: "w11_lalla", title: "Lalla, Naked Song, selections", file: "readings/Week 11_Nishida and Lalla/Week 11_Lalla.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit IV: Process, Contemplation, Emanation",
                weeks: [
                    { num: 12, date: "Apr 22", title: "Eternal Objects and Ingression",
                      focus: "Eternal objects ingress into actual occasions as pure potentials. Whitehead's God functions as the primordial envisagement of possibility, a role that recalls Leibniz, and Peirce's categories find new form in this processual framework.",
                      readings: [
                        { id: "w12_white", title: "Whitehead, Science and the Modern World, ch. 11", file: "readings/Week 12_Whitehead/Week 12_Whitehead.pdf" },
                        { id: "w12_stengers", title: "Stengers, Thinking with Whitehead, selections", file: "readings/Week 12_Whitehead/Week 12_Stengers (Thinking With Whitehead).pdf" }
                    ]},
                    { num: 13, date: "Apr 29", title: "Attention and Awareness",
                      focus: "Thompson and Varela bridge first-person contemplative methods and third-person neuroscience. Weil's account of attention resonates with contemplative approaches while drawing on Platonic sources.",
                      readings: [
                        { id: "w13_thompson", title: "Thompson, Waking, Dreaming, Being, ch. 1", file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Thompson.pdf" },
                        { id: "w13_weil", title: `Weil, "Reflections on the Right Use of School Studies with a View to the Love of God"`, file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Weil.pdf" },
                        { id: "w13_varela", title: `Varela, "Neurophenomenology: A Methodological Remedy for the Hard Problem"`, file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Varela.pdf" }
                    ]},
                    { num: 14, date: "May 6", title: "Emanation and Superabundance",
                      focus: "Possibility flows from the One's inexhaustible superabundance. This emanationist framework shaped Avicenna and passed into German Idealism; it offers a counterpoint to the Aristotelian model of potentiality.",
                      readings: [
                        { id: "w14_plotinus", title: "Plotinus, Enneads V.1", file: "readings/Week 14_Plotinus, Conway/Week 14_Plotinus.pdf" },
                        { id: "w14_conway", title: "Conway, Principles of the Most Ancient and Modern Philosophy, selections", file: "readings/Week 14_Plotinus, Conway/Week 14_Conway.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit V: Mathematical and Formal Possibility",
                weeks: [
                    { num: 15, date: "May 13", title: "Set-Theoretic Potentialism",
                      focus: "Ruth Barcan Marcus founded quantified modal logic; her Barcan formula raises questions about the relation between possibility and existence. Hamkins's multiverse holds many distinct concepts of set, each instantiated in a corresponding universe.",
                      readings: [
                        { id: "w15_marcus", title: `Barcan Marcus, "Modalities and Intensional Languages"`, file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Marcus.pdf" },
                        { id: "w15_hamkins", title: `Hamkins, "The Set-Theoretic Multiverse"`, file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Hamkins (multiverse).pdf" },
                        { id: "w15_linnebo", title: `Hamkins & Linnebo, "The Modal Logic of Set-Theoretic Potentialism"`, file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Hamkins and Linnebo.pdf" }
                    ]},
                    { num: 16, date: "May 20", title: "Producing the Possible",
                      focus: "How do possibility spaces themselves get produced? Foster's work shows tradition constraining what becomes thinkable while furnishing materials for innovation, bringing the semester's philosophical questions into contact with computational and sociological methods. Borges's story explores the literary form of branching possibility.",
                      readings: [
                        { id: "w16_metal", title: `Koch, Silvestro & Foster, "The Evolutionary Dynamics of Cultural Change (As Told Through the Birth and Brutal, Blackened Death of Metal Music)"`, file: "readings/Week 16_Foster/Week 16_Foster and Koch.pdf" },
                        { id: "w16_borges", title: `Borges, "The Garden of Forking Paths"`, file: "readings/Week 16_Foster/Week 16_Borges.pdf" }
                    ]}
                ]
            }
        ];

        // State
        let currentWeekNum = 1;
        let currentReading = null;
        let selectedText = '';
        let annotations = {};
        let notes = [];
        let posts = [];
        let editingNoteId = null;

        // =============================================
        // INITIALIZATION
        // =============================================

        async function init() {
            // Test Supabase connection
            if (db) {
                updateStatus('connecting', 'Connecting...');
                try {
                    // Quick test query
                    const { error } = await db.from('annotations').select('id').limit(1);
                    if (error) {
                        console.error('Supabase test query error:', error);
                        updateStatus('error', 'Database error');
                    } else {
                        updateStatus('online', 'Connected');
                    }
                } catch (e) {
                    console.error('Supabase connection test failed:', e);
                    updateStatus('offline', 'Offline mode');
                }
            } else {
                updateStatus('offline', 'Offline mode');
            }

            buildSyllabus();
            buildReadingsList();
            renderCurrentWeek();
            loadFeed();
            loadNotes();

            // Handle URL parameters for deep linking
            const params = new URLSearchParams(window.location.search);
            const weekParam = params.get('week');
            if (weekParam) {
                const weekNum = parseInt(weekParam, 10);
                if (weekNum >= 1 && weekNum <= 16) {
                    goToWeek(weekNum);
                }
            }

            // Auth state
            if (db) {
                db.auth.onAuthStateChange((event, session) => {
                    if (session?.user) {
                        currentUser = session.user;
                        updateAuthUI(currentUser);
                        hideAuthModal();
                        loadNotes();
                    } else {
                        currentUser = null;
                        updateAuthUI(null);
                    }
                });

                db.auth.getSession().then(({ data: { session } }) => {
                    if (session?.user) {
                        currentUser = session.user;
                        updateAuthUI(currentUser);
                        loadNotes();
                    }
                });
            }

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Cmd/Ctrl + [ = toggle left sidebar
                if ((e.metaKey || e.ctrlKey) && e.key === '[') {
                    e.preventDefault();
                    toggleReadSidebar();
                }
                // Cmd/Ctrl + ] = toggle right sidebar
                if ((e.metaKey || e.ctrlKey) && e.key === ']') {
                    e.preventDefault();
                    toggleAnnotationsPanel();
                }
                // Cmd/Ctrl + \ = toggle both sidebars (focus mode)
                if ((e.metaKey || e.ctrlKey) && e.key === '\\') {
                    e.preventDefault();
                    toggleReadSidebar();
                    toggleAnnotationsPanel();
                }
                // Cmd/Ctrl + / = toggle split view
                if ((e.metaKey || e.ctrlKey) && e.key === '/') {
                    e.preventDefault();
                    toggleSplitView();
                }
                // Cmd/Ctrl + = or + = zoom in
                if ((e.metaKey || e.ctrlKey) && (e.key === '=' || e.key === '+')) {
                    e.preventDefault();
                    zoomIn();
                }
                // Cmd/Ctrl + - = zoom out
                if ((e.metaKey || e.ctrlKey) && e.key === '-') {
                    e.preventDefault();
                    zoomOut();
                }
                // Cmd/Ctrl + 0 = fit width
                if ((e.metaKey || e.ctrlKey) && e.key === '0') {
                    e.preventDefault();
                    fitWidth();
                }
            });
        }

        function updateStatus(status, text) {
            document.getElementById('statusDot').className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = text;
        }

        // =============================================
        // SPLIT VIEW
        // =============================================

        let splitViewActive = false;

        function toggleSplitView() {
            splitViewActive = !splitViewActive;
            const splitContainer = document.getElementById('splitContainer');
            const splitBtn = document.getElementById('splitBtn');

            if (splitViewActive) {
                // Hide all regular views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                // Show split container
                splitContainer.classList.add('active');
                splitBtn.classList.add('active');
                // Initialize panes with default content
                setSplitPaneContent(1, 'read');
                setSplitPaneContent(2, 'notes');
            } else {
                // Hide split container
                splitContainer.classList.remove('active');
                splitBtn.classList.remove('active');
                // Show home view (or last active view)
                switchView('home');
            }
        }

        // Track split pane state
        const splitPaneState = { 1: { zoom: 1.0, reading: null }, 2: { zoom: 1.0, reading: null } };

        function setSplitPaneContent(paneNum, contentType) {
            const paneContent = document.getElementById(`splitPane${paneNum}Content`);
            paneContent.innerHTML = '';

            switch (contentType) {
                case 'read':
                    paneContent.innerHTML = `
                        <div class="split-pdf-layout">
                            <div class="split-readings-sidebar">
                                <div class="split-readings-header">Readings</div>
                                <div id="splitReadings${paneNum}"></div>
                            </div>
                            <div class="split-pdf-main">
                                <div class="split-pdf-toolbar">
                                    <span class="pdf-title" id="splitPdfTitle${paneNum}">Select a reading</span>
                                    <button class="btn zoom-btn" onclick="splitZoom(${paneNum}, -0.1)" title="Zoom out">âˆ’</button>
                                    <button class="btn zoom-btn" onclick="splitZoom(${paneNum}, 0.1)" title="Zoom in">+</button>
                                    <button class="btn zoom-btn" onclick="splitFitWidth(${paneNum})" title="Fit width">â¤¢</button>
                                </div>
                                <div class="split-pdf-viewer" id="splitPdfViewer${paneNum}">
                                    <div class="empty-state">Select a reading from the sidebar</div>
                                </div>
                            </div>
                            <div class="split-annotations-panel">
                                <div class="split-annotations-header">Annotations</div>
                                <div class="split-annotations-list" id="splitAnnotationsList${paneNum}">
                                    <div class="empty-state">Select text to annotate</div>
                                </div>
                            </div>
                        </div>
                    `;
                    renderSplitReadingsList(paneNum);
                    break;
                case 'notes':
                    paneContent.innerHTML = `
                        <div style="display: flex; height: 100%;">
                            <div style="width: 200px; border-right: 1px solid var(--border); overflow-y: auto; background: var(--bg-sidebar);">
                                <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Notes</span>
                                    <button class="btn" style="padding: 2px 8px; font-size: 11px;" onclick="newSplitNote(${paneNum})">+</button>
                                </div>
                                <div id="splitNotesList${paneNum}"></div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <input type="text" id="splitNoteTitle${paneNum}" placeholder="Note title..." style="padding: 15px; border: none; border-bottom: 1px solid var(--border); font-size: 16px; font-weight: 500;">
                                <textarea id="splitNoteContent${paneNum}" placeholder="Write your thoughts..." style="flex: 1; padding: 15px; border: none; resize: none; font-family: inherit; font-size: 14px; line-height: 1.6;"></textarea>
                                <div style="padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn" onclick="saveSplitNote(${paneNum})">Save</button>
                                </div>
                            </div>
                        </div>
                    `;
                    renderSplitNotesList(paneNum);
                    break;
                case 'discuss':
                    paneContent.innerHTML = `
                        <div style="padding: 20px; max-width: 700px; margin: 0 auto;">
                            <h2 style="margin-bottom: 20px;">Discussion</h2>
                            <div id="splitFeed${paneNum}"></div>
                        </div>
                    `;
                    renderSplitFeed(paneNum);
                    break;
                case 'annotations':
                    paneContent.innerHTML = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px;">All Annotations</h3>
                            <div id="splitAnnotations${paneNum}"></div>
                        </div>
                    `;
                    renderSplitAnnotations(paneNum);
                    break;
            }
        }

        function renderSplitReadingsList(paneNum) {
            const container = document.getElementById(`splitReadings${paneNum}`);
            let html = '';
            schedule.forEach(unit => {
                unit.weeks.forEach(week => {
                    html += `<div class="split-week-header">Week ${week.num}</div>`;
                    week.readings.forEach(r => {
                        const isActive = splitPaneState[paneNum].reading === r.id;
                        html += `<div class="split-reading-item ${isActive ? 'active' : ''}"
                                     data-reading-id="${r.id}"
                                     onclick="loadSplitReading(${paneNum}, '${r.id}')">${r.title.split(',')[0]}</div>`;
                    });
                });
            });
            container.innerHTML = html;
        }

        async function loadSplitReading(paneNum, readingId) {
            const viewer = document.getElementById(`splitPdfViewer${paneNum}`);
            const titleEl = document.getElementById(`splitPdfTitle${paneNum}`);
            viewer.innerHTML = '<div class="empty-state">Loading...</div>';

            // Find the reading
            let reading = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    for (const r of week.readings) {
                        if (r.id === readingId) {
                            reading = r;
                            break;
                        }
                    }
                }
            }

            if (!reading) return;

            // Update state and UI
            splitPaneState[paneNum].reading = readingId;
            splitPaneState[paneNum].pdf = null;
            titleEl.textContent = reading.title.split(',')[0];

            // Update active state in readings list
            const container = document.getElementById(`splitReadings${paneNum}`);
            container.querySelectorAll('.split-reading-item').forEach(el => {
                el.classList.toggle('active', el.dataset.readingId === readingId);
            });

            try {
                const pdf = await pdfjsLib.getDocument(reading.file).promise;
                splitPaneState[paneNum].pdf = pdf;
                await renderSplitPdf(paneNum);
                renderSplitAnnotationsList(paneNum, readingId);
            } catch (e) {
                viewer.innerHTML = `<div class="empty-state" style="color: var(--error);">Error loading PDF: ${e.message}</div>`;
            }
        }

        async function renderSplitPdf(paneNum) {
            const state = splitPaneState[paneNum];
            if (!state.pdf) return;

            const viewer = document.getElementById(`splitPdfViewer${paneNum}`);
            const availableWidth = viewer.clientWidth - 40;
            viewer.innerHTML = '';

            for (let i = 1; i <= state.pdf.numPages; i++) {
                const page = await state.pdf.getPage(i);
                const baseViewport = page.getViewport({ scale: 1.0 });
                const fitScale = availableWidth / baseViewport.width;
                const scale = fitScale * state.zoom;
                const viewport = page.getViewport({ scale });

                // Create page wrapper
                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'split-page-wrapper';
                pageWrapper.dataset.pane = paneNum;
                pageWrapper.dataset.page = i;

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                pageWrapper.appendChild(canvas);

                // Create text layer
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'textLayer';
                textLayerDiv.style.width = viewport.width + 'px';
                textLayerDiv.style.height = viewport.height + 'px';
                textLayerDiv.style.setProperty('--scale-factor', scale);
                pageWrapper.appendChild(textLayerDiv);

                viewer.appendChild(pageWrapper);

                // Render canvas
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                // Render text layer
                const textContent = await page.getTextContent();
                await pdfjsLib.renderTextLayer({
                    textContent: textContent,
                    container: textLayerDiv,
                    viewport: viewport,
                    textDivs: []
                }).promise;
            }

            // Set up text selection listener for this pane
            viewer.onmouseup = () => handleSplitTextSelection(paneNum);
        }

        function splitZoom(paneNum, delta) {
            splitPaneState[paneNum].zoom = Math.max(0.5, Math.min(3, splitPaneState[paneNum].zoom + delta));
            renderSplitPdf(paneNum);
        }

        function splitFitWidth(paneNum) {
            splitPaneState[paneNum].zoom = 1.0;
            renderSplitPdf(paneNum);
        }

        function handleSplitTextSelection(paneNum) {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (!text || text.length < 3) return;

            // Store selected text for annotation
            splitPaneState[paneNum].selectedText = text;

            // Show annotation prompt
            const annotationsList = document.getElementById(`splitAnnotationsList${paneNum}`);
            annotationsList.innerHTML = `
                <div style="padding: 15px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Selected text:</div>
                    <div style="font-size: 13px; font-style: italic; margin-bottom: 15px; padding: 10px; background: var(--bg-dark); border-radius: 6px;">"${text.substring(0, 100)}${text.length > 100 ? '...' : ''}"</div>
                    <textarea id="splitAnnotationComment${paneNum}" placeholder="Add your annotation..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; resize: none;"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 8px;">
                        <button class="btn" onclick="saveSplitAnnotation(${paneNum})">Save</button>
                        <button class="btn secondary" onclick="cancelSplitAnnotation(${paneNum})">Cancel</button>
                    </div>
                </div>
            `;
        }

        async function saveSplitAnnotation(paneNum) {
            const state = splitPaneState[paneNum];
            if (!state.reading || !state.selectedText) return;

            const comment = document.getElementById(`splitAnnotationComment${paneNum}`).value;
            const annotation = {
                id: Date.now().toString(),
                reading_id: state.reading,
                quote: state.selectedText,
                comment: comment,
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            // Add to local state
            if (!annotations[state.reading]) annotations[state.reading] = [];
            annotations[state.reading].unshift(annotation);
            localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

            // Save to Supabase if logged in
            if (db && currentUser) {
                annotation.user_id = currentUser.id;
                try {
                    await db.from('annotations').insert([annotation]);
                } catch (e) {
                    console.warn('Failed to save to Supabase:', e);
                }
            }

            state.selectedText = null;
            renderSplitAnnotationsList(paneNum, state.reading);
            renderActivityStream();
        }

        function cancelSplitAnnotation(paneNum) {
            splitPaneState[paneNum].selectedText = null;
            renderSplitAnnotationsList(paneNum, splitPaneState[paneNum].reading);
        }

        function renderSplitAnnotationsList(paneNum, readingId) {
            const container = document.getElementById(`splitAnnotationsList${paneNum}`);
            const readingAnnotations = annotations[readingId] || [];

            if (readingAnnotations.length === 0) {
                container.innerHTML = '<div class="empty-state">Select text to annotate</div>';
                return;
            }

            container.innerHTML = readingAnnotations.map(a => `
                <div class="annotation-item" style="padding: 12px; border-bottom: 1px solid var(--border);">
                    <div class="quote" style="font-size: 12px; font-style: italic; color: var(--text-muted); margin-bottom: 6px;">"${(a.quote || '').substring(0, 60)}..."</div>
                    <div class="comment" style="font-size: 13px; color: var(--text);">${a.comment || ''}</div>
                    <div class="meta" style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">${a.author_email?.split('@')[0] || 'Anonymous'} Â· ${new Date(a.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function renderSplitNotesList(paneNum) {
            const container = document.getElementById(`splitNotesList${paneNum}`);
            if (notes.length === 0) {
                container.innerHTML = '<div style="padding: 15px; color: var(--text-muted); font-size: 12px;">No notes yet</div>';
                return;
            }
            container.innerHTML = notes.map(n => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer;"
                     onclick="loadSplitNote(${paneNum}, '${n.id}')"
                     onmouseover="this.style.background='var(--highlight)'"
                     onmouseout="this.style.background=''">
                    <div style="font-size: 13px; font-weight: 500;">${n.title || 'Untitled'}</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${new Date(n.created_at || n.createdAt).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function loadSplitNote(paneNum, noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            document.getElementById(`splitNoteTitle${paneNum}`).value = note.title || '';
            document.getElementById(`splitNoteContent${paneNum}`).value = note.content || '';
            document.getElementById(`splitNoteTitle${paneNum}`).dataset.noteId = noteId;
        }

        function newSplitNote(paneNum) {
            document.getElementById(`splitNoteTitle${paneNum}`).value = '';
            document.getElementById(`splitNoteContent${paneNum}`).value = '';
            delete document.getElementById(`splitNoteTitle${paneNum}`).dataset.noteId;
        }

        async function saveSplitNote(paneNum) {
            const titleEl = document.getElementById(`splitNoteTitle${paneNum}`);
            const contentEl = document.getElementById(`splitNoteContent${paneNum}`);
            const title = titleEl.value;
            const content = contentEl.value;
            const noteId = titleEl.dataset.noteId;

            if (noteId) {
                // Update existing
                const idx = notes.findIndex(n => n.id === noteId);
                if (idx >= 0) {
                    notes[idx].title = title;
                    notes[idx].content = content;
                }
            } else {
                // Create new
                const note = { id: Date.now().toString(), title, content, createdAt: new Date().toISOString() };
                notes.unshift(note);
                titleEl.dataset.noteId = note.id;
            }

            renderSplitNotesList(paneNum);
            // Also update main notes if loaded
            renderNotesList();
        }

        function renderSplitFeed(paneNum) {
            const container = document.getElementById(`splitFeed${paneNum}`);
            if (posts.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">No posts yet</div>';
                return;
            }
            container.innerHTML = posts.map(p => `
                <div style="padding: 20px; background: var(--bg-panel); border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                    <h3 style="margin-bottom: 10px;">${p.title}</h3>
                    <p style="color: var(--text); line-height: 1.6;">${p.content?.substring(0, 200)}...</p>
                    <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">${p.author_email || 'Anonymous'}</div>
                </div>
            `).join('');
        }

        function renderSplitAnnotations(paneNum) {
            const container = document.getElementById(`splitAnnotations${paneNum}`);
            // Get all annotations from localStorage
            const allAnnotations = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('metamodality_annotations_')) {
                    const readingId = key.replace('metamodality_annotations_', '');
                    const annotations = JSON.parse(localStorage.getItem(key) || '[]');
                    annotations.forEach(a => allAnnotations.push({ ...a, readingId }));
                }
            }

            if (allAnnotations.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">No annotations yet</div>';
                return;
            }

            container.innerHTML = allAnnotations.map(a => `
                <div style="padding: 15px; background: var(--bg-sidebar); border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-style: italic; color: var(--text); margin-bottom: 8px; padding-left: 10px; border-left: 3px solid var(--accent);">"${a.quote}"</div>
                    <div style="font-size: 13px; color: var(--text);">${a.comment || ''}</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">${a.readingId}</div>
                </div>
            `).join('');
        }

        function closeSplitPane(paneNum) {
            // If closing a pane, exit split view
            toggleSplitView();
        }

        // =============================================
        // VIEW SWITCHING
        // =============================================

        function switchView(viewName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            document.getElementById('view-' + viewName).classList.add('active');
        }

        // =============================================
        // HOME VIEW
        // =============================================

        function getCurrentWeek() {
            // For now, default to week 1. Could be date-based later.
            let week = null;
            for (const unit of schedule) {
                for (const w of unit.weeks) {
                    if (w.num === currentWeekNum) {
                        week = w;
                        break;
                    }
                }
            }
            return week;
        }

        function renderCurrentWeek() {
            const week = getCurrentWeek();
            if (!week) return;

            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            const weekProgress = progress[`week_${week.num}`] || {};

            document.getElementById('currentWeekCard').innerHTML = `
                <div class="current-week-label">Week ${week.num} â€” ${week.date}</div>
                <h2>${week.title}</h2>
                <p class="focus">${week.focus}</p>
                <div class="current-week-readings">
                    ${week.readings.map(r => `
                        <div class="reading-card" onclick="openReading('${r.id}')">
                            <span class="icon">${weekProgress[r.id] ? 'âœ“' : 'ðŸ“„'}</span>
                            <div class="info">
                                <div class="title">${r.title}</div>
                            </div>
                            <span class="arrow">â†’</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Also render sidebar components
            renderCourseStream();
            renderActivityStream();
        }

        function renderCourseStream() {
            const container = document.getElementById('courseStream');
            if (!container) return;

            let html = '';
            schedule.forEach(unit => {
                // Unit header
                html += `<div class="course-unit-header">${unit.unit}</div>`;

                // Weeks in unit
                unit.weeks.forEach(week => {
                    const isCurrent = week.num === currentWeekNum;
                    html += `
                        <div class="course-week-item ${isCurrent ? 'current' : ''}" onclick="goToWeek(${week.num})">
                            <div class="week-num">Week ${week.num}</div>
                            <div class="week-title">${week.title}</div>
                            <div class="week-date">${week.date}</div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;

            // Scroll current week into view
            setTimeout(() => {
                const currentItem = container.querySelector('.course-week-item.current');
                if (currentItem) {
                    currentItem.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            }, 100);
        }

        function renderActivityStream() {
            const container = document.getElementById('activityStream');
            if (!container) return;

            // Combine recent posts and annotations into a single stream
            const activities = [];

            // Add posts
            posts.slice(0, 5).forEach(p => {
                activities.push({
                    type: 'post',
                    author: p.author_email || 'Anonymous',
                    title: p.title,
                    time: new Date(p.published_at),
                    onClick: `switchView('discuss')`
                });
            });

            // Add annotations from all readings
            Object.entries(annotations).forEach(([readingId, items]) => {
                (items || []).slice(0, 3).forEach(a => {
                    activities.push({
                        type: 'annotation',
                        author: a.author_email || 'Anonymous',
                        quote: a.quote?.substring(0, 50) + '...',
                        readingId: readingId,
                        time: new Date(a.created_at),
                        onClick: `openReading('${readingId}')`
                    });
                });
            });

            // Sort by time, most recent first
            activities.sort((a, b) => b.time - a.time);

            if (activities.length === 0) {
                container.innerHTML = '<div class="empty-state">Activity from the group will appear here.</div>';
                return;
            }

            container.innerHTML = activities.slice(0, 8).map(a => {
                const initial = (a.author.split('@')[0] || 'A')[0].toUpperCase();
                const timeAgo = formatTimeAgo(a.time);

                if (a.type === 'post') {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> posted
                                    <span class="target">"${a.title}"</span>
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> annotated "${a.quote}"
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function openReading(readingId) {
            switchView('read');
            loadReading(readingId);
        }

        // =============================================
        // SYLLABUS VIEW
        // =============================================

        function buildSyllabus() {
            const container = document.getElementById('syllabusContent');
            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            let html = '';

            schedule.forEach((unit, unitIdx) => {
                // Parse unit title: "Unit I: Ancient and Medieval Foundations"
                const unitMatch = unit.unit.match(/^(Unit [IVX]+):\s*(.+)$/);
                const unitLabel = unitMatch ? unitMatch[1] : `Unit ${unitIdx + 1}`;
                const unitTitle = unitMatch ? unitMatch[2] : unit.unit;

                html += `<div class="unit">
                    <div class="unit-header">
                        <div class="unit-label">${unitLabel}</div>
                        <div class="unit-title">${unitTitle}</div>
                    </div>
                    ${unit.weeks.map(week => {
                        const isCurrent = week.num === currentWeekNum;
                        const weekProgress = progress[`week_${week.num}`] || {};
                        const readingsComplete = week.readings.filter(r => weekProgress[r.id]).length;
                        const isComplete = readingsComplete === week.readings.length && week.readings.length > 0;

                        return `
                        <div class="week-card ${isCurrent ? 'current' : ''} ${isComplete ? 'completed' : ''}" id="syllabus-week-${week.num}">
                            <div class="week-card-main" onclick="toggleSyllabusWeek(${week.num})">
                                <div class="week-card-header">
                                    <span class="week-num">Week ${week.num}</span>
                                    <span class="week-title">${week.title}</span>
                                    ${isCurrent ? '<span class="week-status">Current</span>' : ''}
                                    <span class="week-date">${week.date}</span>
                                </div>
                                <div class="week-focus">${week.focus}</div>
                                <div class="week-summary">
                                    <span>ðŸ“š ${week.readings.length} readings</span>
                                    ${readingsComplete > 0 ? `<span>âœ“ ${readingsComplete}/${week.readings.length} complete</span>` : ''}
                                    <span class="expand-icon">â–¼</span>
                                </div>
                            </div>
                            <div class="week-readings-list">
                                ${week.readings.map(r => {
                                    const isRead = weekProgress[r.id];
                                    return `
                                    <div class="week-reading-item" onclick="event.stopPropagation(); openReading('${r.id}')">
                                        <div class="reading-icon">ðŸ“„</div>
                                        <div class="reading-info">
                                            <div class="reading-title">${r.title}</div>
                                        </div>
                                        <div class="reading-progress ${isRead ? 'complete' : ''}">${isRead ? 'âœ“' : ''}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `}).join('')}
                </div>`;
            });

            container.innerHTML = html;
        }

        function toggleSyllabusWeek(num) {
            const card = document.getElementById('syllabus-week-' + num);
            if (card) card.classList.toggle('expanded');
        }

        function markReadingComplete(readingId) {
            // Find which week this reading belongs to
            let weekNum = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    if (week.readings.some(r => r.id === readingId)) {
                        weekNum = week.num;
                        break;
                    }
                }
            }
            if (!weekNum) return;

            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            if (!progress[`week_${weekNum}`]) progress[`week_${weekNum}`] = {};
            progress[`week_${weekNum}`][readingId] = true;
            localStorage.setItem('metamodality_progress', JSON.stringify(progress));

            // Rebuild syllabus to reflect changes
            buildSyllabus();
        }

        function goToWeek(num) {
            currentWeekNum = num;
            buildReadingsList();
            switchView('read');
        }

        // =============================================
        // READ VIEW
        // =============================================

        function buildReadingsList() {
            const container = document.getElementById('readingsList');
            container.innerHTML = schedule.map((unit, unitIdx) => `
                <div class="sidebar-unit" id="unit-${unitIdx}">
                    <div class="sidebar-unit-header" onclick="toggleUnit(${unitIdx})">
                        <span class="collapse-icon">â–¼</span>
                        ${unit.unit.replace('Unit ', '').replace(/:.+/, '')}
                    </div>
                    <div class="sidebar-unit-weeks">
                        ${unit.weeks.map((week, weekIdx) => `
                            <div class="sidebar-week" id="week-${week.num}">
                                <div class="sidebar-week-header" onclick="toggleWeek(${week.num})">
                                    <span class="collapse-icon">â–¼</span>
                                    Week ${week.num}: ${week.title}
                                </div>
                                <div class="sidebar-week-readings">
                                    ${week.readings.map(r => `
                                        <div class="reading-list-item" data-id="${r.id}" onclick="event.stopPropagation(); loadReading('${r.id}')">
                                            ${r.title.split(',')[0]}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Collapse all except current week's unit
            const currentWeek = getCurrentWeek();
            if (currentWeek) {
                document.querySelectorAll('.sidebar-unit').forEach(el => el.classList.add('collapsed'));
                document.querySelectorAll('.sidebar-week').forEach(el => el.classList.add('collapsed'));
                const weekEl = document.getElementById('week-' + currentWeek.num);
                if (weekEl) {
                    weekEl.classList.remove('collapsed');
                    weekEl.closest('.sidebar-unit')?.classList.remove('collapsed');
                }
            }
        }

        function toggleUnit(idx) {
            document.getElementById('unit-' + idx)?.classList.toggle('collapsed');
        }

        function toggleWeek(num) {
            event.stopPropagation();
            document.getElementById('week-' + num)?.classList.toggle('collapsed');
        }

        function toggleReadSidebar() {
            document.getElementById('readSidebar').classList.toggle('collapsed');
        }

        function toggleAnnotationsPanel() {
            document.getElementById('annotationsPanel').classList.toggle('collapsed');
        }

        function toggleFullscreen() {
            const readView = document.getElementById('view-read');
            readView.classList.toggle('fullscreen');
            const btn = document.querySelector('.fullscreen-btn');
            if (readView.classList.contains('fullscreen')) {
                btn.textContent = 'âœ• Exit';
                document.body.style.overflow = 'hidden';
            } else {
                btn.textContent = 'â›¶ Fullscreen';
                document.body.style.overflow = '';
            }
        }

        function toggleOrientation() {
            const body = document.getElementById('orientationBody');
            const toggle = document.getElementById('orientationToggle');
            body.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function loadReading(readingId) {
            currentReading = readingId;
            pdfHasText = false; // Reset for new PDF

            // Reset zoom for new PDF
            currentZoom = 1.0;
            updateZoomDisplay();

            // Hide OCR controls until we know if text exists
            document.getElementById('ocrStatus').style.display = 'none';
            document.getElementById('ocrBtn').style.display = 'none';

            // Update sidebar selection
            document.querySelectorAll('.reading-list-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.reading-list-item[data-id="${readingId}"]`)?.classList.add('active');

            // Find reading info
            let readingInfo = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    for (const r of week.readings) {
                        if (r.id === readingId) {
                            readingInfo = r;
                            break;
                        }
                    }
                }
            }

            document.getElementById('pdfTitle').textContent = readingInfo?.title || 'Loading...';
            document.getElementById('pdfViewer').innerHTML = '<div class="pdf-empty"><div class="pdf-empty-icon">â³</div><div>Loading...</div></div>';
            document.getElementById('pdfControls').style.display = 'none';

            // Load annotations
            await loadAnnotations(readingId);

            // Try to load PDF
            try {
                const response = await fetch(readingInfo.file);
                if (!response.ok) throw new Error('Not found');

                const arrayBuffer = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                window.currentPdf = pdf;
                window.currentPageNum = 1;

                document.getElementById('totalPages').textContent = pdf.numPages;
                document.getElementById('pdfControls').style.display = 'flex';

                const viewer = document.getElementById('pdfViewer');
                viewer.innerHTML = '';

                // Create all page containers
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.id = 'page-container-' + i;
                    pageContainer.dataset.pageNum = i;

                    const canvas = document.createElement('canvas');
                    canvas.id = 'page-' + i;
                    pageContainer.appendChild(canvas);

                    const textLayer = document.createElement('div');
                    textLayer.className = 'pdf-text-layer';
                    textLayer.id = 'text-layer-' + i;
                    pageContainer.appendChild(textLayer);

                    viewer.appendChild(pageContainer);
                }

                // Render all pages progressively
                renderAllPages();
            } catch (e) {
                document.getElementById('pdfViewer').innerHTML = `
                    <div class="pdf-empty">
                        <div class="pdf-empty-icon">ðŸ“„</div>
                        <div>PDF not yet available</div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">${readingInfo?.file}</div>
                    </div>
                `;
            }
        }

        // Zoom state - simple percentage-based zoom
        let currentZoom = 1.0;
        const ZOOM_STEP = 0.25;
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 2.5;

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function zoomIn() {
            currentZoom = Math.min(MAX_ZOOM, currentZoom + ZOOM_STEP);
            updateZoomDisplay();
            rerenderAllPages();
        }

        function zoomOut() {
            currentZoom = Math.max(MIN_ZOOM, currentZoom - ZOOM_STEP);
            updateZoomDisplay();
            rerenderAllPages();
        }

        function fitWidth() {
            currentZoom = 1.0;
            updateZoomDisplay();
            rerenderAllPages();
        }

        async function rerenderAllPages() {
            if (!window.currentPdf) return;
            const pdf = window.currentPdf;
            for (let num = 1; num <= pdf.numPages; num++) {
                await renderSinglePage(num);
            }
        }

        async function renderAllPages() {
            if (!window.currentPdf) return;

            const pdf = window.currentPdf;
            const scale = 1.5;

            // Render pages in batches for better performance
            for (let num = 1; num <= pdf.numPages; num++) {
                await renderSinglePage(num, scale);
            }
        }

        // Track text layer status
        let pdfHasText = false;
        let ocrWorker = null;

        async function renderSinglePage(num, baseScale = 1.5) {
            if (!window.currentPdf) return;

            try {
                const page = await window.currentPdf.getPage(num);
                const canvas = document.getElementById('page-' + num);
                if (!canvas) return;

                const context = canvas.getContext('2d');
                const textLayerDiv = document.getElementById('text-layer-' + num);

                // Calculate scale to fit available width (no CSS scaling needed)
                const viewer = document.getElementById('pdfViewer');
                const availableWidth = viewer.clientWidth - 60; // Account for padding
                const baseViewport = page.getViewport({ scale: 1.0 });
                const fitScale = availableWidth / baseViewport.width;
                const scale = fitScale * currentZoom;

                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport }).promise;

                // Set container to exact canvas size - no CSS scaling
                const pageContainer = canvas.parentElement;
                pageContainer.style.width = viewport.width + 'px';
                pageContainer.style.height = viewport.height + 'px';

                // Render text layer at exact same size
                if (textLayerDiv) {
                    textLayerDiv.innerHTML = '';
                    textLayerDiv.style.width = viewport.width + 'px';
                    textLayerDiv.style.height = viewport.height + 'px';

                    const textContent = await page.getTextContent();

                    // Check if PDF has meaningful text content
                    const totalChars = textContent.items.reduce((sum, item) => sum + (item.str?.length || 0), 0);

                    if (totalChars > 50) {
                        pdfHasText = true;

                        // Use PDF.js built-in text layer rendering for proper alignment
                        textLayerDiv.classList.add('textLayer');

                        // Set the CSS variable for scale factor (required by pdf_viewer.css)
                        textLayerDiv.style.setProperty('--scale-factor', scale);

                        // Use PDF.js renderTextLayer for proper font metrics and positioning
                        await pdfjsLib.renderTextLayer({
                            textContent: textContent,
                            container: textLayerDiv,
                            viewport: viewport,
                            textDivs: []
                        }).promise;

                        // Detect two-column layout for column toggle feature
                        const pageWidth = viewport.width;
                        const midpoint = pageWidth / 2;
                        const spans = textLayerDiv.querySelectorAll('span');
                        let leftCount = 0, rightCount = 0;
                        spans.forEach(span => {
                            const rect = span.getBoundingClientRect();
                            const containerRect = textLayerDiv.getBoundingClientRect();
                            const relativeX = rect.left - containerRect.left + rect.width / 2;
                            if (relativeX < midpoint) leftCount++;
                            else rightCount++;
                        });
                        const isTwoColumn = leftCount > 10 && rightCount > 10;

                        // Mark spans with column data for filtering
                        if (isTwoColumn) {
                            spans.forEach(span => {
                                const rect = span.getBoundingClientRect();
                                const containerRect = textLayerDiv.getBoundingClientRect();
                                const relativeX = rect.left - containerRect.left + rect.width / 2;
                                span.dataset.column = relativeX < midpoint ? 'left' : 'right';
                            });
                        }
                    }

                    // Update OCR status and column toggle after first page
                    if (num === 1) {
                        updateOcrStatus();
                        showColumnToggleIfNeeded();
                    }
                }
            } catch (e) {
                console.warn('Failed to render page', num, e);
            }
        }

        function updateOcrStatus() {
            const statusEl = document.getElementById('ocrStatus');
            const btnEl = document.getElementById('ocrBtn');

            if (pdfHasText) {
                statusEl.textContent = 'Text layer detected';
                statusEl.className = 'ocr-status';
                statusEl.style.display = 'inline-block';
                btnEl.style.display = 'none';
            } else {
                statusEl.textContent = 'No text layer';
                statusEl.className = 'ocr-status warning';
                statusEl.style.display = 'inline-block';
                btnEl.style.display = 'inline-block';
            }
        }

        async function runOcrOnCurrentPage() {
            const btn = document.getElementById('ocrBtn');
            const statusEl = document.getElementById('ocrStatus');
            btn.classList.add('loading');

            try {
                const pdf = window.currentPdf;
                if (!pdf) return;

                // Initialize Tesseract worker if needed
                if (!ocrWorker) {
                    statusEl.textContent = 'Loading OCR engine...';
                    ocrWorker = await Tesseract.createWorker('eng');
                }

                // Process all pages
                for (let num = 1; num <= pdf.numPages; num++) {
                    statusEl.textContent = `OCR: page ${num}/${pdf.numPages}`;

                    const canvas = document.getElementById('page-' + num);
                    const textLayerDiv = document.getElementById('text-layer-' + num);
                    if (!canvas || !textLayerDiv) continue;

                    // Get image data from canvas
                    const imageData = canvas.toDataURL('image/png');

                    // Run OCR
                    const { data } = await ocrWorker.recognize(imageData);

                    // Clear existing text layer and add OCR results
                    textLayerDiv.innerHTML = '';

                    // Process OCR words with position info
                    const words = data.words
                        .filter(word => word.text && word.text.trim())
                        .map(word => ({
                            text: word.text,
                            x: word.bbox.x0,
                            y: word.bbox.y0,
                            width: word.bbox.x1 - word.bbox.x0,
                            height: word.bbox.y1 - word.bbox.y0
                        }));

                    // Detect columns
                    const canvasWidth = canvas.width;
                    const midpoint = canvasWidth / 2;
                    const leftWords = words.filter(w => w.x + w.width / 2 < midpoint);
                    const rightWords = words.filter(w => w.x + w.width / 2 >= midpoint);
                    const isTwoColumn = leftWords.length > 10 && rightWords.length > 10;

                    if (isTwoColumn) {
                        // Create separate containers for each column
                        const leftContainer = document.createElement('div');
                        leftContainer.className = 'column-container left-column';
                        const rightContainer = document.createElement('div');
                        rightContainer.className = 'column-container right-column';

                        leftWords.sort((a, b) => a.y - b.y);
                        rightWords.sort((a, b) => a.y - b.y);

                        // Render left column
                        leftWords.forEach(word => {
                            const span = document.createElement('span');
                            span.textContent = word.text + ' ';
                            span.style.left = word.x + 'px';
                            span.style.top = word.y + 'px';
                            span.style.fontSize = word.height * 0.8 + 'px';
                            span.style.letterSpacing = '0.5px';
                            leftContainer.appendChild(span);
                        });

                        // Render right column (no offset needed with clip-path)
                        rightWords.forEach(word => {
                            const span = document.createElement('span');
                            span.textContent = word.text + ' ';
                            span.style.left = word.x + 'px';
                            span.style.top = word.y + 'px';
                            span.style.fontSize = word.height * 0.8 + 'px';
                            span.style.letterSpacing = '0.5px';
                            rightContainer.appendChild(span);
                        });

                        textLayerDiv.appendChild(leftContainer);
                        textLayerDiv.appendChild(rightContainer);
                    } else {
                        // Single column
                        const sortedWords = words.sort((a, b) => {
                            const yDiff = a.y - b.y;
                            if (Math.abs(yDiff) > 10) return yDiff;
                            return a.x - b.x;
                        });

                        sortedWords.forEach(word => {
                            const span = document.createElement('span');
                            span.textContent = word.text + ' ';
                            span.style.left = word.x + 'px';
                            span.style.top = word.y + 'px';
                            span.style.fontSize = word.height * 0.8 + 'px';
                            span.style.letterSpacing = '0.5px';
                            textLayerDiv.appendChild(span);
                        });
                    }
                }

                // Update status
                statusEl.textContent = 'OCR complete';
                statusEl.className = 'ocr-status';
                btn.style.display = 'none';
                showColumnToggleIfNeeded();

            } catch (e) {
                console.error('OCR failed:', e);
                statusEl.textContent = 'OCR failed';
                statusEl.className = 'ocr-status warning';
            } finally {
                btn.classList.remove('loading');
            }
        }

        // =============================================
        // COLUMN MODE
        // =============================================

        let currentColumnMode = 'all';

        function setColumnMode(mode) {
            currentColumnMode = mode;

            // Update button states
            document.querySelectorAll('#columnToggle button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Apply mode to all text layers
            document.querySelectorAll('.textLayer').forEach(layer => {
                layer.classList.remove('column-mode-left', 'column-mode-right');
                if (mode === 'left') {
                    layer.classList.add('column-mode-left');
                } else if (mode === 'right') {
                    layer.classList.add('column-mode-right');
                }
            });
        }

        function showColumnToggleIfNeeded() {
            // Check if any text layer has column-marked spans
            const hasColumns = document.querySelector('.textLayer span[data-column]');
            const toggle = document.getElementById('columnToggle');
            if (toggle) {
                toggle.style.display = hasColumns ? 'flex' : 'none';
            }
        }

        // =============================================
        // ANNOTATIONS
        // =============================================

        async function loadAnnotations(readingId) {
            // Load from localStorage first as fallback
            const localAnnotations = JSON.parse(localStorage.getItem('metamodality_annotations') || '{}');
            annotations = { ...localAnnotations };

            // Try to load from Supabase (works for all users, not just logged in)
            if (db) {
                try {
                    const { data, error } = await db
                        .from('annotations')
                        .select('*')
                        .eq('reading_id', readingId)
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.warn('Supabase annotations error:', error);
                        updateStatus('error', 'Database error');
                    } else if (data && data.length > 0) {
                        // Merge Supabase data with local (Supabase takes priority for shared annotations)
                        const localItems = annotations[readingId] || [];
                        const supabaseIds = new Set(data.map(a => a.id));
                        // Keep local items that aren't in Supabase (user's unsaved annotations)
                        const localOnly = localItems.filter(a => !supabaseIds.has(a.id));
                        annotations[readingId] = [...data, ...localOnly];
                        updateStatus('online', 'Connected');
                    } else {
                        updateStatus('online', 'Connected');
                    }
                } catch (e) {
                    console.warn('Failed to load annotations:', e);
                    updateStatus('error', 'Connection failed');
                }
            } else {
                updateStatus('offline', 'Offline mode');
            }
            renderAnnotations();
        }

        function renderAnnotations() {
            const list = document.getElementById('annotationsList');
            const items = annotations[currentReading] || [];

            document.getElementById('annotationsCount').textContent = items.length > 0 ? `(${items.length})` : '';

            if (items.length === 0) {
                list.innerHTML = '<div class="annotations-empty">Select text to annotate, or click "+ Note" to add a pinned note.</div>';
                return;
            }

            list.innerHTML = items.map((a, index) => `
                <div class="annotation-item${a.pinned ? ' pinned' : ''}" data-id="${a.id}">
                    ${a.pinned
                        ? '<div class="annotation-quote">ðŸ“Œ Pinned note</div>'
                        : `<div class="annotation-quote">${escapeHtml(a.quote)}</div>`
                    }
                    ${a.comment ? `<div class="annotation-comment">${a.comment}</div>` : ''}
                    <div class="annotation-meta">${a.author_email || 'Anonymous'} Â· ${new Date(a.created_at).toLocaleDateString()}</div>
                    <div class="annotation-actions">
                        <button onclick="toggleReplyForm('${a.id}')">Reply</button>
                        ${(a.replies?.length || 0) > 0 ? `<span>${a.replies.length} ${a.replies.length === 1 ? 'reply' : 'replies'}</span>` : ''}
                    </div>
                    ${a.replies?.length > 0 ? `
                        <div class="annotation-replies">
                            ${a.replies.map(r => `
                                <div class="annotation-reply">
                                    <div class="annotation-comment">${r.comment}</div>
                                    <div class="annotation-meta">${r.author_email || 'Anonymous'} Â· ${new Date(r.created_at).toLocaleDateString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="reply-form" id="reply-form-${a.id}">
                        <div class="rtf-toolbar">
                            <button onclick="rtfCommandReply('${a.id}', 'bold')"><b>B</b></button>
                            <button onclick="rtfCommandReply('${a.id}', 'italic')"><i>I</i></button>
                            <button onclick="rtfCommandReply('${a.id}', 'underline')"><u>U</u></button>
                        </div>
                        <div class="rtf-editor" id="reply-editor-${a.id}" contenteditable="true" data-placeholder="Write a reply..."></div>
                        <div class="form-actions">
                            <button class="btn secondary" onclick="toggleReplyForm('${a.id}')">Cancel</button>
                            <button class="btn" onclick="saveReply('${a.id}')">Reply</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleReplyForm(annotationId) {
            const form = document.getElementById('reply-form-' + annotationId);
            form.classList.toggle('active');
            if (form.classList.contains('active')) {
                document.getElementById('reply-editor-' + annotationId).focus();
            }
        }

        function rtfCommandReply(annotationId, command) {
            document.execCommand(command, false, null);
            document.getElementById('reply-editor-' + annotationId).focus();
        }

        async function saveReply(annotationId) {
            const editor = document.getElementById('reply-editor-' + annotationId);
            const comment = editor.innerHTML.trim();
            if (!comment || !editor.innerText.trim()) {
                alert('Please enter a reply');
                return;
            }

            const reply = {
                id: Date.now().toString(),
                comment: comment,
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            // Find the annotation and add the reply
            const items = annotations[currentReading] || [];
            const annotation = items.find(a => a.id === annotationId);
            if (annotation) {
                if (!annotation.replies) annotation.replies = [];
                annotation.replies.push(reply);

                // Save to localStorage
                localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

                // Try to save to Supabase
                if (db && currentUser) {
                    try {
                        await db.from('annotations')
                            .update({ replies: annotation.replies })
                            .eq('id', annotationId);
                    } catch (e) {
                        console.warn('Failed to save reply to Supabase:', e);
                    }
                }
            }

            renderAnnotations();
        }

        // Text selection with column filtering
        document.addEventListener('mouseup', e => {
            // Small delay to let selection finalize
            setTimeout(() => {
                const selection = window.getSelection();
                let text = selection.toString().trim();

                // Check if selection is in PDF area
                const inPdfViewer = e.target.closest('.pdf-viewer') ||
                                    e.target.closest('.pdf-text-layer') ||
                                    e.target.closest('.pdf-page-container');

                // If column mode is active, filter selection to only include text from that column
                if (text.length > 5 && currentReading && inPdfViewer && currentColumnMode !== 'all') {
                    text = filterSelectionByColumn(selection, currentColumnMode);
                }

                if (text.length > 5 && currentReading && inPdfViewer) {
                    selectedText = text;
                    const popup = document.getElementById('selectionPopup');
                    popup.style.left = e.pageX + 'px';
                    popup.style.top = (e.pageY + 10) + 'px';
                    popup.style.display = 'block';
                }
            }, 10);
        });

        // Filter selection to only include text from the specified column
        function filterSelectionByColumn(selection, columnMode) {
            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;

            // Find all text nodes in the selection
            const textParts = [];
            const walker = document.createTreeWalker(
                container.nodeType === Node.TEXT_NODE ? container.parentElement : container,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            let node;
            while (node = walker.nextNode()) {
                // Check if this node is in the selection
                if (selection.containsNode(node, true)) {
                    // Check if node is in the correct column
                    const columnContainer = node.parentElement?.closest('.column-container');
                    if (columnContainer) {
                        const isLeftColumn = columnContainer.classList.contains('left-column');
                        const isRightColumn = columnContainer.classList.contains('right-column');

                        if ((columnMode === 'left' && isLeftColumn) ||
                            (columnMode === 'right' && isRightColumn)) {
                            textParts.push(node.textContent);
                        }
                    } else {
                        // Not in a column container, include it
                        textParts.push(node.textContent);
                    }
                }
            }

            return textParts.join(' ').replace(/\s+/g, ' ').trim();
        }

        document.addEventListener('mousedown', e => {
            if (!e.target.closest('.selection-popup')) {
                document.getElementById('selectionPopup').style.display = 'none';
            }
        });

        let isPinnedNote = false;

        function startAnnotation() {
            isPinnedNote = false;
            document.getElementById('selectionPopup').style.display = 'none';
            const quotePreview = document.getElementById('quotePreview');
            quotePreview.textContent = selectedText;
            quotePreview.classList.remove('pinned-note');
            const editor = document.getElementById('annotationComment');
            editor.innerHTML = '';
            editor.setAttribute('data-placeholder', 'Add your thoughts...');
            document.getElementById('annotationForm').classList.add('active');
        }

        function startPinnedNote() {
            if (!currentReading) {
                alert('Please select a reading first');
                return;
            }
            isPinnedNote = true;
            selectedText = '';
            const quotePreview = document.getElementById('quotePreview');
            quotePreview.textContent = 'ðŸ“Œ Pinned note (no highlighted text)';
            quotePreview.classList.add('pinned-note');
            const editor = document.getElementById('annotationComment');
            editor.innerHTML = '';
            editor.setAttribute('data-placeholder', 'Write your note about this reading...');
            document.getElementById('annotationForm').classList.add('active');
            editor.focus();
        }

        function cancelAnnotation() {
            document.getElementById('annotationForm').classList.remove('active');
            document.getElementById('quotePreview').classList.remove('pinned-note');
            const editor = document.getElementById('annotationComment');
            editor.innerHTML = '';
            editor.setAttribute('data-placeholder', 'Add your thoughts...');
            selectedText = '';
            isPinnedNote = false;
        }

        // RTF Editor commands
        function rtfCommand(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('annotationComment').focus();
        }

        async function saveAnnotation() {
            if (!currentReading) return;
            if (!isPinnedNote && !selectedText) return;

            const editor = document.getElementById('annotationComment');
            const comment = editor.innerHTML.trim();
            const commentText = editor.innerText.trim();
            if (!commentText && isPinnedNote) {
                alert('Please enter a note');
                return;
            }
            const annotation = {
                id: Date.now().toString(),
                reading_id: currentReading,
                quote: isPinnedNote ? '' : selectedText,
                comment: comment,  // Now stores HTML
                pinned: isPinnedNote,
                replies: [],  // Initialize empty replies array
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            // Add to local state
            if (!annotations[currentReading]) annotations[currentReading] = [];
            annotations[currentReading].unshift(annotation);

            // Always save to localStorage as backup
            localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

            // Try to save to Supabase if logged in
            if (db && currentUser) {
                annotation.user_id = currentUser.id;
                try {
                    const { error } = await db.from('annotations').insert([annotation]);
                    if (error) console.warn('Supabase save error:', error);
                } catch (e) {
                    console.warn('Failed to save to Supabase:', e);
                }
            }

            renderAnnotations();
            renderActivityStream();  // Update home screen activity
            cancelAnnotation();
        }

        // =============================================
        // DISCUSS VIEW
        // =============================================

        async function loadFeed() {
            if (db) {
                try {
                    const { data } = await db
                        .from('posts')
                        .select('*')
                        .order('published_at', { ascending: false });

                    if (data) posts = data;
                } catch (e) {
                    console.warn('Failed to load posts:', e);
                }
            }
            renderFeed();
        }

        function renderFeed() {
            const container = document.getElementById('postsContainer');

            if (posts.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 60px 20px;">No posts yet. Switch to Write to share your thoughts.</div>';
                return;
            }

            container.innerHTML = posts.map(p => `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-avatar">${(p.author_email || 'A')[0].toUpperCase()}</div>
                        <div>
                            <div class="post-author">${p.author_email || 'Anonymous'}</div>
                            <div class="post-date">${new Date(p.published_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="post-title">${p.title}</div>
                    <div class="post-content">${marked.parse(p.content || '')}</div>
                    ${p.linked_readings?.length ? `<div class="post-links">ðŸ“Ž ${p.linked_readings.join(', ')}</div>` : ''}
                </div>
            `).join('');

            // Also update home view
            renderRecentPosts();
        }

        function renderRecentPosts() {
            const container = document.getElementById('recentPosts');
            const recent = posts.slice(0, 3);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">No posts yet.</div>';
                return;
            }

            container.innerHTML = recent.map(p => `
                <div class="activity-item" onclick="switchView('discuss')" style="cursor: pointer;">
                    <span class="author">${p.author_email?.split('@')[0] || 'Someone'}</span>
                    <span class="action">posted</span>
                    <span class="target">"${p.title}"</span>
                    <span class="time">${new Date(p.published_at).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        // =============================================
        // WRITE VIEW
        // =============================================

        async function loadNotes() {
            if (db && currentUser) {
                try {
                    const { data } = await db
                        .from('notes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('updated_at', { ascending: false });

                    if (data) notes = data;
                } catch (e) {
                    console.warn('Failed to load notes:', e);
                }
            } else {
                notes = JSON.parse(localStorage.getItem('metamodality_notes') || '[]');
            }
            renderNotesList();
        }

        function renderNotesList() {
            const container = document.getElementById('notesList');

            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 30px;">No notes yet. Click "+ New" to start writing.</div>';
                return;
            }

            container.innerHTML = notes.map(n => `
                <div class="note-list-item ${editingNoteId === n.id ? 'active' : ''}" onclick="editNote('${n.id}')">
                    <div class="note-title">${n.title || 'Untitled'}</div>
                    <div class="note-preview">${(n.content || '').substring(0, 60)}...</div>
                    <div class="note-date">${new Date(n.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function newNote() {
            editingNoteId = null;
            showEditor();
            document.getElementById('noteTitleInput').value = '';
            document.getElementById('noteContentInput').value = '';
            document.getElementById('editorLinks').innerHTML = 'Use [[Week Title]] to link to readings';
        }

        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            editingNoteId = id;
            showEditor();
            document.getElementById('noteTitleInput').value = note.title || '';
            document.getElementById('noteContentInput').value = note.content || '';
            parseNoteLinks(note.content || '');
            renderNotesList();
        }

        function showEditor() {
            document.getElementById('editorContainer').style.display = 'none';
            document.getElementById('editorActive').style.display = 'flex';
        }

        function parseNoteLinks(content) {
            const links = content.match(/\[\[([^\]]+)\]\]/g) || [];
            const linksEl = document.getElementById('editorLinks');

            if (links.length === 0) {
                linksEl.innerHTML = 'Use [[Week Title]] to link to readings';
                return;
            }

            linksEl.innerHTML = 'Links: ' + links.map(l => {
                const text = l.replace(/\[\[|\]\]/g, '');
                return `<span class="editor-link">${text}</span>`;
            }).join('');
        }

        document.getElementById('noteContentInput')?.addEventListener('input', e => {
            parseNoteLinks(e.target.value);
        });

        async function saveNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;
            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const note = {
                title,
                content,
                linked_readings: links,
                updated_at: new Date().toISOString()
            };

            if (db && currentUser) {
                note.user_id = currentUser.id;
                try {
                    if (editingNoteId) {
                        await db.from('notes').update(note).eq('id', editingNoteId);
                        const idx = notes.findIndex(n => n.id === editingNoteId);
                        if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                    } else {
                        const { data } = await db.from('notes').insert([note]).select();
                        if (data?.[0]) {
                            notes.unshift(data[0]);
                            editingNoteId = data[0].id;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to save:', e);
                }
            } else {
                if (editingNoteId) {
                    const idx = notes.findIndex(n => n.id === editingNoteId);
                    if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                } else {
                    note.id = Date.now().toString();
                    note.created_at = note.updated_at;
                    notes.unshift(note);
                    editingNoteId = note.id;
                }
                localStorage.setItem('metamodality_notes', JSON.stringify(notes));
            }

            renderNotesList();
        }

        async function publishNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;

            if (!title || !content) {
                alert('Please add a title and content before publishing.');
                return;
            }

            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const post = {
                title,
                content,
                linked_readings: links,
                published_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous',
                reactions: {}
            };

            if (db && currentUser) {
                post.author_id = currentUser.id;
                try {
                    const { data } = await db.from('posts').insert([post]).select();
                    if (data?.[0]) posts.unshift(data[0]);
                } catch (e) {
                    console.warn('Failed to publish:', e);
                }
            } else {
                post.id = Date.now().toString();
                posts.unshift(post);
            }

            renderFeed();
            switchView('discuss');
        }

        // =============================================
        // AUTHENTICATION
        // =============================================

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('authEmail').focus();
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authMessage').style.display = 'none';
        }

        async function sendMagicLink() {
            const email = document.getElementById('authEmail').value;
            if (!email) return;

            const msgEl = document.getElementById('authMessage');

            if (db) {
                try {
                    const { error } = await db.auth.signInWithOtp({
                        email,
                        options: { emailRedirectTo: window.location.href }
                    });

                    if (error) throw error;

                    msgEl.className = 'message success';
                    msgEl.textContent = 'Check your email for the magic link!';
                    msgEl.style.display = 'block';
                } catch (e) {
                    msgEl.className = 'message error';
                    msgEl.textContent = e.message || 'Failed to send link';
                    msgEl.style.display = 'block';
                }
            }
        }

        function updateAuthUI(user) {
            const btn = document.getElementById('authBtn');
            if (user) {
                btn.outerHTML = `<div class="user-avatar" onclick="signOut()" title="Sign out">${user.email[0].toUpperCase()}</div>`;
            } else {
                const existing = document.querySelector('.user-avatar');
                if (existing) {
                    existing.outerHTML = `<button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>`;
                }
            }
        }

        async function signOut() {
            if (db) {
                await db.auth.signOut();
            }
            currentUser = null;
            location.reload();
        }

        // Start
        init();
    </script>
</body>
</html>
