<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metamodality ‚Äî Reading Group Workspace</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #f5f4f0;
            --bg-sidebar: #eae8e4;
            --bg-panel: #ffffff;
            --bg-editor: #fffcf8;
            --border: #e0ddd5;
            --text: #3d3929;
            --text-muted: #8b8579;
            --text-bright: #1a1815;
            --accent: #da7756;
            --accent-hover: #c4684a;
            --highlight: #f0ebe3;
            --success: #5a9a6e;
            --warning: #b8860b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== TOP BAR ========== */
        .topbar {
            height: 44px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 15px;
            gap: 15px;
            flex-shrink: 0;
        }
        .topbar h1 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .topbar .subtitle {
            font-size: 11px;
            color: var(--text-muted);
            margin-left: -10px;
        }
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
            margin-left: auto;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .status-dot.connected { background: var(--success); }
        .status-dot.syncing { background: var(--warning); animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        .topbar-actions { display: flex; gap: 8px; }
        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 6px 14px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn.secondary {
            background: var(--bg-panel);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn.secondary:hover { background: var(--highlight); }
        .user-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        /* ========== MAIN LAYOUT ========== */
        .main-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ========== LEFT SIDEBAR - SCHEDULE ========== */
        .sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s;
        }
        .sidebar.collapsed { width: 40px; }
        .sidebar.collapsed .sidebar-content,
        .sidebar.collapsed .sidebar-header span { display: none; }

        .sidebar-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-dark);
        }
        .collapse-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px 8px;
            font-size: 10px;
            border-radius: 3px;
        }
        .collapse-btn:hover { background: var(--border); color: var(--text); }
        .sidebar.collapsed .collapse-btn { transform: rotate(180deg); }

        .sidebar-header span {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
        }

        /* Unit headers */
        .unit-group { margin-bottom: 4px; }
        .unit-header {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-bright);
            gap: 6px;
            user-select: none;
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
        }
        .unit-header:hover { background: var(--highlight); }
        .unit-header .toggle {
            font-size: 9px;
            color: var(--text-muted);
            transition: transform 0.2s;
        }
        .unit-header.collapsed .toggle { transform: rotate(-90deg); }
        .unit-children { }
        .unit-children.collapsed { display: none; }

        /* Week items */
        .week-item {
            display: flex;
            align-items: center;
            padding: 8px 12px 8px 24px;
            cursor: pointer;
            font-size: 12px;
            gap: 8px;
            color: var(--text);
            border-left: 2px solid transparent;
        }
        .week-item:hover { background: var(--highlight); }
        .week-item.selected {
            background: var(--highlight);
            border-left-color: var(--accent);
        }
        .week-item .week-num {
            font-size: 10px;
            color: var(--text-muted);
            min-width: 24px;
        }
        .week-item .week-title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .week-item .week-date {
            font-size: 10px;
            color: var(--text-muted);
        }

        /* Reading items */
        .reading-list { margin-left: 24px; }
        .reading-list.collapsed { display: none; }
        .reading-item {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            gap: 6px;
            color: var(--text-muted);
            border-left: 2px solid transparent;
        }
        .reading-item:hover {
            background: var(--highlight);
            color: var(--text);
        }
        .reading-item.selected {
            background: #e8f4fc;
            border-left-color: var(--accent);
            color: var(--text-bright);
        }
        .reading-item .icon { font-size: 10px; }
        .reading-item .title {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reading-item .pages {
            font-size: 9px;
            color: var(--text-muted);
            background: var(--bg-dark);
            padding: 1px 5px;
            border-radius: 8px;
        }

        /* ========== CENTER - VIEWER ========== */
        .viewer-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-editor);
            min-width: 0;
        }
        .viewer-header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-panel);
        }
        .viewer-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            flex: 1;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .viewer-actions { display: flex; gap: 8px; }

        .viewer-content {
            flex: 1;
            overflow: auto;
            background: #e8e4dc;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 10px;
        }
        .viewer-content canvas {
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            max-width: 100%;
        }

        .viewer-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 15px;
        }
        .viewer-empty-icon { font-size: 48px; opacity: 0.5; }
        .viewer-empty-text { font-size: 14px; }

        .pdf-controls {
            position: sticky;
            top: 0;
            background: var(--bg-panel);
            padding: 8px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-radius: 5px;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .pdf-controls span { font-size: 12px; }
        .pdf-controls button {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 4px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        .pdf-controls button:hover { background: var(--highlight); }

        /* ========== RIGHT PANEL - CONTEXT ========== */
        .context-panel {
            width: 320px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s;
        }
        .context-panel.collapsed { width: 40px; }
        .context-panel.collapsed .panel-content,
        .context-panel.collapsed .context-tabs { display: none; }

        .panel-header {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-dark);
        }
        .panel-header h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            font-weight: 600;
        }
        .context-panel.collapsed .panel-header h3 { display: none; }

        /* Context tabs */
        .context-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-dark);
        }
        .context-tab {
            flex: 1;
            padding: 10px 8px;
            font-size: 11px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        .context-tab:hover { color: var(--text); background: var(--highlight); }
        .context-tab.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
            background: var(--bg-panel);
        }

        .panel-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        .tab-panel {
            display: none;
            flex: 1;
            overflow: auto;
            flex-direction: column;
        }
        .tab-panel.active { display: flex; }

        /* Focus tab */
        .focus-content { padding: 15px; }
        .focus-week {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 5px;
        }
        .focus-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 12px;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .focus-text {
            font-size: 13px;
            line-height: 1.6;
            color: var(--text);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .focus-readings {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .focus-readings h4 {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 8px;
        }
        .focus-reading-item {
            padding: 8px;
            margin-bottom: 6px;
            background: var(--bg-dark);
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .focus-reading-item:hover { background: var(--highlight); }

        /* Annotations tab */
        .annotations-list { flex: 1; overflow-y: auto; }
        .annotation-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
        }
        .annotation-quote {
            font-size: 12px;
            font-style: italic;
            color: var(--text);
            margin-bottom: 6px;
            padding-left: 10px;
            border-left: 3px solid var(--accent);
        }
        .annotation-comment {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .annotation-meta {
            font-size: 10px;
            color: var(--text-muted);
        }
        .annotations-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        .annotation-form {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            display: none;
        }
        .annotation-form.active { display: block; }
        .annotation-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            resize: vertical;
            min-height: 60px;
            margin-bottom: 10px;
        }
        .annotation-form .selected-quote {
            font-size: 11px;
            font-style: italic;
            color: var(--text-muted);
            margin-bottom: 10px;
            padding: 8px;
            background: var(--bg-panel);
            border-radius: 4px;
            max-height: 60px;
            overflow-y: auto;
        }
        .color-picker {
            display: flex;
            gap: 6px;
            margin-bottom: 10px;
        }
        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
        }
        .color-dot.selected { border-color: var(--text-bright); }
        .color-dot.yellow { background: #fef3c7; }
        .color-dot.green { background: #d1fae5; }
        .color-dot.blue { background: #dbeafe; }
        .color-dot.purple { background: #ede9fe; }
        .form-buttons { display: flex; gap: 8px; justify-content: flex-end; }

        /* Notes tab */
        .notes-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notes-list { flex: 1; overflow-y: auto; }
        .note-item {
            padding: 12px 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .note-item:hover { background: var(--highlight); }
        .note-item.selected { background: var(--highlight); border-left: 2px solid var(--accent); }
        .note-item-title { font-size: 13px; color: var(--text-bright); margin-bottom: 3px; }
        .note-item-preview { font-size: 11px; color: var(--text-muted); }
        .note-item-meta { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

        .note-editor {
            display: none;
            flex-direction: column;
            flex: 1;
        }
        .note-editor.active { display: flex; }
        .note-editor-header {
            padding: 10px 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .note-title-input {
            flex: 1;
            border: none;
            font-size: 14px;
            font-weight: 500;
            background: transparent;
            color: var(--text-bright);
        }
        .note-title-input:focus { outline: none; }
        .note-content-input {
            flex: 1;
            border: none;
            padding: 15px;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            font-family: 'Monaco', 'Consolas', monospace;
        }
        .note-content-input:focus { outline: none; }
        .note-links {
            padding: 10px 15px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            font-size: 11px;
            color: var(--text-muted);
        }
        .note-link {
            display: inline-block;
            background: var(--bg-panel);
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 5px;
            cursor: pointer;
        }
        .note-link:hover { background: var(--highlight); }

        /* Feed tab */
        .feed-list { flex: 1; overflow-y: auto; }
        .feed-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .feed-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .feed-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
        }
        .feed-author { font-size: 13px; font-weight: 500; color: var(--text-bright); }
        .feed-date { font-size: 11px; color: var(--text-muted); }
        .feed-title { font-size: 15px; font-weight: 600; margin-bottom: 8px; color: var(--text-bright); }
        .feed-content { font-size: 13px; line-height: 1.5; color: var(--text); }
        .feed-links {
            margin-top: 10px;
            font-size: 11px;
        }
        .feed-actions {
            margin-top: 12px;
            display: flex;
            gap: 15px;
        }
        .feed-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .feed-action:hover { color: var(--accent); }
        .feed-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 12px;
        }

        /* Selection popup */
        .selection-popup {
            display: none;
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .selection-popup button {
            padding: 8px 16px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 12px;
            cursor: pointer;
        }
        .selection-popup button:hover { background: var(--accent-hover); }

        /* Auth modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-panel);
            border-radius: 8px;
            width: 400px;
            max-width: 90%;
            padding: 25px;
        }
        .modal h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-bright);
        }
        .modal p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 15px;
        }
        .modal input {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .modal input:focus { outline: none; border-color: var(--accent); }
        .modal .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal .message {
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            margin-bottom: 15px;
        }
        .modal .message.success { background: #d1fae5; color: #065f46; }
        .modal .message.error { background: #fee2e2; color: #991b1b; }

        /* Responsive */
        @media (max-width: 900px) {
            .sidebar { width: 220px; }
            .context-panel { width: 280px; }
        }
        @media (max-width: 700px) {
            .sidebar { display: none; }
            .context-panel {
                position: fixed;
                right: -100%;
                top: 44px;
                bottom: 0;
                width: 100%;
                transition: right 0.3s;
            }
            .context-panel.expanded { right: 0; }
        }
    </style>
</head>
<body>
    <!-- Top Bar -->
    <div class="topbar">
        <h1>Metamodality</h1>
        <span class="subtitle">An Inquiry into Forms of the Possible</span>
        <div class="status-indicator">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Connecting...</span>
        </div>
        <div class="topbar-actions">
            <button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Sidebar: Schedule -->
        <div class="sidebar" id="sidebarPanel">
            <div class="sidebar-header">
                <button class="collapse-btn" onclick="togglePanel('sidebarPanel')">‚óÄ</button>
                <span>Schedule</span>
            </div>
            <div class="sidebar-content" id="scheduleTree"></div>
        </div>

        <!-- Center: Viewer -->
        <div class="viewer-panel">
            <div class="viewer-header">
                <div class="viewer-title" id="viewerTitle">Select a reading</div>
                <div class="viewer-actions">
                    <button class="btn secondary" onclick="togglePanel('contextPanel')">Context ‚ñ∂</button>
                </div>
            </div>
            <div class="viewer-content" id="viewerContent">
                <div class="viewer-empty">
                    <div class="viewer-empty-icon">üìö</div>
                    <div class="viewer-empty-text">Select a reading from the schedule to begin</div>
                </div>
            </div>
        </div>

        <!-- Right Panel: Context -->
        <aside class="context-panel" id="contextPanel">
            <div class="panel-header">
                <button class="collapse-btn" onclick="togglePanel('contextPanel')">‚ñ∂</button>
                <h3>Context</h3>
            </div>
            <div class="context-tabs">
                <button class="context-tab active" data-tab="focus">Focus</button>
                <button class="context-tab" data-tab="annotations">Notes</button>
                <button class="context-tab" data-tab="notes">Write</button>
                <button class="context-tab" data-tab="feed">Feed</button>
            </div>
            <div class="panel-content">
                <!-- Focus Tab -->
                <div class="tab-panel active" id="tab-focus">
                    <div class="focus-content" id="focusContent">
                        <div class="focus-week">Welcome</div>
                        <div class="focus-title">Spring 2026</div>
                        <div class="focus-text">
                            Select a week from the schedule to see its focus question and readings.
                        </div>
                    </div>
                </div>

                <!-- Annotations Tab -->
                <div class="tab-panel" id="tab-annotations">
                    <div class="annotations-list" id="annotationsList">
                        <div class="annotations-empty">
                            Select text in a reading to create annotations.
                        </div>
                    </div>
                    <div class="annotation-form" id="annotationForm">
                        <div class="selected-quote" id="selectedQuote"></div>
                        <textarea id="annotationComment" placeholder="Add a comment..."></textarea>
                        <div class="color-picker">
                            <div class="color-dot yellow selected" data-color="yellow"></div>
                            <div class="color-dot green" data-color="green"></div>
                            <div class="color-dot blue" data-color="blue"></div>
                            <div class="color-dot purple" data-color="purple"></div>
                        </div>
                        <div class="form-buttons">
                            <button class="btn secondary" onclick="cancelAnnotation()">Cancel</button>
                            <button class="btn" onclick="saveAnnotation()">Save</button>
                        </div>
                    </div>
                </div>

                <!-- Notes Tab -->
                <div class="tab-panel" id="tab-notes">
                    <div class="notes-header">
                        <span style="font-size: 12px; color: var(--text-muted);">Your notes</span>
                        <button class="btn" onclick="newNote()">+ New</button>
                    </div>
                    <div class="notes-list" id="notesList"></div>
                    <div class="note-editor" id="noteEditor">
                        <div class="note-editor-header">
                            <input type="text" class="note-title-input" id="noteTitleInput" placeholder="Note title...">
                            <button class="btn secondary" onclick="closeNoteEditor()">‚úï</button>
                        </div>
                        <textarea class="note-content-input" id="noteContentInput" placeholder="Write your note... Use [[Week 1: Parmenides]] to link to readings."></textarea>
                        <div class="note-links" id="noteLinks"></div>
                        <div style="padding: 10px 15px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end;">
                            <button class="btn secondary" onclick="closeNoteEditor()">Cancel</button>
                            <button class="btn" onclick="saveNote()">Save</button>
                            <button class="btn" style="background: var(--success);" onclick="publishNote()">Publish</button>
                        </div>
                    </div>
                </div>

                <!-- Feed Tab -->
                <div class="tab-panel" id="tab-feed">
                    <div class="feed-list" id="feedList">
                        <div class="feed-empty">
                            No posts yet. Write a note and publish it to share with the group.
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Selection Popup -->
    <div class="selection-popup" id="selectionPopup">
        <button onclick="startAnnotation()">Annotate</button>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h3>Sign in</h3>
            <p>Enter your email to receive a magic link.</p>
            <div class="message" id="authMessage" style="display: none;"></div>
            <input type="email" id="authEmail" placeholder="your@email.com">
            <div class="btn-row">
                <button class="btn secondary" onclick="hideAuthModal()">Cancel</button>
                <button class="btn" onclick="sendMagicLink()">Send link</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // SUPABASE CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://tnasxupoydyoxibccovm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuYXN4dXBveWR5b3hpYmNjb3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDM5NjksImV4cCI6MjA4NDc3OTk2OX0.JTXSnyDDl5Ta3s7fDtnGfWcuicuchwP5A5WhRZ_exIg';

        let supabase = null;
        let currentUser = null;

        try {
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            updateStatus('connected', 'Connected');
        } catch (e) {
            console.warn('Supabase init failed:', e);
            updateStatus('offline', 'Offline mode');
        }

        // =============================================
        // COURSE DATA
        // =============================================
        const schedule = [
            {
                unit: "Unit I: Ancient and Medieval Foundations",
                weeks: [
                    { num: 1, date: "Feb 4", title: "Parmenides",
                      focus: "How can we think or speak \"what is not\"? This problem drives subsequent responses from Aristotle through Heidegger. Kingsley's reading situates Parmenides within an initiatory tradition.",
                      readings: [
                        { id: "w01_parmenides", title: "Parmenides, \"On Nature\"", pages: "~10 pp.", file: "readings/week01_parmenides.pdf" },
                        { id: "w01_kingsley", title: "Kingsley, In the Dark Places of Wisdom, ch. 1-4", pages: "~30 pp.", file: "readings/week01_kingsley.pdf" }
                    ]},
                    { num: 2, date: "Feb 11", title: "Aristotle",
                      focus: "Aristotle's potentiality (dynamis) answers Parmenides by locating possibility within beings themselves. The sea-battle problem asks whether future contingents have determinate truth values.",
                      readings: [
                        { id: "w02_meta", title: "Aristotle, Metaphysics Book Theta, ch. 1-3, 6-8", pages: "~30 pp.", file: "readings/week02_aristotle_metaphysics.pdf" },
                        { id: "w02_di", title: "Aristotle, De Interpretatione, ch. 9", pages: "~5 pp.", file: "readings/week02_aristotle_de_interpretatione.pdf" },
                        { id: "w02_witt", title: "Witt, \"The Priority of Actuality\"", pages: "~10 pp.", file: "readings/week02_witt.pdf" }
                    ]},
                    { num: 3, date: "Feb 18", title: "Avicenna",
                      focus: "Separating essence from existence, Avicenna makes contingency fundamental to everything except the Necessary Existent.",
                      readings: [
                        { id: "w03_avicenna", title: "Avicenna, Metaphysics of The Healing", pages: "~25 pp.", file: "readings/week03_avicenna.pdf" },
                        { id: "w03_adamson", title: "Adamson, \"From the Necessary Existent to God\"", pages: "~15 pp.", file: "readings/week03_adamson.pdf" }
                    ]},
                    { num: 4, date: "Feb 25", title: "Nagarjuna",
                      focus: "Does \"possibility\" mean anything once inherent existence drops out? Nagarjuna's tetralemma refuses the logical options that Western frameworks take for granted.",
                      readings: [
                        { id: "w04_nagarjuna", title: "Nagarjuna, Mulamadhyamakakarika, ch. 1, 15, 24", pages: "~20 pp.", file: "readings/week04_nagarjuna.pdf" },
                        { id: "w04_garfield", title: "Garfield, \"Dependent Arising and the Emptiness of Emptiness\"", pages: "~20 pp.", file: "readings/week04_garfield.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit II: Rationalism, Transcendentalism, and the Imaginal",
                weeks: [
                    { num: 5, date: "Mar 4", title: "Leibniz and Du Ch√¢telet",
                      focus: "Compossibility constrains which possibilities can coexist within a single world. The Monadology raises the question of what individuates possible worlds.",
                      readings: [
                        { id: "w05_monad", title: "Leibniz, Monadology", pages: "~15 pp.", file: "readings/week05_leibniz_monadology.pdf" },
                        { id: "w05_duchat", title: "Du Ch√¢telet, Institutions de physique, ch. 1-2", pages: "~15 pp.", file: "readings/week05_du_chatelet.pdf" },
                        { id: "w05_orig", title: "Leibniz, \"On the Ultimate Origination of Things\"", pages: "~5 pp.", file: "readings/week05_leibniz_origination.pdf" }
                    ]},
                    { num: 6, date: "Mar 11", title: "Kant",
                      focus: "What must any possible experience conform to? Kant's Postulates distinguish logical from real possibility.",
                      readings: [
                        { id: "w06_kant", title: "Kant, CPR: \"Postulates of Empirical Thought\"", pages: "~20 pp.", file: "readings/week06_kant.pdf" },
                        { id: "w06_leech", title: "Leech, \"The Function of Modal Judgment\"", pages: "~25 pp.", file: "readings/week06_leech.pdf" }
                    ]},
                    { num: 7, date: "Mar 18", title: "Sufi Metaphysics",
                      focus: "Ibn Arabi's imaginal world occupies a realm between sensible and intelligible, where possibilities take on form.",
                      readings: [
                        { id: "w07_rabia", title: "Rabia al-Adawiyya, selected sayings", pages: "~5 pp.", file: "readings/week07_rabia.pdf" },
                        { id: "w07_arabi", title: "Ibn Arabi, Fusus al-Hikam, \"Adam\"", pages: "~10 pp.", file: "readings/week07_ibn_arabi.pdf" },
                        { id: "w07_chittick", title: "Chittick, Sufi Path of Knowledge, ch. 1", pages: "~20 pp.", file: "readings/week07_chittick.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit III: Phenomenology, Pragmatism, and Nothingness",
                weeks: [
                    { num: 8, date: "Mar 25", title: "Husserl and Derrida",
                      focus: "Can a condition of possibility also be a condition of impossibility?",
                      readings: [
                        { id: "w08_husserl", title: "Husserl, \"The Origin of Geometry\"", pages: "~20 pp.", file: "readings/week08_husserl.pdf" },
                        { id: "w08_derrida", title: "Derrida, Introduction to \"Origin of Geometry\"", pages: "~25 pp.", file: "readings/week08_derrida.pdf" }
                    ]},
                    { num: 9, date: "Apr 1", title: "Heidegger and Arendt",
                      focus: "Possibility becomes constitutive of Dasein; death individualizes as the ownmost possibility. Arendt's natality offers a counter-emphasis.",
                      readings: [
                        { id: "w09_heid", title: "Heidegger, Being and Time, II.1 (¬ß¬ß46-53)", pages: "~30 pp.", file: "readings/week09_heidegger.pdf" },
                        { id: "w09_arendt", title: "Arendt, Human Condition, ch. 5 ¬ß¬ß24-26", pages: "~15 pp.", file: "readings/week09_arendt.pdf" }
                    ]},
                    { num: 10, date: "Apr 8", title: "Peirce",
                      focus: "Firstness is pure qualitative possibility, prior to relation or resistance.",
                      readings: [
                        { id: "w10_incap", title: "Peirce, \"Some Consequences of Four Incapacities\"", pages: "~20 pp.", file: "readings/week10_peirce_incapacities.pdf" },
                        { id: "w10_guess", title: "Peirce, \"A Guess at the Riddle\", ch. 1-3", pages: "~20 pp.", file: "readings/week10_peirce_guess.pdf" }
                    ]},
                    { num: 11, date: "Apr 15", title: "Nishida and Women Mystics",
                      focus: "Nishida's \"place of absolute nothingness\" holds particulars without being one itself. Lalla and Weil offer contemplative perspectives.",
                      readings: [
                        { id: "w11_lalla", title: "Lalla, selected vakhs", pages: "~5 pp.", file: "readings/week11_lalla.pdf" },
                        { id: "w11_nishida", title: "Nishida, Inquiry into the Good, Part I ch. 1-3", pages: "~25 pp.", file: "readings/week11_nishida.pdf" },
                        { id: "w11_weil", title: "Weil, Gravity and Grace, selections", pages: "~15 pp.", file: "readings/week11_weil.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit IV: Process, Contemplation, Emanation",
                weeks: [
                    { num: 12, date: "Apr 22", title: "Whitehead and Conway",
                      focus: "Eternal objects ingress into actual occasions as pure potentials. Conway's monist vitalism offers a 17th-century precursor.",
                      readings: [
                        { id: "w12_conway", title: "Conway, Principles of the Most Ancient Philosophy, ch. 6-7", pages: "~15 pp.", file: "readings/week12_conway.pdf" },
                        { id: "w12_white", title: "Whitehead, Science and the Modern World, ch. 11", pages: "~25 pp.", file: "readings/week12_whitehead.pdf" }
                    ]},
                    { num: 13, date: "Apr 29", title: "Contemplative Science",
                      focus: "Thompson and Varela bridge first-person contemplative methods and third-person neuroscience.",
                      readings: [
                        { id: "w13_thompson", title: "Thompson, Waking, Dreaming, Being, ch. 1", pages: "~25 pp.", file: "readings/week13_thompson.pdf" },
                        { id: "w13_varela", title: "Varela, \"Neurophenomenology\"", pages: "~20 pp.", file: "readings/week13_varela.pdf" }
                    ]},
                    { num: 14, date: "May 6", title: "Neoplatonism",
                      focus: "Possibility flows from the One's inexhaustible superabundance.",
                      readings: [
                        { id: "w14_plotinus", title: "Plotinus, Enneads V.1", pages: "~25 pp.", file: "readings/week14_plotinus.pdf" },
                        { id: "w14_proclus", title: "Proclus, Elements of Theology, Prop. 1-25", pages: "~15 pp.", file: "readings/week14_proclus.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit V: Mathematical and Formal Possibility",
                weeks: [
                    { num: 15, date: "May 13", title: "Hamkins and Barcan Marcus",
                      focus: "Many distinct concepts of set exist in Hamkins's multiverse. Barcan Marcus's work on modal logic provides formal foundations.",
                      readings: [
                        { id: "w15_marcus", title: "Barcan Marcus, \"Modalities and Intensional Languages\"", pages: "~15 pp.", file: "readings/week15_barcan_marcus.pdf" },
                        { id: "w15_hamkins", title: "Hamkins, \"The Set-Theoretic Multiverse\"", pages: "~25 pp.", file: "readings/week15_hamkins.pdf" }
                    ]},
                    { num: 16, date: "May 20", title: "Foster",
                      focus: "How do possibility spaces themselves get produced? Tradition constrains what becomes thinkable while furnishing materials for innovation.",
                      readings: [
                        { id: "w16_foster1", title: "Foster, \"Culture and Computation\"", pages: "~15 pp.", file: "readings/week16_foster_culture.pdf" },
                        { id: "w16_foster2", title: "Foster et al., \"Tradition and Innovation\"", pages: "~25 pp.", file: "readings/week16_foster_tradition.pdf" }
                    ]}
                ]
            }
        ];

        // State
        let currentWeek = null;
        let currentReading = null;
        let selectedText = '';
        let selectedColor = 'yellow';
        let annotations = {};
        let notes = [];
        let posts = [];
        let editingNoteId = null;

        // =============================================
        // UI FUNCTIONS
        // =============================================

        function updateStatus(status, text) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('statusText');
            dot.className = 'status-dot ' + status;
            txt.textContent = text;
        }

        function togglePanel(panelId) {
            document.getElementById(panelId).classList.toggle('collapsed');
        }

        function switchTab(tabName) {
            document.querySelectorAll('.context-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById('tab-' + tabName).classList.add('active');
        }

        // =============================================
        // SCHEDULE RENDERING
        // =============================================

        function buildSchedule() {
            const container = document.getElementById('scheduleTree');
            let html = '';

            schedule.forEach((unit, unitIdx) => {
                html += `
                    <div class="unit-group">
                        <div class="unit-header" onclick="toggleUnit(${unitIdx})">
                            <span class="toggle">‚ñº</span>
                            ${unit.unit}
                        </div>
                        <div class="unit-children" id="unit-${unitIdx}">
                            ${unit.weeks.map(week => `
                                <div class="week-item" data-week="${week.num}" onclick="selectWeek(${week.num})">
                                    <span class="week-num">${week.num}</span>
                                    <span class="week-title">${week.title}</span>
                                    <span class="week-date">${week.date}</span>
                                </div>
                                <div class="reading-list" id="readings-${week.num}">
                                    ${week.readings.map(r => `
                                        <div class="reading-item" data-id="${r.id}" onclick="event.stopPropagation(); loadReading('${r.id}', '${r.file}', ${week.num})">
                                            <span class="icon">üìÑ</span>
                                            <span class="title">${r.title}</span>
                                            <span class="pages">${r.pages}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function toggleUnit(unitIdx) {
            const header = document.querySelectorAll('.unit-header')[unitIdx];
            const children = document.getElementById('unit-' + unitIdx);
            header.classList.toggle('collapsed');
            children.classList.toggle('collapsed');
        }

        function selectWeek(num) {
            // Find week data
            let weekData = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    if (week.num === num) {
                        weekData = week;
                        break;
                    }
                }
            }
            if (!weekData) return;

            currentWeek = weekData;

            // Update selection
            document.querySelectorAll('.week-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.week-item[data-week="${num}"]`).classList.add('selected');

            // Toggle readings
            document.querySelectorAll('.reading-list').forEach(el => el.classList.add('collapsed'));
            document.getElementById('readings-' + num).classList.remove('collapsed');

            // Update focus panel
            updateFocusPanel(weekData);
        }

        function updateFocusPanel(week) {
            const content = document.getElementById('focusContent');
            content.innerHTML = `
                <div class="focus-week">Week ${week.num} ‚Äî ${week.date}</div>
                <div class="focus-title">${week.title}</div>
                <div class="focus-text">${week.focus}</div>
                <div class="focus-readings">
                    <h4>Readings</h4>
                    ${week.readings.map(r => `
                        <div class="focus-reading-item" onclick="loadReading('${r.id}', '${r.file}', ${week.num})">
                            ${r.title} <span style="color: var(--text-muted);">${r.pages}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // =============================================
        // PDF VIEWER
        // =============================================

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function loadReading(id, file, weekNum) {
            currentReading = id;

            // Update selection
            document.querySelectorAll('.reading-item').forEach(el => el.classList.remove('selected'));
            document.querySelector(`.reading-item[data-id="${id}"]`)?.classList.add('selected');

            // Find reading info
            let readingInfo = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    for (const r of week.readings) {
                        if (r.id === id) {
                            readingInfo = r;
                            break;
                        }
                    }
                }
            }

            document.getElementById('viewerTitle').textContent = readingInfo ? readingInfo.title : 'Loading...';
            document.getElementById('viewerContent').innerHTML = '<div class="viewer-empty"><div class="viewer-empty-icon">‚è≥</div><div class="viewer-empty-text">Loading PDF...</div></div>';

            // Select the week too
            if (weekNum) selectWeek(weekNum);

            // Load annotations
            await loadAnnotations(id);

            // Try to load PDF
            try {
                const response = await fetch(file);
                if (!response.ok) throw new Error('PDF not found');

                const arrayBuffer = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                let html = `
                    <div class="pdf-controls">
                        <span>Page <span id="currentPage">1</span> of ${pdf.numPages}</span>
                        <button onclick="prevPage()">‚óÄ</button>
                        <button onclick="nextPage()">‚ñ∂</button>
                    </div>
                `;

                for (let i = 1; i <= pdf.numPages; i++) {
                    html += `<canvas id="page-${i}" style="display: ${i === 1 ? 'block' : 'none'};"></canvas>`;
                }

                document.getElementById('viewerContent').innerHTML = html;
                window.currentPdf = pdf;
                window.currentPageNum = 1;

                renderPage(1);
            } catch (e) {
                document.getElementById('viewerContent').innerHTML = `
                    <div class="viewer-empty">
                        <div class="viewer-empty-icon">üìÑ</div>
                        <div class="viewer-empty-text">PDF not yet available<br><small style="color: var(--text-muted);">${file}</small></div>
                    </div>
                `;
            }
        }

        async function renderPage(num) {
            if (!window.currentPdf) return;

            const page = await window.currentPdf.getPage(num);
            const canvas = document.getElementById('page-' + num);
            const context = canvas.getContext('2d');

            const viewport = page.getViewport({ scale: 1.5 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport }).promise;

            // Show/hide pages
            for (let i = 1; i <= window.currentPdf.numPages; i++) {
                const c = document.getElementById('page-' + i);
                if (c) c.style.display = i === num ? 'block' : 'none';
            }

            document.getElementById('currentPage').textContent = num;
            window.currentPageNum = num;
        }

        function prevPage() {
            if (window.currentPageNum > 1) renderPage(window.currentPageNum - 1);
        }

        function nextPage() {
            if (window.currentPdf && window.currentPageNum < window.currentPdf.numPages) {
                renderPage(window.currentPageNum + 1);
            }
        }

        // =============================================
        // ANNOTATIONS
        // =============================================

        async function loadAnnotations(readingId) {
            if (supabase && currentUser) {
                try {
                    const { data, error } = await supabase
                        .from('annotations')
                        .select('*')
                        .eq('reading_id', readingId)
                        .order('created_at', { ascending: false });

                    if (!error && data) {
                        annotations[readingId] = data;
                    }
                } catch (e) {
                    console.warn('Failed to load annotations:', e);
                }
            } else {
                annotations = JSON.parse(localStorage.getItem('metamodality_annotations') || '{}');
            }
            renderAnnotations();
        }

        function renderAnnotations() {
            const list = document.getElementById('annotationsList');
            const items = annotations[currentReading] || [];

            if (items.length === 0) {
                list.innerHTML = '<div class="annotations-empty">Select text in a reading to create annotations.</div>';
                return;
            }

            list.innerHTML = items.map(a => `
                <div class="annotation-item" style="border-left: 3px solid ${getColorHex(a.color)};">
                    <div class="annotation-quote">${a.quote}</div>
                    ${a.comment ? `<div class="annotation-comment">${a.comment}</div>` : ''}
                    <div class="annotation-meta">${a.author_email || 'You'} ¬∑ ${new Date(a.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function getColorHex(color) {
            const colors = { yellow: '#fbbf24', green: '#34d399', blue: '#60a5fa', purple: '#a78bfa' };
            return colors[color] || colors.yellow;
        }

        function startAnnotation() {
            document.getElementById('selectionPopup').style.display = 'none';
            document.getElementById('selectedQuote').textContent = selectedText;
            document.getElementById('annotationComment').value = '';
            document.getElementById('annotationForm').classList.add('active');
            switchTab('annotations');
        }

        function cancelAnnotation() {
            document.getElementById('annotationForm').classList.remove('active');
            selectedText = '';
        }

        async function saveAnnotation() {
            if (!selectedText || !currentReading) return;

            const comment = document.getElementById('annotationComment').value;
            const annotation = {
                reading_id: currentReading,
                quote: selectedText,
                comment: comment,
                color: selectedColor,
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'You'
            };

            if (supabase && currentUser) {
                annotation.user_id = currentUser.id;
                try {
                    await supabase.from('annotations').insert([annotation]);
                } catch (e) {
                    console.warn('Failed to save annotation:', e);
                }
            }

            // Local update
            if (!annotations[currentReading]) annotations[currentReading] = [];
            annotations[currentReading].unshift(annotation);

            if (!supabase || !currentUser) {
                localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));
            }

            renderAnnotations();
            cancelAnnotation();
        }

        // Text selection
        document.addEventListener('mouseup', e => {
            const selection = window.getSelection();
            const text = selection.toString().trim();

            if (text.length > 10 && currentReading && e.target.closest('.viewer-content')) {
                selectedText = text;
                const popup = document.getElementById('selectionPopup');
                popup.style.left = e.pageX + 'px';
                popup.style.top = (e.pageY + 10) + 'px';
                popup.style.display = 'block';
            }
        });

        document.addEventListener('mousedown', e => {
            if (!e.target.closest('.selection-popup')) {
                document.getElementById('selectionPopup').style.display = 'none';
            }
        });

        // Color picker
        document.querySelectorAll('.color-dot').forEach(dot => {
            dot.addEventListener('click', () => {
                document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected'));
                dot.classList.add('selected');
                selectedColor = dot.dataset.color;
            });
        });

        // =============================================
        // NOTES
        // =============================================

        async function loadNotes() {
            if (supabase && currentUser) {
                try {
                    const { data, error } = await supabase
                        .from('notes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('updated_at', { ascending: false });

                    if (!error && data) notes = data;
                } catch (e) {
                    console.warn('Failed to load notes:', e);
                }
            } else {
                notes = JSON.parse(localStorage.getItem('metamodality_notes') || '[]');
            }
            renderNotes();
        }

        function renderNotes() {
            const list = document.getElementById('notesList');
            if (notes.length === 0) {
                list.innerHTML = '<div class="annotations-empty">No notes yet. Click "+ New" to create one.</div>';
                return;
            }

            list.innerHTML = notes.map(n => `
                <div class="note-item" onclick="editNote('${n.id}')">
                    <div class="note-item-title">${n.title || 'Untitled'}</div>
                    <div class="note-item-preview">${(n.content || '').substring(0, 80)}...</div>
                    <div class="note-item-meta">${new Date(n.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function newNote() {
            editingNoteId = null;
            document.getElementById('noteTitleInput').value = '';
            document.getElementById('noteContentInput').value = '';
            document.getElementById('noteLinks').innerHTML = '';
            document.getElementById('notesList').style.display = 'none';
            document.getElementById('noteEditor').classList.add('active');
            document.querySelector('.notes-header').style.display = 'none';
        }

        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            editingNoteId = id;
            document.getElementById('noteTitleInput').value = note.title || '';
            document.getElementById('noteContentInput').value = note.content || '';
            parseNoteLinks(note.content || '');
            document.getElementById('notesList').style.display = 'none';
            document.getElementById('noteEditor').classList.add('active');
            document.querySelector('.notes-header').style.display = 'none';
        }

        function closeNoteEditor() {
            document.getElementById('noteEditor').classList.remove('active');
            document.getElementById('notesList').style.display = 'block';
            document.querySelector('.notes-header').style.display = 'flex';
            editingNoteId = null;
        }

        function parseNoteLinks(content) {
            const links = content.match(/\[\[([^\]]+)\]\]/g) || [];
            const linksEl = document.getElementById('noteLinks');

            if (links.length === 0) {
                linksEl.innerHTML = 'Use [[Week 1: Parmenides]] to link to readings';
                return;
            }

            linksEl.innerHTML = 'Links: ' + links.map(l => {
                const text = l.replace(/\[\[|\]\]/g, '');
                return `<span class="note-link">${text}</span>`;
            }).join('');
        }

        document.getElementById('noteContentInput').addEventListener('input', e => {
            parseNoteLinks(e.target.value);
        });

        async function saveNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;
            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const note = {
                title,
                content,
                linked_readings: links,
                updated_at: new Date().toISOString()
            };

            if (supabase && currentUser) {
                note.user_id = currentUser.id;
                try {
                    if (editingNoteId) {
                        await supabase.from('notes').update(note).eq('id', editingNoteId);
                        const idx = notes.findIndex(n => n.id === editingNoteId);
                        if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                    } else {
                        const { data } = await supabase.from('notes').insert([note]).select();
                        if (data?.[0]) notes.unshift(data[0]);
                    }
                } catch (e) {
                    console.warn('Failed to save note:', e);
                }
            } else {
                if (editingNoteId) {
                    const idx = notes.findIndex(n => n.id === editingNoteId);
                    if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                } else {
                    note.id = Date.now().toString();
                    note.created_at = note.updated_at;
                    notes.unshift(note);
                }
                localStorage.setItem('metamodality_notes', JSON.stringify(notes));
            }

            renderNotes();
            closeNoteEditor();
        }

        async function publishNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;

            if (!title || !content) {
                alert('Please add a title and content before publishing.');
                return;
            }

            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const post = {
                title,
                content,
                linked_readings: links,
                published_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous',
                reactions: {}
            };

            if (supabase && currentUser) {
                post.author_id = currentUser.id;
                try {
                    const { data } = await supabase.from('posts').insert([post]).select();
                    if (data?.[0]) posts.unshift(data[0]);
                } catch (e) {
                    console.warn('Failed to publish:', e);
                }
            } else {
                post.id = Date.now().toString();
                posts.unshift(post);
                localStorage.setItem('metamodality_posts', JSON.stringify(posts));
            }

            renderFeed();
            closeNoteEditor();
            switchTab('feed');
        }

        // =============================================
        // FEED
        // =============================================

        async function loadFeed() {
            if (supabase) {
                try {
                    const { data, error } = await supabase
                        .from('posts')
                        .select('*')
                        .order('published_at', { ascending: false });

                    if (!error && data) posts = data;
                } catch (e) {
                    console.warn('Failed to load feed:', e);
                }
            } else {
                posts = JSON.parse(localStorage.getItem('metamodality_posts') || '[]');
            }
            renderFeed();
        }

        function renderFeed() {
            const list = document.getElementById('feedList');
            if (posts.length === 0) {
                list.innerHTML = '<div class="feed-empty">No posts yet. Write a note and publish it to share with the group.</div>';
                return;
            }

            list.innerHTML = posts.map(p => `
                <div class="feed-item">
                    <div class="feed-header">
                        <div class="feed-avatar">${(p.author_email || 'A')[0].toUpperCase()}</div>
                        <div>
                            <div class="feed-author">${p.author_email || 'Anonymous'}</div>
                            <div class="feed-date">${new Date(p.published_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="feed-title">${p.title}</div>
                    <div class="feed-content">${marked.parse(p.content || '')}</div>
                    ${p.linked_readings?.length ? `<div class="feed-links">üìé ${p.linked_readings.join(', ')}</div>` : ''}
                </div>
            `).join('');
        }

        // =============================================
        // AUTHENTICATION
        // =============================================

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('authEmail').focus();
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authMessage').style.display = 'none';
        }

        async function sendMagicLink() {
            const email = document.getElementById('authEmail').value;
            if (!email) return;

            const msgEl = document.getElementById('authMessage');

            if (supabase) {
                try {
                    const { error } = await supabase.auth.signInWithOtp({
                        email,
                        options: { emailRedirectTo: window.location.origin + window.location.pathname }
                    });

                    if (error) throw error;

                    msgEl.className = 'message success';
                    msgEl.textContent = 'Check your email for the magic link!';
                    msgEl.style.display = 'block';
                } catch (e) {
                    msgEl.className = 'message error';
                    msgEl.textContent = e.message || 'Failed to send link';
                    msgEl.style.display = 'block';
                }
            }
        }

        function updateAuthUI(user) {
            const btn = document.getElementById('authBtn');
            if (user) {
                btn.innerHTML = `<span class="user-avatar">${user.email[0].toUpperCase()}</span>`;
                btn.onclick = signOut;
            } else {
                btn.textContent = 'Sign In';
                btn.onclick = showAuthModal;
            }
        }

        async function signOut() {
            if (supabase) {
                await supabase.auth.signOut();
            }
            currentUser = null;
            updateAuthUI(null);
        }

        // =============================================
        // TABS
        // =============================================

        document.querySelectorAll('.context-tab').forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });

        // =============================================
        // INITIALIZATION
        // =============================================

        buildSchedule();
        loadFeed();

        if (supabase) {
            supabase.auth.onAuthStateChange((event, session) => {
                if (session?.user) {
                    currentUser = session.user;
                    updateAuthUI(currentUser);
                    hideAuthModal();
                    updateStatus('connected', 'Synced');
                    loadNotes();
                    if (currentReading) loadAnnotations(currentReading);
                } else {
                    currentUser = null;
                    updateAuthUI(null);
                    updateStatus('offline', 'Sign in to sync');
                }
            });

            supabase.auth.getSession().then(({ data: { session } }) => {
                if (session?.user) {
                    currentUser = session.user;
                    updateAuthUI(currentUser);
                    updateStatus('connected', 'Synced');
                    loadNotes();
                }
            });
        } else {
            updateStatus('offline', 'Offline mode');
            notes = JSON.parse(localStorage.getItem('metamodality_notes') || '[]');
            renderNotes();
        }

        // Select first week by default
        selectWeek(1);
    </script>
</body>
</html>
