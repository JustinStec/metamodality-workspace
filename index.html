<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metamodality ‚Äî Reading Group</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #f5f4f0;
            --bg-sidebar: #eae8e4;
            --bg-panel: #ffffff;
            --bg-editor: #fffcf8;
            --border: #e0ddd5;
            --text: #3d3929;
            --text-muted: #8b8579;
            --text-bright: #1a1815;
            --accent: #da7756;
            --accent-hover: #c4684a;
            --highlight: #f0ebe3;
            --success: #5a9a6e;
            --warning: #b8860b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        header {
            height: 50px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            cursor: pointer;
        }

        nav {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }

        .nav-tab {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .nav-tab:hover { background: var(--highlight); color: var(--text); }
        .nav-tab.active { background: var(--accent); color: white; }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .status-dot.connected { background: var(--success); }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn.secondary {
            background: var(--bg-dark);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn.secondary:hover { background: var(--highlight); }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== MAIN CONTENT ========== */
        main {
            flex: 1;
            overflow: hidden;
        }

        .view {
            display: none;
            height: 100%;
            overflow: auto;
        }
        .view.active { display: block; }

        /* ========== HOME VIEW ========== */
        .home-view {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .home-hero {
            text-align: center;
            margin-bottom: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(139,90,43,0.08) 0%, rgba(101,67,33,0.04) 100%);
            border-radius: 16px;
            border: 1px solid rgba(139,90,43,0.15);
        }
        .home-hero h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 36px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }
        .home-hero .subtitle {
            font-size: 16px;
            color: var(--text-muted);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            margin-bottom: 24px;
        }
        .home-hero .epigraph {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-style: italic;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
            max-width: 560px;
            margin: 0 auto 12px;
        }
        .home-hero .epigraph-source {
            font-size: 13px;
            color: var(--text-muted);
        }
        .home-intro {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
            max-width: 640px;
            margin: 0 auto 40px;
            text-align: center;
        }

        .current-week {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .current-week-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 8px;
        }
        .current-week h2 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .current-week .focus {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            margin-bottom: 20px;
        }
        .current-week-readings {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .reading-card {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .reading-card:hover { background: var(--highlight); transform: translateX(4px); }
        .reading-card .icon { font-size: 18px; margin-right: 12px; }
        .reading-card .info { flex: 1; }
        .reading-card .title { font-size: 14px; color: var(--text-bright); }
        .reading-card .pages { font-size: 12px; color: var(--text-muted); }
        .reading-card .arrow { color: var(--text-muted); }

        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 700px) {
            .home-grid { grid-template-columns: 1fr; }
        }

        .home-section {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .home-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .home-section h3 .icon { font-size: 16px; }

        .activity-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-item .author { color: var(--accent); font-weight: 500; }
        .activity-item .action { color: var(--text-muted); }
        .activity-item .target { color: var(--text); }
        .activity-item .time { font-size: 11px; color: var(--text-muted); display: block; margin-top: 4px; }

        .empty-state {
            text-align: center;
            padding: 20px;
            color: var(--text-muted);
            font-size: 13px;
        }

        /* ========== SYLLABUS VIEW ========== */
        .syllabus-view {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .syllabus-view h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 28px;
            font-weight: normal;
            margin-bottom: 30px;
            color: var(--text-bright);
        }

        .unit {
            margin-bottom: 30px;
        }
        .unit-title {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .week-card {
            background: var(--bg-panel);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.15s;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
        }
        .week-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); transform: translateY(-2px); }
        .week-card-header {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 8px;
        }
        .week-card .week-num {
            font-size: 12px;
            color: var(--text-muted);
            min-width: 50px;
        }
        .week-card .week-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 18px;
            color: var(--text-bright);
        }
        .week-card .week-date {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
        }
        .week-card .week-focus {
            font-size: 13px;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        .week-card .week-readings {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .week-card .reading-tag {
            font-size: 11px;
            padding: 4px 10px;
            background: var(--bg-dark);
            border-radius: 12px;
            color: var(--text-muted);
        }

        /* ========== READ VIEW ========== */
        .read-view {
            display: none;
            height: 100%;
            flex-direction: row;
        }
        .read-view.active { display: flex; }

        .read-sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .read-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .read-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }

        .reading-list-item {
            padding: 12px 15px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s;
        }
        .reading-list-item:hover { background: var(--highlight); }
        .reading-list-item.active {
            background: var(--highlight);
            border-left-color: var(--accent);
        }
        .reading-list-item .week-label {
            font-size: 10px;
            color: var(--text-muted);
            margin-bottom: 4px;
        }
        .reading-list-item .reading-title {
            font-size: 13px;
            color: var(--text-bright);
            line-height: 1.4;
        }

        .pdf-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #525659;
            min-width: 0;
        }
        .pdf-header {
            padding: 12px 20px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .pdf-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
        }
        .pdf-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pdf-controls button {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .pdf-controls button:hover { background: var(--highlight); }
        .pdf-controls span { font-size: 12px; color: var(--text-muted); }

        .pdf-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }
        .pdf-viewer canvas {
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            max-width: 100%;
        }
        .pdf-page-container {
            position: relative;
        }
        .pdf-text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            opacity: 0.2;
            line-height: 1;
        }
        .pdf-text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            transform-origin: 0% 0%;
        }
        .pdf-text-layer ::selection {
            background: rgba(0, 100, 200, 0.3);
        }
        .pdf-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            gap: 15px;
        }
        .pdf-empty-icon { font-size: 48px; opacity: 0.5; }

        .annotations-panel {
            width: 320px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .annotations-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .annotations-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
        }
        .annotations-list {
            flex: 1;
            overflow-y: auto;
        }
        .annotation-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .annotation-quote {
            font-size: 13px;
            font-style: italic;
            color: var(--text);
            margin-bottom: 8px;
            padding-left: 12px;
            border-left: 3px solid var(--accent);
            line-height: 1.5;
        }
        .annotation-comment {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }
        .annotation-meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        .annotations-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .annotation-form {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            display: none;
        }
        .annotation-form.active { display: block; }
        .annotation-form .quote-preview {
            font-size: 12px;
            font-style: italic;
            color: var(--text-muted);
            padding: 10px;
            background: var(--bg-panel);
            border-radius: 6px;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }
        .annotation-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            resize: none;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .annotation-form textarea:focus { outline: none; border-color: var(--accent); }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* ========== DISCUSS VIEW ========== */
        .discuss-view {
            max-width: 700px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .discuss-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .discuss-header h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
        }

        .post-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }
        .post-author { font-size: 14px; font-weight: 500; color: var(--text-bright); }
        .post-date { font-size: 12px; color: var(--text-muted); }
        .post-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 20px;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .post-content {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text);
        }
        .post-content p { margin-bottom: 12px; }
        .post-links {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .post-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 20px;
        }
        .post-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .post-action:hover { color: var(--accent); }

        /* ========== WRITE VIEW ========== */
        .write-view {
            display: none;
            height: 100%;
            flex-direction: row;
        }
        .write-view.active { display: flex; }

        .notes-sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .notes-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notes-sidebar-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
        }
        .notes-list {
            flex: 1;
            overflow-y: auto;
        }
        .note-list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .note-list-item:hover { background: var(--highlight); }
        .note-list-item.active { background: var(--highlight); border-left: 3px solid var(--accent); }
        .note-list-item .note-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 4px;
        }
        .note-list-item .note-preview {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .note-list-item .note-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-editor);
        }
        .editor-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
        }
        .editor-title-input {
            font-size: 20px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--text-bright);
            flex: 1;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .editor-title-input:focus { outline: none; }
        .editor-title-input::placeholder { color: var(--text-muted); }

        .editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .editor-textarea {
            flex: 1;
            padding: 25px;
            border: none;
            font-size: 15px;
            line-height: 1.8;
            resize: none;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: var(--bg-editor);
            color: var(--text);
        }
        .editor-textarea:focus { outline: none; }
        .editor-textarea::placeholder { color: var(--text-muted); }

        .editor-footer {
            padding: 12px 25px;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-links {
            font-size: 12px;
            color: var(--text-muted);
        }
        .editor-link {
            display: inline-block;
            background: var(--bg-dark);
            padding: 3px 10px;
            border-radius: 12px;
            margin-right: 6px;
            cursor: pointer;
        }
        .editor-link:hover { background: var(--highlight); }

        .editor-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 15px;
        }
        .editor-empty-icon { font-size: 48px; opacity: 0.5; }

        /* ========== SELECTION POPUP ========== */
        .selection-popup {
            display: none;
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
        }
        .selection-popup button {
            padding: 10px 18px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 13px;
            cursor: pointer;
        }
        .selection-popup button:hover { background: var(--accent-hover); }

        /* ========== AUTH MODAL ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-panel);
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            padding: 30px;
        }
        .modal h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-bright);
        }
        .modal p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        .modal input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .modal input:focus { outline: none; border-color: var(--accent); }
        .modal .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal .message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        .modal .message.success { background: #d1fae5; color: #065f46; }
        .modal .message.error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo" onclick="switchView('home')">Metamodality</div>
        <nav>
            <button class="nav-tab active" data-view="home">Home</button>
            <button class="nav-tab" data-view="syllabus">Syllabus</button>
            <button class="nav-tab" data-view="read">Read</button>
            <button class="nav-tab" data-view="discuss">Discuss</button>
            <button class="nav-tab" data-view="write">Write</button>
        </nav>
        <div class="header-right">
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- HOME VIEW -->
        <div class="view active" id="view-home">
            <div class="home-view">
                <div class="home-hero">
                    <h1>An Inquiry into Forms of the Possible</h1>
                    <p class="subtitle">Center for Possible Minds ‚Äî Spring 2026</p>
                    <p class="epigraph">"What is it that it would not be right to say? That which is to be thought and spoken of must be. For it is there for being, but nothing is not."</p>
                    <p class="epigraph-source">‚Äî Parmenides</p>
                </div>

                <p class="home-intro">
                    From Parmenides through contemporary set theory, thinkers have asked what it means for something to be possible. This reading group traces possibility across traditions‚ÄîGreek, Islamic, Buddhist, phenomenological, pragmatist‚Äîasking how each configures the space between what is and what might be.
                </p>

                <div class="current-week" id="currentWeekCard">
                    <!-- Populated by JS -->
                </div>

                <div class="home-grid">
                    <div class="home-section">
                        <h3><span class="icon">üí¨</span> Recent Discussion</h3>
                        <div id="recentPosts">
                            <div class="empty-state">No posts yet. Be the first to share your thoughts.</div>
                        </div>
                    </div>
                    <div class="home-section">
                        <h3><span class="icon">‚ú®</span> Recent Annotations</h3>
                        <div id="recentAnnotations">
                            <div class="empty-state">Annotations from the group will appear here.</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SYLLABUS VIEW -->
        <div class="view" id="view-syllabus">
            <div class="syllabus-view">
                <h1>Schedule of Readings</h1>
                <div id="syllabusContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- READ VIEW -->
        <div class="view read-view" id="view-read">
            <div class="read-sidebar">
                <div class="read-sidebar-header">This Week's Readings</div>
                <div class="read-sidebar-content" id="readingsList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="pdf-container">
                <div class="pdf-header">
                    <div class="pdf-title" id="pdfTitle">Select a reading</div>
                    <div class="pdf-controls" id="pdfControls" style="display: none;">
                        <button onclick="prevPage()">‚Üê Prev</button>
                        <span>Page <span id="currentPage">1</span> of <span id="totalPages">1</span></span>
                        <button onclick="nextPage()">Next ‚Üí</button>
                    </div>
                </div>
                <div class="pdf-viewer" id="pdfViewer">
                    <div class="pdf-empty">
                        <div class="pdf-empty-icon">üìñ</div>
                        <div>Select a reading from the sidebar</div>
                    </div>
                </div>
            </div>
            <div class="annotations-panel">
                <div class="annotations-header">
                    <h3>Annotations</h3>
                    <span id="annotationsCount" style="font-size: 12px; color: var(--text-muted);"></span>
                </div>
                <div class="annotations-list" id="annotationsList">
                    <div class="annotations-empty">
                        Select text in the reading to create an annotation.
                    </div>
                </div>
                <div class="annotation-form" id="annotationForm">
                    <div class="quote-preview" id="quotePreview"></div>
                    <textarea id="annotationComment" placeholder="Add your thoughts..."></textarea>
                    <div class="form-actions">
                        <button class="btn secondary" onclick="cancelAnnotation()">Cancel</button>
                        <button class="btn" onclick="saveAnnotation()">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DISCUSS VIEW -->
        <div class="view" id="view-discuss">
            <div class="discuss-view">
                <div class="discuss-header">
                    <h1>Discussion</h1>
                    <button class="btn" onclick="switchView('write')">+ New Post</button>
                </div>
                <div id="postsContainer">
                    <div class="empty-state" style="padding: 60px 20px;">
                        No posts yet. Switch to Write to share your thoughts with the group.
                    </div>
                </div>
            </div>
        </div>

        <!-- WRITE VIEW -->
        <div class="view write-view" id="view-write">
            <div class="notes-sidebar">
                <div class="notes-sidebar-header">
                    <h3>Your Notes</h3>
                    <button class="btn" onclick="newNote()">+ New</button>
                </div>
                <div class="notes-list" id="notesList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="editor-container" id="editorContainer">
                <div class="editor-empty">
                    <div class="editor-empty-icon">‚úçÔ∏è</div>
                    <div>Select a note or create a new one</div>
                </div>
            </div>
            <div class="editor-active" id="editorActive" style="display: none; flex: 1; flex-direction: column;">
                <div class="editor-header">
                    <input type="text" class="editor-title-input" id="noteTitleInput" placeholder="Title...">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn secondary" onclick="saveNote()">Save</button>
                        <button class="btn" onclick="publishNote()">Publish</button>
                    </div>
                </div>
                <div class="editor-body">
                    <textarea class="editor-textarea" id="noteContentInput" placeholder="Write your thoughts...

Use [[Week 1: Parmenides]] to link to readings."></textarea>
                </div>
                <div class="editor-footer">
                    <div class="editor-links" id="editorLinks">
                        Use [[Week Title]] to link to readings
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Selection Popup -->
    <div class="selection-popup" id="selectionPopup">
        <button onclick="startAnnotation()">Annotate</button>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h3>Sign in</h3>
            <p>Enter your email to receive a magic link.</p>
            <div class="message" id="authMessage" style="display: none;"></div>
            <input type="email" id="authEmail" placeholder="your@email.com">
            <div class="btn-row">
                <button class="btn secondary" onclick="hideAuthModal()">Cancel</button>
                <button class="btn" onclick="sendMagicLink()">Send link</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://tnasxupoydyoxibccovm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuYXN4dXBveWR5b3hpYmNjb3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDM5NjksImV4cCI6MjA4NDc3OTk2OX0.JTXSnyDDl5Ta3s7fDtnGfWcuicuchwP5A5WhRZ_exIg';

        let db = null;
        let currentUser = null;

        try {
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.warn('Supabase init failed:', e);
        }

        // =============================================
        // SCHEDULE DATA
        // =============================================
        const schedule = [
            {
                unit: "Unit I: Ancient and Medieval Foundations",
                weeks: [
                    { num: 1, date: "Feb 4", title: "Parmenides",
                      focus: "How can we think or speak \"what is not\"? This problem drives subsequent responses from Aristotle through Heidegger.",
                      readings: [
                        { id: "w01_parmenides", title: "Parmenides, \"On Nature\"", pages: "~10 pp.", file: "readings/Week 1_Parmenides/Week 1_Parmenides.pdf" },
                        { id: "w01_kingsley", title: "Kingsley, In the Dark Places of Wisdom, ch. 1-4", pages: "~30 pp.", file: "readings/Week 1_Parmenides/Week 1_Kingsley.pdf" }
                    ]},
                    { num: 2, date: "Feb 11", title: "Aristotle",
                      focus: "Aristotle's potentiality (dynamis) answers Parmenides by locating possibility within beings themselves.",
                      readings: [
                        { id: "w02_meta", title: "Aristotle, Metaphysics Book Theta", pages: "~30 pp.", file: "readings/week02_aristotle_metaphysics.pdf" },
                        { id: "w02_di", title: "Aristotle, De Interpretatione, ch. 9", pages: "~5 pp.", file: "readings/week02_aristotle_di.pdf" },
                        { id: "w02_witt", title: "Witt, \"The Priority of Actuality\"", pages: "~10 pp.", file: "readings/week02_witt.pdf" }
                    ]},
                    { num: 3, date: "Feb 18", title: "Avicenna",
                      focus: "Separating essence from existence, Avicenna makes contingency fundamental to everything except the Necessary Existent.",
                      readings: [
                        { id: "w03_avicenna", title: "Avicenna, Metaphysics of The Healing", pages: "~25 pp.", file: "readings/week03_avicenna.pdf" },
                        { id: "w03_adamson", title: "Adamson, \"From the Necessary Existent to God\"", pages: "~15 pp.", file: "readings/week03_adamson.pdf" }
                    ]},
                    { num: 4, date: "Feb 25", title: "Nagarjuna",
                      focus: "Does \"possibility\" mean anything once inherent existence drops out? Nagarjuna's tetralemma refuses the logical options that Western frameworks take for granted.",
                      readings: [
                        { id: "w04_nagarjuna", title: "Nagarjuna, Mulamadhyamakakarika", pages: "~20 pp.", file: "readings/week04_nagarjuna.pdf" },
                        { id: "w04_garfield", title: "Garfield, \"Dependent Arising and the Emptiness of Emptiness\"", pages: "~20 pp.", file: "readings/week04_garfield.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit II: Rationalism, Transcendentalism, and the Imaginal",
                weeks: [
                    { num: 5, date: "Mar 4", title: "Leibniz and Du Ch√¢telet",
                      focus: "Compossibility constrains which possibilities can coexist within a single world.",
                      readings: [
                        { id: "w05_monad", title: "Leibniz, Monadology", pages: "~15 pp.", file: "readings/week05_leibniz_monadology.pdf" },
                        { id: "w05_duchat", title: "Du Ch√¢telet, Institutions de physique, ch. 1-2", pages: "~15 pp.", file: "readings/week05_du_chatelet.pdf" },
                        { id: "w05_orig", title: "Leibniz, \"On the Ultimate Origination of Things\"", pages: "~5 pp.", file: "readings/week05_leibniz_origination.pdf" }
                    ]},
                    { num: 6, date: "Mar 11", title: "Kant",
                      focus: "What must any possible experience conform to? Kant's Postulates distinguish logical from real possibility.",
                      readings: [
                        { id: "w06_kant", title: "Kant, CPR: \"Postulates of Empirical Thought\"", pages: "~20 pp.", file: "readings/week06_kant.pdf" },
                        { id: "w06_leech", title: "Leech, \"The Function of Modal Judgment\"", pages: "~25 pp.", file: "readings/week06_leech.pdf" }
                    ]},
                    { num: 7, date: "Mar 18", title: "Sufi Metaphysics",
                      focus: "Ibn Arabi's imaginal world occupies a realm between sensible and intelligible.",
                      readings: [
                        { id: "w07_rabia", title: "Rabia al-Adawiyya, selected sayings", pages: "~5 pp.", file: "readings/week07_rabia.pdf" },
                        { id: "w07_arabi", title: "Ibn Arabi, Fusus al-Hikam, \"Adam\"", pages: "~10 pp.", file: "readings/week07_ibn_arabi.pdf" },
                        { id: "w07_chittick", title: "Chittick, Sufi Path of Knowledge, ch. 1", pages: "~20 pp.", file: "readings/week07_chittick.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit III: Phenomenology, Pragmatism, and Nothingness",
                weeks: [
                    { num: 8, date: "Mar 25", title: "Husserl and Derrida",
                      focus: "Can a condition of possibility also be a condition of impossibility?",
                      readings: [
                        { id: "w08_husserl", title: "Husserl, \"The Origin of Geometry\"", pages: "~20 pp.", file: "readings/week08_husserl.pdf" },
                        { id: "w08_derrida", title: "Derrida, Introduction to \"Origin of Geometry\"", pages: "~25 pp.", file: "readings/week08_derrida.pdf" }
                    ]},
                    { num: 9, date: "Apr 1", title: "Heidegger and Arendt",
                      focus: "Possibility becomes constitutive of Dasein; death individualizes as the ownmost possibility.",
                      readings: [
                        { id: "w09_heid", title: "Heidegger, Being and Time, II.1", pages: "~30 pp.", file: "readings/week09_heidegger.pdf" },
                        { id: "w09_arendt", title: "Arendt, Human Condition, ch. 5", pages: "~15 pp.", file: "readings/week09_arendt.pdf" }
                    ]},
                    { num: 10, date: "Apr 8", title: "Peirce",
                      focus: "Firstness is pure qualitative possibility, prior to relation or resistance.",
                      readings: [
                        { id: "w10_incap", title: "Peirce, \"Some Consequences of Four Incapacities\"", pages: "~20 pp.", file: "readings/week10_peirce_incapacities.pdf" },
                        { id: "w10_guess", title: "Peirce, \"A Guess at the Riddle\"", pages: "~20 pp.", file: "readings/week10_peirce_guess.pdf" }
                    ]},
                    { num: 11, date: "Apr 15", title: "Nishida and Women Mystics",
                      focus: "Nishida's \"place of absolute nothingness\" holds particulars without being one itself.",
                      readings: [
                        { id: "w11_lalla", title: "Lalla, selected vakhs", pages: "~5 pp.", file: "readings/week11_lalla.pdf" },
                        { id: "w11_nishida", title: "Nishida, Inquiry into the Good", pages: "~25 pp.", file: "readings/week11_nishida.pdf" },
                        { id: "w11_weil", title: "Weil, Gravity and Grace, selections", pages: "~15 pp.", file: "readings/week11_weil.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit IV: Process, Contemplation, Emanation",
                weeks: [
                    { num: 12, date: "Apr 22", title: "Whitehead and Conway",
                      focus: "Eternal objects ingress into actual occasions as pure potentials.",
                      readings: [
                        { id: "w12_conway", title: "Conway, Principles of the Most Ancient Philosophy", pages: "~15 pp.", file: "readings/week12_conway.pdf" },
                        { id: "w12_white", title: "Whitehead, Science and the Modern World, ch. 11", pages: "~25 pp.", file: "readings/week12_whitehead.pdf" }
                    ]},
                    { num: 13, date: "Apr 29", title: "Contemplative Science",
                      focus: "Thompson and Varela bridge first-person contemplative methods and third-person neuroscience.",
                      readings: [
                        { id: "w13_thompson", title: "Thompson, Waking, Dreaming, Being, ch. 1", pages: "~25 pp.", file: "readings/week13_thompson.pdf" },
                        { id: "w13_varela", title: "Varela, \"Neurophenomenology\"", pages: "~20 pp.", file: "readings/week13_varela.pdf" }
                    ]},
                    { num: 14, date: "May 6", title: "Neoplatonism",
                      focus: "Possibility flows from the One's inexhaustible superabundance.",
                      readings: [
                        { id: "w14_plotinus", title: "Plotinus, Enneads V.1", pages: "~25 pp.", file: "readings/week14_plotinus.pdf" },
                        { id: "w14_proclus", title: "Proclus, Elements of Theology", pages: "~15 pp.", file: "readings/week14_proclus.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit V: Mathematical and Formal Possibility",
                weeks: [
                    { num: 15, date: "May 13", title: "Hamkins and Barcan Marcus",
                      focus: "Many distinct concepts of set exist in Hamkins's multiverse.",
                      readings: [
                        { id: "w15_marcus", title: "Barcan Marcus, \"Modalities and Intensional Languages\"", pages: "~15 pp.", file: "readings/week15_barcan_marcus.pdf" },
                        { id: "w15_hamkins", title: "Hamkins, \"The Set-Theoretic Multiverse\"", pages: "~25 pp.", file: "readings/week15_hamkins.pdf" }
                    ]},
                    { num: 16, date: "May 20", title: "Foster",
                      focus: "How do possibility spaces themselves get produced?",
                      readings: [
                        { id: "w16_foster1", title: "Foster, \"Culture and Computation\"", pages: "~15 pp.", file: "readings/week16_foster_culture.pdf" },
                        { id: "w16_foster2", title: "Foster et al., \"Tradition and Innovation\"", pages: "~25 pp.", file: "readings/week16_foster_tradition.pdf" }
                    ]}
                ]
            }
        ];

        // State
        let currentWeekNum = 1;
        let currentReading = null;
        let selectedText = '';
        let annotations = {};
        let notes = [];
        let posts = [];
        let editingNoteId = null;

        // =============================================
        // INITIALIZATION
        // =============================================

        function init() {
            updateStatus('connected', 'Connected');
            buildSyllabus();
            buildReadingsList();
            renderCurrentWeek();
            loadFeed();
            loadNotes();

            // Auth state
            if (db) {
                db.auth.onAuthStateChange((event, session) => {
                    if (session?.user) {
                        currentUser = session.user;
                        updateAuthUI(currentUser);
                        hideAuthModal();
                        loadNotes();
                    } else {
                        currentUser = null;
                        updateAuthUI(null);
                    }
                });

                db.auth.getSession().then(({ data: { session } }) => {
                    if (session?.user) {
                        currentUser = session.user;
                        updateAuthUI(currentUser);
                        loadNotes();
                    }
                });
            }

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });
        }

        function updateStatus(status, text) {
            document.getElementById('statusDot').className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = text;
        }

        // =============================================
        // VIEW SWITCHING
        // =============================================

        function switchView(viewName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            document.getElementById('view-' + viewName).classList.add('active');
        }

        // =============================================
        // HOME VIEW
        // =============================================

        function getCurrentWeek() {
            // For now, default to week 1. Could be date-based later.
            let week = null;
            for (const unit of schedule) {
                for (const w of unit.weeks) {
                    if (w.num === currentWeekNum) {
                        week = w;
                        break;
                    }
                }
            }
            return week;
        }

        function renderCurrentWeek() {
            const week = getCurrentWeek();
            if (!week) return;

            document.getElementById('currentWeekCard').innerHTML = `
                <div class="current-week-label">Week ${week.num} ‚Äî ${week.date}</div>
                <h2>${week.title}</h2>
                <p class="focus">${week.focus}</p>
                <div class="current-week-readings">
                    ${week.readings.map(r => `
                        <div class="reading-card" onclick="openReading('${r.id}')">
                            <span class="icon">üìÑ</span>
                            <div class="info">
                                <div class="title">${r.title}</div>
                                <div class="pages">${r.pages}</div>
                            </div>
                            <span class="arrow">‚Üí</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function openReading(readingId) {
            switchView('read');
            loadReading(readingId);
        }

        // =============================================
        // SYLLABUS VIEW
        // =============================================

        function buildSyllabus() {
            const container = document.getElementById('syllabusContent');
            let html = '';

            schedule.forEach(unit => {
                html += `<div class="unit">
                    <div class="unit-title">${unit.unit}</div>
                    ${unit.weeks.map(week => `
                        <div class="week-card" onclick="goToWeek(${week.num})">
                            <div class="week-card-header">
                                <span class="week-num">Week ${week.num}</span>
                                <span class="week-title">${week.title}</span>
                                <span class="week-date">${week.date}</span>
                            </div>
                            <div class="week-focus">${week.focus}</div>
                            <div class="week-readings">
                                ${week.readings.map(r => `<span class="reading-tag">${r.title.split(',')[0]}</span>`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>`;
            });

            container.innerHTML = html;
        }

        function goToWeek(num) {
            currentWeekNum = num;
            buildReadingsList();
            switchView('read');
        }

        // =============================================
        // READ VIEW
        // =============================================

        function buildReadingsList() {
            const week = getCurrentWeek();
            if (!week) return;

            const container = document.getElementById('readingsList');
            container.innerHTML = week.readings.map(r => `
                <div class="reading-list-item" data-id="${r.id}" onclick="loadReading('${r.id}')">
                    <div class="week-label">Week ${week.num}: ${week.title}</div>
                    <div class="reading-title">${r.title}</div>
                </div>
            `).join('');
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function loadReading(readingId) {
            currentReading = readingId;

            // Update sidebar selection
            document.querySelectorAll('.reading-list-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.reading-list-item[data-id="${readingId}"]`)?.classList.add('active');

            // Find reading info
            let readingInfo = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    for (const r of week.readings) {
                        if (r.id === readingId) {
                            readingInfo = r;
                            break;
                        }
                    }
                }
            }

            document.getElementById('pdfTitle').textContent = readingInfo?.title || 'Loading...';
            document.getElementById('pdfViewer').innerHTML = '<div class="pdf-empty"><div class="pdf-empty-icon">‚è≥</div><div>Loading...</div></div>';
            document.getElementById('pdfControls').style.display = 'none';

            // Load annotations
            await loadAnnotations(readingId);

            // Try to load PDF
            try {
                const response = await fetch(readingInfo.file);
                if (!response.ok) throw new Error('Not found');

                const arrayBuffer = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                window.currentPdf = pdf;
                window.currentPageNum = 1;

                document.getElementById('totalPages').textContent = pdf.numPages;
                document.getElementById('pdfControls').style.display = 'flex';

                const viewer = document.getElementById('pdfViewer');
                viewer.innerHTML = '';

                for (let i = 1; i <= pdf.numPages; i++) {
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.id = 'page-container-' + i;
                    pageContainer.style.display = i === 1 ? 'block' : 'none';

                    const canvas = document.createElement('canvas');
                    canvas.id = 'page-' + i;
                    pageContainer.appendChild(canvas);

                    const textLayer = document.createElement('div');
                    textLayer.className = 'pdf-text-layer';
                    textLayer.id = 'text-layer-' + i;
                    pageContainer.appendChild(textLayer);

                    viewer.appendChild(pageContainer);
                }

                renderPage(1);
            } catch (e) {
                document.getElementById('pdfViewer').innerHTML = `
                    <div class="pdf-empty">
                        <div class="pdf-empty-icon">üìÑ</div>
                        <div>PDF not yet available</div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">${readingInfo?.file}</div>
                    </div>
                `;
            }
        }

        async function renderPage(num) {
            if (!window.currentPdf) return;

            const page = await window.currentPdf.getPage(num);
            const canvas = document.getElementById('page-' + num);
            const context = canvas.getContext('2d');
            const textLayerDiv = document.getElementById('text-layer-' + num);

            const viewport = page.getViewport({ scale: 1.5 });
            canvas.height = viewport.height;
            canvas.width = viewport.width;

            await page.render({ canvasContext: context, viewport }).promise;

            // Render text layer for selection
            textLayerDiv.innerHTML = '';
            textLayerDiv.style.width = viewport.width + 'px';
            textLayerDiv.style.height = viewport.height + 'px';

            const textContent = await page.getTextContent();
            pdfjsLib.renderTextLayer({
                textContentSource: textContent,
                container: textLayerDiv,
                viewport: viewport,
                textDivs: []
            });

            for (let i = 1; i <= window.currentPdf.numPages; i++) {
                const container = document.getElementById('page-container-' + i);
                if (container) container.style.display = i === num ? 'block' : 'none';
            }

            document.getElementById('currentPage').textContent = num;
            window.currentPageNum = num;
        }

        function prevPage() {
            if (window.currentPageNum > 1) renderPage(window.currentPageNum - 1);
        }

        function nextPage() {
            if (window.currentPdf && window.currentPageNum < window.currentPdf.numPages) {
                renderPage(window.currentPageNum + 1);
            }
        }

        // =============================================
        // ANNOTATIONS
        // =============================================

        async function loadAnnotations(readingId) {
            if (db) {
                try {
                    const { data } = await db
                        .from('annotations')
                        .select('*')
                        .eq('reading_id', readingId)
                        .order('created_at', { ascending: false });

                    if (data) annotations[readingId] = data;
                } catch (e) {
                    console.warn('Failed to load annotations:', e);
                }
            }
            renderAnnotations();
        }

        function renderAnnotations() {
            const list = document.getElementById('annotationsList');
            const items = annotations[currentReading] || [];

            document.getElementById('annotationsCount').textContent = items.length > 0 ? `(${items.length})` : '';

            if (items.length === 0) {
                list.innerHTML = '<div class="annotations-empty">Select text in the reading to create an annotation.</div>';
                return;
            }

            list.innerHTML = items.map(a => `
                <div class="annotation-item">
                    <div class="annotation-quote">${a.quote}</div>
                    ${a.comment ? `<div class="annotation-comment">${a.comment}</div>` : ''}
                    <div class="annotation-meta">${a.author_email || 'Anonymous'} ¬∑ ${new Date(a.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        // Text selection
        document.addEventListener('mouseup', e => {
            const selection = window.getSelection();
            const text = selection.toString().trim();

            if (text.length > 10 && currentReading && e.target.closest('.pdf-viewer')) {
                selectedText = text;
                const popup = document.getElementById('selectionPopup');
                popup.style.left = e.pageX + 'px';
                popup.style.top = (e.pageY + 10) + 'px';
                popup.style.display = 'block';
            }
        });

        document.addEventListener('mousedown', e => {
            if (!e.target.closest('.selection-popup')) {
                document.getElementById('selectionPopup').style.display = 'none';
            }
        });

        function startAnnotation() {
            document.getElementById('selectionPopup').style.display = 'none';
            document.getElementById('quotePreview').textContent = selectedText;
            document.getElementById('annotationComment').value = '';
            document.getElementById('annotationForm').classList.add('active');
        }

        function cancelAnnotation() {
            document.getElementById('annotationForm').classList.remove('active');
            selectedText = '';
        }

        async function saveAnnotation() {
            if (!selectedText || !currentReading) return;

            const comment = document.getElementById('annotationComment').value;
            const annotation = {
                reading_id: currentReading,
                quote: selectedText,
                comment: comment,
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            if (db && currentUser) {
                annotation.user_id = currentUser.id;
                try {
                    await db.from('annotations').insert([annotation]);
                } catch (e) {
                    console.warn('Failed to save:', e);
                }
            }

            if (!annotations[currentReading]) annotations[currentReading] = [];
            annotations[currentReading].unshift(annotation);

            renderAnnotations();
            cancelAnnotation();
        }

        // =============================================
        // DISCUSS VIEW
        // =============================================

        async function loadFeed() {
            if (db) {
                try {
                    const { data } = await db
                        .from('posts')
                        .select('*')
                        .order('published_at', { ascending: false });

                    if (data) posts = data;
                } catch (e) {
                    console.warn('Failed to load posts:', e);
                }
            }
            renderFeed();
        }

        function renderFeed() {
            const container = document.getElementById('postsContainer');

            if (posts.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 60px 20px;">No posts yet. Switch to Write to share your thoughts.</div>';
                return;
            }

            container.innerHTML = posts.map(p => `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-avatar">${(p.author_email || 'A')[0].toUpperCase()}</div>
                        <div>
                            <div class="post-author">${p.author_email || 'Anonymous'}</div>
                            <div class="post-date">${new Date(p.published_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="post-title">${p.title}</div>
                    <div class="post-content">${marked.parse(p.content || '')}</div>
                    ${p.linked_readings?.length ? `<div class="post-links">üìé ${p.linked_readings.join(', ')}</div>` : ''}
                </div>
            `).join('');

            // Also update home view
            renderRecentPosts();
        }

        function renderRecentPosts() {
            const container = document.getElementById('recentPosts');
            const recent = posts.slice(0, 3);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">No posts yet.</div>';
                return;
            }

            container.innerHTML = recent.map(p => `
                <div class="activity-item" onclick="switchView('discuss')" style="cursor: pointer;">
                    <span class="author">${p.author_email?.split('@')[0] || 'Someone'}</span>
                    <span class="action">posted</span>
                    <span class="target">"${p.title}"</span>
                    <span class="time">${new Date(p.published_at).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        // =============================================
        // WRITE VIEW
        // =============================================

        async function loadNotes() {
            if (db && currentUser) {
                try {
                    const { data } = await db
                        .from('notes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('updated_at', { ascending: false });

                    if (data) notes = data;
                } catch (e) {
                    console.warn('Failed to load notes:', e);
                }
            } else {
                notes = JSON.parse(localStorage.getItem('metamodality_notes') || '[]');
            }
            renderNotesList();
        }

        function renderNotesList() {
            const container = document.getElementById('notesList');

            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 30px;">No notes yet. Click "+ New" to start writing.</div>';
                return;
            }

            container.innerHTML = notes.map(n => `
                <div class="note-list-item ${editingNoteId === n.id ? 'active' : ''}" onclick="editNote('${n.id}')">
                    <div class="note-title">${n.title || 'Untitled'}</div>
                    <div class="note-preview">${(n.content || '').substring(0, 60)}...</div>
                    <div class="note-date">${new Date(n.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function newNote() {
            editingNoteId = null;
            showEditor();
            document.getElementById('noteTitleInput').value = '';
            document.getElementById('noteContentInput').value = '';
            document.getElementById('editorLinks').innerHTML = 'Use [[Week Title]] to link to readings';
        }

        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            editingNoteId = id;
            showEditor();
            document.getElementById('noteTitleInput').value = note.title || '';
            document.getElementById('noteContentInput').value = note.content || '';
            parseNoteLinks(note.content || '');
            renderNotesList();
        }

        function showEditor() {
            document.getElementById('editorContainer').style.display = 'none';
            document.getElementById('editorActive').style.display = 'flex';
        }

        function parseNoteLinks(content) {
            const links = content.match(/\[\[([^\]]+)\]\]/g) || [];
            const linksEl = document.getElementById('editorLinks');

            if (links.length === 0) {
                linksEl.innerHTML = 'Use [[Week Title]] to link to readings';
                return;
            }

            linksEl.innerHTML = 'Links: ' + links.map(l => {
                const text = l.replace(/\[\[|\]\]/g, '');
                return `<span class="editor-link">${text}</span>`;
            }).join('');
        }

        document.getElementById('noteContentInput')?.addEventListener('input', e => {
            parseNoteLinks(e.target.value);
        });

        async function saveNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;
            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const note = {
                title,
                content,
                linked_readings: links,
                updated_at: new Date().toISOString()
            };

            if (db && currentUser) {
                note.user_id = currentUser.id;
                try {
                    if (editingNoteId) {
                        await db.from('notes').update(note).eq('id', editingNoteId);
                        const idx = notes.findIndex(n => n.id === editingNoteId);
                        if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                    } else {
                        const { data } = await db.from('notes').insert([note]).select();
                        if (data?.[0]) {
                            notes.unshift(data[0]);
                            editingNoteId = data[0].id;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to save:', e);
                }
            } else {
                if (editingNoteId) {
                    const idx = notes.findIndex(n => n.id === editingNoteId);
                    if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                } else {
                    note.id = Date.now().toString();
                    note.created_at = note.updated_at;
                    notes.unshift(note);
                    editingNoteId = note.id;
                }
                localStorage.setItem('metamodality_notes', JSON.stringify(notes));
            }

            renderNotesList();
        }

        async function publishNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;

            if (!title || !content) {
                alert('Please add a title and content before publishing.');
                return;
            }

            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const post = {
                title,
                content,
                linked_readings: links,
                published_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous',
                reactions: {}
            };

            if (db && currentUser) {
                post.author_id = currentUser.id;
                try {
                    const { data } = await db.from('posts').insert([post]).select();
                    if (data?.[0]) posts.unshift(data[0]);
                } catch (e) {
                    console.warn('Failed to publish:', e);
                }
            } else {
                post.id = Date.now().toString();
                posts.unshift(post);
            }

            renderFeed();
            switchView('discuss');
        }

        // =============================================
        // AUTHENTICATION
        // =============================================

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('authEmail').focus();
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authMessage').style.display = 'none';
        }

        async function sendMagicLink() {
            const email = document.getElementById('authEmail').value;
            if (!email) return;

            const msgEl = document.getElementById('authMessage');

            if (db) {
                try {
                    const { error } = await db.auth.signInWithOtp({
                        email,
                        options: { emailRedirectTo: window.location.href }
                    });

                    if (error) throw error;

                    msgEl.className = 'message success';
                    msgEl.textContent = 'Check your email for the magic link!';
                    msgEl.style.display = 'block';
                } catch (e) {
                    msgEl.className = 'message error';
                    msgEl.textContent = e.message || 'Failed to send link';
                    msgEl.style.display = 'block';
                }
            }
        }

        function updateAuthUI(user) {
            const btn = document.getElementById('authBtn');
            if (user) {
                btn.outerHTML = `<div class="user-avatar" onclick="signOut()" title="Sign out">${user.email[0].toUpperCase()}</div>`;
            } else {
                const existing = document.querySelector('.user-avatar');
                if (existing) {
                    existing.outerHTML = `<button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>`;
                }
            }
        }

        async function signOut() {
            if (db) {
                await db.auth.signOut();
            }
            currentUser = null;
            location.reload();
        }

        // Start
        init();
    </script>
</body>
</html>
