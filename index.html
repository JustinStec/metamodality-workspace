<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metamodality â€” Reading Group</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ“š</text></svg>">

    <!-- PDF.js (self-hosted) -->
    <script src="libs/pdf.min.js"></script>
    <link rel="stylesheet" href="libs/pdf_viewer.min.css">

    <!-- Tesseract.js for OCR (self-hosted) -->
    <script src="libs/tesseract.min.js"></script>

    <!-- Supabase SDK (self-hosted to avoid Safari Tracking Prevention blocking) -->
    <script src="libs/supabase.min.js"></script>

    <!-- Markdown parser (self-hosted) -->
    <script src="libs/marked.min.js"></script>

    <!-- Inter font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --bg-dark: #f5f4f0;
            --bg-sidebar: #eae8e4;
            --bg-panel: #ffffff;
            --bg-editor: #fffcf8;
            --bg-secondary: #eae8e4;
            --bg-hover: #f0ebe3;
            --border: #e0ddd5;
            --text: #3d3929;
            --text-muted: #8b8579;
            --text-bright: #1a1815;
            --accent: #da7756;
            --accent-hover: #c4684a;
            --highlight: #f0ebe3;
            --success: #5a9a6e;
            --warning: #b8860b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        header {
            height: 50px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            cursor: pointer;
        }

        nav {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }

        .nav-tab {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .nav-tab:hover { background: var(--highlight); color: var(--text); }
        .nav-tab.active { background: var(--accent); color: white; }

        /* Notification badge */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 18px;
            height: 18px;
            padding: 0 5px;
            background: #ef4444;
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 9px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .status-dot.connected { background: var(--success); }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }
        .search-box input {
            width: 200px;
            padding: 7px 12px 7px 32px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            background: var(--bg-dark);
            color: var(--text);
        }
        .search-box input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-panel);
        }
        .search-box .search-icon {
            position: absolute;
            left: 10px;
            font-size: 12px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-result-item {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.15s;
        }
        .search-result-item:hover {
            background: var(--highlight);
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-type {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            margin-bottom: 4px;
        }
        .search-result-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 4px;
        }
        .search-result-desc {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn.secondary {
            background: var(--bg-dark);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn.secondary:hover { background: var(--highlight); }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        .user-menu-container {
            position: relative;
        }

        .user-menu {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: var(--bg-light);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 160px;
            z-index: 1000;
            display: none;
        }

        .user-menu.active {
            display: block;
        }

        .user-menu-header {
            padding: 10px 14px;
            font-weight: 600;
            font-size: 0.9rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }

        .user-menu-item {
            padding: 10px 14px;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-muted);
            transition: background 0.15s;
        }

        .user-menu-item:hover {
            background: var(--bg-hover);
            color: var(--text);
        }

        .user-menu-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        /* ========== MAIN CONTENT ========== */
        main {
            flex: 1;
            overflow: hidden;
            display: flex;
        }

        .view {
            display: none;
            height: 100%;
            overflow: auto;
            flex: 1;
        }
        .view.active { display: block; }

        /* ========== SPLIT VIEW ========== */
        .split-container {
            display: none;
            flex: 1;
            height: 100%;
        }
        .split-container.active {
            display: flex;
        }
        .split-container.horizontal {
            flex-direction: row;
        }
        .split-container.vertical {
            flex-direction: column;
        }
        .split-pane {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-dark);
            padding: 12px;
            min-width: 0;
        }
        .split-pane:first-child {
            padding-right: 6px;
        }
        .split-pane:last-child {
            padding-left: 6px;
        }
        .split-container.vertical .split-pane:first-child {
            padding-right: 12px;
            padding-bottom: 6px;
        }
        .split-container.vertical .split-pane:last-child {
            padding-left: 12px;
            padding-top: 6px;
        }
        .split-pane-module {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            min-width: 0;
        }
        .split-pane-header {
            padding: 10px 16px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }
        .split-pane-select {
            padding: 4px 8px;
            border: 1px solid var(--border);
            border-radius: 4px;
            background: var(--bg-panel);
            font-size: 12px;
            cursor: pointer;
        }
        .split-pane-close {
            margin-left: auto;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: var(--text-muted);
            padding: 2px 6px;
        }
        .split-pane-close:hover {
            color: var(--text);
        }
        .split-pane-content {
            flex: 1;
            overflow: hidden;
            display: flex;
            min-height: 0;
        }
        .split-divider {
            width: 12px;
            background: transparent;
            cursor: col-resize;
            flex-shrink: 0;
        }
        .split-divider:hover {
            background: rgba(139,90,43,0.1);
        }
        .split-container.vertical .split-divider {
            width: auto;
            height: 12px;
            cursor: row-resize;
        }

        /* Split PDF Viewer */
        .split-pdf-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .split-readings-sidebar {
            width: 180px;
            border-right: 1px solid var(--border);
            overflow-y: auto;
            background: var(--bg-sidebar);
            flex-shrink: 0;
        }
        .split-readings-header {
            padding: 12px;
            font-size: 11px;
            text-transform: uppercase;
            color: var(--text-muted);
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }
        .split-reading-item {
            padding: 10px 12px;
            font-size: 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            color: var(--text);
        }
        .split-reading-item:hover {
            background: var(--highlight);
        }
        .split-reading-item.active {
            background: rgba(139,90,43,0.1);
            border-left: 3px solid var(--accent);
        }
        .split-week-header {
            padding: 8px 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--accent);
            background: var(--bg-dark);
        }
        .split-pdf-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
        }
        .split-pdf-toolbar {
            padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            background: var(--bg-panel);
        }
        .split-pdf-toolbar .pdf-title {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-bright);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .split-pdf-toolbar .zoom-btn {
            padding: 4px 8px;
            font-size: 12px;
        }
        .split-pdf-viewer {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .split-page-wrapper {
            position: relative;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            background: white;
        }
        .split-page-wrapper canvas {
            display: block;
        }
        .split-page-wrapper .textLayer {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            line-height: 1.0;
        }
        .split-annotations-panel {
            width: 280px;
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-panel);
            flex-shrink: 0;
        }
        .split-annotations-header {
            padding: 12px;
            font-size: 13px;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
            color: var(--text-bright);
        }
        .split-annotations-list {
            flex: 1;
            overflow-y: auto;
        }
        .split-btn {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .split-btn:hover {
            background: var(--highlight);
            color: var(--text);
        }
        .split-btn.active {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        /* ========== HOME VIEW ========== */
        .home-view {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px 30px;
        }

        .home-hero {
            margin-bottom: 24px;
            padding: 30px;
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .home-hero h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 32px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 6px;
            letter-spacing: -0.01em;
            text-align: center;
        }
        .home-hero .subtitle {
            font-size: 15px;
            color: var(--text-muted);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            margin-bottom: 20px;
            text-align: center;
        }
        .home-hero .epigraph {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.4;
            color: var(--text);
            margin: 0 0 10px;
            text-align: left;
        }
        .home-hero .epigraph-source {
            font-size: 12px;
            color: var(--text-muted);
            text-align: left;
            margin-bottom: 16px;
        }
        .welcome-banner {
            background: linear-gradient(135deg, #da7756 0%, #c4684a 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 24px;
            position: relative;
        }
        .welcome-banner h3 {
            margin: 0 0 8px;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .welcome-banner p {
            margin: 0;
            font-size: 0.95rem;
            line-height: 1.5;
            opacity: 0.95;
        }
        .welcome-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            opacity: 0.7;
            line-height: 1;
        }
        .welcome-close:hover { opacity: 1; }
        .course-description-module {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 24px 30px;
            margin-bottom: 24px;
        }
        .course-description-module p {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
            margin: 0;
        }

        /* Meeting Info Bar */
        .meeting-info-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            padding: 12px 20px;
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 24px;
            font-size: 13px;
        }
        .meeting-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text);
        }
        .meeting-info-item .icon {
            font-size: 14px;
        }
        .meeting-info-item .label {
            color: var(--text-muted);
        }

        /* Progress Bar */
        .semester-progress {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 16px 20px;
            margin-bottom: 24px;
        }
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            font-size: 13px;
        }
        .progress-header .label {
            color: var(--text-muted);
        }
        .progress-header .value {
            font-weight: 600;
            color: var(--accent);
        }
        .progress-bar {
            height: 8px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #e8a87c);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* Next Week Preview */
        .next-week-preview {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid var(--text-muted);
            opacity: 0.85;
        }
        .next-week-preview:hover {
            opacity: 1;
        }
        .next-week-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 6px;
        }
        .next-week-preview h3 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 18px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 8px;
        }
        .next-week-preview .focus {
            font-size: 13px;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Workshop Card */
        .workshop-card {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .workshop-card-header {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 12px 12px 0 0;
            background: var(--bg-panel);
        }
        .workshop-card-body {
            padding: 0;
        }
        .workshop-item {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .workshop-item:last-child {
            border-bottom: none;
        }
        .workshop-item .unit {
            color: var(--accent);
            font-weight: 500;
        }
        .workshop-item .dates {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 2px;
        }

        /* Tags */
        .tag {
            display: inline-block;
            padding: 3px 10px;
            background: var(--bg-dark);
            border-radius: 12px;
            font-size: 11px;
            color: var(--text-muted);
            margin: 2px 4px 2px 0;
            cursor: pointer;
            transition: all 0.15s;
        }
        .tag:hover {
            background: var(--accent);
            color: white;
        }
        .tag.active {
            background: var(--accent);
            color: white;
        }
        .tag-cloud {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            padding: 12px 18px;
        }
        .tag-filter-header {
            padding: 12px 18px;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tag-filter-header button {
            font-size: 10px;
            color: var(--accent);
            background: none;
            border: none;
            cursor: pointer;
        }
        .week-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 8px;
        }
        .week-tags .tag {
            font-size: 10px;
            padding: 2px 8px;
        }

        .current-week {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .current-week-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 8px;
        }
        .current-week h2 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .current-week .focus {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            margin-bottom: 20px;
        }
        .current-week-readings {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .reading-card {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .reading-card:hover { background: var(--highlight); transform: translateX(4px); }
        .reading-card .icon { font-size: 18px; margin-right: 12px; }
        .reading-card .info { flex: 1; }
        .reading-card .title { font-size: 14px; color: var(--text-bright); }
        .reading-card .pages { font-size: 12px; color: var(--text-muted); }
        .reading-card .arrow { color: var(--text-muted); }

        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 700px) {
            .home-grid { grid-template-columns: 1fr; }
        }

        .home-section {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .home-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            padding: 16px 20px;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid var(--border);
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: var(--bg-panel);
        }
        .home-section h3 .icon { font-size: 16px; }
        .home-section > div {
            max-height: 280px;
            overflow-y: auto;
            padding: 0;
            border-radius: 0 0 12px 12px;
            background: var(--bg-panel);
        }

        .activity-item {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-item .author { color: var(--accent); font-weight: 500; }
        .activity-item .action { color: var(--text-muted); }
        .activity-item .target { color: var(--text); }
        .activity-item .time { font-size: 11px; color: var(--text-muted); display: block; margin-top: 4px; }

        .empty-state {
            text-align: left;
            padding: 20px;
            color: var(--text-muted);
            font-size: 13px;
            font-style: italic;
        }

        /* Home Layout - Three columns: Schedule | Main | Sidebar */
        .home-layout {
            display: grid;
            grid-template-columns: 240px 1fr 300px;
            gap: 20px;
            margin-top: 24px;
        }
        @media (max-width: 1200px) {
            .home-layout { grid-template-columns: 220px 1fr; }
            .home-sidebar { display: none; }
        }
        @media (max-width: 900px) {
            .home-layout { grid-template-columns: 1fr; }
            .course-stream-sidebar { display: none; }
        }

        .course-stream-sidebar {
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 80px);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-radius: 12px;
        }
        .course-stream-card {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            max-height: 100%;
        }
        .course-stream-header {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
            border-radius: 12px 12px 0 0;
            background: var(--bg-panel);
        }
        .course-stream-body {
            flex: 1;
            overflow-y: auto;
            padding: 8px 0;
            border-radius: 0 0 12px 12px;
            background: var(--bg-panel);
        }
        .course-week-item {
            padding: 10px 18px;
            cursor: pointer;
            transition: background 0.15s;
            border-left: 3px solid transparent;
        }
        .course-week-item:hover {
            background: var(--highlight);
        }
        .course-week-item.current {
            background: rgba(139,90,43,0.08);
            border-left-color: var(--accent);
        }
        .course-week-item .week-num {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 2px;
        }
        .course-week-item .week-title {
            font-size: 13px;
            color: var(--text-bright);
            line-height: 1.3;
        }
        .course-week-item .week-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .course-unit-header {
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--accent);
            padding: 12px 18px 6px;
            font-weight: 600;
            background: var(--bg-dark);
        }

        .home-main {
            display: flex;
            flex-direction: column;
            gap: 24px;
            min-width: 0;
        }

        .home-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .home-sidebar .activity-card {
            flex-shrink: 0;
        }

        .activity-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .activity-card {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .activity-card-header {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 12px 12px 0 0;
            background: var(--bg-panel);
        }
        .activity-card-header .icon { font-size: 14px; }
        .activity-card-header .toggle-icon {
            margin-left: auto;
            font-size: 10px;
            transition: transform 0.2s;
        }
        .activity-card-header .toggle-icon.collapsed {
            transform: rotate(-90deg);
        }
        .activity-card-body {
            max-height: 280px;
            overflow-y: auto;
            border-radius: 0 0 12px 12px;
            background: var(--bg-panel);
        }
        .activity-card-body.collapsed {
            display: none;
        }

        /* Orientation card */
        .orientation-card .activity-card-body {
            max-height: none;
            padding: 0;
        }
        .orientation-section {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
        }
        .orientation-section:last-child {
            border-bottom: none;
        }
        .orientation-section h4 {
            font-size: 13px;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 6px;
        }
        .orientation-section p {
            font-size: 13px;
            line-height: 1.5;
            color: var(--text);
            margin: 0;
        }
        .orientation-section code {
            background: var(--bg-dark);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            color: var(--accent);
        }
        .orientation-section ul {
            margin: 0;
            padding-left: 18px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text);
        }
        .orientation-section li {
            margin-bottom: 4px;
        }
        .orientation-section kbd {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 3px;
            padding: 1px 5px;
            font-size: 11px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-muted);
        }

        .stream-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: background 0.15s;
            cursor: pointer;
        }
        .stream-item:last-child { border-bottom: none; }
        .stream-item:hover { background: var(--highlight); }
        .stream-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .stream-avatar.system { background: var(--text-muted); font-size: 14px; }
        .stream-content { flex: 1; min-width: 0; }
        .stream-text {
            font-size: 13px;
            color: var(--text);
            line-height: 1.4;
        }
        .stream-text .author { color: var(--accent); font-weight: 500; }
        .stream-text .target { color: var(--text-bright); font-weight: 500; }
        .stream-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .upcoming-item {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .upcoming-item:last-child { border-bottom: none; }
        .upcoming-item:hover { background: var(--highlight); }
        .upcoming-date {
            width: 44px;
            height: 44px;
            background: var(--bg-dark);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .upcoming-date .month {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            font-weight: 600;
        }
        .upcoming-date .day {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            line-height: 1;
        }
        .upcoming-info { flex: 1; }
        .upcoming-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 2px;
        }
        .upcoming-detail {
            font-size: 11px;
            color: var(--text-muted);
        }
        .upcoming-item.current .upcoming-date {
            background: var(--accent);
        }
        .upcoming-item.current .upcoming-date .month,
        .upcoming-item.current .upcoming-date .day { color: white; }

        /* ========== SYLLABUS VIEW ========== */
        .syllabus-view {
            max-width: 850px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .syllabus-view h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 28px;
            font-weight: normal;
            margin-bottom: 30px;
            color: var(--text-bright);
        }

        .unit {
            margin-bottom: 40px;
        }
        .unit-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--accent);
        }
        .unit-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .unit-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 20px;
            color: var(--text-bright);
            font-weight: normal;
        }

        .week-card {
            background: var(--bg-panel);
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            overflow: hidden;
            border-left: 3px solid transparent;
            transition: all 0.15s;
        }
        .week-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .week-card.current { border-left-color: var(--accent); background: rgba(218, 119, 86, 0.03); }
        .week-card.completed { border-left-color: var(--success); }
        .week-card-main {
            padding: 20px;
            cursor: pointer;
        }
        .week-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .week-card .week-num {
            font-size: 11px;
            font-weight: 600;
            color: white;
            background: var(--text-muted);
            padding: 3px 8px;
            border-radius: 4px;
            min-width: 55px;
            text-align: center;
        }
        .week-card.current .week-num { background: var(--accent); }
        .week-card.completed .week-num { background: var(--success); }
        .week-card .week-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 18px;
            color: var(--text-bright);
            flex: 1;
        }
        .week-card .week-date {
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-card .week-status {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            background: var(--bg-dark);
            color: var(--text-muted);
        }
        .week-card.current .week-status { background: rgba(218, 119, 86, 0.15); color: var(--accent); }
        .week-card .week-focus {
            font-size: 13px;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        .week-card .week-summary {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-card .expand-icon {
            margin-left: auto;
            transition: transform 0.2s;
            color: var(--text-muted);
        }
        .week-card.expanded .expand-icon { transform: rotate(180deg); }

        .week-readings-list {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid var(--border);
            margin-top: 0;
        }
        .week-card.expanded .week-readings-list { display: block; }
        .week-reading-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
        }
        .week-reading-item:last-child { border-bottom: none; }
        .week-reading-item:hover { padding-left: 8px; }
        .week-reading-item .reading-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-dark);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
        }
        .week-reading-item .reading-info { flex: 1; }
        .week-reading-item .reading-title {
            font-size: 14px;
            color: var(--text-bright);
            margin-bottom: 2px;
        }
        .week-reading-item .reading-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-reading-item .reading-progress {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: transparent;
        }
        .week-reading-item .reading-progress.started { border-color: var(--warning); background: rgba(184, 134, 11, 0.1); }
        .week-reading-item .reading-progress.complete { border-color: var(--success); background: var(--success); color: white; }

        /* ========== READ VIEW ========== */
        .read-view {
            display: none;
            height: 100%;
            width: 100%;
            flex-direction: row;
            overflow: hidden;
        }
        .read-view.active { display: flex; }

        .read-sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width 0.2s ease;
        }
        .read-sidebar.collapsed {
            width: 50px;
            overflow: hidden;
        }
        .read-sidebar.collapsed .read-sidebar-content,
        .read-sidebar.collapsed .read-sidebar-header span {
            display: none;
        }
        .read-sidebar.collapsed .sidebar-toggle-btn {
            transform: rotate(180deg);
        }
        .sidebar-toggle-btn {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        .sidebar-toggle-btn:hover {
            background: var(--highlight);
            color: var(--text);
        }
        .read-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .read-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .sidebar-unit {
            border-bottom: 1px solid var(--border);
        }
        .sidebar-unit-header {
            padding: 10px 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-unit-header:hover { background: var(--highlight); }
        .sidebar-unit-header .collapse-icon {
            transition: transform 0.2s;
        }
        .sidebar-unit.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        .sidebar-unit.collapsed .sidebar-unit-weeks {
            display: none;
        }
        .sidebar-week {
            border-top: 1px solid var(--border);
        }
        .sidebar-week-header {
            padding: 8px 15px 8px 25px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-bright);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sidebar-week-header:hover { background: var(--highlight); }
        .sidebar-week.collapsed .sidebar-week-readings {
            display: none;
        }
        .sidebar-week.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .reading-list-item {
            padding: 8px 15px 8px 40px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s;
            font-size: 12px;
            color: var(--text);
        }
        .reading-list-item:hover { background: var(--highlight); }
        .reading-list-item.active {
            background: var(--highlight);
            border-left-color: var(--accent);
            color: var(--text-bright);
        }

        .pdf-container {
            flex: 1 1 0;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            min-width: 0;
            overflow: hidden;
            padding: 12px;
        }
        .pdf-module {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
            min-width: 0;
        }
        .pdf-header {
            padding: 10px 15px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .pdf-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }
        .pdf-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .pdf-controls button {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .pdf-controls button:hover { background: var(--highlight); }
        .pdf-controls span { font-size: 12px; color: var(--text-muted); }
        .fullscreen-btn { margin-left: 8px; }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 2px;
        }
        .zoom-controls button {
            width: 28px;
            height: 28px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 500;
            background: transparent;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text);
        }
        .zoom-controls button:hover {
            background: var(--highlight);
        }
        .zoom-controls #zoomLevel {
            min-width: 50px;
            text-align: center;
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }

        .ocr-btn { position: relative; }
        .ocr-btn.loading { opacity: 0.7; pointer-events: none; }
        .ocr-btn .spinner {
            display: none;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 4px;
        }
        .ocr-btn.loading .spinner { display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .ocr-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(90, 154, 110, 0.15);
            color: var(--success);
        }
        .ocr-status.warning {
            background: rgba(184, 134, 11, 0.15);
            color: var(--warning);
        }

        /* Fullscreen mode */
        .read-view.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            background: var(--bg-dark);
            padding: 12px;
            gap: 12px;
        }
        .read-view.fullscreen .read-sidebar { display: none; }
        .read-view.fullscreen .pdf-container {
            flex: 1;
            padding: 0;
            min-width: 0;
        }
        .read-view.fullscreen .pdf-module {
            border-radius: 12px;
        }
        .read-view.fullscreen .pdf-viewer {
            align-items: center;
            padding: 20px;
        }
        .read-view.fullscreen .annotations-container {
            padding: 0;
            background: transparent;
        }
        .read-view.fullscreen .annotations-panel {
            width: 380px;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
        }
        .read-view.fullscreen .annotations-panel.collapsed {
            width: 50px;
        }

        .pdf-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 10px;
            background: #e8e4dc;
            width: 100%;
            min-width: 0; /* Allow flex item to shrink below content size */
        }
        .pdf-viewer canvas {
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: block;
        }
        .pdf-page-container {
            position: relative;
            flex-shrink: 0;
        }
        /* Text layer - uses PDF.js textLayer class with pdf_viewer.css */
        .pdf-page-container .textLayer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            line-height: 1;
            z-index: 2;
        }
        /* Custom selection color */
        .textLayer ::selection {
            background: rgba(218, 119, 86, 0.4);
        }
        .textLayer ::-moz-selection {
            background: rgba(218, 119, 86, 0.4);
        }
        /* Column selection mode - dim opposite column */
        .textLayer.column-mode-left span[data-column="right"] {
            opacity: 0.3;
            pointer-events: none;
            user-select: none;
        }
        .textLayer.column-mode-right span[data-column="left"] {
            opacity: 0.3;
            pointer-events: none;
            user-select: none;
        }

        .column-toggle {
            display: flex;
            gap: 4px;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 4px;
            padding: 2px;
        }
        .column-toggle button {
            padding: 4px 8px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 11px;
            border-radius: 3px;
            color: var(--text-muted);
        }
        .column-toggle button:hover {
            background: var(--highlight);
        }
        .column-toggle button.active {
            background: var(--accent);
            color: white;
        }
        .pdf-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            gap: 15px;
        }
        .pdf-empty-icon { font-size: 48px; opacity: 0.5; }

        .annotations-container {
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
            padding: 12px;
            padding-left: 0;
            flex-shrink: 0;
            height: 100%;
            overflow: hidden;
        }
        .annotations-panel {
            width: 380px;
            background: var(--bg-panel);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            transition: width 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .annotations-panel.collapsed {
            width: 50px;
        }
        .annotations-panel.collapsed .annotations-list,
        .annotations-panel.collapsed .annotation-form,
        .annotations-panel.collapsed .annotations-header h3,
        .annotations-panel.collapsed #annotationsCount,
        .annotations-panel.collapsed .add-note-btn {
            display: none;
        }
        .annotations-panel.collapsed .sidebar-toggle-btn {
            transform: rotate(180deg);
        }
        .annotations-header {
            padding: 16px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .annotations-header h3 {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-bright);
            flex: 1;
            margin: 0;
        }
        #annotationsCount {
            font-size: 12px;
            color: var(--text-muted);
        }
        .add-note-btn {
            font-size: 11px;
            padding: 4px 8px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .add-note-btn:hover {
            background: var(--accent-hover);
        }
        .annotations-list {
            flex: 1;
            overflow-y: auto;
        }
        .annotation-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .annotation-quote {
            font-size: 13px;
            font-style: italic;
            color: var(--text);
            margin-bottom: 8px;
            padding-left: 12px;
            border-left: 3px solid var(--accent);
            line-height: 1.5;
        }
        .annotation-comment {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }
        .annotation-meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        .annotations-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .annotation-form {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            display: none;
        }
        .annotation-form.active { display: block; }
        .annotation-form .quote-preview {
            font-size: 12px;
            font-style: italic;
            color: var(--text-muted);
            padding: 10px;
            background: var(--bg-panel);
            border-radius: 6px;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }
        .annotation-form .quote-preview:empty {
            display: none;
        }
        .annotation-form .quote-preview.pinned-note {
            display: block;
            font-style: normal;
            color: var(--accent);
            background: rgba(139,90,43,0.1);
        }
        /* Pinned annotation display */
        .annotation-item.pinned .annotation-quote {
            border-left-color: var(--text-muted);
            font-style: normal;
            color: var(--text-muted);
            font-size: 11px;
        }
        .annotation-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            resize: none;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .annotation-form textarea:focus { outline: none; border-color: var(--accent); }

        /* RTF Editor */
        .rtf-toolbar {
            display: flex;
            gap: 2px;
            padding: 4px;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-bottom: none;
            border-radius: 6px 6px 0 0;
        }
        .rtf-toolbar button {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text);
            cursor: pointer;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 600;
        }
        .rtf-toolbar button:hover {
            background: var(--highlight);
        }
        .rtf-toolbar button.active {
            background: var(--accent);
            color: white;
        }
        .rtf-editor {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 0 0 6px 6px;
            font-size: 13px;
            min-height: 80px;
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
            background: var(--bg-panel);
            line-height: 1.5;
        }
        .rtf-editor:focus {
            outline: none;
            border-color: var(--accent);
        }
        .rtf-editor:empty:before {
            content: attr(data-placeholder);
            color: var(--text-muted);
        }

        /* Annotation replies */
        .annotation-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }
        .annotation-actions button {
            font-size: 11px;
            color: var(--text-muted);
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }
        .annotation-actions button:hover {
            color: var(--accent);
        }
        .annotation-replies {
            margin-top: 12px;
            padding-left: 15px;
            border-left: 2px solid var(--border);
        }
        .annotation-reply {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
        }
        .annotation-reply:last-child {
            border-bottom: none;
        }
        .reply-form {
            margin-top: 10px;
            display: none;
        }
        .reply-form.active {
            display: block;
        }
        .reply-form .rtf-editor {
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* ========== DISCUSS VIEW ========== */
        .discuss-view {
            max-width: 700px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .discuss-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .discuss-header h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
        }

        /* Quick Post Composer */
        .quick-post-composer {
            display: flex;
            gap: 12px;
            padding: 20px;
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            margin-bottom: 20px;
        }
        .composer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }
        .composer-input-area {
            flex: 1;
        }
        .composer-input-area textarea {
            width: 100%;
            border: none;
            resize: none;
            font-size: 1rem;
            line-height: 1.5;
            padding: 8px 0;
            background: transparent;
            color: var(--text);
            font-family: inherit;
            min-height: 60px;
        }
        .composer-input-area textarea:focus { outline: none; }
        .composer-input-area textarea::placeholder { color: var(--text-muted); }
        .composer-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .char-count {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Feed Tabs */
        .feed-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }
        .feed-tab {
            padding: 8px 16px;
            border: none;
            background: var(--bg-panel);
            color: var(--text-muted);
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.15s;
        }
        .feed-tab:hover { background: var(--highlight); color: var(--text); }
        .feed-tab.active { background: var(--accent); color: white; }

        /* Quick Thought Post (smaller than essay) */
        .thought-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .thought-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .thought-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .thought-author { font-weight: 500; color: var(--text-bright); }
        .thought-time { font-size: 0.85rem; color: var(--text-muted); }
        .thought-content {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text);
        }
        .thought-actions {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .thought-action {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .thought-action:hover { color: var(--accent); }

        .post-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }
        .post-author { font-size: 14px; font-weight: 500; color: var(--text-bright); }
        .post-date { font-size: 12px; color: var(--text-muted); }
        .post-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 22px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 6px;
        }
        .post-subtitle {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 16px;
            color: var(--text-muted);
            margin-bottom: 16px;
            font-style: italic;
        }
        .post-content {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text);
        }
        .post-content p { margin-bottom: 12px; }
        .post-links {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .post-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 20px;
        }
        .post-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .post-action:hover { color: var(--accent); }

        /* Post Comments */
        .post-comments-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }
        .post-comments-list {
            margin-bottom: 15px;
        }
        .post-comment {
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .post-comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }
        .post-comment-author {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text-bright);
        }
        .post-comment-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .post-comment-content {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text);
        }
        .post-comment-form {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }
        .post-comment-form textarea {
            flex: 1;
            min-height: 60px;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 0.9rem;
            resize: vertical;
        }
        .post-comment-form textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ========== WORKSHOP VIEW ========== */
        .workshop-view {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .workshop-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }
        .workshop-title-area {
            flex: 1;
        }
        .workshop-unit-label {
            font-size: 0.85rem;
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
        }
        .workshop-title-area h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 28px;
            font-weight: normal;
            color: var(--text-bright);
            margin: 0 0 8px;
        }
        .workshop-dates {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .workshop-content {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }
        .workshop-section h2 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        .workshop-weeks {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 15px;
        }
        .workshop-week-card {
            background: var(--bg-panel);
            border-radius: 10px;
            padding: 18px;
            cursor: pointer;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .workshop-week-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .workshop-week-num {
            font-size: 0.75rem;
            color: var(--accent);
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 4px;
        }
        .workshop-week-title {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 8px;
        }
        .workshop-week-readings {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .workshop-essays {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .workshop-essay-card {
            background: var(--bg-panel);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
        }
        .workshop-essay-card:hover {
            background: var(--bg-hover);
        }
        .workshop-essay-title {
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 4px;
        }
        .workshop-essay-author {
            font-size: 0.85rem;
            color: var(--text-muted);
        }
        .workshop-discussion {
            background: var(--bg-panel);
            border-radius: 10px;
            padding: 20px;
        }
        .workshop-comment-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .workshop-comment-form textarea {
            width: 100%;
            min-height: 80px;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 0.9rem;
            resize: vertical;
        }
        .workshop-comment-form textarea:focus {
            outline: none;
            border-color: var(--accent);
        }
        .workshop-comment-form .btn {
            align-self: flex-end;
        }
        .workshop-comments {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .workshop-comment {
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        .workshop-comment-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .workshop-comment-author {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-bright);
        }
        .workshop-comment-date {
            font-size: 0.8rem;
            color: var(--text-muted);
        }
        .workshop-comment-content {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text);
        }

        /* ========== WRITE VIEW ========== */
        .write-view {
            display: none;
            height: 100%;
            flex-direction: row;
        }
        .write-view.active { display: flex; }

        .notes-sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .notes-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notes-sidebar-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
        }
        .notes-list {
            flex: 1;
            overflow-y: auto;
        }
        .note-list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .note-list-item:hover { background: var(--highlight); }
        .note-list-item.active { background: var(--highlight); border-left: 3px solid var(--accent); }
        .note-list-item .note-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 4px;
        }
        .note-list-item .note-preview {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .note-list-item .note-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-editor);
        }
        .editor-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
        }
        .editor-title-input {
            font-size: 20px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--text-bright);
            flex: 1;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .editor-title-input:focus { outline: none; }
        .editor-title-input::placeholder { color: var(--text-muted); }

        .editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .editor-textarea {
            flex: 1;
            padding: 25px;
            border: none;
            font-size: 15px;
            line-height: 1.8;
            resize: none;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: var(--bg-editor);
            color: var(--text);
        }
        .editor-textarea:focus { outline: none; }
        .editor-textarea::placeholder { color: var(--text-muted); }

        .editor-footer {
            padding: 12px 25px;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-links {
            font-size: 12px;
            color: var(--text-muted);
        }
        .editor-link {
            display: inline-block;
            background: var(--bg-dark);
            padding: 3px 10px;
            border-radius: 12px;
            margin-right: 6px;
            cursor: pointer;
        }
        .editor-link:hover { background: var(--highlight); }

        .editor-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 15px;
        }
        .editor-empty-icon { font-size: 48px; opacity: 0.5; }
        .editor-empty-hint { font-size: 13px; opacity: 0.7; }

        /* ========== NOTES VIEW ========== */
        .notes-view {
            display: none;
            height: 100%;
            flex-direction: row;
        }
        .notes-view.active { display: flex; }

        /* ========== SUBSTACK-STYLE WRITE VIEW ========== */
        .substack-editor {
            display: flex;
            width: 100%;
            height: 100%;
        }
        .substack-editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 720px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .substack-header {
            margin-bottom: 30px;
        }
        .substack-title {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 42px;
            font-weight: 700;
            color: var(--text-bright);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            line-height: 1.2;
            margin-bottom: 12px;
        }
        .substack-title:focus { outline: none; }
        .substack-title::placeholder { color: var(--text-muted); opacity: 0.5; }
        .substack-subtitle {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 22px;
            font-weight: 400;
            color: var(--text-muted);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .substack-subtitle:focus { outline: none; }
        .substack-subtitle::placeholder { color: var(--text-muted); opacity: 0.4; }
        .substack-body {
            flex: 1;
            display: flex;
        }
        .substack-textarea {
            width: 100%;
            flex: 1;
            border: none;
            background: transparent;
            font-size: 18px;
            line-height: 1.9;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            color: var(--text);
            resize: none;
        }
        .substack-textarea:focus { outline: none; }
        .substack-textarea::placeholder { color: var(--text-muted); opacity: 0.5; }
        .substack-footer {
            padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 20px;
        }
        .substack-links {
            font-size: 13px;
            color: var(--text-muted);
        }
        .substack-actions {
            display: flex;
            gap: 10px;
        }
        .substack-sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .substack-sidebar-header {
            padding: 15px;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            border-bottom: 1px solid var(--border);
        }
        .drafts-list {
            flex: 1;
            overflow-y: auto;
        }
        .draft-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .draft-item:hover { background: var(--highlight); }
        .draft-item.active { background: var(--highlight); border-left: 3px solid var(--accent); }
        .draft-item-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 4px;
        }
        .draft-item-preview {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .draft-item-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        /* ========== READING LINK SYSTEM ========== */
        .editor-textarea-wrapper {
            position: relative;
            flex: 1;
            display: flex;
        }
        .autocomplete-dropdown {
            display: none;
            position: absolute;
            left: 25px;
            top: 60px;
            width: 350px;
            max-height: 300px;
            overflow-y: auto;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.2);
            z-index: 100;
        }
        .autocomplete-dropdown.active { display: block; }
        .autocomplete-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .autocomplete-item:last-child { border-bottom: none; }
        .autocomplete-item:hover, .autocomplete-item.selected {
            background: var(--highlight);
        }
        .autocomplete-item-title {
            font-size: 14px;
            color: var(--text-bright);
            margin-bottom: 2px;
        }
        .autocomplete-item-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        .autocomplete-hint {
            padding: 8px 15px;
            font-size: 11px;
            color: var(--text-muted);
            background: var(--bg-dark);
            border-bottom: 1px solid var(--border);
        }

        .linked-readings {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            flex: 1;
        }
        .reading-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 5px 10px;
            background: var(--highlight);
            border: 1px solid var(--border);
            border-radius: 16px;
            font-size: 12px;
            color: var(--text);
        }
        .reading-chip-text {
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .reading-chip-remove {
            cursor: pointer;
            opacity: 0.6;
            font-size: 14px;
            line-height: 1;
        }
        .reading-chip-remove:hover { opacity: 1; }

        .link-reading-btn {
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .substack-footer-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        /* Reading Picker Modal */
        .reading-picker-modal {
            width: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .reading-picker-header {
            margin-bottom: 15px;
        }
        .reading-picker-header h3 {
            margin-bottom: 12px;
        }
        .reading-picker-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-editor);
            color: var(--text);
            font-size: 14px;
        }
        .reading-picker-search:focus {
            outline: none;
            border-color: var(--accent);
        }
        .reading-picker-body {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
            border: 1px solid var(--border);
            border-radius: 6px;
            margin-bottom: 15px;
        }
        .reading-picker-unit {
            border-bottom: 1px solid var(--border);
        }
        .reading-picker-unit:last-child { border-bottom: none; }
        .reading-picker-unit-header {
            padding: 10px 15px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--bg-dark);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .reading-picker-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
        }
        .reading-picker-item:last-child { border-bottom: none; }
        .reading-picker-item:hover {
            background: var(--highlight);
        }
        .reading-picker-item-title {
            font-size: 13px;
            color: var(--text-bright);
        }
        .reading-picker-item-week {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 2px;
        }
        .reading-picker-item.hidden { display: none; }

        /* ========== SELECTION POPUP ========== */
        .selection-popup {
            display: none;
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
        }
        .selection-popup button {
            padding: 10px 18px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 13px;
            cursor: pointer;
        }
        .selection-popup button:hover { background: var(--accent-hover); }

        /* ========== AUTH GATE ========== */
        .auth-gate {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f5f4f0;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .auth-gate.hidden { display: none; }
        .auth-gate-content {
            max-width: 480px;
            padding: 3rem;
            text-align: center;
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .auth-gate-content h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem;
            color: var(--text);
        }
        .auth-gate-content .subtitle {
            font-size: 1.1rem;
            color: var(--text-muted);
            font-style: italic;
            margin: 0 0 2rem;
        }
        .auth-gate-info {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
        }
        .auth-gate-info p { margin: 0; }
        .auth-gate-info .schedule {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-top: 0.25rem;
        }
        .auth-gate-features {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            margin-bottom: 2rem;
            text-align: left;
        }
        .auth-gate-features .feature {
            padding: 0.75rem;
            background: var(--bg-hover);
            border-radius: 6px;
            font-size: 0.85rem;
        }
        .auth-gate-cta {
            color: var(--text-muted);
            font-size: 0.9rem;
            margin-bottom: 1.5rem;
        }
        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            max-width: 360px;
            margin: 0 auto;
            padding: 12px 24px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.15s;
        }
        .btn-google:hover {
            background: var(--bg-hover);
            border-color: var(--text-muted);
        }
        .auth-divider {
            display: flex;
            align-items: center;
            max-width: 360px;
            margin: 1.5rem auto;
            color: var(--text-muted);
            font-size: 0.85rem;
        }
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--border);
        }
        .auth-divider span {
            padding: 0 1rem;
        }
        .auth-gate-form {
            display: flex;
            gap: 0.5rem;
            max-width: 360px;
            margin: 0 auto;
        }
        .auth-gate-form input {
            flex: 1;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text);
            font-size: 1rem;
        }
        .auth-gate-form input:focus {
            outline: none;
            border-color: var(--accent);
        }
        .auth-gate-message {
            margin-top: 1rem;
            padding: 0.75rem;
            border-radius: 6px;
            font-size: 0.9rem;
        }
        .auth-gate-message:empty { display: none; }
        .auth-gate-message.success {
            background: #d1fae5;
            color: #065f46;
        }
        .auth-gate-message.error {
            background: #fee2e2;
            color: #991b1b;
        }

        /* ========== AUTH MODAL ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-panel);
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            padding: 30px;
        }
        .modal h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-bright);
        }
        .modal p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        .modal input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .modal input:focus { outline: none; border-color: var(--accent); }
        .modal .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal .message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        .modal .message.success { background: #d1fae5; color: #065f46; }
        .modal .message.error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <!-- Auth Gate (shown until user signs in) -->
    <div class="auth-gate" id="authGate">
        <div class="auth-gate-content">
            <h1 onclick="bypassAuthGate()" style="cursor: pointer;" title="Click 3 times to bypass (dev mode)">Metamodality</h1>
            <p class="subtitle">An Inquiry into Forms of the Possible</p>

            <div class="auth-gate-info">
                <p>Center for Possible Minds Reading Group</p>
                <p class="schedule">Spring 2026 â€” Wednesdays, 4:00â€“5:30 PM</p>
            </div>

            <div class="auth-gate-features">
                <div class="feature">ðŸ“– Weekly readings with shared annotations</div>
                <div class="feature">ðŸ“ Private notes with reading links</div>
                <div class="feature">âœï¸ Draft and publish essays</div>
                <div class="feature">ðŸ’¬ Discuss with the group</div>
            </div>

            <p class="auth-gate-cta">Sign in with your email to access the workspace.</p>

            <form class="auth-gate-form" onsubmit="event.preventDefault(); handleGateLogin();" autocomplete="on">
                <input type="email" id="gateEmail" name="email" autocomplete="email" placeholder="your@email.edu">
                <input type="password" id="gatePassword" name="password" autocomplete="current-password" placeholder="Password (if set)" style="display: none;">
                <div id="otpCodeSection" style="display: none;">
                    <input type="text" id="gateOtpCode" name="otp" autocomplete="one-time-code" placeholder="Enter 8-digit code" maxlength="8" pattern="[0-9]{8}" style="text-align: center; font-size: 1.5rem; letter-spacing: 0.5rem;">
                </div>
                <button type="submit" class="btn" id="gateSubmitBtn">Send Code</button>
            </form>
            <div style="margin-top: 0.75rem;">
                <button onclick="toggleLoginMode()" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.85rem;" id="toggleLoginBtn">Have a password? Sign in with password</button>
                <button onclick="resetOtpFlow()" id="resetOtpBtn" style="display: none; background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.85rem; margin-left: 1rem;">Use different email</button>
            </div>
            <div class="auth-gate-message" id="gateMessage"></div>
            <p style="margin-top: 2rem; font-size: 0.75rem; color: var(--text-muted);">&copy; 2026 Justin Stec. All rights reserved.</p>
        </div>
    </div>

    <!-- Header -->
    <header>
        <div class="logo" onclick="switchView('home')">Metamodality</div>
        <nav>
            <button class="nav-tab active" data-view="home">Home</button>
            <button class="nav-tab" data-view="syllabus">Syllabus</button>
            <button class="nav-tab" data-view="read">Read</button>
            <button class="nav-tab" data-view="notes">Notes</button>
            <button class="nav-tab" data-view="write">Write</button>
            <button class="nav-tab" data-view="discuss">Discuss</button>
        </nav>
        <div class="header-right">
            <div class="search-box">
                <input type="text" id="globalSearch" placeholder="Search readings, notes..." onkeyup="handleSearch(event)">
                <span class="search-icon">ðŸ”</span>
            </div>
            <button class="split-btn" id="splitBtn" onclick="toggleSplitView()" title="Split view (âŒ˜/)">
                <span>â«¿</span> Split
            </button>
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- HOME VIEW -->
        <div class="view active" id="view-home">
            <div class="home-view">
                <div class="home-hero">
                    <h1>An Inquiry into Forms of the Possible</h1>
                    <p class="subtitle">Center for Possible Minds â€” Spring 2026</p>
                    <div class="epigraph">
                        What is it that it would not be right to say?<br>
                        That which is to be thought and spoken of must be.<br>
                        For it is there for being,<br>
                        but nothing is not.
                    </div>
                    <p class="epigraph-source">â€” Parmenides, Fr. 6.1â€“2 (Kingsley trans.)</p>
                </div>

                <div class="welcome-banner" id="welcomeBanner" style="display: none;">
                    <button class="welcome-close" onclick="dismissWelcome()">&times;</button>
                    <h3>Welcome to Metamodality!</h3>
                    <p>The workspace is now live. Browse the weekly readings, annotate passages with the group, take private notes, and join the discussion. We look forward to exploring the forms of the possible together.</p>
                </div>

                <div class="course-description-module">
                    <p>From Parmenides through contemporary set theory, thinkers have asked what it means for something to be possible. This reading group traces possibility across traditionsâ€”Greek, Islamic, Buddhist, phenomenological, pragmatistâ€”asking how each configures the space between what is and what might be.</p>
                </div>

                <div class="meeting-info-bar">
                    <div class="meeting-info-item">
                        <span class="icon">ðŸ‘¤</span>
                        <span><span class="label">Organizers:</span> Justin Stec & Jacob Foster</span>
                    </div>
                    <div class="meeting-info-item">
                        <span class="icon">ðŸ“…</span>
                        <span><span class="label">When:</span> Wednesdays, 4:00â€“5:30 PM</span>
                    </div>
                    <div class="meeting-info-item">
                        <span class="icon">ðŸ“</span>
                        <span><span class="label">First Meeting:</span> February 4, 2026</span>
                    </div>
                </div>

                <div class="semester-progress" id="semesterProgress">
                    <!-- Populated by JS -->
                </div>

                <div class="home-layout">
                    <!-- Course Stream Sidebar -->
                    <div class="course-stream-sidebar">
                        <div class="course-stream-card">
                            <div class="course-stream-header">
                                <span class="icon">ðŸ“š</span> Course Schedule
                            </div>
                            <div class="course-stream-body" id="courseStream">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>

                    <!-- Center: Current Week + Discussion -->
                    <div class="home-main">
                        <!-- Current Week (Featured) -->
                        <div class="current-week" id="currentWeekCard">
                            <!-- Populated by JS -->
                        </div>

                        <!-- Next Week Preview -->
                        <div class="next-week-preview" id="nextWeekPreview" style="cursor: pointer;">
                            <!-- Populated by JS -->
                        </div>

                        <!-- Recent Discussion -->
                        <div class="home-section">
                            <h3><span class="icon">ðŸ’¬</span> Recent Discussion</h3>
                            <div id="recentPosts">
                                <div class="empty-state">No posts yet. Be the first to share your thoughts.</div>
                            </div>
                        </div>

                        <!-- Recent Activity -->
                        <div class="home-section">
                            <h3><span class="icon">âš¡</span> Recent Activity</h3>
                            <div id="activityStream">
                                <div class="empty-state">Activity from the group will appear here.</div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Sidebar: Getting Started + Workshops -->
                    <div class="home-sidebar">
                        <!-- Getting Started -->
                        <div class="activity-card orientation-card">
                            <div class="activity-card-header" onclick="toggleOrientation()" style="cursor: pointer;">
                                <span class="icon">ðŸ§­</span> Getting Started
                                <span class="toggle-icon" id="orientationToggle">â–¼</span>
                            </div>
                            <div class="activity-card-body" id="orientationBody">
                                <div class="orientation-section">
                                    <h4>ðŸ“– Read</h4>
                                    <p>Browse readings by week. Select text to annotate and highlight. Annotations sync across the group in real-time.</p>
                                </div>
                                <div class="orientation-section">
                                    <h4>ðŸ“ Notes</h4>
                                    <p>Private reading notes with Markdown support. Type <code>@</code> to link readings, or use the ðŸ“š button to browse.</p>
                                </div>
                                <div class="orientation-section">
                                    <h4>âœï¸ Write</h4>
                                    <p>Draft longer essays to share with the group. Link readings and publish when ready.</p>
                                </div>
                                <div class="orientation-section">
                                    <h4>ðŸ’¬ Discuss</h4>
                                    <p>Share quick thoughts about readings, read essays, and comment on posts. A feed for group conversation.</p>
                                </div>
                                <div class="orientation-section">
                                    <h4>ðŸ” Search</h4>
                                    <p>Full-text search across all readings. Use âŒ˜/Ctrl+K or the search icon.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Workshops -->
                        <div class="workshop-card">
                            <div class="workshop-card-header">
                                <span class="icon">ðŸ› ï¸</span> Unit Workshops
                            </div>
                            <div class="workshop-card-body">
                                <div class="workshop-item" onclick="openWorkshop(1)" style="cursor: pointer;">
                                    <div class="unit">Unit I Workshop</div>
                                    <div class="dates">Feb 26 or 27</div>
                                </div>
                                <div class="workshop-item" onclick="openWorkshop(2)" style="cursor: pointer;">
                                    <div class="unit">Unit II Workshop</div>
                                    <div class="dates">Mar 19 or 20</div>
                                </div>
                                <div class="workshop-item" onclick="openWorkshop(3)" style="cursor: pointer;">
                                    <div class="unit">Unit III Workshop</div>
                                    <div class="dates">Apr 17 or 18</div>
                                </div>
                                <div class="workshop-item" onclick="openWorkshop(4)" style="cursor: pointer;">
                                    <div class="unit">Unit IV Workshop</div>
                                    <div class="dates">May 7 or 8</div>
                                </div>
                                <div class="workshop-item" onclick="openWorkshop(5)" style="cursor: pointer;">
                                    <div class="unit">Unit V Workshop</div>
                                    <div class="dates">May 21 or 22</div>
                                </div>
                            </div>
                        </div>

                        <!-- Tags -->
                        <div class="activity-card">
                            <div class="activity-card-header">
                                <span class="icon">ðŸ·ï¸</span> Browse by Topic
                            </div>
                            <div class="tag-cloud" id="tagCloud">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SYLLABUS VIEW -->
        <div class="view" id="view-syllabus">
            <div class="syllabus-view">
                <h1>Schedule of Readings</h1>
                <div id="syllabusContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- READ VIEW -->
        <div class="view read-view" id="view-read">
            <div class="read-sidebar" id="readSidebar">
                <div class="read-sidebar-header">
                    <span>Readings</span>
                    <button class="sidebar-toggle-btn" onclick="toggleReadSidebar()" title="Toggle sidebar (âŒ˜[)">â—€</button>
                </div>
                <div class="read-sidebar-content" id="readingsList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="pdf-container">
                <div class="pdf-module">
                    <div class="pdf-header">
                        <div class="pdf-title" id="pdfTitle">Select a reading</div>
                        <div class="pdf-controls" id="pdfControls" style="display: none;">
                            <span><span id="totalPages">0</span> pages</span>
                            <div class="zoom-controls">
                                <button onclick="zoomOut()" title="Zoom out">âˆ’</button>
                                <span id="zoomLevel">100%</span>
                                <button onclick="zoomIn()" title="Zoom in">+</button>
                                <button onclick="fitWidth()" title="Reset">â†”</button>
                            </div>
                            <div class="column-toggle" id="columnToggle" style="display: none;">
                                <button onclick="setColumnMode('all')" class="active" data-mode="all">All</button>
                                <button onclick="setColumnMode('left')" data-mode="left">Left</button>
                                <button onclick="setColumnMode('right')" data-mode="right">Right</button>
                            </div>
                            <span class="ocr-status" id="ocrStatus" style="display: none;"></span>
                            <button class="ocr-btn" id="ocrBtn" onclick="runOcrOnCurrentPage()" style="display: none;">
                                <span class="spinner"></span>OCR
                            </button>
                            <button class="fullscreen-btn" onclick="toggleFullscreen()">â›¶</button>
                        </div>
                    </div>
                    <div class="pdf-viewer" id="pdfViewer">
                        <div class="pdf-empty">
                            <div class="pdf-empty-icon">ðŸ“–</div>
                            <div>Select a reading from the sidebar</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="annotations-container">
                <div class="annotations-panel" id="annotationsPanel">
                    <div class="annotations-header">
                        <button class="sidebar-toggle-btn" onclick="toggleAnnotationsPanel()" title="Toggle annotations (âŒ˜])">â–¶</button>
                        <h3>Annotations</h3>
                        <span id="annotationsCount"></span>
                        <button class="add-note-btn" onclick="startPinnedNote()" title="Add a note without highlighting">+ Note</button>
                    </div>
                <div class="annotations-list" id="annotationsList">
                    <div class="annotations-empty">
                        Select text to annotate, or click "+ Note" to add a pinned note.
                    </div>
                </div>
                <div class="annotation-form" id="annotationForm">
                    <div class="quote-preview" id="quotePreview"></div>
                    <div class="rtf-toolbar">
                        <button onclick="rtfCommand('bold')" title="Bold (âŒ˜B)"><b>B</b></button>
                        <button onclick="rtfCommand('italic')" title="Italic (âŒ˜I)"><i>I</i></button>
                        <button onclick="rtfCommand('underline')" title="Underline (âŒ˜U)"><u>U</u></button>
                        <button onclick="rtfCommand('strikeThrough')" title="Strikethrough"><s>S</s></button>
                        <button onclick="rtfCommand('insertUnorderedList')" title="Bullet list">â€¢</button>
                        <button onclick="rtfCommand('insertOrderedList')" title="Numbered list">1.</button>
                    </div>
                    <div class="rtf-editor" id="annotationComment" contenteditable="true" data-placeholder="Add your thoughts..."></div>
                    <div class="form-actions">
                        <button class="btn secondary" onclick="cancelAnnotation()">Cancel</button>
                        <button class="btn" onclick="saveAnnotation()">Save</button>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- NOTES VIEW (Private Reading Notes) -->
        <div class="view notes-view" id="view-notes">
            <div class="notes-sidebar">
                <div class="notes-sidebar-header">
                    <h3>Your Notes</h3>
                    <button class="btn" onclick="newNote()">+ New</button>
                </div>
                <div class="notes-list" id="notesList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="editor-container" id="editorContainer">
                <div class="editor-empty">
                    <div class="editor-empty-icon">ðŸ“</div>
                    <div>Select a note or create a new one</div>
                    <div class="editor-empty-hint">Your notes are private and won't be shared with the group.</div>
                </div>
            </div>
            <div class="editor-active" id="editorActive" style="display: none; flex: 1; flex-direction: column;">
                <div class="editor-header">
                    <input type="text" class="editor-title-input" id="noteTitleInput" placeholder="Note title...">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn secondary" onclick="saveNote()">Save</button>
                        <button class="btn secondary" onclick="deleteNote()">Delete</button>
                    </div>
                </div>
                <div class="editor-body">
                    <div class="editor-textarea-wrapper">
                        <textarea class="editor-textarea" id="noteContentInput" placeholder="Write your notes here...

Type @ to link a reading, or use the ðŸ“Ž button below."></textarea>
                        <div class="autocomplete-dropdown" id="noteAutocomplete"></div>
                    </div>
                </div>
                <div class="editor-footer">
                    <div class="linked-readings" id="noteLinkedReadings">
                        <!-- Chips appear here -->
                    </div>
                    <button class="btn secondary link-reading-btn" onclick="openReadingPicker('note')">
                        <span>ðŸ“Ž</span> Link Reading
                    </button>
                </div>
            </div>
        </div>

        <!-- WRITE VIEW (Substack-style Essay Editor) -->
        <div class="view write-view" id="view-write">
            <div class="substack-editor">
                <div class="substack-editor-container">
                    <div class="substack-header">
                        <input type="text" class="substack-title" id="essayTitleInput" placeholder="Title">
                        <input type="text" class="substack-subtitle" id="essaySubtitleInput" placeholder="Add a subtitle...">
                    </div>
                    <div class="substack-body">
                        <div class="editor-textarea-wrapper">
                            <textarea class="substack-textarea" id="essayContentInput" placeholder="Start writing...

Your essay will be published to the Discuss feed where others can read and respond.

Type @ to link a reading."></textarea>
                            <div class="autocomplete-dropdown" id="essayAutocomplete"></div>
                        </div>
                    </div>
                    <div class="substack-footer">
                        <div class="substack-footer-left">
                            <div class="linked-readings" id="essayLinkedReadings">
                                <!-- Chips appear here -->
                            </div>
                            <button class="btn secondary link-reading-btn" onclick="openReadingPicker('essay')">
                                <span>ðŸ“Ž</span> Link Reading
                            </button>
                        </div>
                        <div class="substack-actions">
                            <button class="btn secondary" onclick="saveDraft()">Save Draft</button>
                            <button class="btn" onclick="publishEssay()">Publish</button>
                        </div>
                    </div>
                </div>
                <div class="substack-sidebar">
                    <div class="substack-sidebar-header" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Your Drafts</span>
                        <button class="btn" onclick="newDraft()" style="padding: 4px 10px; font-size: 12px;">+ New</button>
                    </div>
                    <div class="drafts-list" id="draftsList">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- DISCUSS VIEW (Published Essays Feed) -->
        <div class="view" id="view-discuss">
            <div class="discuss-view">
                <div class="discuss-header">
                    <h1>Discussion</h1>
                    <button class="btn secondary" onclick="switchView('write')">Write Essay</button>
                </div>

                <!-- Quick Post Composer -->
                <div class="quick-post-composer">
                    <div class="composer-avatar" id="composerAvatar">?</div>
                    <div class="composer-input-area">
                        <textarea id="quickPostInput" placeholder="What's on your mind about the readings?" maxlength="500"></textarea>
                        <div class="composer-footer">
                            <span class="char-count"><span id="charCount">0</span>/500</span>
                            <button class="btn" onclick="postQuickThought()">Post</button>
                        </div>
                    </div>
                </div>

                <!-- Feed -->
                <div class="feed-tabs">
                    <button class="feed-tab active" onclick="switchFeedTab('all')">All</button>
                    <button class="feed-tab" onclick="switchFeedTab('thoughts')">Thoughts</button>
                    <button class="feed-tab" onclick="switchFeedTab('essays')">Essays</button>
                </div>

                <div id="postsContainer">
                    <div class="empty-state" style="padding: 60px 20px;">
                        No posts yet. Share your thoughts about the readings!
                    </div>
                </div>
            </div>
        </div>

        <!-- WORKSHOP VIEW -->
        <div class="view" id="view-workshop">
            <div class="workshop-view">
                <div class="workshop-header">
                    <button class="btn secondary" onclick="switchView('home')">&larr; Back</button>
                    <div class="workshop-title-area">
                        <div class="workshop-unit-label" id="workshopUnitLabel">Unit I</div>
                        <h1 id="workshopTitle">Workshop</h1>
                        <div class="workshop-dates" id="workshopDates">Feb 26 or 27</div>
                    </div>
                </div>

                <div class="workshop-content">
                    <!-- Covered Weeks -->
                    <div class="workshop-section">
                        <h2>Covered Readings</h2>
                        <div class="workshop-weeks" id="workshopWeeks">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Related Essays -->
                    <div class="workshop-section">
                        <h2>Related Essays</h2>
                        <div class="workshop-essays" id="workshopEssays">
                            <div class="empty-state">No essays linked to this unit's readings yet.</div>
                        </div>
                    </div>

                    <!-- Discussion Thread -->
                    <div class="workshop-section">
                        <h2>Discussion</h2>
                        <div class="workshop-discussion">
                            <div class="workshop-comment-form">
                                <textarea id="workshopCommentInput" placeholder="Share thoughts, questions, or ideas for the workshop..."></textarea>
                                <button class="btn" onclick="postWorkshopComment()">Post</button>
                            </div>
                            <div class="workshop-comments" id="workshopComments">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SPLIT VIEW CONTAINER -->
        <div class="split-container horizontal" id="splitContainer">
            <div class="split-pane" id="splitPane1">
                <div class="split-pane-module">
                    <div class="split-pane-header">
                        <select id="splitPane1Select" name="splitPane1Select" class="split-pane-select" onchange="setSplitPaneContent(1, this.value)">
                            <option value="read">Read</option>
                            <option value="notes">Notes</option>
                            <option value="discuss">Discuss</option>
                            <option value="annotations">Annotations</option>
                        </select>
                        <button class="split-pane-close" onclick="closeSplitPane(1)" title="Close pane">âœ•</button>
                    </div>
                    <div class="split-pane-content" id="splitPane1Content"></div>
                </div>
            </div>
            <div class="split-divider" id="splitDivider"></div>
            <div class="split-pane" id="splitPane2">
                <div class="split-pane-module">
                    <div class="split-pane-header">
                        <select id="splitPane2Select" name="splitPane2Select" class="split-pane-select" onchange="setSplitPaneContent(2, this.value)">
                            <option value="notes" selected>Notes</option>
                            <option value="read">Read</option>
                            <option value="discuss">Discuss</option>
                            <option value="annotations">Annotations</option>
                        </select>
                        <button class="split-pane-close" onclick="closeSplitPane(2)" title="Close pane">âœ•</button>
                    </div>
                    <div class="split-pane-content" id="splitPane2Content"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Selection Popup -->
    <div class="selection-popup" id="selectionPopup">
        <button onclick="startAnnotation()">Annotate</button>
    </div>

    <!-- Auth Modal -->
    <!-- Welcome Modal (first-time visitors) -->
    <div class="modal-overlay" id="welcomeModal">
        <div class="modal" style="max-width: 560px;">
            <div style="text-align: center; margin-bottom: 1rem;">
                <h2 style="margin: 0; font-size: 1.5rem;">Welcome to Metamodality</h2>
                <p style="color: var(--text-muted); margin: 0.5rem 0 0;">An Inquiry into Forms of the Possible</p>
            </div>

            <div style="background: var(--bg-secondary); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <p style="margin: 0 0 0.75rem; font-size: 0.9rem;">This workspace is for participants in the Center for Possible Minds reading group, Spring 2026.</p>
                <p style="margin: 0; font-size: 0.9rem; color: var(--text-muted);">Wednesdays, 4:00â€“5:30 PM, starting February 4.</p>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                <div style="padding: 0.75rem; background: var(--bg-hover); border-radius: 6px;">
                    <strong style="font-size: 0.85rem;">ðŸ“– Read</strong>
                    <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--text-muted);">All readings with shared annotations</p>
                </div>
                <div style="padding: 0.75rem; background: var(--bg-hover); border-radius: 6px;">
                    <strong style="font-size: 0.85rem;">ðŸ“ Notes</strong>
                    <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--text-muted);">Private notes with reading links</p>
                </div>
                <div style="padding: 0.75rem; background: var(--bg-hover); border-radius: 6px;">
                    <strong style="font-size: 0.85rem;">âœï¸ Write</strong>
                    <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--text-muted);">Draft and publish essays</p>
                </div>
                <div style="padding: 0.75rem; background: var(--bg-hover); border-radius: 6px;">
                    <strong style="font-size: 0.85rem;">ðŸ’¬ Discuss</strong>
                    <p style="margin: 0.25rem 0 0; font-size: 0.8rem; color: var(--text-muted);">Comment on shared work</p>
                </div>
            </div>

            <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 1rem; text-align: center;">
                Sign in with your email to sync notes and participate in discussions.
            </p>

            <div class="btn-row" style="justify-content: center;">
                <button class="btn secondary" onclick="dismissWelcome()">Browse first</button>
                <button class="btn" onclick="dismissWelcome(); showAuthModal();">Sign in</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h3>Sign in</h3>
            <p id="authModalText">Enter your email to receive a login code.</p>
            <div class="message" id="authMessage" style="display: none;"></div>
            <form onsubmit="event.preventDefault(); handleModalLogin();" autocomplete="on">
                <input type="email" id="authEmail" name="email" autocomplete="email" placeholder="your@email.com">
                <input type="text" id="authOtpCode" name="otp" autocomplete="one-time-code" placeholder="Enter 8-digit code" maxlength="8" pattern="[0-9]{8}" style="display: none; text-align: center; font-size: 1.25rem; letter-spacing: 0.3rem;">
                <div class="btn-row">
                    <button type="button" class="btn secondary" onclick="hideAuthModal()">Cancel</button>
                    <button type="submit" class="btn" id="authModalSubmitBtn">Send Code</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Profile Modal -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal" style="max-width: 400px;">
            <h3>Your Profile</h3>
            <p style="color: var(--text-muted); margin-bottom: 1rem;">Choose how you appear to others.</p>
            <div class="message" id="profileMessage" style="display: none;"></div>
            <form onsubmit="event.preventDefault(); saveProfile();" autocomplete="on">
                <div style="margin-bottom: 1rem;">
                    <label for="profileUsername" style="font-size: 0.85rem; font-weight: 500; display: block; margin-bottom: 0.25rem;">Username</label>
                    <input type="text" id="profileUsername" name="username" autocomplete="username" placeholder="yourname" style="width: 100%;" maxlength="30">
                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-top: 0.25rem;">Letters, numbers, and underscores only</div>
                </div>
                <div style="margin-bottom: 1rem;">
                    <label for="profileDisplayName" style="font-size: 0.85rem; font-weight: 500; display: block; margin-bottom: 0.25rem;">Display Name (optional)</label>
                    <input type="text" id="profileDisplayName" name="displayName" autocomplete="name" placeholder="Your Full Name" style="width: 100%;" maxlength="50">
                </div>
                <div class="btn-row">
                    <button type="button" class="btn secondary" onclick="hideProfileModal()">Cancel</button>
                    <button type="submit" class="btn">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Reading Picker Modal -->
    <div class="modal-overlay" id="readingPickerModal">
        <div class="modal reading-picker-modal">
            <div class="reading-picker-header">
                <h3>Link a Reading</h3>
                <input type="text" class="reading-picker-search" id="readingPickerSearch" placeholder="Search readings..." oninput="filterReadingPicker()">
            </div>
            <div class="reading-picker-body" id="readingPickerBody">
                <!-- Populated by JS -->
            </div>
            <div class="btn-row">
                <button class="btn secondary" onclick="closeReadingPicker()">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://tnasxupoydyoxibccovm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuYXN4dXBveWR5b3hpYmNjb3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDM5NjksImV4cCI6MjA4NDc3OTk2OX0.JTXSnyDDl5Ta3s7fDtnGfWcuicuchwP5A5WhRZ_exIg';

        let db = null;
        let currentUser = null;
        let currentProfile = null;
        let profilesCache = {}; // Cache profiles by user ID

        try {
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.warn('Supabase init failed:', e);
        }

        // =============================================
        // AUTH DEBUG LOGGING
        // =============================================
        const authDebug = {
            startTime: Date.now(),
            log: function(step, details = {}) {
                const elapsed = Date.now() - this.startTime;
                const msg = `[AUTH ${elapsed}ms] ${step}`;
                console.log(msg, details);
                // Also store in array for easy export
                if (!window.authDebugLog) window.authDebugLog = [];
                window.authDebugLog.push({ time: elapsed, step, details, timestamp: new Date().toISOString() });
            },
            getReport: function() {
                return JSON.stringify(window.authDebugLog || [], null, 2);
            }
        };

        // Check URL for auth callback parameters
        let isAuthCallback = false;
        (function checkAuthCallback() {
            const hash = window.location.hash;
            const search = window.location.search;
            authDebug.log('Page loaded', {
                url: window.location.href,
                hasHash: !!hash,
                hashPreview: hash ? hash.substring(0, 100) : null,
                hasSearch: !!search,
                search: search,
                referrer: document.referrer
            });

            // Check for Supabase auth tokens in hash
            if (hash.includes('access_token')) {
                authDebug.log('Auth callback detected - access_token in URL hash');
                isAuthCallback = true;
                // Show loading feedback
                document.body.insertAdjacentHTML('afterbegin',
                    '<div id="authCallbackOverlay" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(255,255,255,0.95);z-index:99999;display:flex;align-items:center;justify-content:center;flex-direction:column;font-family:system-ui,sans-serif;">' +
                    '<div style="font-size:24px;margin-bottom:16px;">Completing login...</div>' +
                    '<div style="font-size:14px;color:#666;">Please wait</div>' +
                    '</div>'
                );

                // Timeout - if still showing after 10 seconds, something went wrong
                setTimeout(() => {
                    const overlay = document.getElementById('authCallbackOverlay');
                    if (overlay) {
                        authDebug.log('Auth callback timeout - login may have failed');
                        overlay.innerHTML =
                            '<div style="font-size:24px;margin-bottom:16px;color:#c00;">Login failed</div>' +
                            '<div style="font-size:14px;color:#666;margin-bottom:20px;">The magic link may have expired or already been used.</div>' +
                            '<button onclick="document.getElementById(\'authCallbackOverlay\').remove();window.location.hash=\'\';" style="padding:12px 24px;font-size:16px;cursor:pointer;">Try Again</button>';
                    }
                }, 10000);
            }

            // Check for error in hash (Supabase returns errors this way)
            if (hash.includes('error')) {
                authDebug.log('Auth ERROR detected in URL hash', { hash: hash.substring(0, 500) });
                const hashParams = new URLSearchParams(hash.substring(1));
                const error = hashParams.get('error');
                const errorDescription = hashParams.get('error_description');
                alert('Login failed: ' + (errorDescription || error || 'Unknown error'));
                window.location.hash = '';
            }

            if (search.includes('error')) {
                authDebug.log('Error parameter in URL search', { search });
            }
        })();

        // Make debug report accessible globally
        window.getAuthDebugReport = function() {
            const report = authDebug.getReport();
            console.log('=== AUTH DEBUG REPORT ===');
            console.log(report);
            console.log('=== END REPORT ===');
            console.log('Copy the above or run: copy(window.authDebugLog)');
            return window.authDebugLog;
        };

        // =============================================
        // SCHEDULE DATA
        // =============================================
        // Tag definitions
        const tagCategories = {
            tradition: ['Greek', 'Islamic', 'Buddhist', 'Rationalist', 'Phenomenological', 'Pragmatist', 'Process', 'Contemplative', 'Neoplatonic', 'Kabbalistic'],
            concept: ['possibility', 'actuality', 'potentiality', 'essence', 'existence', 'nothingness', 'contingency', 'necessity', 'imagination', 'emanation', 'continuity', 'attention'],
            thinker: ['Parmenides', 'Aristotle', 'Avicenna', 'NÄgÄrjuna', 'Leibniz', 'Du ChÃ¢telet', 'Kant', 'Ibn Ê¿ArabÄ«', 'Husserl', 'Derrida', 'Heidegger', 'Arendt', 'Peirce', 'Nishida', 'Lalla', 'Whitehead', 'Thompson', 'Weil', 'Varela', 'Plotinus', 'Conway', 'Marcus', 'Hamkins', 'Borges']
        };

        // Workshop data
        const workshops = [
            { id: 1, unit: "Unit I", title: "Ancient and Medieval Foundations", dates: "Feb 26 or 27", weeks: [1, 2, 3, 4] },
            { id: 2, unit: "Unit II", title: "Rationalism, Transcendentalism, and the Imaginal", dates: "Mar 19 or 20", weeks: [5, 6, 7] },
            { id: 3, unit: "Unit III", title: "Phenomenology, Pragmatism, and Nothingness", dates: "Apr 17 or 18", weeks: [8, 9, 10, 11] },
            { id: 4, unit: "Unit IV", title: "Process, Contemplation, Emanation", dates: "May 7 or 8", weeks: [12, 13, 14] },
            { id: 5, unit: "Unit V", title: "Mathematical and Formal Possibility", dates: "May 21 or 22", weeks: [15, 16] }
        ];

        const schedule = [
            {
                unit: "Unit I: Ancient and Medieval Foundations",
                weeks: [
                    { num: 1, date: "Feb 4", title: "Being and Non-Being",
                      tags: ['Greek', 'Parmenides', 'possibility', 'nothingness'],
                      focus: `How can we think or speak "what is not"? This problem drives subsequent responses from Aristotle through Heidegger. Kingsley's reading situates Parmenides within an initiatory tradition.`,
                      readings: [
                        { id: "w01_parmenides", title: `Parmenides, "On Nature" (complete fragments)`, file: "readings/Week 1_Parmenides/Week 1_Parmenides.pdf" },
                        { id: "w01_kingsley", title: `Kingsley, <em>In the Dark Places of Wisdom</em> (Parts One and Two most essential)`, file: "readings/Week 1_Parmenides/Week 1_Kingsley.pdf" }
                    ]},
                    { num: 2, date: "Feb 11", title: "Potentiality and Actuality",
                      tags: ['Greek', 'Aristotle', 'potentiality', 'actuality', 'possibility'],
                      focus: "Aristotle's potentiality (dynamis) answers Parmenides by locating possibility within beings themselves. The sea-battle problem asks whether future contingents have determinate truth values.",
                      readings: [
                        { id: "w02_meta", title: `Aristotle, <em>Metaphysics</em> Book Î˜, ch. 1â€“3 and 6â€“8`, file: "readings/Week 2_Aristotle/Week 2_Aristotle.pdf" },
                        { id: "w02_di", title: `Aristotle, <em>De Interpretatione</em>, ch. 9`, file: "readings/Week 2_Aristotle/Week 2_Conway.pdf" },
                        { id: "w02_witt", title: `Witt, "The Priority of Actuality in Aristotle"`, file: "readings/Week 2_Aristotle/Week 2_Witt.pdf" }
                    ]},
                    { num: 3, date: "Feb 18", title: "Essence and Existence",
                      tags: ['Islamic', 'Avicenna', 'essence', 'existence', 'contingency', 'necessity'],
                      focus: "Separating essence from existence, Avicenna makes contingency fundamental to everything except the Necessary Existent. This reconfiguration of Aristotle shapes Leibniz's later work on possible worlds.",
                      readings: [
                        { id: "w03_avicenna", title: `Avicenna, <em>The Metaphysics of The Healing</em>, selections`, file: "readings/Week 3_Avicenna/Week 3_Avicenna.pdf" },
                        { id: "w03_adamson", title: `Adamson, "From the Necessary Existent to God"`, file: "readings/Week 3_Avicenna/Week 3_Adamson.pdf" }
                    ]},
                    { num: 4, date: "Feb 25", title: "Emptiness and Dependent Arising",
                      tags: ['Buddhist', 'NÄgÄrjuna', 'nothingness', 'contingency'],
                      focus: `Does "possibility" mean anything once inherent existence drops out? NÄgÄrjuna's tetralemma refuses the logical options that Western frameworks take for granted.`,
                      readings: [
                        { id: "w04_nagarjuna", title: `NÄgÄrjuna, <em>MÅ«lamadhyamakakÄrikÄ</em>, ch. 1, 2, 15, 24, 25`, file: "readings/Week 4_Nagarjuna/Week 4_Nagarjuna.pdf" },
                        { id: "w04_garfield", title: `Garfield, "Dependent Arising and the Emptiness of Emptiness"`, file: "readings/Week 4_Nagarjuna/Week 4_Garfield (Essay).pdf" },
                        { id: "w04_commentary", title: `Garfield, <em>Commentary</em> (optional)`, file: "readings/Week 4_Nagarjuna/Week 4_Garfield (Commentary).pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit II: Rationalism, Transcendentalism, and the Imaginal",
                weeks: [
                    { num: 5, date: "Mar 4", title: "Compossibility and Possible Worlds",
                      tags: ['Rationalist', 'Leibniz', 'Du ChÃ¢telet', 'possibility', 'necessity'],
                      focus: `Compossibility constrains which possibilities can coexist within a single world. The <em>Monadology</em> raises the question of what individuates possible worlds.`,
                      readings: [
                        { id: "w05_monad", title: `Leibniz, <em>Monadology</em>`, file: "readings/Week 5_Leibniz and Du ChÃ¢telet/Leibniz_Monadology.pdf" },
                        { id: "w05_duchat", title: `Du ChÃ¢telet, <em>Institutions de physique</em>, ch. 1â€“2`, file: "readings/Week 5_Leibniz and Du ChÃ¢telet/Week 5_Du Chatelet.pdf" },
                        { id: "w05_orig", title: `Leibniz, "On the Ultimate Origination of Things"`, file: "readings/Week 5_Leibniz and Du ChÃ¢telet/Week 5_Leibniz (Origination).pdf" }
                    ]},
                    { num: 6, date: "Mar 11", title: "Real and Logical Possibility",
                      tags: ['Rationalist', 'Kant', 'possibility'],
                      focus: "What must any possible experience conform to? Kant's Postulates distinguish logical possibility from real possibility.",
                      readings: [
                        { id: "w06_kant", title: `Kant, <em>Critique of Pure Reason</em>: "Postulates of Empirical Thought"`, file: "readings/Week 6_Kant and Leech/Week 6_Kant.pdf" },
                        { id: "w06_leech", title: `Leech, "The Function of Modal Judgment and the Kantian Gap"`, file: "readings/Week 6_Kant and Leech/Week 6_Leech.pdf" }
                    ]},
                    { num: 7, date: "Mar 18", title: "The Imaginal World",
                      tags: ['Islamic', 'Ibn Ê¿ArabÄ«', 'imagination', 'possibility'],
                      focus: "Ibn Ê¿ArabÄ«'s imaginal world (Ê¿Älam al-mithÄl) occupies a realm between sensible and intelligible, where possibilities take on form. The Adam chapter introduces the human being as comprehensive mirror of divine names; the Joseph chapter develops imagination as an ontological realm through dream interpretation. (Spring Breakâ€”informal)",
                      readings: [
                        { id: "w07_arabi", title: `Ibn Ê¿ArabÄ«, <em>Fuá¹£Å«á¹£ al-á¸¤ikam</em> (Bezels of Wisdom), "Adam" and "Joseph" chapters (Austin trans.)`, file: "readings/Week 7_al-Adawiyya and Ibn Arabi/Week 7_Arabi.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit III: Phenomenology, Pragmatism, and Nothingness",
                weeks: [
                    { num: 8, date: "Mar 25", title: "Conditions of Possibility",
                      tags: ['Phenomenological', 'Husserl', 'Derrida', 'possibility'],
                      focus: "Can a condition of possibility also be a condition of impossibility? Derrida's introduction examines how ideal objects arise in history yet claim eternal validity.",
                      readings: [
                        { id: "w08_husserl", title: `Husserl, "The Origin of Geometry"`, file: "readings/Week 8_Husserl and Derrida/Week 8_Husserl and Derrida.pdf" },
                        { id: "w08_derrida", title: `Derrida, <em>Introduction to "The Origin of Geometry,"</em> selections`, file: "readings/Week 8_Husserl and Derrida/Week 8_Husserl and Derrida.pdf" }
                    ]},
                    { num: 9, date: "Apr 1", title: "Death and Natality",
                      tags: ['Phenomenological', 'Heidegger', 'Arendt', 'possibility', 'existence'],
                      focus: "Heidegger transforms the Aristotelian vocabulary so that possibility becomes constitutive of Dasein; death individualizes as the ownmost possibility. Arendt's natality offers a counter-emphasis.",
                      readings: [
                        { id: "w09_heid", title: `Heidegger, <em>Being and Time</em>, Division II ch. 1 (Â§Â§46â€“53)`, file: "readings/Week 9_Heidegger and Arendt/Week 9_Heidegger.pdf" },
                        { id: "w09_arendt", title: `Arendt, <em>The Human Condition</em>, ch. 5 Â§Â§24â€“26`, file: "readings/Week 9_Heidegger and Arendt/Week 9_Arendt.pdf" }
                    ]},
                    { num: 10, date: "Apr 8", title: "Firstness and Continuity",
                      tags: ['Pragmatist', 'Peirce', 'possibility', 'continuity'],
                      focus: "Firstness is pure qualitative possibility, prior to relation or resistance. Peirce's continuum allows possibility to grade into actuality.",
                      readings: [
                        { id: "w10_peirce", title: `Peirce, "A Guess at the Riddle"`, file: "readings/Week 10_Peirce/Week 10_Peirce.pdf" },
                        { id: "w10_continuity", title: `"The Continuity of Life: On Peirce's Objective Idealism"`, file: "readings/Week 10_Peirce/Week 10_Ibri (On Peirce's Objective Idealism).pdf" }
                    ]},
                    { num: 11, date: "Apr 15", title: "Nothingness East and West",
                      tags: ['Buddhist', 'Contemplative', 'Nishida', 'Lalla', 'nothingness'],
                      focus: `Nishida's "place of absolute nothingness" (zettai mu no basho) holds particulars without being one itself. Lalla's Kashmiri Shaivite poetry pursues nothingness through a different idiom.`,
                      readings: [
                        { id: "w11_nishida", title: `Nishida KitarÅ, <em>An Inquiry into the Good</em>, Part I ch. 1â€“3`, file: "readings/Week 11_Nishida and Lalla/Week 11_Nishida.pdf" },
                        { id: "w11_lalla", title: `Lalla, <em>Naked Song</em>, selections`, file: "readings/Week 11_Nishida and Lalla/Week 11_Lalla.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit IV: Process, Contemplation, Emanation",
                weeks: [
                    { num: 12, date: "Apr 22", title: "Eternal Objects and Ingression",
                      tags: ['Process', 'Whitehead', 'potentiality', 'actuality'],
                      focus: "Eternal objects ingress into actual occasions as pure potentials. Whitehead's God functions as the primordial envisagement of possibility, a role that recalls Leibniz, and Peirce's categories find new form in this processual framework.",
                      readings: [
                        { id: "w12_white", title: `Whitehead, <em>Science and the Modern World</em>, ch. 11`, file: "readings/Week 12_Whitehead/Week 12_Whitehead.pdf" },
                        { id: "w12_stengers", title: `Stengers, <em>Thinking with Whitehead</em>, selections`, file: "readings/Week 12_Whitehead/Week 12_Stengers (Thinking With Whitehead).pdf" }
                    ]},
                    { num: 13, date: "Apr 29", title: "Attention and Awareness",
                      tags: ['Contemplative', 'Thompson', 'Weil', 'Varela', 'attention'],
                      focus: "Thompson and Varela bridge first-person contemplative methods and third-person neuroscience. Weil's account of attention resonates with contemplative approaches while drawing on Platonic sources.",
                      readings: [
                        { id: "w13_thompson", title: `Thompson, <em>Waking, Dreaming, Being</em>, ch. 1`, file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Thompson.pdf" },
                        { id: "w13_weil", title: `Weil, "Reflections on the Right Use of School Studies with a View to the Love of God"`, file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Weil.pdf" },
                        { id: "w13_varela", title: `Varela, "Neurophenomenology: A Methodological Remedy for the Hard Problem"`, file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Varela.pdf" }
                    ]},
                    { num: 14, date: "May 6", title: "Emanation and Superabundance",
                      tags: ['Neoplatonic', 'Kabbalistic', 'Plotinus', 'Conway', 'emanation'],
                      focus: "Possibility flows from the One's inexhaustible superabundance. This emanationist framework shaped Avicenna and passed into German Idealism; it offers a counterpoint to the Aristotelian model of potentiality.",
                      readings: [
                        { id: "w14_plotinus", title: `Plotinus, <em>Enneads</em> V.1`, file: "readings/Week 14_Plotinus, Conway/Week 14_Plotinus.pdf" },
                        { id: "w14_conway", title: `Conway, <em>Principles of the Most Ancient and Modern Philosophy</em>, selections`, file: "readings/Week 14_Plotinus, Conway/Week 14_Conway.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit V: Mathematical and Formal Possibility",
                weeks: [
                    { num: 15, date: "May 13", title: "Set-Theoretic Potentialism",
                      tags: ['Marcus', 'Hamkins', 'possibility', 'potentiality'],
                      focus: "Ruth Barcan Marcus founded quantified modal logic; her Barcan formula raises questions about the relation between possibility and existence. Hamkins's multiverse holds many distinct concepts of set, each instantiated in a corresponding universe.",
                      readings: [
                        { id: "w15_marcus", title: `Barcan Marcus, "Modalities and Intensional Languages"`, file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Marcus.pdf" },
                        { id: "w15_hamkins", title: `Hamkins, "The Set-Theoretic Multiverse"`, file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Hamkins (multiverse).pdf" },
                        { id: "w15_linnebo", title: `Hamkins & Linnebo, "The Modal Logic of Set-Theoretic Potentialism"`, file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Hamkins and Linnebo.pdf" }
                    ]},
                    { num: 16, date: "May 20", title: "Producing the Possible",
                      tags: ['Borges', 'possibility'],
                      focus: "How do possibility spaces themselves get produced? Foster's work shows tradition constraining what becomes thinkable while furnishing materials for innovation, bringing the semester's philosophical questions into contact with computational and sociological methods. Borges's story explores the literary form of branching possibility.",
                      readings: [
                        { id: "w16_metal", title: `Koch, Silvestro & Foster, "The Evolutionary Dynamics of Cultural Change (As Told Through the Birth and Brutal, Blackened Death of Metal Music)"`, file: "readings/Week 16_Foster/Week 16_Foster and Koch.pdf" },
                        { id: "w16_borges", title: `Borges, "The Garden of Forking Paths"`, file: "readings/Week 16_Foster/Week 16_Borges.pdf" }
                    ]}
                ]
            }
        ];

        // State
        let currentWeekNum = 1;
        let currentReading = null;
        let selectedText = '';
        let annotations = {};
        let notes = [];
        let posts = [];
        let editingNoteId = null;

        // =============================================
        // REALTIME SUBSCRIPTIONS
        // =============================================

        function setupRealtimeSubscriptions() {
            if (!db) return;

            // Annotations - refresh when changes occur
            db.channel('realtime-annotations')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'annotations' },
                    (payload) => {
                        console.log('Realtime annotation update:', payload.eventType);
                        if (currentReading) {
                            loadAnnotations(currentReading);
                        }
                        loadAllAnnotationsForActivity();
                    }
                )
                .subscribe();

            // Thoughts - refresh feed when changes occur
            db.channel('realtime-thoughts')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'thoughts' },
                    (payload) => {
                        console.log('Realtime thought update:', payload.eventType);
                        loadThoughts();
                    }
                )
                .subscribe();

            // Posts - refresh feed when changes occur
            db.channel('realtime-posts')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'posts' },
                    (payload) => {
                        console.log('Realtime post update:', payload.eventType);
                        loadFeed();
                    }
                )
                .subscribe();

            // Post comments - refresh comments when changes occur
            db.channel('realtime-post-comments')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'post_comments' },
                    (payload) => {
                        console.log('Realtime post comment update:', payload.eventType);
                        loadPostComments();
                    }
                )
                .subscribe();

            // Workshop comments - refresh when changes occur
            db.channel('realtime-workshop-comments')
                .on('postgres_changes',
                    { event: '*', schema: 'public', table: 'workshop_comments' },
                    (payload) => {
                        console.log('Realtime workshop comment update:', payload.eventType);
                        loadAllWorkshopComments();
                        if (currentWorkshopId) {
                            loadWorkshopComments(currentWorkshopId);
                        }
                    }
                )
                .subscribe();

            console.log('Realtime subscriptions active');
        }

        // =============================================
        // INITIALIZATION
        // =============================================

        async function init() {
            // Test Supabase connection
            if (db) {
                updateStatus('connecting', 'Connecting...');
                try {
                    // Quick test query
                    const { error } = await db.from('annotations').select('id').limit(1);
                    if (error) {
                        console.error('Supabase test query error:', error);
                        updateStatus('error', 'Database error');
                    } else {
                        updateStatus('online', 'Connected');
                        setupRealtimeSubscriptions();
                    }
                } catch (e) {
                    console.error('Supabase connection test failed:', e);
                    updateStatus('offline', 'Offline mode');
                }
            } else {
                updateStatus('offline', 'Offline mode');
            }

            buildSyllabus();
            buildReadingsList();
            renderCurrentWeek();
            loadFeed();
            loadThoughts();
            loadPostComments();
            loadNotes();
            loadDrafts();
            loadAllAnnotationsForActivity();
            loadAllWorkshopComments();
            setupComposer();

            // Handle URL parameters for deep linking
            const params = new URLSearchParams(window.location.search);
            const weekParam = params.get('week');
            if (weekParam) {
                const weekNum = parseInt(weekParam, 10);
                if (weekNum >= 1 && weekNum <= 16) {
                    goToWeek(weekNum);
                }
            }

            // Auth state with whitelist check
            // Use a flag to prevent race conditions between handlers
            let authCheckInProgress = false;

            if (db) {
                authDebug.log('Setting up onAuthStateChange listener');

                db.auth.onAuthStateChange(async (event, session) => {
                    authDebug.log('onAuthStateChange fired', {
                        event,
                        hasSession: !!session,
                        email: session?.user?.email,
                        userId: session?.user?.id,
                        expiresAt: session?.expires_at
                    });

                    // Prevent duplicate checks
                    if (authCheckInProgress) {
                        authDebug.log('Auth check already in progress, skipping duplicate');
                        return;
                    }

                    if (session?.user) {
                        authCheckInProgress = true;
                        authDebug.log('User session found, starting whitelist check');

                        try {
                            // Check if email is in whitelist
                            const whitelistStart = Date.now();
                            authDebug.log('Calling checkEmailAllowed', { email: session.user.email });
                            const result = await checkEmailAllowed(session.user.email);
                            authDebug.log('checkEmailAllowed returned', {
                                result,
                                duration: Date.now() - whitelistStart
                            });

                            if (!result.allowed) {
                                authDebug.log('Access DENIED', { reason: result.reason });
                                // Show error BEFORE signing out so user sees it
                                if (result.reason === 'not_on_list') {
                                    alert('Access denied. Your email is not on the invite list. Please contact the organizer.');
                                } else {
                                    alert('Login error: ' + result.reason + '. Please try again.');
                                }
                                authDebug.log('Signing out user');
                                await db.auth.signOut();
                                authDebug.log('Sign out complete');
                                return;
                            }

                            authDebug.log('Access GRANTED, setting up user session');
                            currentUser = session.user;
                            await loadCurrentProfile();
                            authDebug.log('Profile loaded');
                            updateAuthUI(currentUser);
                            authDebug.log('Auth UI updated');
                            hideAuthModal();
                            authDebug.log('Auth modal hidden');

                            // Remove auth callback overlay if present
                            const overlay = document.getElementById('authCallbackOverlay');
                            if (overlay) overlay.remove();

                            // Clear the hash from URL (clean up tokens)
                            if (window.location.hash.includes('access_token')) {
                                history.replaceState(null, '', window.location.pathname + window.location.search);
                            }

                            loadNotes();
                            loadDrafts();
                            migrateLocalAnnotationsToSupabase();
                            authDebug.log('Login complete - user is now authenticated');
                        } catch (err) {
                            authDebug.log('ERROR in auth handler', {
                                error: err.message,
                                stack: err.stack
                            });
                            alert('Login error: ' + err.message);
                        } finally {
                            authCheckInProgress = false;
                        }
                    } else {
                        authDebug.log('No session - user is logged out', { event });
                        currentUser = null;
                        currentProfile = null;
                        updateAuthUI(null);
                    }
                });

                // Just trigger initial session check - onAuthStateChange will handle it
                authDebug.log('Calling getSession to check for existing session');
                db.auth.getSession().then(({ data, error }) => {
                    authDebug.log('getSession returned', {
                        hasSession: !!data?.session,
                        email: data?.session?.user?.email,
                        error: error?.message
                    });
                });
            } else {
                authDebug.log('ERROR: db not initialized, auth will not work');
            }

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Cmd/Ctrl + [ = toggle left sidebar
                if ((e.metaKey || e.ctrlKey) && e.key === '[') {
                    e.preventDefault();
                    toggleReadSidebar();
                }
                // Cmd/Ctrl + ] = toggle right sidebar
                if ((e.metaKey || e.ctrlKey) && e.key === ']') {
                    e.preventDefault();
                    toggleAnnotationsPanel();
                }
                // Cmd/Ctrl + \ = toggle both sidebars (focus mode)
                if ((e.metaKey || e.ctrlKey) && e.key === '\\') {
                    e.preventDefault();
                    toggleReadSidebar();
                    toggleAnnotationsPanel();
                }
                // Cmd/Ctrl + / = toggle split view
                if ((e.metaKey || e.ctrlKey) && e.key === '/') {
                    e.preventDefault();
                    toggleSplitView();
                }
                // Cmd/Ctrl + = or + = zoom in
                if ((e.metaKey || e.ctrlKey) && (e.key === '=' || e.key === '+')) {
                    e.preventDefault();
                    zoomIn();
                }
                // Cmd/Ctrl + - = zoom out
                if ((e.metaKey || e.ctrlKey) && e.key === '-') {
                    e.preventDefault();
                    zoomOut();
                }
                // Cmd/Ctrl + 0 = fit width
                if ((e.metaKey || e.ctrlKey) && e.key === '0') {
                    e.preventDefault();
                    fitWidth();
                }
            });

        }

        function updateStatus(status, text) {
            document.getElementById('statusDot').className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = text;
        }

        // =============================================
        // SPLIT VIEW
        // =============================================

        let splitViewActive = false;

        function toggleSplitView() {
            splitViewActive = !splitViewActive;
            const splitContainer = document.getElementById('splitContainer');
            const splitBtn = document.getElementById('splitBtn');

            if (splitViewActive) {
                // Hide all regular views
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                // Show split container
                splitContainer.classList.add('active');
                splitBtn.classList.add('active');
                // Initialize panes with default content
                setSplitPaneContent(1, 'read');
                setSplitPaneContent(2, 'notes');
            } else {
                // Hide split container
                splitContainer.classList.remove('active');
                splitBtn.classList.remove('active');
                // Show home view (or last active view)
                switchView('home');
            }
        }

        // Track split pane state
        const splitPaneState = { 1: { zoom: 1.0, reading: null }, 2: { zoom: 1.0, reading: null } };

        function setSplitPaneContent(paneNum, contentType) {
            const paneContent = document.getElementById(`splitPane${paneNum}Content`);
            paneContent.innerHTML = '';

            switch (contentType) {
                case 'read':
                    paneContent.innerHTML = `
                        <div class="split-pdf-layout">
                            <div class="split-readings-sidebar">
                                <div class="split-readings-header">Readings</div>
                                <div id="splitReadings${paneNum}"></div>
                            </div>
                            <div class="split-pdf-main">
                                <div class="split-pdf-toolbar">
                                    <span class="pdf-title" id="splitPdfTitle${paneNum}">Select a reading</span>
                                    <button class="btn zoom-btn" onclick="splitZoom(${paneNum}, -0.1)" title="Zoom out">âˆ’</button>
                                    <button class="btn zoom-btn" onclick="splitZoom(${paneNum}, 0.1)" title="Zoom in">+</button>
                                    <button class="btn zoom-btn" onclick="splitFitWidth(${paneNum})" title="Fit width">â¤¢</button>
                                </div>
                                <div class="split-pdf-viewer" id="splitPdfViewer${paneNum}">
                                    <div class="empty-state">Select a reading from the sidebar</div>
                                </div>
                            </div>
                            <div class="split-annotations-panel">
                                <div class="split-annotations-header">Annotations</div>
                                <div class="split-annotations-list" id="splitAnnotationsList${paneNum}">
                                    <div class="empty-state">Select text to annotate</div>
                                </div>
                            </div>
                        </div>
                    `;
                    renderSplitReadingsList(paneNum);
                    break;
                case 'notes':
                    paneContent.innerHTML = `
                        <div style="display: flex; height: 100%;">
                            <div style="width: 200px; border-right: 1px solid var(--border); overflow-y: auto; background: var(--bg-sidebar);">
                                <div style="padding: 10px; display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 11px; text-transform: uppercase; color: var(--text-muted); font-weight: 600;">Notes</span>
                                    <button class="btn" style="padding: 2px 8px; font-size: 11px;" onclick="newSplitNote(${paneNum})">+</button>
                                </div>
                                <div id="splitNotesList${paneNum}"></div>
                            </div>
                            <div style="flex: 1; display: flex; flex-direction: column;">
                                <input type="text" id="splitNoteTitle${paneNum}" placeholder="Note title..." style="padding: 15px; border: none; border-bottom: 1px solid var(--border); font-size: 16px; font-weight: 500;">
                                <textarea id="splitNoteContent${paneNum}" placeholder="Write your thoughts..." style="flex: 1; padding: 15px; border: none; resize: none; font-family: inherit; font-size: 14px; line-height: 1.6;"></textarea>
                                <div style="padding: 10px; border-top: 1px solid var(--border); display: flex; gap: 10px; justify-content: flex-end;">
                                    <button class="btn" onclick="saveSplitNote(${paneNum})">Save</button>
                                </div>
                            </div>
                        </div>
                    `;
                    renderSplitNotesList(paneNum);
                    break;
                case 'discuss':
                    paneContent.innerHTML = `
                        <div style="padding: 20px; max-width: 700px; margin: 0 auto;">
                            <h2 style="margin-bottom: 20px;">Discussion</h2>
                            <div id="splitFeed${paneNum}"></div>
                        </div>
                    `;
                    renderSplitFeed(paneNum);
                    break;
                case 'annotations':
                    paneContent.innerHTML = `
                        <div style="padding: 20px;">
                            <h3 style="margin-bottom: 15px;">All Annotations</h3>
                            <div id="splitAnnotations${paneNum}"></div>
                        </div>
                    `;
                    renderSplitAnnotations(paneNum);
                    break;
            }
        }

        function renderSplitReadingsList(paneNum) {
            const container = document.getElementById(`splitReadings${paneNum}`);
            let html = '';
            schedule.forEach(unit => {
                unit.weeks.forEach(week => {
                    html += `<div class="split-week-header">Week ${week.num}</div>`;
                    week.readings.forEach(r => {
                        const isActive = splitPaneState[paneNum].reading === r.id;
                        html += `<div class="split-reading-item ${isActive ? 'active' : ''}"
                                     data-reading-id="${r.id}"
                                     onclick="loadSplitReading(${paneNum}, '${r.id}')">${r.title.split(',')[0]}</div>`;
                    });
                });
            });
            container.innerHTML = html;
        }

        async function loadSplitReading(paneNum, readingId) {
            const viewer = document.getElementById(`splitPdfViewer${paneNum}`);
            const titleEl = document.getElementById(`splitPdfTitle${paneNum}`);
            viewer.innerHTML = '<div class="empty-state">Loading...</div>';

            // Find the reading
            let reading = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    for (const r of week.readings) {
                        if (r.id === readingId) {
                            reading = r;
                            break;
                        }
                    }
                }
            }

            if (!reading) return;

            // Update state and UI
            splitPaneState[paneNum].reading = readingId;
            splitPaneState[paneNum].pdf = null;
            titleEl.textContent = reading.title.split(',')[0];

            // Update active state in readings list
            const container = document.getElementById(`splitReadings${paneNum}`);
            container.querySelectorAll('.split-reading-item').forEach(el => {
                el.classList.toggle('active', el.dataset.readingId === readingId);
            });

            try {
                const pdf = await pdfjsLib.getDocument(reading.file).promise;
                splitPaneState[paneNum].pdf = pdf;
                await renderSplitPdf(paneNum);
                renderSplitAnnotationsList(paneNum, readingId);
            } catch (e) {
                viewer.innerHTML = `<div class="empty-state" style="color: var(--error);">Error loading PDF: ${e.message}</div>`;
            }
        }

        async function renderSplitPdf(paneNum) {
            const state = splitPaneState[paneNum];
            if (!state.pdf) return;

            const viewer = document.getElementById(`splitPdfViewer${paneNum}`);
            const availableWidth = viewer.clientWidth - 40;
            viewer.innerHTML = '';

            for (let i = 1; i <= state.pdf.numPages; i++) {
                const page = await state.pdf.getPage(i);
                const baseViewport = page.getViewport({ scale: 1.0 });
                const fitScale = availableWidth / baseViewport.width;
                const scale = fitScale * state.zoom;
                const viewport = page.getViewport({ scale });

                // Create page wrapper
                const pageWrapper = document.createElement('div');
                pageWrapper.className = 'split-page-wrapper';
                pageWrapper.dataset.pane = paneNum;
                pageWrapper.dataset.page = i;

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                pageWrapper.appendChild(canvas);

                // Create text layer
                const textLayerDiv = document.createElement('div');
                textLayerDiv.className = 'textLayer';
                textLayerDiv.style.width = viewport.width + 'px';
                textLayerDiv.style.height = viewport.height + 'px';
                textLayerDiv.style.setProperty('--scale-factor', scale);
                pageWrapper.appendChild(textLayerDiv);

                viewer.appendChild(pageWrapper);

                // Render canvas
                await page.render({ canvasContext: canvas.getContext('2d'), viewport }).promise;

                // Render text layer
                const textContent = await page.getTextContent();
                await pdfjsLib.renderTextLayer({
                    textContent: textContent,
                    container: textLayerDiv,
                    viewport: viewport,
                    textDivs: []
                }).promise;
            }

            // Set up text selection listener for this pane
            viewer.onmouseup = () => handleSplitTextSelection(paneNum);
        }

        function splitZoom(paneNum, delta) {
            splitPaneState[paneNum].zoom = Math.max(0.5, Math.min(3, splitPaneState[paneNum].zoom + delta));
            renderSplitPdf(paneNum);
        }

        function splitFitWidth(paneNum) {
            splitPaneState[paneNum].zoom = 1.0;
            renderSplitPdf(paneNum);
        }

        function handleSplitTextSelection(paneNum) {
            const selection = window.getSelection();
            const text = selection.toString().trim();
            if (!text || text.length < 3) return;

            // Store selected text for annotation
            splitPaneState[paneNum].selectedText = text;

            // Show annotation prompt
            const annotationsList = document.getElementById(`splitAnnotationsList${paneNum}`);
            annotationsList.innerHTML = `
                <div style="padding: 15px;">
                    <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 8px;">Selected text:</div>
                    <div style="font-size: 13px; font-style: italic; margin-bottom: 15px; padding: 10px; background: var(--bg-dark); border-radius: 6px;">"${text.substring(0, 100)}${text.length > 100 ? '...' : ''}"</div>
                    <textarea id="splitAnnotationComment${paneNum}" placeholder="Add your annotation..." style="width: 100%; height: 80px; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; font-size: 13px; resize: none;"></textarea>
                    <div style="margin-top: 10px; display: flex; gap: 8px;">
                        <button class="btn" onclick="saveSplitAnnotation(${paneNum})">Save</button>
                        <button class="btn secondary" onclick="cancelSplitAnnotation(${paneNum})">Cancel</button>
                    </div>
                </div>
            `;
        }

        async function saveSplitAnnotation(paneNum) {
            const state = splitPaneState[paneNum];
            if (!state.reading || !state.selectedText) return;

            const comment = document.getElementById(`splitAnnotationComment${paneNum}`).value;
            const annotation = {
                id: Date.now().toString(),
                reading_id: state.reading,
                quote: state.selectedText,
                comment: comment,
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            // Add to local state
            if (!annotations[state.reading]) annotations[state.reading] = [];
            annotations[state.reading].unshift(annotation);
            localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

            // Save to Supabase if logged in
            if (db && currentUser) {
                annotation.user_id = currentUser.id;
                try {
                    await db.from('annotations').insert([annotation]);
                } catch (e) {
                    console.warn('Failed to save to Supabase:', e);
                }
            }

            state.selectedText = null;
            renderSplitAnnotationsList(paneNum, state.reading);
            renderActivityStream();
        }

        function cancelSplitAnnotation(paneNum) {
            splitPaneState[paneNum].selectedText = null;
            renderSplitAnnotationsList(paneNum, splitPaneState[paneNum].reading);
        }

        function renderSplitAnnotationsList(paneNum, readingId) {
            const container = document.getElementById(`splitAnnotationsList${paneNum}`);
            const readingAnnotations = annotations[readingId] || [];

            if (readingAnnotations.length === 0) {
                container.innerHTML = '<div class="empty-state">Select text to annotate</div>';
                return;
            }

            container.innerHTML = readingAnnotations.map(a => `
                <div class="annotation-item" style="padding: 12px; border-bottom: 1px solid var(--border);">
                    <div class="quote" style="font-size: 12px; font-style: italic; color: var(--text-muted); margin-bottom: 6px;">"${(a.quote || '').substring(0, 60)}..."</div>
                    <div class="comment" style="font-size: 13px; color: var(--text);">${a.comment || ''}</div>
                    <div class="meta" style="font-size: 11px; color: var(--text-muted); margin-top: 6px;">${a.author_email?.split('@')[0] || 'Anonymous'} Â· ${new Date(a.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function renderSplitNotesList(paneNum) {
            const container = document.getElementById(`splitNotesList${paneNum}`);
            if (notes.length === 0) {
                container.innerHTML = '<div style="padding: 15px; color: var(--text-muted); font-size: 12px;">No notes yet</div>';
                return;
            }
            container.innerHTML = notes.map(n => `
                <div style="padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer;"
                     onclick="loadSplitNote(${paneNum}, '${n.id}')"
                     onmouseover="this.style.background='var(--highlight)'"
                     onmouseout="this.style.background=''">
                    <div style="font-size: 13px; font-weight: 500;">${n.title || 'Untitled'}</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">${new Date(n.created_at || n.createdAt).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function loadSplitNote(paneNum, noteId) {
            const note = notes.find(n => n.id === noteId);
            if (!note) return;
            document.getElementById(`splitNoteTitle${paneNum}`).value = note.title || '';
            document.getElementById(`splitNoteContent${paneNum}`).value = note.content || '';
            document.getElementById(`splitNoteTitle${paneNum}`).dataset.noteId = noteId;
        }

        function newSplitNote(paneNum) {
            document.getElementById(`splitNoteTitle${paneNum}`).value = '';
            document.getElementById(`splitNoteContent${paneNum}`).value = '';
            delete document.getElementById(`splitNoteTitle${paneNum}`).dataset.noteId;
        }

        async function saveSplitNote(paneNum) {
            const titleEl = document.getElementById(`splitNoteTitle${paneNum}`);
            const contentEl = document.getElementById(`splitNoteContent${paneNum}`);
            const title = titleEl.value;
            const content = contentEl.value;
            const noteId = titleEl.dataset.noteId;

            if (noteId) {
                // Update existing
                const idx = notes.findIndex(n => n.id === noteId);
                if (idx >= 0) {
                    notes[idx].title = title;
                    notes[idx].content = content;
                }
            } else {
                // Create new
                const note = { id: Date.now().toString(), title, content, createdAt: new Date().toISOString() };
                notes.unshift(note);
                titleEl.dataset.noteId = note.id;
            }

            renderSplitNotesList(paneNum);
            // Also update main notes if loaded
            renderNotesList();
        }

        function renderSplitFeed(paneNum) {
            const container = document.getElementById(`splitFeed${paneNum}`);
            if (posts.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">No posts yet</div>';
                return;
            }
            container.innerHTML = posts.map(p => `
                <div style="padding: 20px; background: var(--bg-panel); border-radius: 8px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                    <h3 style="margin-bottom: 10px;">${p.title}</h3>
                    <p style="color: var(--text); line-height: 1.6;">${p.content?.substring(0, 200)}...</p>
                    <div style="margin-top: 10px; font-size: 12px; color: var(--text-muted);">${p.author_email || 'Anonymous'}</div>
                </div>
            `).join('');
        }

        function renderSplitAnnotations(paneNum) {
            const container = document.getElementById(`splitAnnotations${paneNum}`);
            // Get all annotations from localStorage
            const allAnnotations = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('metamodality_annotations_')) {
                    const readingId = key.replace('metamodality_annotations_', '');
                    const annotations = JSON.parse(localStorage.getItem(key) || '[]');
                    annotations.forEach(a => allAnnotations.push({ ...a, readingId }));
                }
            }

            if (allAnnotations.length === 0) {
                container.innerHTML = '<div style="color: var(--text-muted);">No annotations yet</div>';
                return;
            }

            container.innerHTML = allAnnotations.map(a => `
                <div style="padding: 15px; background: var(--bg-sidebar); border-radius: 8px; margin-bottom: 10px;">
                    <div style="font-style: italic; color: var(--text); margin-bottom: 8px; padding-left: 10px; border-left: 3px solid var(--accent);">"${a.quote}"</div>
                    <div style="font-size: 13px; color: var(--text);">${a.comment || ''}</div>
                    <div style="font-size: 11px; color: var(--text-muted); margin-top: 8px;">${a.readingId}</div>
                </div>
            `).join('');
        }

        function closeSplitPane(paneNum) {
            // If closing a pane, exit split view
            toggleSplitView();
        }

        // =============================================
        // VIEW SWITCHING
        // =============================================

        function switchView(viewName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            document.querySelector(`[data-view="${viewName}"]`)?.classList.add('active');
            document.getElementById('view-' + viewName)?.classList.add('active');

            // Clear notification badge for this tab
            clearBadge(viewName);

            // Update last visit time when viewing content tabs
            if (['discuss', 'read'].includes(viewName)) {
                updateLastVisit();
            }
        }

        // =============================================
        // SEARCH
        // =============================================

        async function handleSearch(event) {
            if (event.key === 'Enter') {
                const query = document.getElementById('globalSearch').value.trim();
                if (!query) return;

                const queryLower = query.toLowerCase();
                console.log('Searching for:', query);

                // Search through readings and weeks (local)
                const results = [];

                try {
                    schedule.forEach(unit => {
                        unit.weeks.forEach(week => {
                            // Check week title and focus
                            if ((week.title || '').toLowerCase().includes(queryLower) ||
                                (week.focus || '').toLowerCase().includes(queryLower)) {
                                results.push({
                                    type: 'week',
                                    title: `Week ${week.num}: ${week.title}`,
                                    description: (week.focus || '').substring(0, 100) + '...',
                                    action: () => goToWeek(week.num)
                                });
                            }

                            // Check readings
                            (week.readings || []).forEach(r => {
                                const titleText = (r.title || '').replace(/<[^>]*>/g, ''); // Strip HTML
                                if (titleText.toLowerCase().includes(queryLower)) {
                                    results.push({
                                        type: 'reading',
                                        title: titleText,
                                        description: `Week ${week.num}`,
                                        action: () => openReading(r.id)
                                    });
                                }
                            });
                        });
                    });

                    // Search through notes
                    (notes || []).forEach(note => {
                        if ((note.title || '').toLowerCase().includes(queryLower) ||
                            (note.content || '').toLowerCase().includes(queryLower)) {
                            results.push({
                                type: 'note',
                                title: note.title || 'Untitled',
                                description: (note.content || '').substring(0, 80) + '...',
                                action: () => { switchView('notes'); editNote(note.id); }
                            });
                        }
                    });

                    // Search through annotations (quotes from readings)
                    Object.entries(annotations || {}).forEach(([readingId, items]) => {
                        (items || []).forEach(a => {
                            const quote = (a.quote || '').toLowerCase();
                            const comment = (a.comment || '').toLowerCase();
                            if (quote.includes(queryLower) || comment.includes(queryLower)) {
                                results.push({
                                    type: 'annotation',
                                    title: `"${(a.quote || '').substring(0, 60)}..."`,
                                    description: a.comment ? a.comment.substring(0, 60) + '...' : `From ${readingId}`,
                                    action: () => openReading(readingId)
                                });
                            }
                        });
                    });

                    // Full-text search reading content via Supabase
                    if (db) {
                        try {
                            const { data: ftResults, error } = await db
                                .rpc('search_readings', { search_query: query, limit_count: 10 });

                            if (!error && ftResults && ftResults.length > 0) {
                                ftResults.forEach(r => {
                                    results.push({
                                        type: 'content',
                                        title: r.title,
                                        description: r.snippet || `Week ${r.week_num}`,
                                        action: () => openReading(r.reading_id)
                                    });
                                });
                            }
                        } catch (ftErr) {
                            console.warn('Full-text search unavailable:', ftErr);
                        }
                    }

                    console.log('Search results:', results.length);

                    // Show results
                    if (results.length > 0) {
                        showSearchResults(results, query);
                    } else {
                        alert(`No results found for "${query}"`);
                    }
                } catch (err) {
                    console.error('Search error:', err);
                    alert('Search error: ' + err.message);
                }
            }
        }

        function showSearchResults(results, query) {
            // Create modal for search results
            const modal = document.createElement('div');
            modal.className = 'modal-overlay active';
            modal.innerHTML = `
                <div class="modal" style="max-width: 900px; width: 90%;">
                    <div class="modal-header">
                        <h3>Search Results for "${query}"</h3>
                        <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${results.map((r, i) => `
                            <div class="search-result-item" onclick="searchResults[${i}].action(); this.closest('.modal-overlay').remove();">
                                <div class="search-result-type">${r.type}</div>
                                <div class="search-result-title">${r.title}</div>
                                <div class="search-result-desc">${r.description}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            window.searchResults = results;
        }

        // =============================================
        // HOME VIEW
        // =============================================

        function getCurrentWeek() {
            // For now, default to week 1. Could be date-based later.
            let week = null;
            for (const unit of schedule) {
                for (const w of unit.weeks) {
                    if (w.num === currentWeekNum) {
                        week = w;
                        break;
                    }
                }
            }
            return week;
        }

        function renderCurrentWeek() {
            const week = getCurrentWeek();
            if (!week) return;

            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            const weekProgress = progress[`week_${week.num}`] || {};

            document.getElementById('currentWeekCard').innerHTML = `
                <div class="current-week-label">Week ${week.num} â€” ${week.date}</div>
                <h2>${week.title}</h2>
                ${week.tags ? `<div class="week-tags">${week.tags.map(t => `<span class="tag" onclick="filterByTag('${t}')">${t}</span>`).join('')}</div>` : ''}
                <p class="focus">${week.focus}</p>
                <div class="current-week-readings">
                    ${week.readings.map(r => `
                        <div class="reading-card" onclick="openReading('${r.id}')">
                            <span class="icon">${weekProgress[r.id] ? 'âœ“' : 'ðŸ“„'}</span>
                            <div class="info">
                                <div class="title">${r.title}</div>
                            </div>
                            <span class="arrow">â†’</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Also render sidebar components
            renderCourseStream();
            renderActivityStream();
            renderSemesterProgress();
            renderNextWeekPreview();
            renderTagCloud();
        }

        let activeTagFilter = null;

        function filterByTag(tag) {
            if (activeTagFilter === tag) {
                activeTagFilter = null; // Toggle off
            } else {
                activeTagFilter = tag;
            }

            // Show filtered results in a modal
            const matchingWeeks = [];
            schedule.forEach(unit => {
                unit.weeks.forEach(week => {
                    if (week.tags && week.tags.includes(tag)) {
                        matchingWeeks.push(week);
                    }
                });
            });

            if (matchingWeeks.length > 0 && activeTagFilter) {
                const modal = document.createElement('div');
                modal.className = 'modal-overlay active';
                modal.innerHTML = `
                    <div class="modal" style="max-width: 500px;">
                        <div class="modal-header">
                            <h3>Weeks tagged "${tag}"</h3>
                            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">Ã—</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${matchingWeeks.map(w => `
                                <div class="search-result-item" onclick="goToWeek(${w.num}); this.closest('.modal-overlay').remove();">
                                    <div class="search-result-type">Week ${w.num}</div>
                                    <div class="search-result-title">${w.title}</div>
                                    <div class="search-result-desc">${w.focus.substring(0, 80)}...</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            renderTagCloud();
        }

        function renderTagCloud() {
            const container = document.getElementById('tagCloud');
            if (!container) return;

            // Collect all unique tags with counts
            const tagCounts = {};
            schedule.forEach(unit => {
                unit.weeks.forEach(week => {
                    (week.tags || []).forEach(tag => {
                        tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                });
            });

            // Sort by count
            const sortedTags = Object.entries(tagCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 15); // Top 15 tags

            container.innerHTML = sortedTags.map(([tag, count]) =>
                `<span class="tag${activeTagFilter === tag ? ' active' : ''}" onclick="filterByTag('${tag}')">${tag}</span>`
            ).join('');
        }

        function renderSemesterProgress() {
            const container = document.getElementById('semesterProgress');
            if (!container) return;

            const totalWeeks = 16;
            const progressPercent = Math.round((currentWeekNum / totalWeeks) * 100);

            container.innerHTML = `
                <div class="progress-header">
                    <span class="label">Semester Progress</span>
                    <span class="value">Week ${currentWeekNum} of ${totalWeeks}</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: ${progressPercent}%"></div>
                </div>
            `;
        }

        function renderNextWeekPreview() {
            const container = document.getElementById('nextWeekPreview');
            if (!container) return;

            // Find next week
            const nextWeekNum = currentWeekNum + 1;
            if (nextWeekNum > 16) {
                container.style.display = 'none';
                return;
            }

            let nextWeek = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    if (week.num === nextWeekNum) {
                        nextWeek = week;
                        break;
                    }
                }
                if (nextWeek) break;
            }

            if (!nextWeek) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';
            container.onclick = () => goToWeek(nextWeekNum);
            container.innerHTML = `
                <div class="next-week-label">Coming Up â€” Week ${nextWeek.num}</div>
                <h3>${nextWeek.title}</h3>
                <p class="focus">${nextWeek.focus.substring(0, 150)}${nextWeek.focus.length > 150 ? '...' : ''}</p>
            `;
        }

        function renderCourseStream() {
            const container = document.getElementById('courseStream');
            if (!container) return;

            let html = '';
            schedule.forEach(unit => {
                // Unit header
                html += `<div class="course-unit-header">${unit.unit}</div>`;

                // Weeks in unit
                unit.weeks.forEach(week => {
                    const isCurrent = week.num === currentWeekNum;
                    html += `
                        <div class="course-week-item ${isCurrent ? 'current' : ''}" onclick="goToWeek(${week.num})">
                            <div class="week-num">Week ${week.num}</div>
                            <div class="week-title">${week.title}</div>
                            <div class="week-date">${week.date}</div>
                        </div>
                    `;
                });
            });

            container.innerHTML = html;

            // Scroll current week into view
            setTimeout(() => {
                const currentItem = container.querySelector('.course-week-item.current');
                if (currentItem) {
                    currentItem.scrollIntoView({ block: 'center', behavior: 'smooth' });
                }
            }, 100);
        }

        function renderActivityStream() {
            const container = document.getElementById('activityStream');
            if (!container) return;

            // Combine all activity types into a single stream
            const activities = [];

            // Add posts (essays)
            posts.forEach(p => {
                activities.push({
                    type: 'post',
                    author: p.author_email || 'Anonymous',
                    title: p.title,
                    time: new Date(p.published_at),
                    onClick: `switchView('discuss')`
                });
            });

            // Add thoughts (quick posts)
            thoughts.forEach(t => {
                activities.push({
                    type: 'thought',
                    author: t.author_email || 'Anonymous',
                    content: t.content?.substring(0, 50) + (t.content?.length > 50 ? '...' : ''),
                    time: new Date(t.created_at),
                    onClick: `switchView('discuss')`
                });
            });

            // Add post comments
            Object.entries(postComments).forEach(([postId, comments]) => {
                const post = posts.find(p => p.id === postId);
                (comments || []).forEach(c => {
                    activities.push({
                        type: 'comment',
                        author: c.author_email || 'Anonymous',
                        postTitle: post?.title || 'an essay',
                        time: new Date(c.created_at),
                        onClick: `switchView('discuss')`
                    });
                });
            });

            // Add workshop comments (from all workshops)
            allWorkshopComments.forEach(c => {
                const workshop = workshops.find(w => w.id === c.workshop_id);
                activities.push({
                    type: 'workshop_comment',
                    author: c.author_email || 'Anonymous',
                    workshopTitle: workshop ? `${workshop.unit} Workshop` : 'a workshop',
                    time: new Date(c.created_at),
                    onClick: `openWorkshop(${c.workshop_id})`
                });
            });

            // Add annotations from all readings
            Object.entries(annotations).forEach(([readingId, items]) => {
                (items || []).forEach(a => {
                    activities.push({
                        type: 'annotation',
                        author: a.author_email || 'Anonymous',
                        quote: a.quote?.substring(0, 40) + '...',
                        readingId: readingId,
                        time: new Date(a.created_at),
                        onClick: `openReading('${readingId}')`
                    });
                });
            });

            // Sort by time, most recent first
            activities.sort((a, b) => b.time - a.time);

            if (activities.length === 0) {
                container.innerHTML = '<div class="empty-state">Activity from the group will appear here.</div>';
                return;
            }

            // Update notification badges
            updateNotificationBadges(activities);

            container.innerHTML = activities.slice(0, 10).map(a => {
                const initial = (a.author.split('@')[0] || 'A')[0].toUpperCase();
                const timeAgo = formatTimeAgo(a.time);

                if (a.type === 'post') {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> posted
                                    <span class="target">"${a.title}"</span>
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                } else if (a.type === 'thought') {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> shared
                                    <span class="target">"${a.content}"</span>
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                } else if (a.type === 'comment') {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> commented on
                                    <span class="target">"${a.postTitle}"</span>
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                } else if (a.type === 'workshop_comment') {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> posted in
                                    <span class="target">${a.workshopTitle}</span>
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> annotated
                                    <span class="target">"${a.quote}"</span>
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        // Notification badge system
        function getLastVisit() {
            return new Date(localStorage.getItem('metamodality_last_visit') || 0);
        }

        function updateLastVisit() {
            localStorage.setItem('metamodality_last_visit', new Date().toISOString());
        }

        function updateNotificationBadges(activities) {
            const lastVisit = getLastVisit();

            // Count new items since last visit
            const newDiscuss = activities.filter(a =>
                (a.type === 'post' || a.type === 'comment') && a.time > lastVisit
            ).length;

            const newRead = activities.filter(a =>
                a.type === 'annotation' && a.time > lastVisit
            ).length;

            // Update badges
            updateBadge('discuss', newDiscuss);
            updateBadge('read', newRead);
        }

        function updateBadge(tabName, count) {
            const tab = document.querySelector(`[data-view="${tabName}"]`);
            if (!tab) return;

            // Remove existing badge
            const existingBadge = tab.querySelector('.notification-badge');
            if (existingBadge) existingBadge.remove();

            // Add badge if count > 0
            if (count > 0) {
                const badge = document.createElement('span');
                badge.className = 'notification-badge';
                badge.textContent = count > 9 ? '9+' : count;
                tab.style.position = 'relative';
                tab.appendChild(badge);
            }
        }

        // Clear badge when viewing that tab
        function clearBadge(tabName) {
            const tab = document.querySelector(`[data-view="${tabName}"]`);
            if (!tab) return;
            const badge = tab.querySelector('.notification-badge');
            if (badge) badge.remove();
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function openReading(readingId) {
            switchView('read');
            loadReading(readingId);
        }

        // =============================================
        // SYLLABUS VIEW
        // =============================================

        function buildSyllabus() {
            const container = document.getElementById('syllabusContent');
            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            let html = '';

            schedule.forEach((unit, unitIdx) => {
                // Parse unit title: "Unit I: Ancient and Medieval Foundations"
                const unitMatch = unit.unit.match(/^(Unit [IVX]+):\s*(.+)$/);
                const unitLabel = unitMatch ? unitMatch[1] : `Unit ${unitIdx + 1}`;
                const unitTitle = unitMatch ? unitMatch[2] : unit.unit;

                html += `<div class="unit">
                    <div class="unit-header">
                        <div class="unit-label">${unitLabel}</div>
                        <div class="unit-title">${unitTitle}</div>
                    </div>
                    ${unit.weeks.map(week => {
                        const isCurrent = week.num === currentWeekNum;
                        const weekProgress = progress[`week_${week.num}`] || {};
                        const readingsComplete = week.readings.filter(r => weekProgress[r.id]).length;
                        const isComplete = readingsComplete === week.readings.length && week.readings.length > 0;

                        return `
                        <div class="week-card ${isCurrent ? 'current' : ''} ${isComplete ? 'completed' : ''}" id="syllabus-week-${week.num}">
                            <div class="week-card-main" onclick="toggleSyllabusWeek(${week.num})">
                                <div class="week-card-header">
                                    <span class="week-num">Week ${week.num}</span>
                                    <span class="week-title">${week.title}</span>
                                    ${isCurrent ? '<span class="week-status">Current</span>' : ''}
                                    <span class="week-date">${week.date}</span>
                                </div>
                                <div class="week-focus">${week.focus}</div>
                                <div class="week-summary">
                                    <span>ðŸ“š ${week.readings.length} readings</span>
                                    ${readingsComplete > 0 ? `<span>âœ“ ${readingsComplete}/${week.readings.length} complete</span>` : ''}
                                    <span class="expand-icon">â–¼</span>
                                </div>
                            </div>
                            <div class="week-readings-list">
                                ${week.readings.map(r => {
                                    const isRead = weekProgress[r.id];
                                    return `
                                    <div class="week-reading-item" onclick="event.stopPropagation(); openReading('${r.id}')">
                                        <div class="reading-icon">ðŸ“„</div>
                                        <div class="reading-info">
                                            <div class="reading-title">${r.title}</div>
                                        </div>
                                        <div class="reading-progress ${isRead ? 'complete' : ''}">${isRead ? 'âœ“' : ''}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `}).join('')}
                </div>`;
            });

            container.innerHTML = html;
        }

        function toggleSyllabusWeek(num) {
            const card = document.getElementById('syllabus-week-' + num);
            if (card) card.classList.toggle('expanded');
        }

        function markReadingComplete(readingId) {
            // Find which week this reading belongs to
            let weekNum = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    if (week.readings.some(r => r.id === readingId)) {
                        weekNum = week.num;
                        break;
                    }
                }
            }
            if (!weekNum) return;

            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            if (!progress[`week_${weekNum}`]) progress[`week_${weekNum}`] = {};
            progress[`week_${weekNum}`][readingId] = true;
            localStorage.setItem('metamodality_progress', JSON.stringify(progress));

            // Rebuild syllabus to reflect changes
            buildSyllabus();
        }

        function goToWeek(num) {
            currentWeekNum = num;
            buildReadingsList();
            switchView('read');
        }

        // =============================================
        // READ VIEW
        // =============================================

        function buildReadingsList() {
            const container = document.getElementById('readingsList');
            container.innerHTML = schedule.map((unit, unitIdx) => `
                <div class="sidebar-unit" id="unit-${unitIdx}">
                    <div class="sidebar-unit-header" onclick="toggleUnit(${unitIdx})">
                        <span class="collapse-icon">â–¼</span>
                        ${unit.unit.replace('Unit ', '').replace(/:.+/, '')}
                    </div>
                    <div class="sidebar-unit-weeks">
                        ${unit.weeks.map((week, weekIdx) => `
                            <div class="sidebar-week" id="week-${week.num}">
                                <div class="sidebar-week-header" onclick="toggleWeek(${week.num})">
                                    <span class="collapse-icon">â–¼</span>
                                    Week ${week.num}: ${week.title}
                                </div>
                                <div class="sidebar-week-readings">
                                    ${week.readings.map(r => `
                                        <div class="reading-list-item" data-id="${r.id}" onclick="event.stopPropagation(); loadReading('${r.id}')">
                                            ${r.title.split(',')[0]}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Collapse all except current week's unit
            const currentWeek = getCurrentWeek();
            if (currentWeek) {
                document.querySelectorAll('.sidebar-unit').forEach(el => el.classList.add('collapsed'));
                document.querySelectorAll('.sidebar-week').forEach(el => el.classList.add('collapsed'));
                const weekEl = document.getElementById('week-' + currentWeek.num);
                if (weekEl) {
                    weekEl.classList.remove('collapsed');
                    weekEl.closest('.sidebar-unit')?.classList.remove('collapsed');
                }
            }
        }

        function toggleUnit(idx) {
            document.getElementById('unit-' + idx)?.classList.toggle('collapsed');
        }

        function toggleWeek(num) {
            event.stopPropagation();
            document.getElementById('week-' + num)?.classList.toggle('collapsed');
        }

        function toggleReadSidebar() {
            document.getElementById('readSidebar').classList.toggle('collapsed');
        }

        function toggleAnnotationsPanel() {
            document.getElementById('annotationsPanel').classList.toggle('collapsed');
        }

        function toggleFullscreen() {
            const readView = document.getElementById('view-read');
            readView.classList.toggle('fullscreen');
            const btn = document.querySelector('.fullscreen-btn');
            if (readView.classList.contains('fullscreen')) {
                btn.textContent = 'âœ• Exit';
                document.body.style.overflow = 'hidden';
            } else {
                btn.textContent = 'â›¶ Fullscreen';
                document.body.style.overflow = '';
            }
        }

        function toggleOrientation() {
            const body = document.getElementById('orientationBody');
            const toggle = document.getElementById('orientationToggle');
            body.classList.toggle('collapsed');
            toggle.classList.toggle('collapsed');
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'libs/pdf.worker.min.js';

        async function loadReading(readingId) {
            currentReading = readingId;
            pdfHasText = false; // Reset for new PDF

            // Reset zoom for new PDF
            currentZoom = 1.0;
            updateZoomDisplay();

            // Hide OCR controls until we know if text exists
            document.getElementById('ocrStatus').style.display = 'none';
            document.getElementById('ocrBtn').style.display = 'none';

            // Update sidebar selection
            document.querySelectorAll('.reading-list-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.reading-list-item[data-id="${readingId}"]`)?.classList.add('active');

            // Find reading info
            let readingInfo = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    for (const r of week.readings) {
                        if (r.id === readingId) {
                            readingInfo = r;
                            break;
                        }
                    }
                }
            }

            document.getElementById('pdfTitle').textContent = readingInfo?.title || 'Loading...';
            document.getElementById('pdfViewer').innerHTML = '<div class="pdf-empty"><div class="pdf-empty-icon">â³</div><div>Loading...</div></div>';
            document.getElementById('pdfControls').style.display = 'none';

            // Load annotations
            await loadAnnotations(readingId);

            // Try to load PDF
            try {
                const response = await fetch(readingInfo.file);
                if (!response.ok) throw new Error('Not found');

                const arrayBuffer = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                window.currentPdf = pdf;
                window.currentPageNum = 1;

                document.getElementById('totalPages').textContent = pdf.numPages;
                document.getElementById('pdfControls').style.display = 'flex';

                const viewer = document.getElementById('pdfViewer');
                viewer.innerHTML = '';

                // Create all page containers
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.id = 'page-container-' + i;
                    pageContainer.dataset.pageNum = i;

                    const canvas = document.createElement('canvas');
                    canvas.id = 'page-' + i;
                    pageContainer.appendChild(canvas);

                    const textLayer = document.createElement('div');
                    textLayer.className = 'pdf-text-layer';
                    textLayer.id = 'text-layer-' + i;
                    pageContainer.appendChild(textLayer);

                    viewer.appendChild(pageContainer);
                }

                // Render all pages progressively
                renderAllPages();
            } catch (e) {
                document.getElementById('pdfViewer').innerHTML = `
                    <div class="pdf-empty">
                        <div class="pdf-empty-icon">ðŸ“„</div>
                        <div>PDF not yet available</div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">${readingInfo?.file}</div>
                    </div>
                `;
            }
        }

        // Zoom state - simple percentage-based zoom
        let currentZoom = 1.0;
        const ZOOM_STEP = 0.25;
        const MIN_ZOOM = 0.5;
        const MAX_ZOOM = 2.5;

        function updateZoomDisplay() {
            document.getElementById('zoomLevel').textContent = Math.round(currentZoom * 100) + '%';
        }

        function zoomIn() {
            currentZoom = Math.min(MAX_ZOOM, currentZoom + ZOOM_STEP);
            updateZoomDisplay();
            rerenderAllPages();
        }

        function zoomOut() {
            currentZoom = Math.max(MIN_ZOOM, currentZoom - ZOOM_STEP);
            updateZoomDisplay();
            rerenderAllPages();
        }

        function fitWidth() {
            currentZoom = 1.0;
            updateZoomDisplay();
            rerenderAllPages();
        }

        async function rerenderAllPages() {
            if (!window.currentPdf) return;
            const pdf = window.currentPdf;
            for (let num = 1; num <= pdf.numPages; num++) {
                await renderSinglePage(num);
            }
        }

        async function renderAllPages() {
            if (!window.currentPdf) return;

            const pdf = window.currentPdf;
            const scale = 1.5;

            // Render pages in batches for better performance
            for (let num = 1; num <= pdf.numPages; num++) {
                await renderSinglePage(num, scale);
            }
        }

        // Track text layer status
        let pdfHasText = false;
        let ocrWorker = null;

        async function renderSinglePage(num, baseScale = 1.5) {
            if (!window.currentPdf) return;

            try {
                const page = await window.currentPdf.getPage(num);
                const canvas = document.getElementById('page-' + num);
                if (!canvas) return;

                const context = canvas.getContext('2d');
                const textLayerDiv = document.getElementById('text-layer-' + num);

                // Calculate scale to fit available width (no CSS scaling needed)
                const viewer = document.getElementById('pdfViewer');
                const availableWidth = viewer.clientWidth - 60; // Account for padding
                const baseViewport = page.getViewport({ scale: 1.0 });
                const fitScale = availableWidth / baseViewport.width;
                const scale = fitScale * currentZoom;

                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport }).promise;

                // Set container to exact canvas size - no CSS scaling
                const pageContainer = canvas.parentElement;
                pageContainer.style.width = viewport.width + 'px';
                pageContainer.style.height = viewport.height + 'px';

                // Render text layer at exact same size
                if (textLayerDiv) {
                    textLayerDiv.innerHTML = '';
                    textLayerDiv.style.width = viewport.width + 'px';
                    textLayerDiv.style.height = viewport.height + 'px';

                    const textContent = await page.getTextContent();

                    // Check if PDF has meaningful text content
                    const totalChars = textContent.items.reduce((sum, item) => sum + (item.str?.length || 0), 0);

                    if (totalChars > 50) {
                        pdfHasText = true;

                        // Use PDF.js built-in text layer rendering for proper alignment
                        textLayerDiv.classList.add('textLayer');

                        // Set the CSS variable for scale factor (required by pdf_viewer.css)
                        textLayerDiv.style.setProperty('--scale-factor', scale);

                        // Use PDF.js renderTextLayer for proper font metrics and positioning
                        await pdfjsLib.renderTextLayer({
                            textContent: textContent,
                            container: textLayerDiv,
                            viewport: viewport,
                            textDivs: []
                        }).promise;

                        // Detect two-column layout for column toggle feature
                        const pageWidth = viewport.width;
                        const midpoint = pageWidth / 2;
                        const spans = textLayerDiv.querySelectorAll('span');
                        let leftCount = 0, rightCount = 0;
                        spans.forEach(span => {
                            const rect = span.getBoundingClientRect();
                            const containerRect = textLayerDiv.getBoundingClientRect();
                            const relativeX = rect.left - containerRect.left + rect.width / 2;
                            if (relativeX < midpoint) leftCount++;
                            else rightCount++;
                        });
                        const isTwoColumn = leftCount > 10 && rightCount > 10;

                        // Mark spans with column data for filtering
                        if (isTwoColumn) {
                            spans.forEach(span => {
                                const rect = span.getBoundingClientRect();
                                const containerRect = textLayerDiv.getBoundingClientRect();
                                const relativeX = rect.left - containerRect.left + rect.width / 2;
                                span.dataset.column = relativeX < midpoint ? 'left' : 'right';
                            });
                        }
                    }

                    // Update OCR status and column toggle after first page
                    if (num === 1) {
                        updateOcrStatus();
                        showColumnToggleIfNeeded();
                    }
                }
            } catch (e) {
                console.warn('Failed to render page', num, e);
            }
        }

        function updateOcrStatus() {
            const statusEl = document.getElementById('ocrStatus');
            const btnEl = document.getElementById('ocrBtn');

            if (pdfHasText) {
                statusEl.textContent = 'Text layer detected';
                statusEl.className = 'ocr-status';
                statusEl.style.display = 'inline-block';
                btnEl.style.display = 'none';
            } else {
                statusEl.textContent = 'No text layer';
                statusEl.className = 'ocr-status warning';
                statusEl.style.display = 'inline-block';
                btnEl.style.display = 'inline-block';
            }
        }

        async function runOcrOnCurrentPage() {
            const btn = document.getElementById('ocrBtn');
            const statusEl = document.getElementById('ocrStatus');
            btn.classList.add('loading');

            try {
                const pdf = window.currentPdf;
                if (!pdf) return;

                // Initialize Tesseract worker if needed
                if (!ocrWorker) {
                    statusEl.textContent = 'Loading OCR engine...';
                    ocrWorker = await Tesseract.createWorker('eng');
                }

                // Process all pages
                for (let num = 1; num <= pdf.numPages; num++) {
                    statusEl.textContent = `OCR: page ${num}/${pdf.numPages}`;

                    const canvas = document.getElementById('page-' + num);
                    const textLayerDiv = document.getElementById('text-layer-' + num);
                    if (!canvas || !textLayerDiv) continue;

                    // Get image data from canvas
                    const imageData = canvas.toDataURL('image/png');

                    // Run OCR
                    const { data } = await ocrWorker.recognize(imageData);

                    // Clear existing text layer and add OCR results
                    textLayerDiv.innerHTML = '';

                    // Process OCR words with position info
                    const words = data.words
                        .filter(word => word.text && word.text.trim())
                        .map(word => ({
                            text: word.text,
                            x: word.bbox.x0,
                            y: word.bbox.y0,
                            width: word.bbox.x1 - word.bbox.x0,
                            height: word.bbox.y1 - word.bbox.y0
                        }));

                    // Detect columns
                    const canvasWidth = canvas.width;
                    const midpoint = canvasWidth / 2;
                    const leftWords = words.filter(w => w.x + w.width / 2 < midpoint);
                    const rightWords = words.filter(w => w.x + w.width / 2 >= midpoint);
                    const isTwoColumn = leftWords.length > 10 && rightWords.length > 10;

                    if (isTwoColumn) {
                        // Create separate containers for each column
                        const leftContainer = document.createElement('div');
                        leftContainer.className = 'column-container left-column';
                        const rightContainer = document.createElement('div');
                        rightContainer.className = 'column-container right-column';

                        leftWords.sort((a, b) => a.y - b.y);
                        rightWords.sort((a, b) => a.y - b.y);

                        // Render left column
                        leftWords.forEach(word => {
                            const span = document.createElement('span');
                            span.textContent = word.text + ' ';
                            span.style.left = word.x + 'px';
                            span.style.top = word.y + 'px';
                            span.style.fontSize = word.height * 0.8 + 'px';
                            span.style.letterSpacing = '0.5px';
                            leftContainer.appendChild(span);
                        });

                        // Render right column (no offset needed with clip-path)
                        rightWords.forEach(word => {
                            const span = document.createElement('span');
                            span.textContent = word.text + ' ';
                            span.style.left = word.x + 'px';
                            span.style.top = word.y + 'px';
                            span.style.fontSize = word.height * 0.8 + 'px';
                            span.style.letterSpacing = '0.5px';
                            rightContainer.appendChild(span);
                        });

                        textLayerDiv.appendChild(leftContainer);
                        textLayerDiv.appendChild(rightContainer);
                    } else {
                        // Single column
                        const sortedWords = words.sort((a, b) => {
                            const yDiff = a.y - b.y;
                            if (Math.abs(yDiff) > 10) return yDiff;
                            return a.x - b.x;
                        });

                        sortedWords.forEach(word => {
                            const span = document.createElement('span');
                            span.textContent = word.text + ' ';
                            span.style.left = word.x + 'px';
                            span.style.top = word.y + 'px';
                            span.style.fontSize = word.height * 0.8 + 'px';
                            span.style.letterSpacing = '0.5px';
                            textLayerDiv.appendChild(span);
                        });
                    }
                }

                // Update status
                statusEl.textContent = 'OCR complete';
                statusEl.className = 'ocr-status';
                btn.style.display = 'none';
                showColumnToggleIfNeeded();

            } catch (e) {
                console.error('OCR failed:', e);
                statusEl.textContent = 'OCR failed';
                statusEl.className = 'ocr-status warning';
            } finally {
                btn.classList.remove('loading');
            }
        }

        // =============================================
        // COLUMN MODE
        // =============================================

        let currentColumnMode = 'all';

        function setColumnMode(mode) {
            currentColumnMode = mode;

            // Update button states
            document.querySelectorAll('#columnToggle button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });

            // Apply mode to all text layers
            document.querySelectorAll('.textLayer').forEach(layer => {
                layer.classList.remove('column-mode-left', 'column-mode-right');
                if (mode === 'left') {
                    layer.classList.add('column-mode-left');
                } else if (mode === 'right') {
                    layer.classList.add('column-mode-right');
                }
            });
        }

        function showColumnToggleIfNeeded() {
            // Check if any text layer has column-marked spans
            const hasColumns = document.querySelector('.textLayer span[data-column]');
            const toggle = document.getElementById('columnToggle');
            if (toggle) {
                toggle.style.display = hasColumns ? 'flex' : 'none';
            }
        }

        // =============================================
        // ANNOTATIONS
        // =============================================

        async function loadAllAnnotationsForActivity() {
            // Load all recent annotations for the activity stream
            if (db) {
                try {
                    const { data, error } = await db
                        .from('annotations')
                        .select('*')
                        .order('created_at', { ascending: false })
                        .limit(20);

                    if (!error && data && data.length > 0) {
                        // Group by reading_id
                        data.forEach(a => {
                            if (!annotations[a.reading_id]) {
                                annotations[a.reading_id] = [];
                            }
                            // Avoid duplicates
                            if (!annotations[a.reading_id].find(x => x.id === a.id)) {
                                annotations[a.reading_id].push(a);
                            }
                        });
                        renderActivityStream();
                    }
                } catch (e) {
                    console.warn('Failed to load annotations for activity:', e);
                }
            }

            // Also load from localStorage
            const localAnnotations = JSON.parse(localStorage.getItem('metamodality_annotations') || '{}');
            Object.entries(localAnnotations).forEach(([readingId, items]) => {
                if (!annotations[readingId]) {
                    annotations[readingId] = [];
                }
                (items || []).forEach(a => {
                    if (!annotations[readingId].find(x => x.id === a.id)) {
                        annotations[readingId].push(a);
                    }
                });
            });
            renderActivityStream();
        }

        async function loadAnnotations(readingId) {
            // Load from localStorage first as fallback
            const localAnnotations = JSON.parse(localStorage.getItem('metamodality_annotations') || '{}');
            annotations = { ...localAnnotations };

            // Try to load from Supabase (works for all users, not just logged in)
            if (db) {
                try {
                    const { data, error } = await db
                        .from('annotations')
                        .select('*')
                        .eq('reading_id', readingId)
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.warn('Supabase annotations error:', error);
                        updateStatus('error', 'Database error');
                    } else if (data && data.length > 0) {
                        // Merge Supabase data with local (Supabase takes priority for shared annotations)
                        const localItems = annotations[readingId] || [];
                        const supabaseIds = new Set(data.map(a => a.id));
                        // Keep local items that aren't in Supabase (user's unsaved annotations)
                        const localOnly = localItems.filter(a => !supabaseIds.has(a.id));
                        annotations[readingId] = [...data, ...localOnly];
                        updateStatus('online', 'Connected');
                    } else {
                        updateStatus('online', 'Connected');
                    }
                } catch (e) {
                    console.warn('Failed to load annotations:', e);
                    updateStatus('error', 'Connection failed');
                }
            } else {
                updateStatus('offline', 'Offline mode');
            }
            renderAnnotations();
        }

        function renderAnnotations() {
            const list = document.getElementById('annotationsList');
            const items = annotations[currentReading] || [];

            document.getElementById('annotationsCount').textContent = items.length > 0 ? `(${items.length})` : '';

            if (items.length === 0) {
                list.innerHTML = '<div class="annotations-empty">Select text to annotate, or click "+ Note" to add a pinned note.</div>';
                return;
            }

            list.innerHTML = items.map((a, index) => {
                const isAuthor = currentUser && (a.user_id === currentUser.id || a.author_email === currentUser.email);
                return `
                <div class="annotation-item${a.pinned ? ' pinned' : ''}" data-id="${a.id}">
                    ${a.pinned
                        ? '<div class="annotation-quote">ðŸ“Œ Pinned note</div>'
                        : `<div class="annotation-quote">${escapeHtml(a.quote)}</div>`
                    }
                    ${a.comment ? `<div class="annotation-comment">${a.comment}</div>` : ''}
                    <div class="annotation-meta">${a.author_email || 'Anonymous'} Â· ${new Date(a.created_at).toLocaleDateString()}</div>
                    <div class="annotation-actions">
                        <button onclick="toggleReplyForm('${a.id}')">Reply</button>
                        ${(a.replies?.length || 0) > 0 ? `<span>${a.replies.length} ${a.replies.length === 1 ? 'reply' : 'replies'}</span>` : ''}
                        ${isAuthor ? `<button onclick="editAnnotation('${a.id}')" style="color: var(--text-muted);">âœï¸ Edit</button>` : ''}
                        ${isAuthor ? `<button onclick="deleteAnnotation('${a.id}')" style="color: var(--text-muted);">ðŸ—‘ï¸ Delete</button>` : ''}
                    </div>
                    ${a.replies?.length > 0 ? `
                        <div class="annotation-replies">
                            ${a.replies.map(r => `
                                <div class="annotation-reply">
                                    <div class="annotation-comment">${r.comment}</div>
                                    <div class="annotation-meta">${r.author_email || 'Anonymous'} Â· ${new Date(r.created_at).toLocaleDateString()}</div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    <div class="reply-form" id="reply-form-${a.id}">
                        <div class="rtf-toolbar">
                            <button onclick="rtfCommandReply('${a.id}', 'bold')"><b>B</b></button>
                            <button onclick="rtfCommandReply('${a.id}', 'italic')"><i>I</i></button>
                            <button onclick="rtfCommandReply('${a.id}', 'underline')"><u>U</u></button>
                        </div>
                        <div class="rtf-editor" id="reply-editor-${a.id}" contenteditable="true" data-placeholder="Write a reply..."></div>
                        <div class="form-actions">
                            <button class="btn secondary" onclick="toggleReplyForm('${a.id}')">Cancel</button>
                            <button class="btn" onclick="saveReply('${a.id}')">Reply</button>
                        </div>
                    </div>
                </div>
            `}).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function toggleReplyForm(annotationId) {
            const form = document.getElementById('reply-form-' + annotationId);
            form.classList.toggle('active');
            if (form.classList.contains('active')) {
                document.getElementById('reply-editor-' + annotationId).focus();
            }
        }

        function rtfCommandReply(annotationId, command) {
            document.execCommand(command, false, null);
            document.getElementById('reply-editor-' + annotationId).focus();
        }

        async function saveReply(annotationId) {
            const editor = document.getElementById('reply-editor-' + annotationId);
            const comment = editor.innerHTML.trim();
            if (!comment || !editor.innerText.trim()) {
                alert('Please enter a reply');
                return;
            }

            const reply = {
                id: Date.now().toString(),
                comment: comment,
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            // Find the annotation and add the reply
            const items = annotations[currentReading] || [];
            const annotation = items.find(a => a.id === annotationId);
            if (annotation) {
                if (!annotation.replies) annotation.replies = [];
                annotation.replies.push(reply);

                // Save to localStorage
                localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

                // Try to save to Supabase
                if (db && currentUser) {
                    try {
                        await db.from('annotations')
                            .update({ replies: annotation.replies })
                            .eq('id', annotationId);
                    } catch (e) {
                        console.warn('Failed to save reply to Supabase:', e);
                    }
                }
            }

            renderAnnotations();
        }

        async function deleteAnnotation(annotationId) {
            if (!confirm('Delete this annotation?')) return;

            // Remove from local state
            if (annotations[currentReading]) {
                annotations[currentReading] = annotations[currentReading].filter(a => a.id !== annotationId);
                localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));
            }

            // Try to delete from Supabase
            if (db && currentUser) {
                try {
                    await db.from('annotations').delete().eq('id', annotationId);
                } catch (e) {
                    console.warn('Failed to delete annotation from Supabase:', e);
                }
            }

            renderAnnotations();
            renderActivityStream();
        }

        async function migrateLocalAnnotationsToSupabase() {
            if (!db || !currentUser) return;

            // Check if migration already done
            if (localStorage.getItem('metamodality_data_migrated')) return;

            console.log('Starting localStorage migration to Supabase...');
            let totalMigrated = 0;

            // Migrate annotations
            try {
                const localData = localStorage.getItem('metamodality_annotations');
                if (localData) {
                    const localAnnotations = JSON.parse(localData);
                    const { data: existing } = await db.from('annotations').select('id');
                    const existingIds = new Set((existing || []).map(a => a.id));

                    for (const readingId in localAnnotations) {
                        const items = localAnnotations[readingId] || [];
                        for (const annotation of items) {
                            if (existingIds.has(annotation.id)) continue;
                            const toUpload = {
                                ...annotation,
                                user_id: currentUser.id,
                                author_email: annotation.author_email || currentUser.email
                            };
                            const { error } = await db.from('annotations').insert([toUpload]);
                            if (!error) totalMigrated++;
                            else console.warn('Annotation migration error:', error);
                        }
                    }
                }
            } catch (e) {
                console.warn('Annotation migration failed:', e);
            }

            // Migrate notes
            try {
                const localNotes = localStorage.getItem('metamodality_notes');
                if (localNotes) {
                    const notesData = JSON.parse(localNotes);
                    const { data: existing } = await db.from('notes').select('id').eq('user_id', currentUser.id);
                    const existingIds = new Set((existing || []).map(n => n.id));

                    for (const note of notesData) {
                        if (existingIds.has(note.id)) continue;
                        const toUpload = {
                            ...note,
                            user_id: currentUser.id
                        };
                        const { error } = await db.from('notes').insert([toUpload]);
                        if (!error) totalMigrated++;
                        else console.warn('Note migration error:', error);
                    }
                }
            } catch (e) {
                console.warn('Notes migration failed:', e);
            }

            // Migrate drafts
            try {
                const localDrafts = localStorage.getItem('metamodality_drafts');
                if (localDrafts) {
                    const draftsData = JSON.parse(localDrafts);
                    const { data: existing } = await db.from('drafts').select('id').eq('user_id', currentUser.id);
                    const existingIds = new Set((existing || []).map(d => d.id));

                    for (const draft of draftsData) {
                        if (existingIds.has(draft.id)) continue;
                        const toUpload = {
                            ...draft,
                            user_id: currentUser.id
                        };
                        const { error } = await db.from('drafts').insert([toUpload]);
                        if (!error) totalMigrated++;
                        else console.warn('Draft migration error:', error);
                    }
                }
            } catch (e) {
                console.warn('Drafts migration failed:', e);
            }

            if (totalMigrated > 0) {
                console.log(`Migration complete: ${totalMigrated} items uploaded to Supabase`);
            }

            // Mark migration as done
            localStorage.setItem('metamodality_data_migrated', 'true');
        }

        // Text selection with column filtering
        document.addEventListener('mouseup', e => {
            // Small delay to let selection finalize
            setTimeout(() => {
                const selection = window.getSelection();
                let text = selection.toString().trim();

                // Check if selection is in PDF area
                const inPdfViewer = e.target.closest('.pdf-viewer') ||
                                    e.target.closest('.pdf-text-layer') ||
                                    e.target.closest('.pdf-page-container');

                // If column mode is active, filter selection to only include text from that column
                if (text.length > 5 && currentReading && inPdfViewer && currentColumnMode !== 'all') {
                    text = filterSelectionByColumn(selection, currentColumnMode);
                }

                if (text.length > 5 && currentReading && inPdfViewer) {
                    selectedText = text;
                    const popup = document.getElementById('selectionPopup');
                    popup.style.left = e.pageX + 'px';
                    popup.style.top = (e.pageY + 10) + 'px';
                    popup.style.display = 'block';
                }
            }, 10);
        });

        // Filter selection to only include text from the specified column
        function filterSelectionByColumn(selection, columnMode) {
            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;

            // Find all text nodes in the selection
            const textParts = [];
            const walker = document.createTreeWalker(
                container.nodeType === Node.TEXT_NODE ? container.parentElement : container,
                NodeFilter.SHOW_TEXT,
                null,
                false
            );

            let node;
            while (node = walker.nextNode()) {
                // Check if this node is in the selection
                if (selection.containsNode(node, true)) {
                    // Check if node is in the correct column
                    const columnContainer = node.parentElement?.closest('.column-container');
                    if (columnContainer) {
                        const isLeftColumn = columnContainer.classList.contains('left-column');
                        const isRightColumn = columnContainer.classList.contains('right-column');

                        if ((columnMode === 'left' && isLeftColumn) ||
                            (columnMode === 'right' && isRightColumn)) {
                            textParts.push(node.textContent);
                        }
                    } else {
                        // Not in a column container, include it
                        textParts.push(node.textContent);
                    }
                }
            }

            return textParts.join(' ').replace(/\s+/g, ' ').trim();
        }

        document.addEventListener('mousedown', e => {
            if (!e.target.closest('.selection-popup')) {
                document.getElementById('selectionPopup').style.display = 'none';
            }
        });

        let isPinnedNote = false;
        let editingAnnotationId = null;

        function startAnnotation() {
            editingAnnotationId = null;
            isPinnedNote = false;
            document.getElementById('selectionPopup').style.display = 'none';
            const quotePreview = document.getElementById('quotePreview');
            quotePreview.textContent = selectedText;
            quotePreview.classList.remove('pinned-note');
            const editor = document.getElementById('annotationComment');
            editor.innerHTML = '';
            editor.setAttribute('data-placeholder', 'Add your thoughts...');
            document.getElementById('annotationForm').classList.add('active');
        }

        function startPinnedNote() {
            if (!currentReading) {
                alert('Please select a reading first');
                return;
            }
            editingAnnotationId = null;
            isPinnedNote = true;
            selectedText = '';
            const quotePreview = document.getElementById('quotePreview');
            quotePreview.textContent = 'ðŸ“Œ Pinned note (no highlighted text)';
            quotePreview.classList.add('pinned-note');
            const editor = document.getElementById('annotationComment');
            editor.innerHTML = '';
            editor.setAttribute('data-placeholder', 'Write your note about this reading...');
            document.getElementById('annotationForm').classList.add('active');
            editor.focus();
        }

        function cancelAnnotation() {
            document.getElementById('annotationForm').classList.remove('active');
            document.getElementById('quotePreview').classList.remove('pinned-note');
            const editor = document.getElementById('annotationComment');
            editor.innerHTML = '';
            editor.setAttribute('data-placeholder', 'Add your thoughts...');
            selectedText = '';
            isPinnedNote = false;
            editingAnnotationId = null;
        }

        function editAnnotation(annotationId) {
            const items = annotations[currentReading] || [];
            const annotation = items.find(a => a.id === annotationId);
            if (!annotation) return;

            editingAnnotationId = annotationId;
            isPinnedNote = annotation.pinned;
            selectedText = annotation.quote || '';

            const quotePreview = document.getElementById('quotePreview');
            if (annotation.pinned) {
                quotePreview.textContent = 'ðŸ“Œ Pinned note (no highlighted text)';
                quotePreview.classList.add('pinned-note');
            } else {
                quotePreview.textContent = annotation.quote;
                quotePreview.classList.remove('pinned-note');
            }

            const editor = document.getElementById('annotationComment');
            editor.innerHTML = annotation.comment || '';
            document.getElementById('annotationForm').classList.add('active');
            editor.focus();
        }

        // RTF Editor commands
        function rtfCommand(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('annotationComment').focus();
        }

        async function saveAnnotation() {
            if (!currentReading) return;
            if (!editingAnnotationId && !isPinnedNote && !selectedText) return;

            const editor = document.getElementById('annotationComment');
            const comment = editor.innerHTML.trim();
            const commentText = editor.innerText.trim();
            if (!commentText && isPinnedNote) {
                alert('Please enter a note');
                return;
            }

            // Editing existing annotation
            if (editingAnnotationId) {
                const items = annotations[currentReading] || [];
                const annotation = items.find(a => a.id === editingAnnotationId);
                if (annotation) {
                    annotation.comment = comment;
                    annotation.updated_at = new Date().toISOString();

                    // Save to localStorage
                    localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

                    // Update in Supabase
                    if (db && currentUser) {
                        try {
                            await db.from('annotations')
                                .update({ comment: comment, updated_at: annotation.updated_at })
                                .eq('id', editingAnnotationId);
                        } catch (e) {
                            console.warn('Failed to update annotation in Supabase:', e);
                        }
                    }
                }

                renderAnnotations();
                cancelAnnotation();
                return;
            }

            // Creating new annotation
            const annotation = {
                id: Date.now().toString(),
                reading_id: currentReading,
                quote: isPinnedNote ? '' : selectedText,
                comment: comment,  // Now stores HTML
                pinned: isPinnedNote,
                replies: [],  // Initialize empty replies array
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            // Add to local state
            if (!annotations[currentReading]) annotations[currentReading] = [];
            annotations[currentReading].unshift(annotation);

            // Always save to localStorage as backup
            localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

            // Try to save to Supabase if logged in
            if (db && currentUser) {
                annotation.user_id = currentUser.id;
                try {
                    const { error } = await db.from('annotations').insert([annotation]);
                    if (error) console.warn('Supabase save error:', error);
                } catch (e) {
                    console.warn('Failed to save to Supabase:', e);
                }
            }

            renderAnnotations();
            renderActivityStream();  // Update home screen activity
            cancelAnnotation();
        }

        // =============================================
        // DISCUSS VIEW
        // =============================================

        let thoughts = [];
        let currentFeedTab = 'all';

        async function loadThoughts() {
            if (db) {
                try {
                    const { data } = await db
                        .from('thoughts')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (data) thoughts = data;
                } catch (e) {
                    console.warn('Failed to load thoughts:', e);
                }
            }
            renderFeed();
            renderActivityStream();
        }

        async function postQuickThought() {
            const input = document.getElementById('quickPostInput');
            const content = input?.value?.trim();

            if (!content) return;

            if (!currentUser) {
                alert('Please sign in to post.');
                return;
            }

            // Editing existing thought
            if (editingThoughtId) {
                if (db) {
                    try {
                        const { error } = await db
                            .from('thoughts')
                            .update({ content: content, updated_at: new Date().toISOString() })
                            .eq('id', editingThoughtId);

                        if (!error) {
                            const thought = thoughts.find(t => t.id === editingThoughtId);
                            if (thought) thought.content = content;
                            input.value = '';
                            document.getElementById('charCount').textContent = '0';
                            editingThoughtId = null;
                            renderFeed();
                        } else {
                            alert('Failed to update: ' + error.message);
                        }
                    } catch (e) {
                        console.warn('Failed to update thought:', e);
                        alert('Failed to update. Please try again.');
                    }
                }
                return;
            }

            // Creating new thought
            const thought = {
                content: content,
                author_id: currentUser.id,
                author_email: currentUser.email,
                created_at: new Date().toISOString()
            };

            if (db) {
                try {
                    const { data, error } = await db
                        .from('thoughts')
                        .insert([thought])
                        .select();

                    if (!error && data?.[0]) {
                        thoughts.unshift(data[0]);
                        input.value = '';
                        document.getElementById('charCount').textContent = '0';
                        renderFeed();
                        renderActivityStream();
                    } else {
                        alert('Failed to post: ' + (error?.message || 'Unknown error'));
                    }
                } catch (e) {
                    console.warn('Failed to post thought:', e);
                    alert('Failed to post. Please try again.');
                }
            }
        }

        function switchFeedTab(tab) {
            currentFeedTab = tab;
            document.querySelectorAll('.feed-tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.feed-tab[onclick="switchFeedTab('${tab}')"]`)?.classList.add('active');
            renderFeed();
        }

        function setupComposer() {
            const input = document.getElementById('quickPostInput');
            const countEl = document.getElementById('charCount');
            const avatarEl = document.getElementById('composerAvatar');

            if (input && countEl) {
                input.addEventListener('input', () => {
                    countEl.textContent = input.value.length;
                });
            }

            if (avatarEl && currentUser) {
                avatarEl.textContent = currentUser.email[0].toUpperCase();
            }
        }

        async function loadFeed() {
            if (db) {
                try {
                    const { data } = await db
                        .from('posts')
                        .select('*')
                        .order('published_at', { ascending: false });

                    if (data) posts = data;
                } catch (e) {
                    console.warn('Failed to load posts:', e);
                }
            }
            renderFeed();
            renderActivityStream();
        }

        function renderFeed() {
            const container = document.getElementById('postsContainer');

            // Build combined feed based on tab
            let feedItems = [];

            if (currentFeedTab === 'all' || currentFeedTab === 'thoughts') {
                thoughts.forEach(t => feedItems.push({ type: 'thought', data: t, time: new Date(t.created_at) }));
            }

            if (currentFeedTab === 'all' || currentFeedTab === 'essays') {
                posts.forEach(p => feedItems.push({ type: 'essay', data: p, time: new Date(p.published_at) }));
            }

            // Sort by time, newest first
            feedItems.sort((a, b) => b.time - a.time);

            if (feedItems.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 60px 20px;">No posts yet. Share your thoughts about the readings!</div>';
                return;
            }

            container.innerHTML = feedItems.map(item => {
                if (item.type === 'thought') {
                    const t = item.data;
                    const isAuthor = currentUser && t.author_id === currentUser.id;
                    return `
                        <div class="thought-card" data-thought-id="${t.id}">
                            <div class="thought-header">
                                <div class="thought-avatar">${(t.author_email || 'A')[0].toUpperCase()}</div>
                                <div>
                                    <span class="thought-author">${t.author_email?.split('@')[0] || 'Anonymous'}</span>
                                    <span class="thought-time">Â· ${formatTimeAgo(item.time)}</span>
                                </div>
                            </div>
                            <div class="thought-content">${t.content}</div>
                            <div class="thought-actions">
                                <button class="thought-action">ðŸ’¬ Reply</button>
                                ${isAuthor ? `<button class="thought-action" onclick="editThought('${t.id}')">âœï¸ Edit</button>` : ''}
                                ${isAuthor ? `<button class="thought-action" onclick="deleteThought('${t.id}')">ðŸ—‘ï¸ Delete</button>` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    const p = item.data;
                    const isAuthor = currentUser && p.author_id === currentUser.id;
                    const commentCount = (postComments[p.id] || []).length;
                    return `
                        <div class="post-card" data-post-id="${p.id}">
                            <div class="post-header">
                                <div class="post-avatar">${(p.author_email || 'A')[0].toUpperCase()}</div>
                                <div>
                                    <div class="post-author">${p.author_email?.split('@')[0] || 'Anonymous'}</div>
                                    <div class="post-date">${formatTimeAgo(item.time)}</div>
                                </div>
                            </div>
                            <div class="post-title">${p.title}</div>
                            ${p.subtitle ? `<div class="post-subtitle">${p.subtitle}</div>` : ''}
                            <div class="post-content">${marked.parse(p.content || '')}</div>
                            ${p.linked_readings?.length ? `<div class="post-links">ðŸ“Ž ${p.linked_readings.join(', ')}</div>` : ''}
                            <div class="post-actions">
                                <button class="post-action" onclick="togglePostComments('${p.id}')">
                                    ðŸ’¬ ${commentCount} Comment${commentCount !== 1 ? 's' : ''}
                                </button>
                                ${isAuthor ? `
                                    <button class="post-action" onclick="editPost('${p.id}')">âœï¸ Edit</button>
                                    <button class="post-action" onclick="deletePost('${p.id}')">ðŸ—‘ï¸ Delete</button>
                                ` : ''}
                            </div>
                            <div class="post-comments-section" id="comments-${p.id}" style="display: none;">
                                <div class="post-comments-list" id="comments-list-${p.id}"></div>
                                <div class="post-comment-form">
                                    <textarea id="comment-input-${p.id}" placeholder="Write a comment..."></textarea>
                                    <button class="btn" onclick="postComment('${p.id}')">Post</button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');

            // Also update home view
            renderRecentPosts();
        }

        async function deleteThought(thoughtId) {
            if (!confirm('Delete this thought?')) return;

            if (db) {
                try {
                    await db.from('thoughts').delete().eq('id', thoughtId);
                    thoughts = thoughts.filter(t => t.id !== thoughtId);
                    renderFeed();
                    renderActivityStream();
                } catch (e) {
                    console.warn('Failed to delete thought:', e);
                }
            }
        }

        let editingThoughtId = null;

        function editThought(thoughtId) {
            const thought = thoughts.find(t => t.id === thoughtId);
            if (!thought) return;

            editingThoughtId = thoughtId;
            const input = document.getElementById('quickPostInput');
            if (input) {
                input.value = thought.content;
                input.focus();
                document.getElementById('charCount').textContent = thought.content.length;
                // Scroll to composer
                input.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        let editingPostId = null;

        function editPost(postId) {
            const post = posts.find(p => p.id === postId);
            if (!post) return;

            editingPostId = postId;

            // Load post into Write view
            document.getElementById('essayTitleInput').value = post.title || '';
            document.getElementById('essaySubtitleInput').value = post.subtitle || '';
            document.getElementById('essayContentInput').value = post.content || '';

            // Load linked readings
            essayLinkedReadings = (post.linked_readings || []).map(lr => {
                if (typeof lr === 'object') return lr;
                const allReadings = getAllReadings();
                return allReadings.find(r => r.id === lr) || { id: lr, title: lr, week: '?' };
            });
            renderLinkedReadings('essay');

            switchView('write');
        }

        async function deletePost(postId) {
            if (!confirm('Are you sure you want to delete this essay?')) return;

            if (db) {
                try {
                    const { error } = await db.from('posts').delete().eq('id', postId);
                    if (!error) {
                        posts = posts.filter(p => p.id !== postId);
                        renderFeed();
                    }
                } catch (e) {
                    console.warn('Failed to delete post:', e);
                    alert('Failed to delete. Please try again.');
                }
            }
        }

        // Post comments storage
        let postComments = {};

        async function loadPostComments() {
            if (!db) return;

            try {
                const { data, error } = await db
                    .from('post_comments')
                    .select('*')
                    .order('created_at', { ascending: true });

                if (!error && data) {
                    // Group comments by post_id
                    postComments = {};
                    data.forEach(c => {
                        if (!postComments[c.post_id]) postComments[c.post_id] = [];
                        postComments[c.post_id].push(c);
                    });
                }
            } catch (e) {
                console.warn('Failed to load post comments:', e);
            }
            renderActivityStream();
        }

        function togglePostComments(postId) {
            const section = document.getElementById(`comments-${postId}`);
            if (!section) return;

            const isHidden = section.style.display === 'none';
            section.style.display = isHidden ? 'block' : 'none';

            if (isHidden) {
                renderPostComments(postId);
            }
        }

        function renderPostComments(postId) {
            const container = document.getElementById(`comments-list-${postId}`);
            if (!container) return;

            const comments = postComments[postId] || [];

            if (comments.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 15px; font-size: 0.9rem;">No comments yet. Be the first to share your thoughts.</div>';
                return;
            }

            container.innerHTML = comments.map(c => {
                const isAuthor = currentUser && (c.author_id === currentUser.id || c.author_email === currentUser.email);
                return `
                <div class="post-comment">
                    <div class="post-comment-header">
                        <span class="post-comment-author">${c.author_email || 'Anonymous'}</span>
                        <span class="post-comment-date">${new Date(c.created_at).toLocaleDateString()}</span>
                        ${isAuthor ? `<button onclick="deletePostComment('${postId}', '${c.id}')" style="margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px;">ðŸ—‘ï¸</button>` : ''}
                    </div>
                    <div class="post-comment-content">${c.content}</div>
                </div>
            `}).join('');
        }

        async function postComment(postId) {
            const input = document.getElementById(`comment-input-${postId}`);
            const content = input?.value?.trim();

            if (!content) return;

            if (!currentUser) {
                alert('Please sign in to post comments.');
                return;
            }

            const comment = {
                post_id: postId,
                author_id: currentUser.id,
                author_email: currentUser.email,
                content: content,
                created_at: new Date().toISOString()
            };

            if (db) {
                try {
                    const { data, error } = await db
                        .from('post_comments')
                        .insert([comment])
                        .select();

                    if (!error && data?.[0]) {
                        if (!postComments[postId]) postComments[postId] = [];
                        postComments[postId].push(data[0]);
                        input.value = '';
                        renderPostComments(postId);
                        renderActivityStream();

                        // Update comment count in button
                        const btn = document.querySelector(`[data-post-id="${postId}"] .post-action`);
                        if (btn) {
                            const count = postComments[postId].length;
                            btn.innerHTML = `ðŸ’¬ ${count} Comment${count !== 1 ? 's' : ''}`;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to post comment:', e);
                    alert('Failed to post comment. Please try again.');
                }
            }
        }

        async function deletePostComment(postId, commentId) {
            if (!confirm('Delete this comment?')) return;

            // Remove from local state
            if (postComments[postId]) {
                postComments[postId] = postComments[postId].filter(c => c.id !== commentId);
            }

            // Try to delete from Supabase
            if (db && currentUser) {
                try {
                    await db.from('post_comments').delete().eq('id', commentId);
                } catch (e) {
                    console.warn('Failed to delete comment from Supabase:', e);
                }
            }

            renderPostComments(postId);
        }

        function renderRecentPosts() {
            const container = document.getElementById('recentPosts');
            const recent = posts.slice(0, 3);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">No posts yet.</div>';
                return;
            }

            container.innerHTML = recent.map(p => `
                <div class="activity-item" onclick="switchView('discuss')" style="cursor: pointer;">
                    <span class="author">${p.author_email?.split('@')[0] || 'Someone'}</span>
                    <span class="action">posted</span>
                    <span class="target">"${p.title}"</span>
                    <span class="time">${new Date(p.published_at).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        // =============================================
        // WRITE VIEW
        // =============================================

        async function loadNotes() {
            if (db && currentUser) {
                try {
                    const { data } = await db
                        .from('notes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('updated_at', { ascending: false });

                    if (data) notes = data;
                } catch (e) {
                    console.warn('Failed to load notes:', e);
                }
            } else {
                notes = JSON.parse(localStorage.getItem('metamodality_notes') || '[]');
            }
            renderNotesList();
        }

        function renderNotesList() {
            const container = document.getElementById('notesList');

            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 30px;">No notes yet. Click "+ New" to start writing.</div>';
                return;
            }

            container.innerHTML = notes.map(n => `
                <div class="note-list-item ${editingNoteId === n.id ? 'active' : ''}" onclick="editNote('${n.id}')">
                    <div class="note-title">${n.title || 'Untitled'}</div>
                    <div class="note-preview">${(n.content || '').substring(0, 60)}...</div>
                    <div class="note-date">${new Date(n.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function newNote() {
            editingNoteId = null;
            showEditor();
            document.getElementById('noteTitleInput').value = '';
            document.getElementById('noteContentInput').value = '';
            // Clear linked readings
            noteLinkedReadings = [];
            renderLinkedReadings('note');
        }

        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            editingNoteId = id;
            showEditor();
            document.getElementById('noteTitleInput').value = note.title || '';
            document.getElementById('noteContentInput').value = note.content || '';

            // Load linked readings from note
            noteLinkedReadings = (note.linked_readings || []).map(lr => {
                // If it's an object, use it directly; if string (old format), try to find matching reading
                if (typeof lr === 'object') return lr;
                const allReadings = getAllReadings();
                return allReadings.find(r => r.id === lr || r.title.includes(lr)) || { id: lr, title: lr, week: '?' };
            });
            renderLinkedReadings('note');
            renderNotesList();
        }

        function showEditor() {
            document.getElementById('editorContainer').style.display = 'none';
            document.getElementById('editorActive').style.display = 'flex';
        }

        async function saveNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;
            // Use noteLinkedReadings array instead of parsing [[]] syntax
            const links = noteLinkedReadings.map(r => r.id);

            const note = {
                title,
                content,
                linked_readings: links,
                updated_at: new Date().toISOString()
            };

            if (db && currentUser) {
                note.user_id = currentUser.id;
                try {
                    if (editingNoteId) {
                        await db.from('notes').update(note).eq('id', editingNoteId);
                        const idx = notes.findIndex(n => n.id === editingNoteId);
                        if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                    } else {
                        const { data } = await db.from('notes').insert([note]).select();
                        if (data?.[0]) {
                            notes.unshift(data[0]);
                            editingNoteId = data[0].id;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to save:', e);
                }
            } else {
                if (editingNoteId) {
                    const idx = notes.findIndex(n => n.id === editingNoteId);
                    if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                } else {
                    note.id = Date.now().toString();
                    note.created_at = note.updated_at;
                    notes.unshift(note);
                    editingNoteId = note.id;
                }
                localStorage.setItem('metamodality_notes', JSON.stringify(notes));
            }

            renderNotesList();
        }

        async function publishNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;

            if (!title || !content) {
                alert('Please add a title and content before publishing.');
                return;
            }

            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const post = {
                title,
                content,
                linked_readings: links,
                published_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous',
                reactions: {}
            };

            if (db && currentUser) {
                post.author_id = currentUser.id;
                try {
                    const { data } = await db.from('posts').insert([post]).select();
                    if (data?.[0]) posts.unshift(data[0]);
                } catch (e) {
                    console.warn('Failed to publish:', e);
                }
            } else {
                post.id = Date.now().toString();
                posts.unshift(post);
            }

            renderFeed();
            switchView('discuss');
        }

        // Delete note
        async function deleteNote() {
            if (!editingNoteId) return;
            if (!confirm('Delete this note?')) return;

            if (db && currentUser) {
                try {
                    await db.from('notes').delete().eq('id', editingNoteId);
                } catch (e) {
                    console.warn('Failed to delete:', e);
                }
            }

            notes = notes.filter(n => n.id !== editingNoteId);
            localStorage.setItem('metamodality_notes', JSON.stringify(notes));

            editingNoteId = null;
            document.getElementById('editorActive').style.display = 'none';
            document.getElementById('editorContainer').style.display = 'flex';
            renderNotesList();
        }

        // =============================================
        // DRAFTS & ESSAYS (Substack-style Write View)
        // =============================================
        let drafts = [];
        let editingDraftId = null;

        async function loadDrafts() {
            if (db && currentUser) {
                try {
                    const { data } = await db
                        .from('drafts')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('updated_at', { ascending: false });

                    if (data) drafts = data;
                } catch (e) {
                    console.warn('Failed to load drafts:', e);
                }
            } else {
                drafts = JSON.parse(localStorage.getItem('metamodality_drafts') || '[]');
            }
            renderDraftsList();
        }

        function renderDraftsList() {
            const container = document.getElementById('draftsList');
            if (!container) return;

            if (drafts.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 30px; font-size: 13px;">No drafts yet.</div>';
                return;
            }

            container.innerHTML = drafts.map(d => `
                <div class="draft-item ${editingDraftId === d.id ? 'active' : ''}" onclick="editDraft('${d.id}')">
                    <div class="draft-item-title">${d.title || 'Untitled'}</div>
                    <div class="draft-item-preview">${(d.content || '').substring(0, 60)}...</div>
                    <div class="draft-item-date">${new Date(d.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function editDraft(id) {
            const draft = drafts.find(d => d.id === id);
            if (!draft) return;

            editingDraftId = id;
            document.getElementById('essayTitleInput').value = draft.title || '';
            document.getElementById('essaySubtitleInput').value = draft.subtitle || '';
            document.getElementById('essayContentInput').value = draft.content || '';

            // Load linked readings from draft
            essayLinkedReadings = (draft.linked_readings || []).map(lr => {
                if (typeof lr === 'object') return lr;
                const allReadings = getAllReadings();
                return allReadings.find(r => r.id === lr || r.title.includes(lr)) || { id: lr, title: lr, week: '?' };
            });
            renderLinkedReadings('essay');
            renderDraftsList();
        }

        function newDraft() {
            editingDraftId = null;
            document.getElementById('essayTitleInput').value = '';
            document.getElementById('essaySubtitleInput').value = '';
            document.getElementById('essayContentInput').value = '';
            // Clear linked readings
            essayLinkedReadings = [];
            renderLinkedReadings('essay');
        }

        async function saveDraft() {
            const title = document.getElementById('essayTitleInput').value;
            const subtitle = document.getElementById('essaySubtitleInput').value;
            const content = document.getElementById('essayContentInput').value;
            // Use essayLinkedReadings array instead of parsing [[]] syntax
            const links = essayLinkedReadings.map(r => r.id);

            const draft = {
                title,
                subtitle,
                content,
                linked_readings: links,
                updated_at: new Date().toISOString()
            };

            if (db && currentUser) {
                draft.user_id = currentUser.id;
                try {
                    if (editingDraftId) {
                        await db.from('drafts').update(draft).eq('id', editingDraftId);
                        const idx = drafts.findIndex(d => d.id === editingDraftId);
                        if (idx >= 0) drafts[idx] = { ...drafts[idx], ...draft };
                    } else {
                        const { data } = await db.from('drafts').insert([draft]).select();
                        if (data?.[0]) {
                            drafts.unshift(data[0]);
                            editingDraftId = data[0].id;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to save draft:', e);
                }
            } else {
                if (editingDraftId) {
                    const idx = drafts.findIndex(d => d.id === editingDraftId);
                    if (idx >= 0) drafts[idx] = { ...drafts[idx], ...draft };
                } else {
                    draft.id = Date.now().toString();
                    draft.created_at = draft.updated_at;
                    drafts.unshift(draft);
                    editingDraftId = draft.id;
                }
                localStorage.setItem('metamodality_drafts', JSON.stringify(drafts));
            }

            renderDraftsList();
        }

        async function publishEssay() {
            const title = document.getElementById('essayTitleInput').value;
            const subtitle = document.getElementById('essaySubtitleInput').value;
            const content = document.getElementById('essayContentInput').value;

            if (!title || !content) {
                alert('Please add a title and content before publishing.');
                return;
            }

            // Use essayLinkedReadings array
            const links = essayLinkedReadings.map(r => r.id);

            const postData = {
                title,
                subtitle,
                content,
                linked_readings: links,
                updated_at: new Date().toISOString()
            };

            if (db && currentUser) {
                try {
                    // If editing an existing post, update it
                    if (editingPostId) {
                        const { data, error } = await db
                            .from('posts')
                            .update(postData)
                            .eq('id', editingPostId)
                            .select();

                        if (!error && data?.[0]) {
                            const idx = posts.findIndex(p => p.id === editingPostId);
                            if (idx >= 0) posts[idx] = { ...posts[idx], ...data[0] };
                        }
                        editingPostId = null;
                    } else {
                        // New post
                        postData.published_at = new Date().toISOString();
                        postData.author_id = currentUser.id;
                        postData.author_email = currentUser.email || 'Anonymous';
                        postData.reactions = {};

                        const { data } = await db.from('posts').insert([postData]).select();
                        if (data?.[0]) posts.unshift(data[0]);

                        // Delete draft after publishing
                        if (editingDraftId) {
                            await db.from('drafts').delete().eq('id', editingDraftId);
                            drafts = drafts.filter(d => d.id !== editingDraftId);
                            editingDraftId = null;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to publish:', e);
                }
            } else {
                postData.id = Date.now().toString();
                postData.published_at = new Date().toISOString();
                postData.author_email = 'Anonymous';
                postData.reactions = {};
                posts.unshift(postData);

                // Delete draft from local storage after publishing
                if (editingDraftId) {
                    drafts = drafts.filter(d => d.id !== editingDraftId);
                    localStorage.setItem('metamodality_drafts', JSON.stringify(drafts));
                    editingDraftId = null;
                }
            }

            // Clear editor
            document.getElementById('essayTitleInput').value = '';
            document.getElementById('essaySubtitleInput').value = '';
            document.getElementById('essayContentInput').value = '';
            essayLinkedReadings = [];
            renderLinkedReadings('essay');

            renderDraftsList();
            renderFeed();
            switchView('discuss');
        }

        // =============================================
        // READING LINK SYSTEM (Autocomplete + Picker + Chips)
        // =============================================

        // Track linked readings for notes and essays
        let noteLinkedReadings = [];
        let essayLinkedReadings = [];
        let currentPickerTarget = null; // 'note' or 'essay'
        let autocompleteSelectedIndex = 0;
        let currentAutocompleteTarget = null;

        // Get flat list of all readings for autocomplete
        function getAllReadings() {
            const readings = [];
            schedule.forEach(unit => {
                unit.weeks.forEach(week => {
                    week.readings.forEach(reading => {
                        readings.push({
                            id: reading.id,
                            title: reading.title.replace(/<[^>]*>/g, ''), // Strip HTML
                            week: week.num,
                            weekTitle: week.title,
                            unit: unit.unit
                        });
                    });
                });
            });
            return readings;
        }

        // Render linked reading chips
        function renderLinkedReadings(target) {
            const readings = target === 'note' ? noteLinkedReadings : essayLinkedReadings;
            const container = document.getElementById(target === 'note' ? 'noteLinkedReadings' : 'essayLinkedReadings');
            if (!container) return;

            if (readings.length === 0) {
                container.innerHTML = '<span style="font-size: 12px; color: var(--text-muted);">No readings linked</span>';
                return;
            }

            container.innerHTML = readings.map(r => `
                <span class="reading-chip">
                    <span class="reading-chip-text" title="${r.title}">Week ${r.week}: ${r.title}</span>
                    <span class="reading-chip-remove" onclick="removeLinkedReading('${target}', '${r.id}')">&times;</span>
                </span>
            `).join('');
        }

        // Add a reading link
        function addLinkedReading(target, reading) {
            const readings = target === 'note' ? noteLinkedReadings : essayLinkedReadings;
            if (!readings.find(r => r.id === reading.id)) {
                readings.push(reading);
                renderLinkedReadings(target);
            }
        }

        // Remove a reading link
        function removeLinkedReading(target, readingId) {
            if (target === 'note') {
                noteLinkedReadings = noteLinkedReadings.filter(r => r.id !== readingId);
            } else {
                essayLinkedReadings = essayLinkedReadings.filter(r => r.id !== readingId);
            }
            renderLinkedReadings(target);
        }

        // Clear all linked readings
        function clearLinkedReadings(target) {
            if (target === 'note') {
                noteLinkedReadings = [];
            } else {
                essayLinkedReadings = [];
            }
            renderLinkedReadings(target);
        }

        // ========== AUTOCOMPLETE ==========

        function showAutocomplete(target, searchText) {
            const dropdown = document.getElementById(target === 'note' ? 'noteAutocomplete' : 'essayAutocomplete');
            if (!dropdown) return;

            const allReadings = getAllReadings();
            const query = searchText.toLowerCase();
            const filtered = query
                ? allReadings.filter(r =>
                    r.title.toLowerCase().includes(query) ||
                    r.weekTitle.toLowerCase().includes(query) ||
                    `week ${r.week}`.includes(query)
                  ).slice(0, 8)
                : allReadings.slice(0, 8);

            if (filtered.length === 0) {
                dropdown.innerHTML = '<div class="autocomplete-hint">No readings found</div>';
                dropdown.classList.add('active');
                return;
            }

            autocompleteSelectedIndex = 0;
            currentAutocompleteTarget = target;

            dropdown.innerHTML = `
                <div class="autocomplete-hint">â†‘â†“ to navigate, Enter to select, Esc to close</div>
                ${filtered.map((r, i) => `
                    <div class="autocomplete-item ${i === 0 ? 'selected' : ''}"
                         data-reading-id="${r.id}"
                         data-reading-title="${r.title}"
                         data-reading-week="${r.week}"
                         onclick="selectAutocompleteReading('${target}', '${r.id}')">
                        <div class="autocomplete-item-title">${r.title}</div>
                        <div class="autocomplete-item-meta">Week ${r.week}: ${r.weekTitle}</div>
                    </div>
                `).join('')}
            `;
            dropdown.classList.add('active');
        }

        function hideAutocomplete(target) {
            const dropdown = document.getElementById(target === 'note' ? 'noteAutocomplete' : 'essayAutocomplete');
            if (dropdown) {
                dropdown.classList.remove('active');
            }
            currentAutocompleteTarget = null;
        }

        function selectAutocompleteReading(target, readingId) {
            const allReadings = getAllReadings();
            const reading = allReadings.find(r => r.id === readingId);
            if (reading) {
                addLinkedReading(target, reading);
            }

            // Remove the @query from the textarea
            const textarea = document.getElementById(target === 'note' ? 'noteContentInput' : 'essayContentInput');
            if (textarea) {
                const text = textarea.value;
                const cursorPos = textarea.selectionStart;
                const beforeCursor = text.substring(0, cursorPos);
                const afterCursor = text.substring(cursorPos);

                // Find and remove the @query
                const atMatch = beforeCursor.match(/@[\w\s]*$/);
                if (atMatch) {
                    const newBeforeCursor = beforeCursor.substring(0, beforeCursor.length - atMatch[0].length);
                    textarea.value = newBeforeCursor + afterCursor;
                    textarea.selectionStart = textarea.selectionEnd = newBeforeCursor.length;
                }
            }

            hideAutocomplete(target);
        }

        function handleAutocompleteKeydown(e, target) {
            const dropdown = document.getElementById(target === 'note' ? 'noteAutocomplete' : 'essayAutocomplete');
            if (!dropdown || !dropdown.classList.contains('active')) return false;

            const items = dropdown.querySelectorAll('.autocomplete-item');
            if (items.length === 0) return false;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                items[autocompleteSelectedIndex]?.classList.remove('selected');
                autocompleteSelectedIndex = Math.min(autocompleteSelectedIndex + 1, items.length - 1);
                items[autocompleteSelectedIndex]?.classList.add('selected');
                items[autocompleteSelectedIndex]?.scrollIntoView({ block: 'nearest' });
                return true;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                items[autocompleteSelectedIndex]?.classList.remove('selected');
                autocompleteSelectedIndex = Math.max(autocompleteSelectedIndex - 1, 0);
                items[autocompleteSelectedIndex]?.classList.add('selected');
                items[autocompleteSelectedIndex]?.scrollIntoView({ block: 'nearest' });
                return true;
            } else if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                const selected = items[autocompleteSelectedIndex];
                if (selected) {
                    selectAutocompleteReading(target, selected.dataset.readingId);
                }
                return true;
            } else if (e.key === 'Escape') {
                hideAutocomplete(target);
                return true;
            }
            return false;
        }

        // Detect @ trigger and show autocomplete
        function handleTextareaInput(target, textarea) {
            const text = textarea.value;
            const cursorPos = textarea.selectionStart;
            const beforeCursor = text.substring(0, cursorPos);

            // Check for @query pattern
            const atMatch = beforeCursor.match(/@([\w\s]*)$/);
            if (atMatch) {
                showAutocomplete(target, atMatch[1]);
            } else {
                hideAutocomplete(target);
            }
        }

        // Setup event listeners for textareas
        document.getElementById('noteContentInput')?.addEventListener('input', e => {
            handleTextareaInput('note', e.target);
        });

        document.getElementById('noteContentInput')?.addEventListener('keydown', e => {
            handleAutocompleteKeydown(e, 'note');
        });

        document.getElementById('essayContentInput')?.addEventListener('input', e => {
            handleTextareaInput('essay', e.target);
        });

        document.getElementById('essayContentInput')?.addEventListener('keydown', e => {
            handleAutocompleteKeydown(e, 'essay');
        });

        // ========== READING PICKER MODAL ==========

        function openReadingPicker(target) {
            currentPickerTarget = target;
            const modal = document.getElementById('readingPickerModal');
            const body = document.getElementById('readingPickerBody');
            const search = document.getElementById('readingPickerSearch');

            // Build the picker body organized by unit
            body.innerHTML = schedule.map(unit => `
                <div class="reading-picker-unit">
                    <div class="reading-picker-unit-header">${unit.unit}</div>
                    ${unit.weeks.map(week =>
                        week.readings.map(reading => `
                            <div class="reading-picker-item"
                                 data-reading-id="${reading.id}"
                                 data-search-text="${reading.title.toLowerCase()} week ${week.num} ${week.title.toLowerCase()}"
                                 onclick="selectPickerReading('${reading.id}')">
                                <div class="reading-picker-item-title">${reading.title.replace(/<[^>]*>/g, '')}</div>
                                <div class="reading-picker-item-week">Week ${week.num}: ${week.title}</div>
                            </div>
                        `).join('')
                    ).join('')}
                </div>
            `).join('');

            search.value = '';
            modal.classList.add('active');
            search.focus();
        }

        function closeReadingPicker() {
            document.getElementById('readingPickerModal').classList.remove('active');
            currentPickerTarget = null;
        }

        function filterReadingPicker() {
            const query = document.getElementById('readingPickerSearch').value.toLowerCase();
            const items = document.querySelectorAll('.reading-picker-item');

            items.forEach(item => {
                const searchText = item.dataset.searchText;
                if (!query || searchText.includes(query)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function selectPickerReading(readingId) {
            const allReadings = getAllReadings();
            const reading = allReadings.find(r => r.id === readingId);
            if (reading && currentPickerTarget) {
                addLinkedReading(currentPickerTarget, reading);
            }
            closeReadingPicker();
        }

        // Close picker on backdrop click
        document.getElementById('readingPickerModal')?.addEventListener('click', e => {
            if (e.target.id === 'readingPickerModal') {
                closeReadingPicker();
            }
        });

        // Initialize linked readings display
        renderLinkedReadings('note');
        renderLinkedReadings('essay');

        // =============================================
        // AUTHENTICATION
        // =============================================

        function showAuthModal() {
            // Reset OTP state
            modalOtpSent = false;
            modalOtpEmail = '';
            document.getElementById('authEmail').style.display = 'block';
            document.getElementById('authEmail').value = '';
            document.getElementById('authOtpCode').style.display = 'none';
            document.getElementById('authOtpCode').value = '';
            document.getElementById('authModalSubmitBtn').textContent = 'Send Code';
            document.getElementById('authModalText').textContent = 'Enter your email to receive a login code.';
            document.getElementById('authMessage').style.display = 'none';

            document.getElementById('authModal').classList.add('active');
            document.getElementById('authEmail').focus();
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authMessage').style.display = 'none';
            // Reset OTP state
            modalOtpSent = false;
            modalOtpEmail = '';
        }

        function showWelcomeModal() {
            document.getElementById('welcomeModal').classList.add('active');
        }

        function dismissWelcome() {
            document.getElementById('welcomeModal').classList.remove('active');
            localStorage.setItem('metamodality_welcomed', 'true');
        }

        function checkFirstVisit() {
            const welcomed = localStorage.getItem('metamodality_welcomed');
            if (!welcomed && !currentUser) {
                showWelcomeModal();
            }
        }

        let modalOtpSent = false;
        let modalOtpEmail = '';

        async function handleModalLogin() {
            if (modalOtpSent) {
                await verifyModalOtpCode();
            } else {
                await sendModalOtpCode();
            }
        }

        async function sendModalOtpCode() {
            const email = document.getElementById('authEmail').value;
            authDebug.log('sendModalOtpCode called', { email });

            if (!email) {
                authDebug.log('No email provided');
                return;
            }

            const msgEl = document.getElementById('authMessage');

            if (db) {
                try {
                    authDebug.log('Sending OTP code from modal', { email });

                    const otpStart = Date.now();
                    const { error } = await db.auth.signInWithOtp({
                        email
                    });

                    authDebug.log('signInWithOtp returned', {
                        success: !error,
                        error: error ? error.message : null,
                        duration: Date.now() - otpStart
                    });

                    if (error) throw error;

                    // Show code input
                    modalOtpSent = true;
                    modalOtpEmail = email;
                    document.getElementById('authEmail').style.display = 'none';
                    document.getElementById('authOtpCode').style.display = 'block';
                    document.getElementById('authOtpCode').focus();
                    document.getElementById('authModalSubmitBtn').textContent = 'Verify Code';
                    document.getElementById('authModalText').textContent = 'Enter the 8-digit code sent to ' + email;

                    msgEl.className = 'message success';
                    msgEl.textContent = 'Code sent! Check your email.';
                    msgEl.style.display = 'block';
                } catch (e) {
                    authDebug.log('OTP send FAILED', { error: e.message });
                    msgEl.className = 'message error';
                    msgEl.textContent = e.message || 'Failed to send code';
                    msgEl.style.display = 'block';
                }
            } else {
                authDebug.log('ERROR: db not initialized');
            }
        }

        async function verifyModalOtpCode() {
            const code = document.getElementById('authOtpCode').value.trim();
            const msgEl = document.getElementById('authMessage');

            authDebug.log('verifyModalOtpCode called', { email: modalOtpEmail, codeLength: code.length });

            if (!code || code.length !== 8) {
                msgEl.className = 'message error';
                msgEl.textContent = 'Please enter the 8-digit code.';
                msgEl.style.display = 'block';
                return;
            }

            if (db) {
                try {
                    const { data, error } = await db.auth.verifyOtp({
                        email: modalOtpEmail,
                        token: code,
                        type: 'email'
                    });

                    authDebug.log('verifyOtp returned', {
                        success: !error,
                        hasSession: !!data?.session,
                        error: error ? error.message : null
                    });

                    if (error) throw error;

                    msgEl.className = 'message success';
                    msgEl.textContent = 'Verified!';
                    msgEl.style.display = 'block';
                    // onAuthStateChange will handle the rest and close the modal
                } catch (e) {
                    authDebug.log('OTP verify FAILED', { error: e.message });
                    msgEl.className = 'message error';
                    msgEl.textContent = 'Invalid code. Please try again.';
                    msgEl.style.display = 'block';
                }
            }
        }

        // Keep for backwards compatibility
        async function sendMagicLink() {
            await sendModalOtpCode();
        }

        // =============================================
        // WORKSHOP VIEW
        // =============================================

        let currentWorkshopId = null;
        let workshopComments = [];  // Comments for current workshop view
        let allWorkshopComments = [];  // All workshop comments for activity stream

        function openWorkshop(workshopId) {
            currentWorkshopId = workshopId;
            const workshop = workshops.find(w => w.id === workshopId);
            if (!workshop) return;

            // Update header
            document.getElementById('workshopUnitLabel').textContent = workshop.unit;
            document.getElementById('workshopTitle').textContent = workshop.title;
            document.getElementById('workshopDates').textContent = workshop.dates;

            // Render covered weeks
            renderWorkshopWeeks(workshop);

            // Render related essays
            renderWorkshopEssays(workshop);

            // Load comments
            loadWorkshopComments(workshopId);

            // Switch to workshop view
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-workshop').classList.add('active');
        }

        function renderWorkshopWeeks(workshop) {
            const container = document.getElementById('workshopWeeks');

            // Get all weeks in this unit
            const weeksHtml = workshop.weeks.map(weekNum => {
                let weekData = null;
                schedule.forEach(unit => {
                    unit.weeks.forEach(w => {
                        if (w.num === weekNum) weekData = w;
                    });
                });
                if (!weekData) return '';

                const readingsList = weekData.readings.map(r =>
                    r.title.replace(/<[^>]*>/g, '').substring(0, 50) + (r.title.length > 50 ? '...' : '')
                ).join(' â€¢ ');

                return `
                    <div class="workshop-week-card" onclick="goToWeek(${weekNum})">
                        <div class="workshop-week-num">Week ${weekNum} â€” ${weekData.date}</div>
                        <div class="workshop-week-title">${weekData.title}</div>
                        <div class="workshop-week-readings">${readingsList}</div>
                    </div>
                `;
            }).join('');

            container.innerHTML = weeksHtml;
        }

        function renderWorkshopEssays(workshop) {
            const container = document.getElementById('workshopEssays');

            // Get all reading IDs for this unit
            const unitReadingIds = [];
            workshop.weeks.forEach(weekNum => {
                schedule.forEach(unit => {
                    unit.weeks.forEach(w => {
                        if (w.num === weekNum) {
                            w.readings.forEach(r => unitReadingIds.push(r.id));
                        }
                    });
                });
            });

            // Find essays that link to these readings
            const relatedPosts = posts.filter(post => {
                if (!post.linked_readings) return false;
                return post.linked_readings.some(lr => unitReadingIds.includes(lr));
            });

            if (relatedPosts.length === 0) {
                container.innerHTML = '<div class="empty-state">No essays linked to this unit\'s readings yet.</div>';
                return;
            }

            container.innerHTML = relatedPosts.map(post => `
                <div class="workshop-essay-card" onclick="viewPost('${post.id}')">
                    <div class="workshop-essay-title">${post.title}</div>
                    <div class="workshop-essay-author">by ${post.author_email || 'Anonymous'}</div>
                </div>
            `).join('');
        }

        async function loadWorkshopComments(workshopId) {
            const container = document.getElementById('workshopComments');

            if (db) {
                try {
                    const { data, error } = await db
                        .from('workshop_comments')
                        .select('*')
                        .eq('workshop_id', workshopId)
                        .order('created_at', { ascending: true });

                    if (!error && data) {
                        workshopComments = data;
                    }
                } catch (e) {
                    console.warn('Failed to load workshop comments:', e);
                }
            }

            renderWorkshopComments();
        }

        // Load ALL workshop comments for activity stream (called at init)
        async function loadAllWorkshopComments() {
            if (!db) return;

            try {
                const { data, error } = await db
                    .from('workshop_comments')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (!error && data) {
                    allWorkshopComments = data;
                }
            } catch (e) {
                console.warn('Failed to load all workshop comments:', e);
            }
            renderActivityStream();
        }

        function renderWorkshopComments() {
            const container = document.getElementById('workshopComments');

            if (workshopComments.length === 0) {
                container.innerHTML = '<div class="empty-state">No comments yet. Start the discussion!</div>';
                return;
            }

            container.innerHTML = workshopComments.map(c => {
                const isAuthor = currentUser && (c.author_id === currentUser.id || c.author_email === currentUser.email);
                return `
                <div class="workshop-comment">
                    <div class="workshop-comment-header">
                        <span class="workshop-comment-author">${c.author_email || 'Anonymous'}</span>
                        <span class="workshop-comment-date">${new Date(c.created_at).toLocaleDateString()}</span>
                        ${isAuthor ? `<button onclick="deleteWorkshopComment('${c.id}')" style="margin-left: auto; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 12px;">ðŸ—‘ï¸</button>` : ''}
                    </div>
                    <div class="workshop-comment-content">${c.content}</div>
                </div>
            `}).join('');
        }

        async function postWorkshopComment() {
            const input = document.getElementById('workshopCommentInput');
            const content = input.value.trim();

            if (!content) return;

            if (!currentUser) {
                alert('Please sign in to post comments.');
                return;
            }

            const comment = {
                workshop_id: currentWorkshopId,
                author_id: currentUser.id,
                author_email: currentUser.email,
                content: content,
                created_at: new Date().toISOString()
            };

            if (db) {
                try {
                    const { data, error } = await db
                        .from('workshop_comments')
                        .insert([comment])
                        .select();

                    if (!error && data?.[0]) {
                        workshopComments.push(data[0]);
                        allWorkshopComments.unshift(data[0]);  // Add to front (most recent)
                        input.value = '';
                        renderWorkshopComments();
                        renderActivityStream();
                    }
                } catch (e) {
                    console.warn('Failed to post comment:', e);
                    alert('Failed to post comment. Please try again.');
                }
            }
        }

        async function deleteWorkshopComment(commentId) {
            if (!confirm('Delete this comment?')) return;

            // Remove from local state
            workshopComments = workshopComments.filter(c => c.id !== commentId);
            allWorkshopComments = allWorkshopComments.filter(c => c.id !== commentId);

            // Try to delete from Supabase
            if (db && currentUser) {
                try {
                    await db.from('workshop_comments').delete().eq('id', commentId);
                } catch (e) {
                    console.warn('Failed to delete workshop comment from Supabase:', e);
                }
            }

            renderWorkshopComments();
            renderActivityStream();
        }

        function viewPost(postId) {
            // Find the post and show it (could expand to full view)
            const post = posts.find(p => p.id === postId);
            if (post) {
                switchView('discuss');
                // Scroll to the post if needed
            }
        }

        // =============================================
        // AUTH FUNCTIONS
        // =============================================

        async function checkEmailAllowed(email) {
            // Return object with allowed status and reason for better error handling
            authDebug.log('checkEmailAllowed called', { email });

            if (!db) {
                authDebug.log('checkEmailAllowed: db not initialized');
                return { allowed: false, reason: 'database_not_ready' };
            }
            if (!email) {
                authDebug.log('checkEmailAllowed: email missing');
                return { allowed: false, reason: 'no_email' };
            }
            try {
                const queryStart = Date.now();
                authDebug.log('Querying allowed_emails table', { email });

                const { data, error } = await db
                    .from('allowed_emails')
                    .select('email')
                    .ilike('email', email)
                    .single();

                authDebug.log('allowed_emails query returned', {
                    email,
                    data,
                    error: error ? { code: error.code, message: error.message } : null,
                    queryDuration: Date.now() - queryStart
                });

                if (error) {
                    // PGRST116 = no rows found (not on list)
                    if (error.code === 'PGRST116') {
                        authDebug.log('Email NOT FOUND in whitelist', { email });
                        return { allowed: false, reason: 'not_on_list' };
                    }
                    // Other database error
                    authDebug.log('Database error during whitelist check', { code: error.code, message: error.message });
                    return { allowed: false, reason: 'database_error: ' + error.message };
                }

                if (data) {
                    authDebug.log('Email FOUND in whitelist', { email, matchedEmail: data.email });
                    return { allowed: true, reason: 'ok' };
                }

                authDebug.log('No data returned but no error - treating as not on list', { email });
                return { allowed: false, reason: 'not_on_list' };
            } catch (e) {
                authDebug.log('EXCEPTION in checkEmailAllowed', { error: e.message, stack: e.stack });
                return { allowed: false, reason: 'exception: ' + e.message };
            }
        }

        function showAuthError(message) {
            const msgEl = document.getElementById('gateMessage');
            if (msgEl) {
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = message;
            }
        }

        let bypassClickCount = 0;
        let bypassClickTimer = null;

        function bypassAuthGate() {
            bypassClickCount++;
            clearTimeout(bypassClickTimer);

            if (bypassClickCount >= 3) {
                document.getElementById('authGate').classList.add('hidden');
                bypassClickCount = 0;
            } else {
                bypassClickTimer = setTimeout(() => { bypassClickCount = 0; }, 1000);
            }
        }

        async function signInWithGoogle() {
            const msgEl = document.getElementById('gateMessage');

            if (db) {
                try {
                    const { error } = await db.auth.signInWithOAuth({
                        provider: 'google',
                        options: {
                            redirectTo: window.location.origin + window.location.pathname
                        }
                    });

                    if (error) throw error;
                } catch (e) {
                    msgEl.className = 'auth-gate-message error';
                    msgEl.textContent = 'Error: ' + e.message;
                }
            } else {
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Database not configured.';
            }
        }

        function showWelcomeBanner() {
            const banner = document.getElementById('welcomeBanner');
            const dismissed = localStorage.getItem('metamodality_welcome_dismissed');
            if (banner && !dismissed) {
                banner.style.display = 'block';
            }
        }

        function dismissWelcome() {
            const banner = document.getElementById('welcomeBanner');
            if (banner) {
                banner.style.display = 'none';
                localStorage.setItem('metamodality_welcome_dismissed', 'true');
            }
        }

        function updateAuthUI(user) {
            const btn = document.getElementById('authBtn');
            const authGate = document.getElementById('authGate');

            if (user) {
                // Hide auth gate, show app
                authGate.classList.add('hidden');
                showWelcomeBanner();

                // Get display name for avatar
                const displayName = currentProfile?.display_name || currentProfile?.username || user.email.split('@')[0];
                const avatarLetter = displayName[0].toUpperCase();

                if (btn) {
                    btn.outerHTML = `
                        <div class="user-menu-container">
                            <div class="user-avatar" onclick="toggleUserMenu()" title="${displayName}">${avatarLetter}</div>
                            <div class="user-menu" id="userMenu">
                                <div class="user-menu-header">${displayName}</div>
                                <div class="user-menu-item" onclick="showProfileModal(); toggleUserMenu();">Edit Profile</div>
                                <div class="user-menu-item" onclick="signOut()">Sign Out</div>
                            </div>
                        </div>`;
                }

                // Also update existing avatar if it exists
                const existingContainer = document.querySelector('.user-menu-container');
                if (existingContainer) {
                    const avatar = existingContainer.querySelector('.user-avatar');
                    const header = existingContainer.querySelector('.user-menu-header');
                    if (avatar) avatar.textContent = avatarLetter;
                    if (header) header.textContent = displayName;
                }
            } else {
                // Show auth gate, hide app content
                authGate.classList.remove('hidden');
                const existingContainer = document.querySelector('.user-menu-container');
                if (existingContainer) {
                    existingContainer.outerHTML = `<button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>`;
                }
            }
        }

        let usePasswordLogin = false;

        function toggleLoginMode() {
            usePasswordLogin = !usePasswordLogin;
            const pwField = document.getElementById('gatePassword');
            const submitBtn = document.getElementById('gateSubmitBtn');
            const toggleBtn = document.getElementById('toggleLoginBtn');

            if (usePasswordLogin) {
                pwField.style.display = 'block';
                submitBtn.textContent = 'Sign In';
                toggleBtn.textContent = 'Use magic link instead';
            } else {
                pwField.style.display = 'none';
                pwField.value = '';
                submitBtn.textContent = 'Magic Link';
                toggleBtn.textContent = 'Have a password? Sign in with password';
            }
        }

        let otpEmailSent = false;
        let otpEmail = '';

        async function handleGateLogin() {
            if (usePasswordLogin) {
                await signInWithPassword();
            } else if (otpEmailSent) {
                await verifyOtpCode();
            } else {
                await sendOtpCode();
            }
        }

        function resetOtpFlow() {
            otpEmailSent = false;
            otpEmail = '';
            document.getElementById('otpCodeSection').style.display = 'none';
            document.getElementById('gateEmail').style.display = 'block';
            document.getElementById('gateEmail').disabled = false;
            document.getElementById('gateOtpCode').value = '';
            document.getElementById('gateSubmitBtn').textContent = 'Send Code';
            document.getElementById('toggleLoginBtn').style.display = 'inline';
            document.getElementById('resetOtpBtn').style.display = 'none';
            document.getElementById('gateMessage').textContent = '';
        }

        async function signInWithPassword() {
            const email = document.getElementById('gateEmail').value;
            const password = document.getElementById('gatePassword').value;
            const msgEl = document.getElementById('gateMessage');

            if (!email) {
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Please enter your email address.';
                return;
            }

            if (!password) {
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Please enter your password.';
                return;
            }

            if (db) {
                try {
                    const { error } = await db.auth.signInWithPassword({ email, password });

                    if (error) throw error;

                    msgEl.className = 'auth-gate-message success';
                    msgEl.textContent = 'Signing in...';
                } catch (e) {
                    msgEl.className = 'auth-gate-message error';
                    msgEl.textContent = 'Error: ' + e.message;
                }
            } else {
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Database not connected. Please try again.';
            }
        }

        async function sendOtpCode() {
            const email = document.getElementById('gateEmail').value;
            const msgEl = document.getElementById('gateMessage');

            authDebug.log('sendOtpCode called', { email });

            if (!email) {
                authDebug.log('No email provided');
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Please enter your email address.';
                return;
            }

            if (db) {
                try {
                    authDebug.log('Sending OTP code (no redirect)', { email });

                    const otpStart = Date.now();
                    // No emailRedirectTo = sends 8-digit code instead of magic link
                    const { error } = await db.auth.signInWithOtp({
                        email
                    });

                    authDebug.log('signInWithOtp returned', {
                        success: !error,
                        error: error ? error.message : null,
                        duration: Date.now() - otpStart
                    });

                    if (error) throw error;

                    // Success - show code input
                    otpEmailSent = true;
                    otpEmail = email;
                    document.getElementById('gateEmail').style.display = 'none';
                    document.getElementById('otpCodeSection').style.display = 'block';
                    document.getElementById('gateOtpCode').focus();
                    document.getElementById('gateSubmitBtn').textContent = 'Verify Code';
                    document.getElementById('toggleLoginBtn').style.display = 'none';
                    document.getElementById('resetOtpBtn').style.display = 'inline';

                    msgEl.className = 'auth-gate-message success';
                    msgEl.textContent = 'Code sent! Check your email and enter the 8-digit code.';
                } catch (e) {
                    authDebug.log('OTP send FAILED', { error: e.message });
                    msgEl.className = 'auth-gate-message error';
                    msgEl.textContent = 'Error: ' + e.message;
                }
            } else {
                authDebug.log('ERROR: db not initialized');
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Database not connected. Please try again.';
            }
        }

        async function verifyOtpCode() {
            const code = document.getElementById('gateOtpCode').value.trim();
            const msgEl = document.getElementById('gateMessage');

            authDebug.log('verifyOtpCode called', { email: otpEmail, codeLength: code.length });

            if (!code || code.length !== 8) {
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Please enter the 8-digit code from your email.';
                return;
            }

            if (db) {
                try {
                    authDebug.log('Verifying OTP code', { email: otpEmail });

                    const verifyStart = Date.now();
                    const { data, error } = await db.auth.verifyOtp({
                        email: otpEmail,
                        token: code,
                        type: 'email'
                    });

                    authDebug.log('verifyOtp returned', {
                        success: !error,
                        hasSession: !!data?.session,
                        error: error ? error.message : null,
                        duration: Date.now() - verifyStart
                    });

                    if (error) throw error;

                    msgEl.className = 'auth-gate-message success';
                    msgEl.textContent = 'Verified! Logging in...';
                    // onAuthStateChange will handle the rest
                } catch (e) {
                    authDebug.log('OTP verify FAILED', { error: e.message });
                    msgEl.className = 'auth-gate-message error';
                    msgEl.textContent = 'Invalid code. Please try again or request a new code.';
                }
            } else {
                authDebug.log('ERROR: db not initialized');
                msgEl.className = 'auth-gate-message error';
                msgEl.textContent = 'Database not connected. Please try again.';
            }
        }

        // Keep for backwards compatibility with magic links already sent
        async function sendGateMagicLink() {
            await sendOtpCode();
        }

        // =============================================
        // PROFILE FUNCTIONS
        // =============================================

        async function loadProfile(userId) {
            if (!db || !userId) return null;

            // Check cache first
            if (profilesCache[userId]) return profilesCache[userId];

            try {
                const { data, error } = await db
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (data) {
                    profilesCache[userId] = data;
                    return data;
                }
            } catch (e) {
                console.warn('Error loading profile:', e);
            }
            return null;
        }

        async function loadCurrentProfile() {
            if (!currentUser) return;
            currentProfile = await loadProfile(currentUser.id);
        }

        function getDisplayName(authorEmail, authorId) {
            // If we have a cached profile with username, use it
            if (authorId && profilesCache[authorId]) {
                const profile = profilesCache[authorId];
                if (profile.display_name) return profile.display_name;
                if (profile.username) return profile.username;
            }
            // Fall back to email prefix
            if (authorEmail) return authorEmail.split('@')[0];
            return 'Anonymous';
        }

        function getAvatarLetter(authorEmail, authorId) {
            const displayName = getDisplayName(authorEmail, authorId);
            return displayName[0].toUpperCase();
        }

        function showProfileModal() {
            const modal = document.getElementById('profileModal');
            const usernameInput = document.getElementById('profileUsername');
            const displayNameInput = document.getElementById('profileDisplayName');

            // Pre-fill with current profile data or email prefix
            if (currentProfile) {
                usernameInput.value = currentProfile.username || '';
                displayNameInput.value = currentProfile.display_name || '';
            } else if (currentUser) {
                usernameInput.value = currentUser.email.split('@')[0].replace(/[^a-zA-Z0-9_]/g, '');
                displayNameInput.value = '';
            }

            modal.classList.add('active');
            usernameInput.focus();
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
            document.getElementById('profileMessage').style.display = 'none';
        }

        async function saveProfile() {
            const msgEl = document.getElementById('profileMessage');
            const username = document.getElementById('profileUsername').value.trim().toLowerCase();
            const displayName = document.getElementById('profileDisplayName').value.trim();

            // Validate username
            if (!username) {
                msgEl.className = 'message error';
                msgEl.textContent = 'Username is required.';
                msgEl.style.display = 'block';
                return;
            }

            if (!/^[a-z0-9_]+$/.test(username)) {
                msgEl.className = 'message error';
                msgEl.textContent = 'Username can only contain letters, numbers, and underscores.';
                msgEl.style.display = 'block';
                return;
            }

            if (username.length < 3) {
                msgEl.className = 'message error';
                msgEl.textContent = 'Username must be at least 3 characters.';
                msgEl.style.display = 'block';
                return;
            }

            if (!db || !currentUser) {
                console.error('saveProfile: db or currentUser is undefined', { db: !!db, currentUser: !!currentUser });
                msgEl.className = 'message error';
                msgEl.textContent = 'Not logged in. Please refresh and try again.';
                msgEl.style.display = 'block';
                return;
            }

            try {
                // Check if profile exists
                const { data: existing } = await db
                    .from('profiles')
                    .select('id')
                    .eq('id', currentUser.id)
                    .single();

                let error;
                if (existing) {
                    // Update
                    const { error: updateError } = await db
                        .from('profiles')
                        .update({
                            username,
                            display_name: displayName || null,
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', currentUser.id);
                    error = updateError;
                } else {
                    // Insert
                    const { error: insertError } = await db
                        .from('profiles')
                        .insert({
                            id: currentUser.id,
                            username,
                            display_name: displayName || null
                        });
                    error = insertError;
                }

                if (error) {
                    if (error.code === '23505') {
                        msgEl.className = 'message error';
                        msgEl.textContent = 'This username is already taken.';
                        msgEl.style.display = 'block';
                    } else {
                        throw error;
                    }
                    return;
                }

                // Update cache and current profile
                currentProfile = {
                    id: currentUser.id,
                    username,
                    display_name: displayName || null
                };
                profilesCache[currentUser.id] = currentProfile;

                // Update UI
                updateAuthUI(currentUser);
                hideProfileModal();

                // Refresh displays
                renderFeed();
                renderActivityStream();

            } catch (e) {
                console.error('Error saving profile:', e);
                msgEl.className = 'message error';
                msgEl.textContent = 'Failed to save profile. Please try again.';
                msgEl.style.display = 'block';
            }
        }

        function toggleUserMenu() {
            const menu = document.getElementById('userMenu');
            if (menu) {
                menu.classList.toggle('active');
            }
        }

        // Close user menu when clicking outside
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('userMenu');
            const avatar = document.querySelector('.user-avatar');
            if (menu && !menu.contains(e.target) && !avatar?.contains(e.target)) {
                menu.classList.remove('active');
            }
        });

        async function signOut() {
            if (db) {
                await db.auth.signOut();
            }
            currentUser = null;
            currentProfile = null;
            location.reload();
        }

        // Start
        init();
    </script>
</body>
</html>
