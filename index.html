<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Metamodality ‚Äî Reading Group</title>

    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

    <!-- Tesseract.js for OCR -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- Markdown parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        :root {
            --bg-dark: #f5f4f0;
            --bg-sidebar: #eae8e4;
            --bg-panel: #ffffff;
            --bg-editor: #fffcf8;
            --border: #e0ddd5;
            --text: #3d3929;
            --text-muted: #8b8579;
            --text-bright: #1a1815;
            --accent: #da7756;
            --accent-hover: #c4684a;
            --highlight: #f0ebe3;
            --success: #5a9a6e;
            --warning: #b8860b;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* ========== HEADER ========== */
        header {
            height: 50px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 20px;
            flex-shrink: 0;
        }

        .logo {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            cursor: pointer;
        }

        nav {
            display: flex;
            gap: 5px;
            margin-left: 20px;
        }

        .nav-tab {
            padding: 8px 16px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-muted);
            background: transparent;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .nav-tab:hover { background: var(--highlight); color: var(--text); }
        .nav-tab.active { background: var(--accent); color: white; }

        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 11px;
            color: var(--text-muted);
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
        }
        .status-dot.connected { background: var(--success); }

        .btn {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
        }
        .btn:hover { background: var(--accent-hover); }
        .btn.secondary {
            background: var(--bg-dark);
            color: var(--text);
            border: 1px solid var(--border);
        }
        .btn.secondary:hover { background: var(--highlight); }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
        }

        /* ========== MAIN CONTENT ========== */
        main {
            flex: 1;
            overflow: hidden;
        }

        .view {
            display: none;
            height: 100%;
            overflow: auto;
        }
        .view.active { display: block; }

        /* ========== HOME VIEW ========== */
        .home-view {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .home-hero {
            text-align: center;
            margin-bottom: 50px;
            padding: 40px 20px;
            background: linear-gradient(135deg, rgba(139,90,43,0.08) 0%, rgba(101,67,33,0.04) 100%);
            border-radius: 16px;
            border: 1px solid rgba(139,90,43,0.15);
        }
        .home-hero h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 36px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 8px;
            letter-spacing: -0.01em;
        }
        .home-hero .subtitle {
            font-size: 16px;
            color: var(--text-muted);
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            margin-bottom: 24px;
        }
        .home-hero .epigraph {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-style: italic;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
            max-width: 560px;
            margin: 0 auto 12px;
        }
        .home-hero .epigraph-source {
            font-size: 13px;
            color: var(--text-muted);
        }
        .home-intro {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.7;
            color: var(--text);
            max-width: 640px;
            margin: 0 auto 40px;
            text-align: center;
        }

        .current-week {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .current-week-label {
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--accent);
            margin-bottom: 8px;
        }
        .current-week h2 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .current-week .focus {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text);
            margin-bottom: 20px;
        }
        .current-week-readings {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .reading-card {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-dark);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .reading-card:hover { background: var(--highlight); transform: translateX(4px); }
        .reading-card .icon { font-size: 18px; margin-right: 12px; }
        .reading-card .info { flex: 1; }
        .reading-card .title { font-size: 14px; color: var(--text-bright); }
        .reading-card .pages { font-size: 12px; color: var(--text-muted); }
        .reading-card .arrow { color: var(--text-muted); }

        .home-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 700px) {
            .home-grid { grid-template-columns: 1fr; }
        }

        .home-section {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .home-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .home-section h3 .icon { font-size: 16px; }

        .activity-item {
            padding: 10px 0;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
        }
        .activity-item:last-child { border-bottom: none; }
        .activity-item .author { color: var(--accent); font-weight: 500; }
        .activity-item .action { color: var(--text-muted); }
        .activity-item .target { color: var(--text); }
        .activity-item .time { font-size: 11px; color: var(--text-muted); display: block; margin-top: 4px; }

        .empty-state {
            text-align: left;
            padding: 20px;
            color: var(--text-muted);
            font-size: 13px;
            font-style: italic;
        }

        /* Activity Stream */
        .home-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 30px;
            margin-top: 30px;
        }
        @media (max-width: 900px) {
            .home-layout { grid-template-columns: 1fr; }
            .activity-sidebar { order: -1; }
        }

        .activity-sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .activity-card {
            background: var(--bg-panel);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            overflow: hidden;
        }
        .activity-card-header {
            padding: 15px 18px;
            border-bottom: 1px solid var(--border);
            font-size: 13px;
            font-weight: 600;
            color: var(--text-bright);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .activity-card-header .icon { font-size: 14px; }
        .activity-card-body {
            max-height: 280px;
            overflow-y: auto;
        }

        .stream-item {
            padding: 14px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            transition: background 0.15s;
            cursor: pointer;
        }
        .stream-item:last-child { border-bottom: none; }
        .stream-item:hover { background: var(--highlight); }
        .stream-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }
        .stream-avatar.system { background: var(--text-muted); font-size: 14px; }
        .stream-content { flex: 1; min-width: 0; }
        .stream-text {
            font-size: 13px;
            color: var(--text);
            line-height: 1.4;
        }
        .stream-text .author { color: var(--accent); font-weight: 500; }
        .stream-text .target { color: var(--text-bright); font-weight: 500; }
        .stream-meta {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .upcoming-item {
            padding: 12px 18px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .upcoming-item:last-child { border-bottom: none; }
        .upcoming-item:hover { background: var(--highlight); }
        .upcoming-date {
            width: 44px;
            height: 44px;
            background: var(--bg-dark);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .upcoming-date .month {
            font-size: 9px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent);
            font-weight: 600;
        }
        .upcoming-date .day {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-bright);
            line-height: 1;
        }
        .upcoming-info { flex: 1; }
        .upcoming-title {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 2px;
        }
        .upcoming-detail {
            font-size: 11px;
            color: var(--text-muted);
        }
        .upcoming-item.current .upcoming-date {
            background: var(--accent);
        }
        .upcoming-item.current .upcoming-date .month,
        .upcoming-item.current .upcoming-date .day { color: white; }

        /* ========== SYLLABUS VIEW ========== */
        .syllabus-view {
            max-width: 850px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        .syllabus-view h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 28px;
            font-weight: normal;
            margin-bottom: 30px;
            color: var(--text-bright);
        }

        .unit {
            margin-bottom: 40px;
        }
        .unit-header {
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--accent);
        }
        .unit-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--accent);
            font-weight: 600;
            margin-bottom: 4px;
        }
        .unit-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 20px;
            color: var(--text-bright);
            font-weight: normal;
        }

        .week-card {
            background: var(--bg-panel);
            border-radius: 10px;
            margin-bottom: 12px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.04);
            overflow: hidden;
            border-left: 3px solid transparent;
            transition: all 0.15s;
        }
        .week-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .week-card.current { border-left-color: var(--accent); background: rgba(218, 119, 86, 0.03); }
        .week-card.completed { border-left-color: var(--success); }
        .week-card-main {
            padding: 20px;
            cursor: pointer;
        }
        .week-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }
        .week-card .week-num {
            font-size: 11px;
            font-weight: 600;
            color: white;
            background: var(--text-muted);
            padding: 3px 8px;
            border-radius: 4px;
            min-width: 55px;
            text-align: center;
        }
        .week-card.current .week-num { background: var(--accent); }
        .week-card.completed .week-num { background: var(--success); }
        .week-card .week-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 18px;
            color: var(--text-bright);
            flex: 1;
        }
        .week-card .week-date {
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-card .week-status {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 12px;
            background: var(--bg-dark);
            color: var(--text-muted);
        }
        .week-card.current .week-status { background: rgba(218, 119, 86, 0.15); color: var(--accent); }
        .week-card .week-focus {
            font-size: 13px;
            color: var(--text);
            line-height: 1.5;
            margin-bottom: 12px;
        }
        .week-card .week-summary {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-card .expand-icon {
            margin-left: auto;
            transition: transform 0.2s;
            color: var(--text-muted);
        }
        .week-card.expanded .expand-icon { transform: rotate(180deg); }

        .week-readings-list {
            display: none;
            padding: 0 20px 20px;
            border-top: 1px solid var(--border);
            margin-top: 0;
        }
        .week-card.expanded .week-readings-list { display: block; }
        .week-reading-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.15s;
        }
        .week-reading-item:last-child { border-bottom: none; }
        .week-reading-item:hover { padding-left: 8px; }
        .week-reading-item .reading-icon {
            width: 32px;
            height: 32px;
            background: var(--bg-dark);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 14px;
        }
        .week-reading-item .reading-info { flex: 1; }
        .week-reading-item .reading-title {
            font-size: 14px;
            color: var(--text-bright);
            margin-bottom: 2px;
        }
        .week-reading-item .reading-meta {
            font-size: 12px;
            color: var(--text-muted);
        }
        .week-reading-item .reading-progress {
            width: 18px;
            height: 18px;
            border: 2px solid var(--border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: transparent;
        }
        .week-reading-item .reading-progress.started { border-color: var(--warning); background: rgba(184, 134, 11, 0.1); }
        .week-reading-item .reading-progress.complete { border-color: var(--success); background: var(--success); color: white; }

        /* ========== READ VIEW ========== */
        .read-view {
            display: none;
            height: 100%;
            flex-direction: row;
        }
        .read-view.active { display: flex; }

        .read-sidebar {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .read-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            font-weight: 600;
        }
        .read-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .sidebar-unit {
            border-bottom: 1px solid var(--border);
        }
        .sidebar-unit-header {
            padding: 10px 15px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            background: var(--bg-dark);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .sidebar-unit-header:hover { background: var(--highlight); }
        .sidebar-unit-header .collapse-icon {
            transition: transform 0.2s;
        }
        .sidebar-unit.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }
        .sidebar-unit.collapsed .sidebar-unit-weeks {
            display: none;
        }
        .sidebar-week {
            border-top: 1px solid var(--border);
        }
        .sidebar-week-header {
            padding: 8px 15px 8px 25px;
            font-size: 12px;
            font-weight: 500;
            color: var(--text-bright);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .sidebar-week-header:hover { background: var(--highlight); }
        .sidebar-week.collapsed .sidebar-week-readings {
            display: none;
        }
        .sidebar-week.collapsed .collapse-icon {
            transform: rotate(-90deg);
        }

        .reading-list-item {
            padding: 8px 15px 8px 40px;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.15s;
            font-size: 12px;
            color: var(--text);
        }
        .reading-list-item:hover { background: var(--highlight); }
        .reading-list-item.active {
            background: var(--highlight);
            border-left-color: var(--accent);
            color: var(--text-bright);
        }

        .pdf-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #525659;
            min-width: 0;
        }
        .pdf-header {
            padding: 12px 20px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .pdf-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
        }
        .pdf-controls {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .pdf-controls button {
            background: var(--bg-dark);
            border: 1px solid var(--border);
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .pdf-controls button:hover { background: var(--highlight); }
        .pdf-controls span { font-size: 12px; color: var(--text-muted); }
        .fullscreen-btn { margin-left: auto; }

        .ocr-btn { position: relative; }
        .ocr-btn.loading { opacity: 0.7; pointer-events: none; }
        .ocr-btn .spinner {
            display: none;
            width: 12px;
            height: 12px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 4px;
        }
        .ocr-btn.loading .spinner { display: inline-block; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .ocr-status {
            font-size: 11px;
            padding: 3px 8px;
            border-radius: 4px;
            background: rgba(90, 154, 110, 0.15);
            color: var(--success);
        }
        .ocr-status.warning {
            background: rgba(184, 134, 11, 0.15);
            color: var(--warning);
        }

        /* Fullscreen mode */
        .read-view.fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            background: var(--bg-dark);
        }
        .read-view.fullscreen .read-sidebar { display: none; }
        .read-view.fullscreen .pdf-container { flex: 1; }
        .read-view.fullscreen .annotations-panel {
            position: absolute;
            right: 0;
            top: 50px;
            bottom: 0;
            width: 350px;
            z-index: 10;
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
        }
        .read-view.fullscreen .annotations-panel.collapsed { width: 40px; }
        .read-view.fullscreen .annotations-panel.collapsed .annotations-list,
        .read-view.fullscreen .annotations-panel.collapsed .annotation-form { display: none; }

        .sidebar-toggle {
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-left: none;
            padding: 20px 8px;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
            z-index: 5;
        }
        .read-sidebar.collapsed { width: 0; overflow: hidden; border: none; }
        .read-sidebar.collapsed + .sidebar-toggle { display: block; }

        .pdf-viewer {
            flex: 1;
            overflow: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            gap: 15px;
        }
        .pdf-viewer canvas {
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            max-width: 100%;
        }
        .pdf-page-container {
            position: relative;
        }
        .pdf-text-layer {
            position: absolute;
            left: 0;
            top: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            line-height: 1;
            z-index: 2;
            pointer-events: none;
        }
        .pdf-text-layer > span {
            color: transparent;
            position: absolute;
            white-space: pre;
            transform-origin: 0% 0%;
            pointer-events: auto;
            cursor: text;
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
        }
        .pdf-text-layer > span::selection {
            background: rgba(218, 119, 86, 0.4);
            color: transparent;
        }
        .pdf-text-layer > span::-moz-selection {
            background: rgba(218, 119, 86, 0.4);
            color: transparent;
        }
        .pdf-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #999;
            gap: 15px;
        }
        .pdf-empty-icon { font-size: 48px; opacity: 0.5; }

        .annotations-panel {
            width: 320px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
        }
        .annotations-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .annotations-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
        }
        .annotations-list {
            flex: 1;
            overflow-y: auto;
        }
        .annotation-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
        }
        .annotation-quote {
            font-size: 13px;
            font-style: italic;
            color: var(--text);
            margin-bottom: 8px;
            padding-left: 12px;
            border-left: 3px solid var(--accent);
            line-height: 1.5;
        }
        .annotation-comment {
            font-size: 13px;
            color: var(--text);
            margin-bottom: 8px;
        }
        .annotation-meta {
            font-size: 11px;
            color: var(--text-muted);
        }
        .annotations-empty {
            padding: 30px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .annotation-form {
            padding: 15px;
            border-top: 1px solid var(--border);
            background: var(--bg-dark);
            display: none;
        }
        .annotation-form.active { display: block; }
        .annotation-form .quote-preview {
            font-size: 12px;
            font-style: italic;
            color: var(--text-muted);
            padding: 10px;
            background: var(--bg-panel);
            border-radius: 6px;
            margin-bottom: 10px;
            max-height: 80px;
            overflow-y: auto;
        }
        .annotation-form textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 13px;
            resize: none;
            min-height: 80px;
            margin-bottom: 10px;
        }
        .annotation-form textarea:focus { outline: none; border-color: var(--accent); }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        /* ========== DISCUSS VIEW ========== */
        .discuss-view {
            max-width: 700px;
            margin: 0 auto;
            padding: 30px 20px;
        }
        .discuss-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }
        .discuss-header h1 {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 24px;
            font-weight: normal;
            color: var(--text-bright);
        }

        .post-card {
            background: var(--bg-panel);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }
        .post-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }
        .post-author { font-size: 14px; font-weight: 500; color: var(--text-bright); }
        .post-date { font-size: 12px; color: var(--text-muted); }
        .post-title {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            font-size: 20px;
            color: var(--text-bright);
            margin-bottom: 12px;
        }
        .post-content {
            font-size: 14px;
            line-height: 1.7;
            color: var(--text);
        }
        .post-content p { margin-bottom: 12px; }
        .post-links {
            margin-top: 15px;
            font-size: 12px;
            color: var(--text-muted);
        }
        .post-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 20px;
        }
        .post-action {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .post-action:hover { color: var(--accent); }

        /* ========== WRITE VIEW ========== */
        .write-view {
            display: none;
            height: 100%;
            flex-direction: row;
        }
        .write-view.active { display: flex; }

        .notes-sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }
        .notes-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notes-sidebar-header h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-bright);
        }
        .notes-list {
            flex: 1;
            overflow-y: auto;
        }
        .note-list-item {
            padding: 15px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .note-list-item:hover { background: var(--highlight); }
        .note-list-item.active { background: var(--highlight); border-left: 3px solid var(--accent); }
        .note-list-item .note-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-bright);
            margin-bottom: 4px;
        }
        .note-list-item .note-preview {
            font-size: 12px;
            color: var(--text-muted);
            line-height: 1.4;
        }
        .note-list-item .note-date {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
        }

        .editor-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-editor);
        }
        .editor-header {
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-panel);
        }
        .editor-title-input {
            font-size: 20px;
            font-weight: 500;
            border: none;
            background: transparent;
            color: var(--text-bright);
            flex: 1;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }
        .editor-title-input:focus { outline: none; }
        .editor-title-input::placeholder { color: var(--text-muted); }

        .editor-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        .editor-textarea {
            flex: 1;
            padding: 25px;
            border: none;
            font-size: 15px;
            line-height: 1.8;
            resize: none;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: var(--bg-editor);
            color: var(--text);
        }
        .editor-textarea:focus { outline: none; }
        .editor-textarea::placeholder { color: var(--text-muted); }

        .editor-footer {
            padding: 12px 25px;
            border-top: 1px solid var(--border);
            background: var(--bg-panel);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .editor-links {
            font-size: 12px;
            color: var(--text-muted);
        }
        .editor-link {
            display: inline-block;
            background: var(--bg-dark);
            padding: 3px 10px;
            border-radius: 12px;
            margin-right: 6px;
            cursor: pointer;
        }
        .editor-link:hover { background: var(--highlight); }

        .editor-empty {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            gap: 15px;
        }
        .editor-empty-icon { font-size: 48px; opacity: 0.5; }

        /* ========== SELECTION POPUP ========== */
        .selection-popup {
            display: none;
            position: fixed;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 1000;
            overflow: hidden;
        }
        .selection-popup button {
            padding: 10px 18px;
            background: var(--accent);
            color: white;
            border: none;
            font-size: 13px;
            cursor: pointer;
        }
        .selection-popup button:hover { background: var(--accent-hover); }

        /* ========== AUTH MODAL ========== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: var(--bg-panel);
            border-radius: 12px;
            width: 400px;
            max-width: 90%;
            padding: 30px;
        }
        .modal h3 {
            font-size: 18px;
            margin-bottom: 8px;
            color: var(--text-bright);
        }
        .modal p {
            font-size: 14px;
            color: var(--text-muted);
            margin-bottom: 20px;
        }
        .modal input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 15px;
        }
        .modal input:focus { outline: none; border-color: var(--accent); }
        .modal .btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .modal .message {
            padding: 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 15px;
        }
        .modal .message.success { background: #d1fae5; color: #065f46; }
        .modal .message.error { background: #fee2e2; color: #991b1b; }
    </style>
</head>
<body>
    <!-- Header -->
    <header>
        <div class="logo" onclick="switchView('home')">Metamodality</div>
        <nav>
            <button class="nav-tab active" data-view="home">Home</button>
            <button class="nav-tab" data-view="syllabus">Syllabus</button>
            <button class="nav-tab" data-view="read">Read</button>
            <button class="nav-tab" data-view="discuss">Discuss</button>
            <button class="nav-tab" data-view="write">Write</button>
        </nav>
        <div class="header-right">
            <div class="status">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">Connecting...</span>
            </div>
            <button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <!-- HOME VIEW -->
        <div class="view active" id="view-home">
            <div class="home-view">
                <div class="home-hero">
                    <h1>An Inquiry into Forms of the Possible</h1>
                    <p class="subtitle">Center for Possible Minds ‚Äî Spring 2026</p>
                    <div class="epigraph">
                        "What is it that it would not be right to say?<br>
                        That which is to be thought and spoken of must be.<br>
                        For it is there for being,<br>
                        but nothing is not."
                    </div>
                    <p class="epigraph-source">‚Äî Parmenides, Fr. 6.1‚Äì2 (Kingsley trans.)</p>
                </div>

                <p class="home-intro">
                    From Parmenides through contemporary set theory, thinkers have asked what it means for something to be possible. This reading group traces possibility across traditions‚ÄîGreek, Islamic, Buddhist, phenomenological, pragmatist‚Äîasking how each configures the space between what is and what might be.
                </p>

                <div class="home-layout">
                    <div class="home-main">
                        <div class="current-week" id="currentWeekCard">
                            <!-- Populated by JS -->
                        </div>

                        <div class="home-grid">
                            <div class="home-section">
                                <h3><span class="icon">üí¨</span> Recent Discussion</h3>
                                <div id="recentPosts">
                                    <div class="empty-state">No posts yet. Be the first to share your thoughts.</div>
                                </div>
                            </div>
                            <div class="home-section">
                                <h3><span class="icon">‚ú®</span> Recent Annotations</h3>
                                <div id="recentAnnotations">
                                    <div class="empty-state">Annotations from the group will appear here.</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="activity-sidebar">
                        <!-- Upcoming Weeks -->
                        <div class="activity-card">
                            <div class="activity-card-header">
                                <span class="icon">üìÖ</span> Schedule
                            </div>
                            <div class="activity-card-body" id="upcomingWeeks">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <!-- Activity Stream -->
                        <div class="activity-card">
                            <div class="activity-card-header">
                                <span class="icon">‚ö°</span> Recent Activity
                            </div>
                            <div class="activity-card-body" id="activityStream">
                                <div class="empty-state">Activity from the group will appear here.</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SYLLABUS VIEW -->
        <div class="view" id="view-syllabus">
            <div class="syllabus-view">
                <h1>Schedule of Readings</h1>
                <div id="syllabusContent">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- READ VIEW -->
        <div class="view read-view" id="view-read">
            <div class="read-sidebar" id="readSidebar">
                <div class="read-sidebar-header">
                    <span>Readings</span>
                    <button class="btn" style="padding: 4px 8px; font-size: 11px;" onclick="toggleReadSidebar()">‚óÄ</button>
                </div>
                <div class="read-sidebar-content" id="readingsList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="pdf-container">
                <div class="pdf-header">
                    <div class="pdf-title" id="pdfTitle">Select a reading</div>
                    <div class="pdf-controls" id="pdfControls" style="display: none;">
                        <span><span id="totalPages">0</span> pages</span>
                        <span class="ocr-status" id="ocrStatus" style="display: none;"></span>
                        <button class="ocr-btn" id="ocrBtn" onclick="runOcrOnCurrentPage()" style="display: none;">
                            <span class="spinner"></span>
                            Run OCR
                        </button>
                        <button class="fullscreen-btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                    </div>
                </div>
                <div class="pdf-viewer" id="pdfViewer">
                    <div class="pdf-empty">
                        <div class="pdf-empty-icon">üìñ</div>
                        <div>Select a reading from the sidebar</div>
                    </div>
                </div>
            </div>
            <div class="annotations-panel" id="annotationsPanel">
                <div class="annotations-header">
                    <h3>Annotations</h3>
                    <span id="annotationsCount" style="font-size: 12px; color: var(--text-muted);"></span>
                    <button class="btn" style="margin-left: auto; padding: 4px 8px; font-size: 11px;" onclick="toggleAnnotationsPanel()">‚ñ∂</button>
                </div>
                <div class="annotations-list" id="annotationsList">
                    <div class="annotations-empty">
                        Select text in the reading to create an annotation.
                    </div>
                </div>
                <div class="annotation-form" id="annotationForm">
                    <div class="quote-preview" id="quotePreview"></div>
                    <textarea id="annotationComment" placeholder="Add your thoughts..."></textarea>
                    <div class="form-actions">
                        <button class="btn secondary" onclick="cancelAnnotation()">Cancel</button>
                        <button class="btn" onclick="saveAnnotation()">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- DISCUSS VIEW -->
        <div class="view" id="view-discuss">
            <div class="discuss-view">
                <div class="discuss-header">
                    <h1>Discussion</h1>
                    <button class="btn" onclick="switchView('write')">+ New Post</button>
                </div>
                <div id="postsContainer">
                    <div class="empty-state" style="padding: 60px 20px;">
                        No posts yet. Switch to Write to share your thoughts with the group.
                    </div>
                </div>
            </div>
        </div>

        <!-- WRITE VIEW -->
        <div class="view write-view" id="view-write">
            <div class="notes-sidebar">
                <div class="notes-sidebar-header">
                    <h3>Your Notes</h3>
                    <button class="btn" onclick="newNote()">+ New</button>
                </div>
                <div class="notes-list" id="notesList">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="editor-container" id="editorContainer">
                <div class="editor-empty">
                    <div class="editor-empty-icon">‚úçÔ∏è</div>
                    <div>Select a note or create a new one</div>
                </div>
            </div>
            <div class="editor-active" id="editorActive" style="display: none; flex: 1; flex-direction: column;">
                <div class="editor-header">
                    <input type="text" class="editor-title-input" id="noteTitleInput" placeholder="Title...">
                    <div style="display: flex; gap: 8px;">
                        <button class="btn secondary" onclick="saveNote()">Save</button>
                        <button class="btn" onclick="publishNote()">Publish</button>
                    </div>
                </div>
                <div class="editor-body">
                    <textarea class="editor-textarea" id="noteContentInput" placeholder="Write your thoughts...

Use [[Week 1: Parmenides]] to link to readings."></textarea>
                </div>
                <div class="editor-footer">
                    <div class="editor-links" id="editorLinks">
                        Use [[Week Title]] to link to readings
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Selection Popup -->
    <div class="selection-popup" id="selectionPopup">
        <button onclick="startAnnotation()">Annotate</button>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal">
            <h3>Sign in</h3>
            <p>Enter your email to receive a magic link.</p>
            <div class="message" id="authMessage" style="display: none;"></div>
            <input type="email" id="authEmail" placeholder="your@email.com">
            <div class="btn-row">
                <button class="btn secondary" onclick="hideAuthModal()">Cancel</button>
                <button class="btn" onclick="sendMagicLink()">Send link</button>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // CONFIGURATION
        // =============================================
        const SUPABASE_URL = 'https://tnasxupoydyoxibccovm.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRuYXN4dXBveWR5b3hpYmNjb3ZtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkyMDM5NjksImV4cCI6MjA4NDc3OTk2OX0.JTXSnyDDl5Ta3s7fDtnGfWcuicuchwP5A5WhRZ_exIg';

        let db = null;
        let currentUser = null;

        try {
            db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        } catch (e) {
            console.warn('Supabase init failed:', e);
        }

        // =============================================
        // SCHEDULE DATA
        // =============================================
        const schedule = [
            {
                unit: "Unit I: Ancient and Medieval Foundations",
                weeks: [
                    { num: 1, date: "Feb 4", title: "Being and Non-Being",
                      focus: "How can we think or speak "what is not"? This problem drives subsequent responses from Aristotle through Heidegger. Kingsley's reading situates Parmenides within an initiatory tradition.",
                      readings: [
                        { id: "w01_parmenides", title: "Parmenides, "On Nature" (complete fragments)", file: "readings/Week 1_Parmenides/Week 1_Parmenides.pdf" },
                        { id: "w01_kingsley", title: "Kingsley, In the Dark Places of Wisdom (Parts One and Two most essential)", file: "readings/Week 1_Parmenides/Week 1_Kingsley.pdf" }
                    ]},
                    { num: 2, date: "Feb 11", title: "Potentiality and Actuality",
                      focus: "Aristotle's potentiality (dynamis) answers Parmenides by locating possibility within beings themselves. The sea-battle problem asks whether future contingents have determinate truth values.",
                      readings: [
                        { id: "w02_meta", title: "Aristotle, Metaphysics Book Œò, ch. 1‚Äì3 and 6‚Äì8", file: "readings/Week 2_Aristotle/Week 2_Aristotle.pdf" },
                        { id: "w02_di", title: "Aristotle, De Interpretatione, ch. 9", file: "readings/Week 2_Aristotle/Week 2_Conway.pdf" },
                        { id: "w02_witt", title: "Witt, "The Priority of Actuality in Aristotle"", file: "readings/Week 2_Aristotle/Week 2_Witt.pdf" }
                    ]},
                    { num: 3, date: "Feb 18", title: "Essence and Existence",
                      focus: "Separating essence from existence, Avicenna makes contingency fundamental to everything except the Necessary Existent. This reconfiguration of Aristotle shapes Leibniz's later work on possible worlds.",
                      readings: [
                        { id: "w03_avicenna", title: "Avicenna, The Metaphysics of The Healing, selections", file: "readings/Week 3_Avicenna/Week 3_Avicenna.pdf" },
                        { id: "w03_adamson", title: "Adamson, "From the Necessary Existent to God"", file: "readings/Week 3_Avicenna/Week 3_Adamson.pdf" }
                    ]},
                    { num: 4, date: "Feb 25", title: "Emptiness and Dependent Arising",
                      focus: "Does "possibility" mean anything once inherent existence drops out? NƒÅgƒÅrjuna's tetralemma refuses the logical options that Western frameworks take for granted.",
                      readings: [
                        { id: "w04_nagarjuna", title: "NƒÅgƒÅrjuna, M≈´lamadhyamakakƒÅrikƒÅ, ch. 1, 2, 15, 24, 25", file: "readings/Week 4_Nagarjuna/Week 4_Nagarjuna.pdf" },
                        { id: "w04_garfield", title: "Garfield, "Dependent Arising and the Emptiness of Emptiness"", file: "readings/Week 4_Nagarjuna/Week 4_Garfield (Essay).pdf" },
                        { id: "w04_commentary", title: "Garfield, Commentary (optional)", file: "readings/Week 4_Nagarjuna/Week 4_Garfield (Commentary).pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit II: Rationalism, Transcendentalism, and the Imaginal",
                weeks: [
                    { num: 5, date: "Mar 4", title: "Compossibility and Possible Worlds",
                      focus: "Compossibility constrains which possibilities can coexist within a single world. The Monadology raises the question of what individuates possible worlds.",
                      readings: [
                        { id: "w05_monad", title: "Leibniz, Monadology", file: "readings/Week 5_Leibniz and Du Ch√¢telet/Leibniz_Monadology.pdf" },
                        { id: "w05_duchat", title: "Du Ch√¢telet, Institutions de physique, ch. 1‚Äì2", file: "readings/Week 5_Leibniz and Du Ch√¢telet/Week 5_Du Chatelet.pdf" },
                        { id: "w05_orig", title: "Leibniz, "On the Ultimate Origination of Things"", file: "readings/Week 5_Leibniz and Du Ch√¢telet/Week 5_Leibniz (Origination).pdf" }
                    ]},
                    { num: 6, date: "Mar 11", title: "Real and Logical Possibility",
                      focus: "What must any possible experience conform to? Kant's Postulates distinguish logical possibility from real possibility.",
                      readings: [
                        { id: "w06_kant", title: "Kant, Critique of Pure Reason: "Postulates of Empirical Thought"", file: "readings/Week 6_Kant and Leech/Week 6_Kant.pdf" },
                        { id: "w06_leech", title: "Leech, "The Function of Modal Judgment and the Kantian Gap"", file: "readings/Week 6_Kant and Leech/Week 6_Leech.pdf" }
                    ]},
                    { num: 7, date: "Mar 18", title: "The Imaginal World",
                      focus: "Ibn  øArabƒ´'s imaginal world ( øƒÅlam al-mithƒÅl) occupies a realm between sensible and intelligible, where possibilities take on form. The Adam chapter introduces the human being as comprehensive mirror of divine names; the Joseph chapter develops imagination as an ontological realm through dream interpretation. (Spring Break‚Äîinformal)",
                      readings: [
                        { id: "w07_arabi", title: "Ibn  øArabƒ´, Fu·π£≈´·π£ al-·∏§ikam (Bezels of Wisdom), "Adam" and "Joseph" chapters (Austin trans.)", file: "readings/Week 7_al-Adawiyya and Ibn Arabi/Week 7_Arabi.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit III: Phenomenology, Pragmatism, and Nothingness",
                weeks: [
                    { num: 8, date: "Mar 25", title: "Conditions of Possibility",
                      focus: "Can a condition of possibility also be a condition of impossibility? Derrida's introduction examines how ideal objects arise in history yet claim eternal validity.",
                      readings: [
                        { id: "w08_husserl", title: "Husserl, "The Origin of Geometry"", file: "readings/Week 8_Husserl and Derrida/Week 8_Husserl and Derrida.pdf" },
                        { id: "w08_derrida", title: "Derrida, Introduction to "The Origin of Geometry," selections", file: "readings/Week 8_Husserl and Derrida/Week 8_Husserl and Derrida.pdf" }
                    ]},
                    { num: 9, date: "Apr 1", title: "Death and Natality",
                      focus: "Heidegger transforms the Aristotelian vocabulary so that possibility becomes constitutive of Dasein; death individualizes as the ownmost possibility. Arendt's natality offers a counter-emphasis.",
                      readings: [
                        { id: "w09_heid", title: "Heidegger, Being and Time, Division II ch. 1 (¬ß¬ß46‚Äì53)", file: "readings/Week 9_Heidegger and Arendt/Week 9_Heidegger.pdf" },
                        { id: "w09_arendt", title: "Arendt, The Human Condition, ch. 5 ¬ß¬ß24‚Äì26", file: "readings/Week 9_Heidegger and Arendt/Week 9_Arendt.pdf" }
                    ]},
                    { num: 10, date: "Apr 8", title: "Firstness and Continuity",
                      focus: "Firstness is pure qualitative possibility, prior to relation or resistance. Peirce's continuum allows possibility to grade into actuality.",
                      readings: [
                        { id: "w10_peirce", title: "Peirce, "A Guess at the Riddle"", file: "readings/Week 10_Peirce/Week 10_Peirce.pdf" },
                        { id: "w10_continuity", title: ""The Continuity of Life: On Peirce's Objective Idealism"", file: "readings/Week 10_Peirce/Week 10_Ibri (On Peirce's Objective Idealism).pdf" }
                    ]},
                    { num: 11, date: "Apr 15", title: "Nothingness East and West",
                      focus: "Nishida's "place of absolute nothingness" (zettai mu no basho) holds particulars without being one itself. Lalla's Kashmiri Shaivite poetry pursues nothingness through a different idiom.",
                      readings: [
                        { id: "w11_nishida", title: "Nishida Kitar≈ç, An Inquiry into the Good, Part I ch. 1‚Äì3", file: "readings/Week 11_Nishida and Lalla/Week 11_Nishida.pdf" },
                        { id: "w11_lalla", title: "Lalla, Naked Song, selections", file: "readings/Week 11_Nishida and Lalla/Week 11_Lalla.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit IV: Process, Contemplation, Emanation",
                weeks: [
                    { num: 12, date: "Apr 22", title: "Eternal Objects and Ingression",
                      focus: "Eternal objects ingress into actual occasions as pure potentials. Whitehead's God functions as the primordial envisagement of possibility, a role that recalls Leibniz, and Peirce's categories find new form in this processual framework.",
                      readings: [
                        { id: "w12_white", title: "Whitehead, Science and the Modern World, ch. 11", file: "readings/Week 12_Whitehead/Week 12_Whitehead.pdf" },
                        { id: "w12_stengers", title: "Stengers, Thinking with Whitehead, selections", file: "readings/Week 12_Whitehead/Week 12_Stengers (Thinking With Whitehead).pdf" }
                    ]},
                    { num: 13, date: "Apr 29", title: "Attention and Awareness",
                      focus: "Thompson and Varela bridge first-person contemplative methods and third-person neuroscience. Weil's account of attention resonates with contemplative approaches while drawing on Platonic sources.",
                      readings: [
                        { id: "w13_thompson", title: "Thompson, Waking, Dreaming, Being, ch. 1", file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Thompson.pdf" },
                        { id: "w13_weil", title: "Weil, "Reflections on the Right Use of School Studies with a View to the Love of God"", file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Weil.pdf" },
                        { id: "w13_varela", title: "Varela, "Neurophenomenology: A Methodological Remedy for the Hard Problem"", file: "readings/Week 13_Thompson, Weil, Varela /Week 13_Varela.pdf" }
                    ]},
                    { num: 14, date: "May 6", title: "Emanation and Superabundance",
                      focus: "Possibility flows from the One's inexhaustible superabundance. This emanationist framework shaped Avicenna and passed into German Idealism; it offers a counterpoint to the Aristotelian model of potentiality.",
                      readings: [
                        { id: "w14_plotinus", title: "Plotinus, Enneads V.1", file: "readings/Week 14_Plotinus, Conway/Week 14_Plotinus.pdf" },
                        { id: "w14_conway", title: "Conway, Principles of the Most Ancient and Modern Philosophy, selections", file: "readings/Week 14_Plotinus, Conway/Week 14_Conway.pdf" }
                    ]}
                ]
            },
            {
                unit: "Unit V: Mathematical and Formal Possibility",
                weeks: [
                    { num: 15, date: "May 13", title: "Set-Theoretic Potentialism",
                      focus: "Ruth Barcan Marcus founded quantified modal logic; her Barcan formula raises questions about the relation between possibility and existence. Hamkins's multiverse holds many distinct concepts of set, each instantiated in a corresponding universe.",
                      readings: [
                        { id: "w15_marcus", title: "Barcan Marcus, "Modalities and Intensional Languages"", file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Marcus.pdf" },
                        { id: "w15_hamkins", title: "Hamkins, "The Set-Theoretic Multiverse"", file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Hamkins (multiverse).pdf" },
                        { id: "w15_linnebo", title: "Hamkins & Linnebo, "The Modal Logic of Set-Theoretic Potentialism"", file: "readings/Week 15_Hamkins, Barcon Marcus/Week 15_Hamkins and Linnebo.pdf" }
                    ]},
                    { num: 16, date: "May 20", title: "Producing the Possible",
                      focus: "How do possibility spaces themselves get produced? Foster's work shows tradition constraining what becomes thinkable while furnishing materials for innovation, bringing the semester's philosophical questions into contact with computational and sociological methods. Borges's story explores the literary form of branching possibility.",
                      readings: [
                        { id: "w16_metal", title: "Koch, Silvestro & Foster, "The Evolutionary Dynamics of Cultural Change (As Told Through the Birth and Brutal, Blackened Death of Metal Music)"", file: "readings/Week 16_Foster/Week 16_Foster and Koch.pdf" },
                        { id: "w16_borges", title: "Borges, "The Garden of Forking Paths"", file: "readings/Week 16_Foster/Week 16_Borges.pdf" }
                    ]}
                ]
            }
        ];

        // State
        let currentWeekNum = 1;
        let currentReading = null;
        let selectedText = '';
        let annotations = {};
        let notes = [];
        let posts = [];
        let editingNoteId = null;

        // =============================================
        // INITIALIZATION
        // =============================================

        function init() {
            updateStatus('connected', 'Connected');
            buildSyllabus();
            buildReadingsList();
            renderCurrentWeek();
            loadFeed();
            loadNotes();

            // Auth state
            if (db) {
                db.auth.onAuthStateChange((event, session) => {
                    if (session?.user) {
                        currentUser = session.user;
                        updateAuthUI(currentUser);
                        hideAuthModal();
                        loadNotes();
                    } else {
                        currentUser = null;
                        updateAuthUI(null);
                    }
                });

                db.auth.getSession().then(({ data: { session } }) => {
                    if (session?.user) {
                        currentUser = session.user;
                        updateAuthUI(currentUser);
                        loadNotes();
                    }
                });
            }

            // Tab navigation
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.addEventListener('click', () => switchView(tab.dataset.view));
            });
        }

        function updateStatus(status, text) {
            document.getElementById('statusDot').className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = text;
        }

        // =============================================
        // VIEW SWITCHING
        // =============================================

        function switchView(viewName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

            document.querySelector(`[data-view="${viewName}"]`).classList.add('active');
            document.getElementById('view-' + viewName).classList.add('active');
        }

        // =============================================
        // HOME VIEW
        // =============================================

        function getCurrentWeek() {
            // For now, default to week 1. Could be date-based later.
            let week = null;
            for (const unit of schedule) {
                for (const w of unit.weeks) {
                    if (w.num === currentWeekNum) {
                        week = w;
                        break;
                    }
                }
            }
            return week;
        }

        function renderCurrentWeek() {
            const week = getCurrentWeek();
            if (!week) return;

            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            const weekProgress = progress[`week_${week.num}`] || {};

            document.getElementById('currentWeekCard').innerHTML = `
                <div class="current-week-label">Week ${week.num} ‚Äî ${week.date}</div>
                <h2>${week.title}</h2>
                <p class="focus">${week.focus}</p>
                <div class="current-week-readings">
                    ${week.readings.map(r => `
                        <div class="reading-card" onclick="openReading('${r.id}')">
                            <span class="icon">${weekProgress[r.id] ? '‚úì' : 'üìÑ'}</span>
                            <div class="info">
                                <div class="title">${r.title}</div>
                            </div>
                            <span class="arrow">‚Üí</span>
                        </div>
                    `).join('')}
                </div>
            `;

            // Also render sidebar components
            renderUpcomingWeeks();
            renderActivityStream();
        }

        function renderUpcomingWeeks() {
            const container = document.getElementById('upcomingWeeks');
            if (!container) return;

            // Get all weeks flattened
            const allWeeks = [];
            schedule.forEach(unit => {
                unit.weeks.forEach(week => allWeeks.push(week));
            });

            // Show current + next 4 weeks
            const startIdx = Math.max(0, currentWeekNum - 1);
            const visibleWeeks = allWeeks.slice(startIdx, startIdx + 5);

            container.innerHTML = visibleWeeks.map(week => {
                const isCurrent = week.num === currentWeekNum;
                // Parse date like "Feb 4" into month and day
                const dateParts = week.date.split(' ');
                const month = dateParts[0] || '';
                const day = dateParts[1] || '';

                return `
                    <div class="upcoming-item ${isCurrent ? 'current' : ''}" onclick="goToWeek(${week.num})">
                        <div class="upcoming-date">
                            <span class="month">${month}</span>
                            <span class="day">${day}</span>
                        </div>
                        <div class="upcoming-info">
                            <div class="upcoming-title">Week ${week.num}: ${week.title}</div>
                            <div class="upcoming-detail">${week.readings.length} readings</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderActivityStream() {
            const container = document.getElementById('activityStream');
            if (!container) return;

            // Combine recent posts and annotations into a single stream
            const activities = [];

            // Add posts
            posts.slice(0, 5).forEach(p => {
                activities.push({
                    type: 'post',
                    author: p.author_email || 'Anonymous',
                    title: p.title,
                    time: new Date(p.published_at),
                    onClick: `switchView('discuss')`
                });
            });

            // Add annotations from all readings
            Object.entries(annotations).forEach(([readingId, items]) => {
                (items || []).slice(0, 3).forEach(a => {
                    activities.push({
                        type: 'annotation',
                        author: a.author_email || 'Anonymous',
                        quote: a.quote?.substring(0, 50) + '...',
                        readingId: readingId,
                        time: new Date(a.created_at),
                        onClick: `openReading('${readingId}')`
                    });
                });
            });

            // Sort by time, most recent first
            activities.sort((a, b) => b.time - a.time);

            if (activities.length === 0) {
                container.innerHTML = '<div class="empty-state">Activity from the group will appear here.</div>';
                return;
            }

            container.innerHTML = activities.slice(0, 8).map(a => {
                const initial = (a.author.split('@')[0] || 'A')[0].toUpperCase();
                const timeAgo = formatTimeAgo(a.time);

                if (a.type === 'post') {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> posted
                                    <span class="target">"${a.title}"</span>
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="stream-item" onclick="${a.onClick}">
                            <div class="stream-avatar">${initial}</div>
                            <div class="stream-content">
                                <div class="stream-text">
                                    <span class="author">${a.author.split('@')[0]}</span> annotated "${a.quote}"
                                </div>
                                <div class="stream-meta">${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
        }

        function formatTimeAgo(date) {
            const now = new Date();
            const diff = now - date;
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (minutes < 1) return 'Just now';
            if (minutes < 60) return `${minutes}m ago`;
            if (hours < 24) return `${hours}h ago`;
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function openReading(readingId) {
            switchView('read');
            loadReading(readingId);
        }

        // =============================================
        // SYLLABUS VIEW
        // =============================================

        function buildSyllabus() {
            const container = document.getElementById('syllabusContent');
            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            let html = '';

            schedule.forEach((unit, unitIdx) => {
                // Parse unit title: "Unit I: Ancient and Medieval Foundations"
                const unitMatch = unit.unit.match(/^(Unit [IVX]+):\s*(.+)$/);
                const unitLabel = unitMatch ? unitMatch[1] : `Unit ${unitIdx + 1}`;
                const unitTitle = unitMatch ? unitMatch[2] : unit.unit;

                html += `<div class="unit">
                    <div class="unit-header">
                        <div class="unit-label">${unitLabel}</div>
                        <div class="unit-title">${unitTitle}</div>
                    </div>
                    ${unit.weeks.map(week => {
                        const isCurrent = week.num === currentWeekNum;
                        const weekProgress = progress[`week_${week.num}`] || {};
                        const readingsComplete = week.readings.filter(r => weekProgress[r.id]).length;
                        const isComplete = readingsComplete === week.readings.length && week.readings.length > 0;

                        return `
                        <div class="week-card ${isCurrent ? 'current' : ''} ${isComplete ? 'completed' : ''}" id="syllabus-week-${week.num}">
                            <div class="week-card-main" onclick="toggleSyllabusWeek(${week.num})">
                                <div class="week-card-header">
                                    <span class="week-num">Week ${week.num}</span>
                                    <span class="week-title">${week.title}</span>
                                    ${isCurrent ? '<span class="week-status">Current</span>' : ''}
                                    <span class="week-date">${week.date}</span>
                                </div>
                                <div class="week-focus">${week.focus}</div>
                                <div class="week-summary">
                                    <span>üìö ${week.readings.length} readings</span>
                                    ${readingsComplete > 0 ? `<span>‚úì ${readingsComplete}/${week.readings.length} complete</span>` : ''}
                                    <span class="expand-icon">‚ñº</span>
                                </div>
                            </div>
                            <div class="week-readings-list">
                                ${week.readings.map(r => {
                                    const isRead = weekProgress[r.id];
                                    return `
                                    <div class="week-reading-item" onclick="event.stopPropagation(); openReading('${r.id}')">
                                        <div class="reading-icon">üìÑ</div>
                                        <div class="reading-info">
                                            <div class="reading-title">${r.title}</div>
                                        </div>
                                        <div class="reading-progress ${isRead ? 'complete' : ''}">${isRead ? '‚úì' : ''}</div>
                                    </div>
                                `}).join('')}
                            </div>
                        </div>
                    `}).join('')}
                </div>`;
            });

            container.innerHTML = html;
        }

        function toggleSyllabusWeek(num) {
            const card = document.getElementById('syllabus-week-' + num);
            if (card) card.classList.toggle('expanded');
        }

        function markReadingComplete(readingId) {
            // Find which week this reading belongs to
            let weekNum = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    if (week.readings.some(r => r.id === readingId)) {
                        weekNum = week.num;
                        break;
                    }
                }
            }
            if (!weekNum) return;

            const progress = JSON.parse(localStorage.getItem('metamodality_progress') || '{}');
            if (!progress[`week_${weekNum}`]) progress[`week_${weekNum}`] = {};
            progress[`week_${weekNum}`][readingId] = true;
            localStorage.setItem('metamodality_progress', JSON.stringify(progress));

            // Rebuild syllabus to reflect changes
            buildSyllabus();
        }

        function goToWeek(num) {
            currentWeekNum = num;
            buildReadingsList();
            switchView('read');
        }

        // =============================================
        // READ VIEW
        // =============================================

        function buildReadingsList() {
            const container = document.getElementById('readingsList');
            container.innerHTML = schedule.map((unit, unitIdx) => `
                <div class="sidebar-unit" id="unit-${unitIdx}">
                    <div class="sidebar-unit-header" onclick="toggleUnit(${unitIdx})">
                        <span class="collapse-icon">‚ñº</span>
                        ${unit.unit.replace('Unit ', '').replace(/:.+/, '')}
                    </div>
                    <div class="sidebar-unit-weeks">
                        ${unit.weeks.map((week, weekIdx) => `
                            <div class="sidebar-week" id="week-${week.num}">
                                <div class="sidebar-week-header" onclick="toggleWeek(${week.num})">
                                    <span class="collapse-icon">‚ñº</span>
                                    Week ${week.num}: ${week.title}
                                </div>
                                <div class="sidebar-week-readings">
                                    ${week.readings.map(r => `
                                        <div class="reading-list-item" data-id="${r.id}" onclick="event.stopPropagation(); loadReading('${r.id}')">
                                            ${r.title.split(',')[0]}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');

            // Collapse all except current week's unit
            const currentWeek = getCurrentWeek();
            if (currentWeek) {
                document.querySelectorAll('.sidebar-unit').forEach(el => el.classList.add('collapsed'));
                document.querySelectorAll('.sidebar-week').forEach(el => el.classList.add('collapsed'));
                const weekEl = document.getElementById('week-' + currentWeek.num);
                if (weekEl) {
                    weekEl.classList.remove('collapsed');
                    weekEl.closest('.sidebar-unit')?.classList.remove('collapsed');
                }
            }
        }

        function toggleUnit(idx) {
            document.getElementById('unit-' + idx)?.classList.toggle('collapsed');
        }

        function toggleWeek(num) {
            event.stopPropagation();
            document.getElementById('week-' + num)?.classList.toggle('collapsed');
        }

        function toggleReadSidebar() {
            document.getElementById('readSidebar').classList.toggle('collapsed');
        }

        function toggleAnnotationsPanel() {
            document.getElementById('annotationsPanel').classList.toggle('collapsed');
        }

        function toggleFullscreen() {
            const readView = document.getElementById('view-read');
            readView.classList.toggle('fullscreen');
            const btn = document.querySelector('.fullscreen-btn');
            if (readView.classList.contains('fullscreen')) {
                btn.textContent = '‚úï Exit';
                document.body.style.overflow = 'hidden';
            } else {
                btn.textContent = '‚õ∂ Fullscreen';
                document.body.style.overflow = '';
            }
        }

        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        async function loadReading(readingId) {
            currentReading = readingId;
            pdfHasText = false; // Reset for new PDF

            // Hide OCR controls until we know if text exists
            document.getElementById('ocrStatus').style.display = 'none';
            document.getElementById('ocrBtn').style.display = 'none';

            // Update sidebar selection
            document.querySelectorAll('.reading-list-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.reading-list-item[data-id="${readingId}"]`)?.classList.add('active');

            // Find reading info
            let readingInfo = null;
            for (const unit of schedule) {
                for (const week of unit.weeks) {
                    for (const r of week.readings) {
                        if (r.id === readingId) {
                            readingInfo = r;
                            break;
                        }
                    }
                }
            }

            document.getElementById('pdfTitle').textContent = readingInfo?.title || 'Loading...';
            document.getElementById('pdfViewer').innerHTML = '<div class="pdf-empty"><div class="pdf-empty-icon">‚è≥</div><div>Loading...</div></div>';
            document.getElementById('pdfControls').style.display = 'none';

            // Load annotations
            await loadAnnotations(readingId);

            // Try to load PDF
            try {
                const response = await fetch(readingInfo.file);
                if (!response.ok) throw new Error('Not found');

                const arrayBuffer = await response.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;

                window.currentPdf = pdf;
                window.currentPageNum = 1;

                document.getElementById('totalPages').textContent = pdf.numPages;
                document.getElementById('pdfControls').style.display = 'flex';

                const viewer = document.getElementById('pdfViewer');
                viewer.innerHTML = '';

                // Create all page containers
                for (let i = 1; i <= pdf.numPages; i++) {
                    const pageContainer = document.createElement('div');
                    pageContainer.className = 'pdf-page-container';
                    pageContainer.id = 'page-container-' + i;
                    pageContainer.dataset.pageNum = i;

                    const canvas = document.createElement('canvas');
                    canvas.id = 'page-' + i;
                    pageContainer.appendChild(canvas);

                    const textLayer = document.createElement('div');
                    textLayer.className = 'pdf-text-layer';
                    textLayer.id = 'text-layer-' + i;
                    pageContainer.appendChild(textLayer);

                    viewer.appendChild(pageContainer);
                }

                // Render all pages progressively
                renderAllPages();
            } catch (e) {
                document.getElementById('pdfViewer').innerHTML = `
                    <div class="pdf-empty">
                        <div class="pdf-empty-icon">üìÑ</div>
                        <div>PDF not yet available</div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">${readingInfo?.file}</div>
                    </div>
                `;
            }
        }

        async function renderAllPages() {
            if (!window.currentPdf) return;

            const pdf = window.currentPdf;
            const scale = 1.5;

            // Render pages in batches for better performance
            for (let num = 1; num <= pdf.numPages; num++) {
                await renderSinglePage(num, scale);
            }
        }

        // Track text layer status
        let pdfHasText = false;
        let ocrWorker = null;

        async function renderSinglePage(num, scale = 1.5) {
            if (!window.currentPdf) return;

            try {
                const page = await window.currentPdf.getPage(num);
                const canvas = document.getElementById('page-' + num);
                if (!canvas) return;

                const context = canvas.getContext('2d');
                const textLayerDiv = document.getElementById('text-layer-' + num);

                const viewport = page.getViewport({ scale });
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({ canvasContext: context, viewport }).promise;

                // Render text layer for selection
                if (textLayerDiv) {
                    textLayerDiv.innerHTML = '';
                    textLayerDiv.style.width = viewport.width + 'px';
                    textLayerDiv.style.height = viewport.height + 'px';

                    const textContent = await page.getTextContent();

                    // Check if PDF has meaningful text content
                    const totalChars = textContent.items.reduce((sum, item) => sum + (item.str?.length || 0), 0);

                    if (totalChars > 50) {
                        pdfHasText = true;
                        // Render text items manually for reliable selection
                        textContent.items.forEach(item => {
                            if (!item.str) return;

                            const tx = pdfjsLib.Util.transform(
                                viewport.transform,
                                item.transform
                            );

                            const span = document.createElement('span');
                            span.textContent = item.str;
                            span.style.left = tx[4] + 'px';
                            span.style.top = (viewport.height - tx[5]) + 'px';
                            span.style.fontSize = Math.abs(tx[0]) + 'px';
                            span.style.fontFamily = item.fontName || 'sans-serif';

                            // Handle rotation if present
                            if (tx[1] !== 0 || tx[2] !== 0) {
                                const angle = Math.atan2(tx[1], tx[0]);
                                span.style.transform = `rotate(${angle}rad)`;
                            }

                            textLayerDiv.appendChild(span);
                        });
                    }

                    // Update OCR status after first page
                    if (num === 1) {
                        updateOcrStatus();
                    }
                }
            } catch (e) {
                console.warn('Failed to render page', num, e);
            }
        }

        function updateOcrStatus() {
            const statusEl = document.getElementById('ocrStatus');
            const btnEl = document.getElementById('ocrBtn');

            if (pdfHasText) {
                statusEl.textContent = 'Text layer detected';
                statusEl.className = 'ocr-status';
                statusEl.style.display = 'inline-block';
                btnEl.style.display = 'none';
            } else {
                statusEl.textContent = 'No text layer';
                statusEl.className = 'ocr-status warning';
                statusEl.style.display = 'inline-block';
                btnEl.style.display = 'inline-block';
            }
        }

        async function runOcrOnCurrentPage() {
            const btn = document.getElementById('ocrBtn');
            const statusEl = document.getElementById('ocrStatus');
            btn.classList.add('loading');

            try {
                const pdf = window.currentPdf;
                if (!pdf) return;

                // Initialize Tesseract worker if needed
                if (!ocrWorker) {
                    statusEl.textContent = 'Loading OCR engine...';
                    ocrWorker = await Tesseract.createWorker('eng');
                }

                // Process all pages
                for (let num = 1; num <= pdf.numPages; num++) {
                    statusEl.textContent = `OCR: page ${num}/${pdf.numPages}`;

                    const canvas = document.getElementById('page-' + num);
                    const textLayerDiv = document.getElementById('text-layer-' + num);
                    if (!canvas || !textLayerDiv) continue;

                    // Get image data from canvas
                    const imageData = canvas.toDataURL('image/png');

                    // Run OCR
                    const { data } = await ocrWorker.recognize(imageData);

                    // Clear existing text layer and add OCR results
                    textLayerDiv.innerHTML = '';

                    // Create text spans from OCR words
                    data.words.forEach(word => {
                        if (!word.text || word.text.trim() === '') return;

                        const span = document.createElement('span');
                        span.textContent = word.text + ' ';
                        span.style.left = word.bbox.x0 + 'px';
                        span.style.top = word.bbox.y0 + 'px';
                        span.style.fontSize = (word.bbox.y1 - word.bbox.y0) * 0.8 + 'px';
                        span.style.letterSpacing = '0.5px';

                        textLayerDiv.appendChild(span);
                    });
                }

                // Update status
                statusEl.textContent = 'OCR complete';
                statusEl.className = 'ocr-status';
                btn.style.display = 'none';

            } catch (e) {
                console.error('OCR failed:', e);
                statusEl.textContent = 'OCR failed';
                statusEl.className = 'ocr-status warning';
            } finally {
                btn.classList.remove('loading');
            }
        }

        // =============================================
        // ANNOTATIONS
        // =============================================

        async function loadAnnotations(readingId) {
            // Always load from localStorage first as fallback
            const localAnnotations = JSON.parse(localStorage.getItem('metamodality_annotations') || '{}');
            annotations = { ...localAnnotations };

            // Then try to load from Supabase
            if (db && currentUser) {
                try {
                    const { data, error } = await db
                        .from('annotations')
                        .select('*')
                        .eq('reading_id', readingId)
                        .order('created_at', { ascending: false });

                    if (error) {
                        console.warn('Supabase annotations error:', error);
                    } else if (data) {
                        // Merge with local
                        annotations[readingId] = data;
                    }
                } catch (e) {
                    console.warn('Failed to load annotations:', e);
                }
            }
            renderAnnotations();
        }

        function renderAnnotations() {
            const list = document.getElementById('annotationsList');
            const items = annotations[currentReading] || [];

            document.getElementById('annotationsCount').textContent = items.length > 0 ? `(${items.length})` : '';

            if (items.length === 0) {
                list.innerHTML = '<div class="annotations-empty">Select text in the reading to create an annotation.</div>';
                return;
            }

            list.innerHTML = items.map(a => `
                <div class="annotation-item">
                    <div class="annotation-quote">${a.quote}</div>
                    ${a.comment ? `<div class="annotation-comment">${a.comment}</div>` : ''}
                    <div class="annotation-meta">${a.author_email || 'Anonymous'} ¬∑ ${new Date(a.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        // Text selection
        document.addEventListener('mouseup', e => {
            // Small delay to let selection finalize
            setTimeout(() => {
                const selection = window.getSelection();
                const text = selection.toString().trim();

                // Check if selection is in PDF area
                const inPdfViewer = e.target.closest('.pdf-viewer') ||
                                    e.target.closest('.pdf-text-layer') ||
                                    e.target.closest('.pdf-page-container');

                if (text.length > 5 && currentReading && inPdfViewer) {
                    selectedText = text;
                    const popup = document.getElementById('selectionPopup');
                    popup.style.left = e.pageX + 'px';
                    popup.style.top = (e.pageY + 10) + 'px';
                    popup.style.display = 'block';
                }
            }, 10);
        });

        document.addEventListener('mousedown', e => {
            if (!e.target.closest('.selection-popup')) {
                document.getElementById('selectionPopup').style.display = 'none';
            }
        });

        function startAnnotation() {
            document.getElementById('selectionPopup').style.display = 'none';
            document.getElementById('quotePreview').textContent = selectedText;
            document.getElementById('annotationComment').value = '';
            document.getElementById('annotationForm').classList.add('active');
        }

        function cancelAnnotation() {
            document.getElementById('annotationForm').classList.remove('active');
            selectedText = '';
        }

        async function saveAnnotation() {
            if (!selectedText || !currentReading) return;

            const comment = document.getElementById('annotationComment').value;
            const annotation = {
                id: Date.now().toString(),
                reading_id: currentReading,
                quote: selectedText,
                comment: comment,
                created_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous'
            };

            // Add to local state
            if (!annotations[currentReading]) annotations[currentReading] = [];
            annotations[currentReading].unshift(annotation);

            // Always save to localStorage as backup
            localStorage.setItem('metamodality_annotations', JSON.stringify(annotations));

            // Try to save to Supabase if logged in
            if (db && currentUser) {
                annotation.user_id = currentUser.id;
                try {
                    const { error } = await db.from('annotations').insert([annotation]);
                    if (error) console.warn('Supabase save error:', error);
                } catch (e) {
                    console.warn('Failed to save to Supabase:', e);
                }
            }

            renderAnnotations();
            cancelAnnotation();
        }

        // =============================================
        // DISCUSS VIEW
        // =============================================

        async function loadFeed() {
            if (db) {
                try {
                    const { data } = await db
                        .from('posts')
                        .select('*')
                        .order('published_at', { ascending: false });

                    if (data) posts = data;
                } catch (e) {
                    console.warn('Failed to load posts:', e);
                }
            }
            renderFeed();
        }

        function renderFeed() {
            const container = document.getElementById('postsContainer');

            if (posts.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 60px 20px;">No posts yet. Switch to Write to share your thoughts.</div>';
                return;
            }

            container.innerHTML = posts.map(p => `
                <div class="post-card">
                    <div class="post-header">
                        <div class="post-avatar">${(p.author_email || 'A')[0].toUpperCase()}</div>
                        <div>
                            <div class="post-author">${p.author_email || 'Anonymous'}</div>
                            <div class="post-date">${new Date(p.published_at).toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="post-title">${p.title}</div>
                    <div class="post-content">${marked.parse(p.content || '')}</div>
                    ${p.linked_readings?.length ? `<div class="post-links">üìé ${p.linked_readings.join(', ')}</div>` : ''}
                </div>
            `).join('');

            // Also update home view
            renderRecentPosts();
        }

        function renderRecentPosts() {
            const container = document.getElementById('recentPosts');
            const recent = posts.slice(0, 3);

            if (recent.length === 0) {
                container.innerHTML = '<div class="empty-state">No posts yet.</div>';
                return;
            }

            container.innerHTML = recent.map(p => `
                <div class="activity-item" onclick="switchView('discuss')" style="cursor: pointer;">
                    <span class="author">${p.author_email?.split('@')[0] || 'Someone'}</span>
                    <span class="action">posted</span>
                    <span class="target">"${p.title}"</span>
                    <span class="time">${new Date(p.published_at).toLocaleDateString()}</span>
                </div>
            `).join('');
        }

        // =============================================
        // WRITE VIEW
        // =============================================

        async function loadNotes() {
            if (db && currentUser) {
                try {
                    const { data } = await db
                        .from('notes')
                        .select('*')
                        .eq('user_id', currentUser.id)
                        .order('updated_at', { ascending: false });

                    if (data) notes = data;
                } catch (e) {
                    console.warn('Failed to load notes:', e);
                }
            } else {
                notes = JSON.parse(localStorage.getItem('metamodality_notes') || '[]');
            }
            renderNotesList();
        }

        function renderNotesList() {
            const container = document.getElementById('notesList');

            if (notes.length === 0) {
                container.innerHTML = '<div class="empty-state" style="padding: 30px;">No notes yet. Click "+ New" to start writing.</div>';
                return;
            }

            container.innerHTML = notes.map(n => `
                <div class="note-list-item ${editingNoteId === n.id ? 'active' : ''}" onclick="editNote('${n.id}')">
                    <div class="note-title">${n.title || 'Untitled'}</div>
                    <div class="note-preview">${(n.content || '').substring(0, 60)}...</div>
                    <div class="note-date">${new Date(n.updated_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        function newNote() {
            editingNoteId = null;
            showEditor();
            document.getElementById('noteTitleInput').value = '';
            document.getElementById('noteContentInput').value = '';
            document.getElementById('editorLinks').innerHTML = 'Use [[Week Title]] to link to readings';
        }

        function editNote(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            editingNoteId = id;
            showEditor();
            document.getElementById('noteTitleInput').value = note.title || '';
            document.getElementById('noteContentInput').value = note.content || '';
            parseNoteLinks(note.content || '');
            renderNotesList();
        }

        function showEditor() {
            document.getElementById('editorContainer').style.display = 'none';
            document.getElementById('editorActive').style.display = 'flex';
        }

        function parseNoteLinks(content) {
            const links = content.match(/\[\[([^\]]+)\]\]/g) || [];
            const linksEl = document.getElementById('editorLinks');

            if (links.length === 0) {
                linksEl.innerHTML = 'Use [[Week Title]] to link to readings';
                return;
            }

            linksEl.innerHTML = 'Links: ' + links.map(l => {
                const text = l.replace(/\[\[|\]\]/g, '');
                return `<span class="editor-link">${text}</span>`;
            }).join('');
        }

        document.getElementById('noteContentInput')?.addEventListener('input', e => {
            parseNoteLinks(e.target.value);
        });

        async function saveNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;
            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const note = {
                title,
                content,
                linked_readings: links,
                updated_at: new Date().toISOString()
            };

            if (db && currentUser) {
                note.user_id = currentUser.id;
                try {
                    if (editingNoteId) {
                        await db.from('notes').update(note).eq('id', editingNoteId);
                        const idx = notes.findIndex(n => n.id === editingNoteId);
                        if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                    } else {
                        const { data } = await db.from('notes').insert([note]).select();
                        if (data?.[0]) {
                            notes.unshift(data[0]);
                            editingNoteId = data[0].id;
                        }
                    }
                } catch (e) {
                    console.warn('Failed to save:', e);
                }
            } else {
                if (editingNoteId) {
                    const idx = notes.findIndex(n => n.id === editingNoteId);
                    if (idx >= 0) notes[idx] = { ...notes[idx], ...note };
                } else {
                    note.id = Date.now().toString();
                    note.created_at = note.updated_at;
                    notes.unshift(note);
                    editingNoteId = note.id;
                }
                localStorage.setItem('metamodality_notes', JSON.stringify(notes));
            }

            renderNotesList();
        }

        async function publishNote() {
            const title = document.getElementById('noteTitleInput').value;
            const content = document.getElementById('noteContentInput').value;

            if (!title || !content) {
                alert('Please add a title and content before publishing.');
                return;
            }

            const links = (content.match(/\[\[([^\]]+)\]\]/g) || []).map(l => l.replace(/\[\[|\]\]/g, ''));

            const post = {
                title,
                content,
                linked_readings: links,
                published_at: new Date().toISOString(),
                author_email: currentUser?.email || 'Anonymous',
                reactions: {}
            };

            if (db && currentUser) {
                post.author_id = currentUser.id;
                try {
                    const { data } = await db.from('posts').insert([post]).select();
                    if (data?.[0]) posts.unshift(data[0]);
                } catch (e) {
                    console.warn('Failed to publish:', e);
                }
            } else {
                post.id = Date.now().toString();
                posts.unshift(post);
            }

            renderFeed();
            switchView('discuss');
        }

        // =============================================
        // AUTHENTICATION
        // =============================================

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
            document.getElementById('authEmail').focus();
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
            document.getElementById('authMessage').style.display = 'none';
        }

        async function sendMagicLink() {
            const email = document.getElementById('authEmail').value;
            if (!email) return;

            const msgEl = document.getElementById('authMessage');

            if (db) {
                try {
                    const { error } = await db.auth.signInWithOtp({
                        email,
                        options: { emailRedirectTo: window.location.href }
                    });

                    if (error) throw error;

                    msgEl.className = 'message success';
                    msgEl.textContent = 'Check your email for the magic link!';
                    msgEl.style.display = 'block';
                } catch (e) {
                    msgEl.className = 'message error';
                    msgEl.textContent = e.message || 'Failed to send link';
                    msgEl.style.display = 'block';
                }
            }
        }

        function updateAuthUI(user) {
            const btn = document.getElementById('authBtn');
            if (user) {
                btn.outerHTML = `<div class="user-avatar" onclick="signOut()" title="Sign out">${user.email[0].toUpperCase()}</div>`;
            } else {
                const existing = document.querySelector('.user-avatar');
                if (existing) {
                    existing.outerHTML = `<button class="btn" id="authBtn" onclick="showAuthModal()">Sign In</button>`;
                }
            }
        }

        async function signOut() {
            if (db) {
                await db.auth.signOut();
            }
            currentUser = null;
            location.reload();
        }

        // Start
        init();
    </script>
</body>
</html>
